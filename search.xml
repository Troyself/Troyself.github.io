<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>openmpi[0]-openmpi-img-parse</title>
      <link href="/2025/09/16/openmpi-0-openmpi-img-parse/"/>
      <url>/2025/09/16/openmpi-0-openmpi-img-parse/</url>
      
        <content type="html"><![CDATA[<!--<div align="center">-->  <!--<img src="" alt=""/>--><!--</div>--><ol class="series-items"><li><a href="/2025/09/16/openmpi-0-openmpi-img-parse/" title="openmpi[0]-openmpi-img-parse">openmpi[0]-openmpi-img-parse</a></li><li><a href="/2025/09/08/openmpi-1-what-is-openmpi/" title="openmpi[1] ä»€ä¹ˆæ˜¯openmpi">openmpi[1] ä»€ä¹ˆæ˜¯openmpi</a></li><li><a href="/2025/09/08/openmpi-2-modular-component-architecture/" title="openmpi[2] æ¨¡å—åŒ–ç»„ä»¶æ¶æ„">openmpi[2] æ¨¡å—åŒ–ç»„ä»¶æ¶æ„</a></li><li><a href="/2025/09/08/openmpi-3-btl-mca-self/" title="openmpi[3] btlæ¡†æ¶çš„selfç»„ä»¶åˆ†æ">openmpi[3] btlæ¡†æ¶çš„selfç»„ä»¶åˆ†æ</a></li></ol><h2 id="æ€»è§ˆ"><a href="#æ€»è§ˆ" class="headerlink" title="æ€»è§ˆ"></a>æ€»è§ˆ</h2><p>Open MPIï¼ˆOpen å¯¹ç§°å¤šå¤„ç†å™¨æ¥å£ï¼‰æ˜¯ä¸€ä¸ªå¼€æºã€é«˜æ€§èƒ½çš„ MPIï¼ˆæ¶ˆæ¯ä¼ é€’æ¥å£ï¼‰å®ç°ã€‚</p><p>æ ¸å¿ƒæ¦‚å¿µè§£é‡Šï¼š</p><ul><li>MPI (Message Passing Interface)ï¼šMPI ä¸æ˜¯ä¸€ä¸ªç¼–ç¨‹è¯­è¨€ï¼Œè€Œæ˜¯ä¸€ä¸ªæ ‡å‡†æˆ–è§„èŒƒã€‚å®ƒå®šä¹‰äº†ä¸€å¥—ç”¨äºå¹¶è¡Œè®¡ç®—çš„å‡½æ•°åº“ï¼Œå…è®¸ä¸åŒçš„è¿›ç¨‹ï¼ˆé€šå¸¸è¿è¡Œåœ¨ä¸åŒçš„å¤„ç†å™¨æˆ–è®¡ç®—èŠ‚ç‚¹ä¸Šï¼‰é€šè¿‡æ˜¾å¼åœ°å‘é€å’Œæ¥æ”¶æ¶ˆæ¯æ¥ç›¸äº’é€šä¿¡å’Œåä½œã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€å¥—å¹¶è¡Œç¨‹åºä¹‹é—´è¿›è¡Œäº¤æµçš„â€œè¯­è¨€è§„åˆ™â€ã€‚</li><li>å¹¶è¡Œè®¡ç®—ï¼šæŒ‡å°†ä¸€ä¸ªå¤§çš„è®¡ç®—ä»»åŠ¡åˆ†è§£æˆè®¸å¤šå°ä»»åŠ¡ï¼Œè¿™äº›å°ä»»åŠ¡å¯ä»¥åŒæ—¶ï¼ˆå¹¶è¡Œåœ°ï¼‰åœ¨å¤šä¸ªå¤„ç†å™¨ä¸Šæ‰§è¡Œï¼Œä»¥ç¼©çŸ­å®Œæˆæ•´ä¸ªä»»åŠ¡æ‰€éœ€çš„æ—¶é—´ã€‚</li><li>å®ç° (Implementation)ï¼šMPI æœ¬èº«åªæ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œå…·ä½“çš„ç¼–ç¨‹åº“éœ€è¦ç”±ä¸åŒçš„ç»„ç»‡æˆ–å…¬å¸å»â€œå®ç°â€ã€‚Open MPI å°±æ˜¯ä¼—å¤š MPI å®ç°ä¸­çš„ä¸€ä¸ªï¼Œå…¶ä»–è‘—åçš„å®ç°åŒ…æ‹¬ MPICHã€Intel MPI ç­‰ã€‚</li></ul><p>ç®€è€Œè¨€ä¹‹ï¼ŒOpen MPI å°±æ˜¯ä¸€ä¸ªè®©ä½ èƒ½ç”¨ MPI æ ‡å‡†æ¥ç¼–å†™å¹¶è¡Œç¨‹åºï¼Œå¹¶åœ¨å„ç§è®¡ç®—é›†ç¾¤å’Œå¤šæ ¸å¤„ç†å™¨ä¸Šé«˜æ•ˆè¿è¡Œè¿™äº›ç¨‹åºçš„å·¥å…·ç®±ã€‚</p><p>MPIçš„ç¼–ç¨‹æ–¹å¼ï¼Œæ˜¯â€œä¸€å¤„ä»£ç ï¼Œå¤šå¤„æ‰§è¡Œâ€ã€‚ç¼–å†™è¿‡å¤šçº¿ç¨‹çš„äººåº”è¯¥èƒ½å¤Ÿç†è§£ï¼Œå°±æ˜¯åŒæ ·çš„ä»£ç ï¼Œä¸åŒçš„è¿›ç¨‹æ‰§è¡Œä¸åŒçš„è·¯å¾„</p><p>OpenMPIçš„æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤º(old)ï¼š</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922102157.png" alt="2025%2F09%2F22%2F20250922100058"/></div><p>è‡ªä¸Šå‘ä¸‹ä¾æ¬¡ä¸º:</p><ul><li>OMPI(Open MPI)<ul><li>ç”±MPI æ ‡å‡†å®šä¹‰çš„æ¥å£</li><li>æš´éœ²ç»™ä¸Šå±‚çš„APIæ¥å£ï¼Œç›´æ¥ç”±åº”ç”¨ç¨‹åºè°ƒç”¨</li></ul></li><li>ORTE(Open MPI Run-Time Environment) - ç›®å‰å·²ç»è¢«PRRTEæ‰€å–ä»£ï¼Œä¸è¿‡éƒ½æ˜¯runtimeçš„ä¸€å±‚<ul><li>runtime system<ul><li>åŠ è½½ï¼Œç›‘æ§è¿›ç¨‹ï¼Œæ€æ­»ç‹¬ç«‹çš„è¿›ç¨‹</li><li>é‡å®šå‘stdin, stdout, stderr</li></ul></li><li>ORTE è¿›ç¨‹ç®¡ç†æ–¹å¼ï¼šåœ¨ç®€å•çš„ç¯å¢ƒä¸­ï¼Œé€šè¿‡rshæˆ–ssh æ¥launch è¿›ç¨‹ã€‚è€Œå¤æ‚ç¯å¢ƒ(HPCä¸“ç”¨)ä¼šæœ‰shcedulerã€resource managerç­‰ç®¡ç†ç»„ä»¶ï¼Œé¢å‘å¤šä¸ªç”¨æˆ·è¿›è¡Œå…¬å¹³çš„è°ƒåº¦ä»¥åŠèµ„æºåˆ†é…ï¼ŒORTEæ”¯æŒå¤šç§ç®¡ç†ç¯å¢ƒï¼Œä¾‹å¦‚ï¼Œorque&#x2F;PBS Pro, SLURM, Oracle Grid Engine, and LSF.</li></ul></li><li>OPAL (Open, Portable Access Layer) (pronounced: o-pull): OPAL æ˜¯xOmpiçš„æœ€åº•å±‚,åªä½œç”¨äºå•ä¸ªè¿›ç¨‹,è´Ÿè´£ä¸åŒç¯å¢ƒçš„å¯ç§»æ¤æ€§,åŒ…å«äº†ä¸€äº›é€šç”¨åŠŸèƒ½ï¼ˆä¾‹å¦‚é“¾è¡¨ã€å­—ç¬¦ä¸²æ“ä½œã€debugæ§åˆ¶ç­‰ç­‰ï¼‰.</li></ul><p>ç”±äºè€ƒè™‘åˆ°æ€§èƒ½å› ç´ ï¼ŒOpen MPI æœ‰ä¸­â€œæ—è·¯â€æœºåˆ¶ï¼ˆbypassï¼‰ï¼ŒORTEä»¥åŠOMPIå±‚ï¼Œå¯ä»¥ç»•è¿‡OPALï¼Œç›´æ¥ä¸æ“ä½œç³»ç»Ÿï¼ˆç”šè‡³æ˜¯ç¡¬ä»¶ï¼‰è¿›è¡Œäº¤äº’.<br>ä¾‹å¦‚OMPIä¼šç›´æ¥ä¸ç½‘å¡è¿›è¡Œäº¤äº’ï¼Œä»è€Œè¾¾åˆ°æœ€å¤§çš„ç½‘ç»œæ€§èƒ½ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥åœ¨æ¶æ„å›¾ä¸­çœ‹åˆ°ï¼ŒOMPI&#x2F;ORTEä¸æ“ä½œç³»ç»Ÿæœ‰ä¸€ä¸ªæ—è·¯æ¥å£ã€‚</p><p>ä½†æ˜¯ï¼Œopenmpiè‡ªä»v4.0å¼€å§‹ï¼Œå·²ç»å°†ORTEç§»å‡ºopenmpiæ¡†æ¶ã€‚æ”¹ä¸º3rd-partyå¹¶é‡å‘½åä¸ºPRRTE.</p><p>æœ€æ–°æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922102224.png" alt="2025%2F09%2F22%2F20250922100321"/></div><h2 id="MCA-Architecture"><a href="#MCA-Architecture" class="headerlink" title="MCA Architecture"></a>MCA Architecture</h2><p>ä¸ºäº†åœ¨ Open MPI ä¸­ä½¿ç”¨ç±»ä¼¼åŠŸèƒ½ä½†æ˜¯ä¸åŒå®ç°ï¼ŒOpen MPI è®¾è®¡ä¸€å¥—è¢«ç§°ä¸ºModular Component Architecture (MCA)çš„æ¶æ„.</p><p>MCAæ¶æ„çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡é…ç½®æ–‡ä»¶æ¥é€‰æ‹©ä½¿ç”¨å“ªäº›ç»„ä»¶ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹æºä»£ç ã€‚</p><p>Open MPI é¡¹ç›®çš„æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922102252.png" alt="2025%2F09%2F22%2F20250922100413"/></div><p>è‡ªé¡¶å‘ä¸‹ä¾æ¬¡ä¸º:</p><ul><li>Project: Projectæœ¬è´¨ä¸Šæ˜¯ Open MPI ä»£ç åº“ä¸­æœ€é«˜æŠ½è±¡å±‚çš„åˆ’åˆ†ã€‚ä½†è¿™é‡Œçš„Projectå¯ä¸æ˜¯è¯´çš„é¡¹ç›®ï¼Œè€Œæ˜¯æŒ‡çš„Open MPI ä»£ç åº“ä¸­ä¸»è¦çš„ã€é¡¶å±‚çš„ä»£ç éƒ¨åˆ†<ul><li>OMPI</li><li>OPAL</li><li>OSHMEM: æä¾›å¯¹ç§°å †åˆ†é…å™¨ï¼Œæ”¯æŒä¸åŒç±»å‹çš„å†…å­˜åˆ†é…å™¨;å®ç°OpenSHMEMæ ‡å‡†çš„é€šä¿¡åŸè¯­ï¼Œå¦‚put&#x2F;getæ“ä½œç­‰;ç®¡ç†OpenSHMEMç¨‹åºçš„åˆå§‹åŒ–ã€è¿›ç¨‹ç®¡ç†å’Œèµ„æºåè°ƒ.</li><li>â€¦ (maybe)</li></ul></li><li>Framework:<ul><li>BTL: å­—èŠ‚ä¼ è¾“</li><li>coll: é›†åˆæ“ä½œ</li><li>PML: ç‚¹å¯¹ç‚¹ä¼ è¾“</li><li>â€¦</li></ul></li><li>Component:<ul><li>self: è¿›ç¨‹ä¸ä»–è‡ªèº«é€šä¿¡</li><li>sm: åŒä¸€ä¸»æœºå†…çš„è¿›ç¨‹äº’ç›¸é€šä¿¡</li><li>tcp: é€šè¿‡tcpä¸å…¶ä»–ä¸»æœºå†…çš„è¿›ç¨‹é€šä¿¡</li><li>â€¦</li></ul></li><li>Module:<ul><li>eth0</li><li>eth1</li><li>â€¦</li></ul></li></ul><h2 id="BTL-self-å®ç°-åŒä¸»æœº-åŒè¿›ç¨‹-ä¸åŒçº¿ç¨‹é€šä¿¡"><a href="#BTL-self-å®ç°-åŒä¸»æœº-åŒè¿›ç¨‹-ä¸åŒçº¿ç¨‹é€šä¿¡" class="headerlink" title="BTL&#x2F;self å®ç°: åŒä¸»æœº, åŒè¿›ç¨‹, ä¸åŒçº¿ç¨‹é€šä¿¡"></a>BTL&#x2F;self å®ç°: åŒä¸»æœº, åŒè¿›ç¨‹, ä¸åŒçº¿ç¨‹é€šä¿¡</h2><h3 id="component"><a href="#component" class="headerlink" title="component"></a>component</h3><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922102048.png" style="zoom:80%" alt="2025%2F09%2F22%2F20250922102048"/></div><p>åœ¨btlçš„componentå®ç°ä¸­ï¼Œæœ€é¦–å…ˆå®ç°çš„æ˜¯componentçš„registerå’Œinitå‡½æ•°ã€‚</p><p>registerå‡½æ•°å‘mcaæ¶æ„æ³¨å†Œäº†mcaå‚æ•°ï¼Œinitå‡½æ•°å®Œæˆäº†opal_freelistçš„initå·¥ä½œã€‚</p><p>è¿™é‡Œæåˆ°äº†ä¸€ä¸ªæ–°çš„æ•°æ®ç»“æ„:opal_freelist, è¿™æ˜¯Open MPIä¸­OPALå±‚çš„ä¸€ä¸ªæ ¸å¿ƒå†…å­˜ç®¡ç†ç»„ä»¶ï¼Œç”¨äºé«˜æ•ˆç®¡ç†å¯é‡ç”¨å¯¹è±¡çš„å†…å­˜æ± ã€‚åŸºäºLIFO(åè¿›å…ˆå‡º)çš„å†…å­˜æ± å®ç°ï¼Œä¸»è¦ä½œç”¨æ˜¯ï¼š</p><ul><li>å†…å­˜æ± ç®¡ç†ï¼šé¢„åˆ†é…å›ºå®šå¤§å°çš„å†…å­˜å—ï¼Œé¿å…é¢‘ç¹çš„malloc&#x2F;freeæ“ä½œ</li><li>å¯¹è±¡é‡ç”¨ï¼šæ”¯æŒå¯¹è±¡çš„å¿«é€Ÿåˆ†é…å’Œå›æ”¶</li><li>å†…å­˜å¯¹é½ï¼šæ”¯æŒæŒ‡å®šçš„å†…å­˜å¯¹é½è¦æ±‚</li><li>åŠ¨æ€æ‰©å±•ï¼šå½“å†…å­˜æ± è€—å°½æ—¶å¯ä»¥è‡ªåŠ¨å¢é•¿</li></ul><p>å½“opal_freeliståˆå§‹åŒ–æ—¶ï¼Œæ¯ä¸€ä¸ªopal_freelist_itemçš„å†…å­˜ç»“æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922111949.png" style="zoom:50%" alt="2025%2F09%2F22%2F20250922111949"/></div><p>åœ¨æœ€åè¿˜è°ƒç”¨äº†ä¸€ä¸ªadd_procså‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†åˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å¦å¯ä»¥ç”¨è¯¥ç»„ä»¶(self)è¿›è¡Œé€šä¿¡ï¼Œè¿™ä¹Ÿæ˜¯openmpiè‡ªåŠ¨é€‰æ‹©ç»„ä»¶çš„æ ¸å¿ƒæ”¯æ’‘ä¹‹ä¸€ã€‚</p><p>selfç»„ä»¶è¿™é‡Œçš„å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­æƒ³è¦ä¸æœ¬è¿›ç¨‹é€šä¿¡çš„æ˜¯ä¸æ˜¯æœ¬è¿›ç¨‹ï¼Œå¦‚æœæ˜¯æœ¬è¿›ç¨‹åˆ™æ ‡è®°å¯ä»¥é€šä¿¡, å¦åˆ™æ‹’ç»é€šä¿¡ï¼Œè®©openmpié€‰æ‹©å…¶ä»–ç»„ä»¶ã€‚</p><p>å…¶å®add_procsä¹Ÿæ˜¯ä¸‹ä¸€ä¸ªæ ‡é¢˜çš„opsçš„ä¸€éƒ¨åˆ†ï¼Œä¸è¿‡æ¬åˆ°è¿™é‡Œæ¥è®²æ˜¯å› ä¸ºç¬”è€…è®¤ä¸ºå®ƒä»¬éƒ½å±äºâ€initâ€åˆå§‹åŒ–å·¥ä½œçš„ä¸€éƒ¨åˆ†ã€‚</p><h3 id="ops"><a href="#ops" class="headerlink" title="ops"></a>ops</h3><p>åœ¨btlæ¡†æ¶ä¸‹çš„ç»„ä»¶ï¼Œéœ€è¦å®ç°btlæ¡†æ¶è¦æ±‚çš„ops:</p><ul><li>add_procs: å·²ç»åœ¨ä¸Šé¢è§£é‡Šè¿‡</li><li>del_procs: åˆ é™¤process, ä¸€èˆ¬åœ¨finalizeçš„æ—¶å€™è°ƒç”¨ï¼Œåœ¨selfä¸­ç›´æ¥è¿”å›æˆåŠŸ</li><li>finalize: åœ¨selfä¸­ç›´æ¥è¿”å›æˆåŠŸ</li><li>alloc: ç”³è¯·æ•°æ®æè¿°ç¬¦å‡½æ•°(éœ€è¦æ ¹æ®æ•°æ®å¤§å°é€‰æ‹©ä¸åŒçš„æ•°æ®æè¿°ç¬¦)</li><li>free: é‡Šæ”¾æ•°æ®æè¿°ç¬¦å‡½æ•°</li><li>prepare_src: å‡†å¤‡å‘é€çš„æ•°æ®</li><li>send: å°†æ•°æ®å®é™…å‘é€</li><li>sendi: prepare_src + send</li><li>put: rdma putå‡½æ•°</li><li>get: rdma getå‡½æ•°</li></ul><h4 id="send"><a href="#send" class="headerlink" title="send"></a>send</h4><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922112134.png" style="zoom:50%" alt="2025%2F09%2F22%2F20250922112134"/></div><p>åœ¨sendæ—¶ï¼Œä»MPI Applicationé€å±‚è°ƒç”¨ï¼Œæœ€ç»ˆåˆ°è¾¾btlå±‚ã€‚</p><p>é¦–å…ˆåˆ°è¾¾çš„å¹¶ä¸ä¼šæ˜¯sendå‡½æ•°è€Œæ˜¯prepare_srcå‡½æ•°ï¼Œå› ä¸ºä¸æ˜¯sendiè¿™æ ·çš„â€åŸå­æ“ä½œâ€ï¼Œæ‰€ä»¥æ•°æ®å‡†å¤‡å‘é€æ˜¯å¯ä»¥åˆ†å¼€å¤„ç†çš„ã€‚</p><p>åœ¨prepare_srcå‡½æ•°ä¸­ï¼Œå…ˆè°ƒç”¨allocå‡½æ•°ç”³è¯·æ•°æ®æè¿°ç¬¦ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦ä¸ºå†…è”å‡½æ•°ã€‚</p><p>å¦‚æœæ˜¯å†…è”å‡½æ•°ï¼Œåˆ™ç›´æ¥å°†æ•°æ®åœ°å€ä¼ é€’ç»™æ•°æ®æè¿°ç¬¦ï¼›å¦åˆ™é€šè¿‡iovå°†æ•°æ®æ‰“åŒ…åˆ°æ•°æ®æè¿°ç¬¦ä¸­çš„é¢„ç”³è¯·buffer.</p><p>æ•°æ®æè¿°ç¬¦çš„å†…å­˜ç©ºé—´æ˜¯åœ¨opal_freeliståˆå§‹åŒ–çš„æ—¶å€™ç”³è¯·çš„ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†éå†…è”å‘é€çš„æ•°æ®ç¼“å­˜ã€‚</p><p>ä¹‹ååœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨åˆ°selfçš„sendå‡½æ•°ã€‚</p><p>selfçš„sendå‡½æ•°ç›´æ¥è°ƒç”¨openmpi btlå†…éƒ¨çš„æ¥æ”¶å›è°ƒå‡½æ•°ï¼Œå¹¶å°†prepare_srcæ—¶å‡†å¤‡çš„æ•°æ®æè¿°ç¬¦ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ã€‚</p><p>å› ä¸ºselfæ˜¯æœ¬è¿›ç¨‹ä¸æœ¬è¿›ç¨‹é€šä¿¡ï¼Œæ‰€æœ‰èµ„æºéƒ½æ˜¯å¯ä»¥äº’ç›¸ç›´æ¥è®¿é—®çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä¼ é€’è¿›å»ã€‚</p><h4 id="recv"><a href="#recv" class="headerlink" title="recv"></a>recv</h4><p>åœ¨recvå‡½æ•°ä¸­ï¼Œç›´æ¥å°±å¯ä»¥ä»openmpié‡Œé¢å‡†å¤‡å¥½çš„æ•°æ®æè¿°ç¬¦æ‹¿åˆ°æ•°æ®ã€‚</p><p>send &amp; recvå®Œæ•´æµç¨‹å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922103343.png" alt="2025%2F09%2F22%2F20250922103343"/></div><h4 id="rdma-put-get"><a href="#rdma-put-get" class="headerlink" title="rdma: put&#x2F;get"></a>rdma: put&#x2F;get</h4><p>åœ¨selfè¿›ç¨‹ä¸­çš„rdma put&#x2F;getæ“ä½œï¼Œå› ä¸ºçŸ¥é“ç›®æ ‡åœ°å€ä¸æºåœ°å€ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦é‚£äº›éº»çƒ¦çš„æ•°æ®æè¿°ç¬¦ã€‚</p><p>è€Œä¸”æ˜¯selfè¿›ç¨‹é—´é€šä¿¡ï¼Œæ‰€ä»¥rdmaçš„put&#x2F;getæ“ä½œå¯ä»¥ç›´æ¥é€šè¿‡memcpyå®Œæˆã€‚</p><p>rdma put&#x2F;getçš„æµç¨‹å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922112610.png" alt="2025%2F09%2F22%2F20250922112610"/></div><h2 id="BTL-sm-å®ç°-åŒä¸»æœº-ä¸åŒè¿›ç¨‹é€šä¿¡"><a href="#BTL-sm-å®ç°-åŒä¸»æœº-ä¸åŒè¿›ç¨‹é€šä¿¡" class="headerlink" title="BTL&#x2F;sm å®ç°: åŒä¸»æœº, ä¸åŒè¿›ç¨‹é€šä¿¡"></a>BTL&#x2F;sm å®ç°: åŒä¸»æœº, ä¸åŒè¿›ç¨‹é€šä¿¡</h2><h3 id="component-1"><a href="#component-1" class="headerlink" title="component"></a>component</h3><p>smçš„componentæµç¨‹ä¸selfç±»ä¼¼ï¼Œå¦‚ä¸‹ï¼š</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922134932.png" style="zoom:30%" alt="2025%2F09%2F22%2F20250922134932"/></div><p>ä¸è¿‡smçš„componentæœ‰è®¸å¤šç»†èŠ‚éœ€è¦è§£é‡Šã€‚</p><h4 id="register"><a href="#register" class="headerlink" title="register"></a>register</h4><p>é¦–å…ˆå…ˆæ³¨å†Œè‡ªå®šä¹‰çš„mcaå‚æ•°åˆ°æ¶æ„ä¸­ï¼Œä¹‹ååˆ¤æ–­æ˜¯å¦æ‹¥æœ‰&#x2F;dev&#x2F;shmç›®å½•ã€‚</p><p>å¦‚æœæœ‰ï¼Œåˆ™dir &#x3D; &#x2F;dev&#x2F;shm,å¦åˆ™dir &#x3D; OMPI session dir.</p><p>ä¹‹åé…ç½®btléœ€è¦è¢«ä¼ é€’çš„å‚æ•°ï¼Œè¿™ç‚¹ä¸selfä¸€è‡´ã€‚</p><p>å…·ä½“æ¡†å›¾ï¼š</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922135258.png" style="zoom:50%" alt="2025%2F09%2F22%2F20250922135258"/></div><h4 id="init"><a href="#init" class="headerlink" title="init"></a>init</h4><p>å…ˆæ£€æŸ¥ç”¨æˆ·æ‰€ä¼ é€’çš„è‡ªå®šä¹‰å‚æ•°æ˜¯å¦åˆæ³•ï¼Œä¹‹ååˆ¤æ–­æ˜¯å¦å…·æœ‰SMSCã€‚</p><p>SMSCæ˜¯Linuxå®ç°çš„å…±äº«å†…å­˜æœºåˆ¶ï¼Œå¯ä»¥è·¨è¿›ç¨‹å…±äº«æ•°æ®ï¼Œä¹Ÿæ˜¯OMPIçš„smç»„ä»¶é‡Œé¢å®ç°single-copyçš„é‡è¦ä¾èµ–ã€‚</p><p>å¦‚æœæ”¯æŒSMSCçš„è¯å°±è®¾ç½®btlå‚æ•°æ”¯æŒsingle-copy.</p><p>å¦åˆ™è®¾ç½®btlæ‰€éœ€è¦çš„opsç»“æ„ä½“ä¸­çš„rdma get&#x2F;putä¸ºNULL,è¡¨ç¤ºä¸æ”¯æŒrdmaæ“ä½œ(å¿…é¡»é€šè¿‡openmpi bufferä¸­è½¬).</p><p>ä¹‹åæ ¹æ®registerä¸­èµ‹å€¼çš„dirå˜é‡åˆ›å»ºå…±äº«å†…å­˜æ–‡ä»¶ï¼Œå¹¶å°†å…±äº«å†…å­˜æ–‡ä»¶attachåˆ°my_segmentå˜é‡ä¸­ï¼Œè®©è¿™ä¸ªå˜é‡æŒ‡å‘è¿™æ®µå…±äº«å†…å­˜ã€‚</p><p>åœ¨my_segmentè¿™æ®µå…±äº«å†…å­˜ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯FIFOæ•°æ®ç»“æ„å æ®äº†å‰128ä¸ªbytes.</p><p>æœ€åé€šè¿‡MODEXæ“ä½œå‘é€è¿™ä¸ªmemory infoåˆ°å¯¹ç­‰è¿›ç¨‹ä¸­ï¼Œå‘Šè¯‰ä»–ä»¬:å˜¿ï¼Œæˆ‘çš„å†…å­˜åœ¨è¿™ä¸ªä½ç½®ã€‚</p><p>è¿™é‡Œæ˜¯å¦è¿˜è®°å¾—ä¹‹å‰çš„æ¡†å›¾ï¼Œbtl&#x2F;tcpç»„ä»¶æœ‰ä¸€ä¸ªï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªethç½‘å£å°±æœ‰ä¸¤ä¸ªmodule.</p><p>è¿™é‡Œå¦‚æœé€šè¿‡smè¿›è¡Œé€šè®¯ï¼Œåˆ™æ¯ä¸€ä¸ªè¿›ç¨‹å°±æ˜¯ä¸€ä¸ªmodule.</p><p>æ‰€ä»¥æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„å…±äº«å†…å­˜åŒºåŸŸã€‚</p><p>å…·ä½“æ¡†å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922135819.png" style="zoom:50%" alt="2025%2F09%2F22%2F20250922135819"/></div><h4 id="add-procs"><a href="#add-procs" class="headerlink" title="add_procs"></a>add_procs</h4><p>add_procsçš„è¿‡ç¨‹æ˜¯æ¯”selfå¤æ‚å¾ˆå¤šçš„ï¼Œå› ä¸ºè®¾è®¡åˆ°äº†ep(endpoint)çš„æ¦‚å¿µï¼Œæ­¤æ—¶å†…å­˜ä¸å†æ˜¯é“æ¿ä¸€å—ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ‰‹æ®µè·å–åˆ°å¯¹ç­‰è¿›ç¨‹çš„å†…å­˜ã€‚</p><p>åœ¨add_procsä¸­ï¼Œä¼šæ ¹æ®btl_initedå˜é‡æ¥åˆ¤æ–­æ˜¯å¦ç¬¬ä¸€æ¬¡åˆå§‹åŒ–è¿‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±è°ƒç”¨sm_btl_first_time_init()è¿›è¡Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–.</p><p>ä¹‹åéå†æ‰€æœ‰è¿›ç¨‹ï¼Œå½“è¿›ç¨‹çš„jobidä¸å½“å‰è¿›ç¨‹jobidç›¸åŒå¹¶ä¸”å±äºlocal nodeçš„è¯ï¼Œå°±ä¼šè®¾ç½®è¿›ç¨‹å¯è§æ€§ã€‚</p><p>åœ¨è®¾ç½®è¿›ç¨‹å¯è§æ€§åï¼Œé€šè¿‡init_sm_endpoint()åˆå§‹åŒ–è¿™ä¸ªè¿›ç¨‹çš„ep.</p><p>å…·ä½“æ¡†å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922135611.png" style="zoom:40%" alt="2025%2F09%2F22%2F20250922135611"/></div><h5 id="first-time-init"><a href="#first-time-init" class="headerlink" title="first_time_init"></a>first_time_init</h5><p>é¦–å…ˆä¸ºendpointsæ•°ç»„åŠ¨æ€åˆ†é…å†…å­˜(æ•°ç»„æˆå‘˜æ•°é‡æ¥è‡ªMCA_BTL_SM_NUM_LOCAL_PEERS),<br>ä¹‹åç»™fbox_in_enpointsæ•°ç»„åˆ†é…å†…å­˜ï¼Œæ•°ç»„æˆå‘˜æ•°é‡å¦‚ä¸Šã€‚</p><p>ä¹‹ååˆ›å»ºå†…å­˜æ± ï¼Œå†…å­˜æ± çš„å†…å­˜ç©ºé—´ç”±my_segmentæä¾›ï¼Œmy_segmentå˜é‡åœ¨initçš„æ—¶å€™attachåˆ°äº†å…±äº«å†…å­˜æ–‡ä»¶ã€‚</p><p>æœ€ååˆå§‹åŒ–free_listæ•°æ®ç»“æ„ã€‚</p><p>åœ¨åˆå§‹åŒ–free_listçš„æ—¶å€™ï¼Œæµç¨‹ä¸å†…å­˜ç©ºé—´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922151616.png" style="zoom:50%" alt="2025%2F09%2F22%2F20250922151616"/></div><p>å…·ä½“æ¡†å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922151706.png" style="zoom:50%" alt="2025%2F09%2F22%2F20250922151706"/></div><h5 id="init-sm-endpoint"><a href="#init-sm-endpoint" class="headerlink" title="init_sm_endpoint"></a>init_sm_endpoint</h5><p>è¯¥å‡½æ•°ä¼šå…ˆé€šè¿‡modexæ‹¿åˆ°å¯¹ç­‰è¿›ç¨‹çš„ä¿¡æ¯ï¼Œå¦‚æœå¯¹ç­‰è¿›ç¨‹æ˜¯æœ¬è¿›ç¨‹çš„è¯ï¼Œé‚£ä¹ˆep-&gt;segment_base &#x3D; my_segment;å¦åˆ™çš„è¯åˆ™é€šè¿‡modexæ‹¿åˆ°å¯¹ç­‰è¿›ç¨‹çš„å†…å­˜ä¿¡æ¯ï¼Œå°†ep-&gt;segment_base attachåˆ°å¯¹ç­‰è¿›ç¨‹çš„å…±äº«å†…å­˜ã€‚</p><p>å…·ä½“æ¡†å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922153242.png" style="zoom:50%" alt="2025%2F09%2F22%2F20250922153242"/></div><h4 id="componentå®Œæ•´æ¡†å›¾"><a href="#componentå®Œæ•´æ¡†å›¾" class="headerlink" title="componentå®Œæ•´æ¡†å›¾"></a>componentå®Œæ•´æ¡†å›¾</h4><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922134837.png" alt="2025%2F09%2F22%2F20250922134837"/></div><h3 id="send-1"><a href="#send-1" class="headerlink" title="send"></a>send</h3><p>sendçš„è°ƒç”¨é“¾ä¸selfç›¸åŒï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯prepare_srcå’Œsendå‡½æ•°çš„å®ç°ã€‚</p><h4 id="prepare-src"><a href="#prepare-src" class="headerlink" title="prepare_src"></a>prepare_src</h4><p>åœ¨prepare_srcå‡½æ•°ä¸­ï¼Œé¦–å…ˆç”³è¯·æ•°æ®æè¿°ç¬¦ã€‚</p><p>åœ¨æ‹¿åˆ°æ•°æ®æè¿°ç¬¦åï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå†…è”å‘é€(æ•°æ®ä¸åœ¨è®¾å¤‡ä¸Šå¹¶ä¸”æ˜¯è¿ç»­çš„å†…å­˜ç©ºé—´)ã€‚</p><p>å¦‚æœæ˜¯å†…è”å‘é€ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦å…·æœ‰SMSC(å…±äº«å†…å­˜åŠŸèƒ½),å¦‚æœæœ‰çš„è¯ï¼Œåˆ™ç›´æ¥å°†åœ°å€å†™å…¥æ•°æ®æè¿°ç¬¦ï¼ˆsingle-copy);å¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™memcpyåˆ°åˆ°æ•°æ®æè¿°ç¬¦ä¸­çš„é¢„ç•™ç©ºé—´ã€‚</p><p>å¦‚æœä¸æ˜¯å†…è”å‘é€ï¼Œåˆ™é€šè¿‡covertor_packå‡½æ•°å°†æ•°æ®æ‰“åŒ…åˆ°æ•°æ®æè¿°ç¬¦ä¸­çš„é¢„ç•™ç©ºé—´ã€‚</p><p>å…·ä½“æ¡†å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922154056.png" alt="2025%2F09%2F22%2F20250922154056"/></div><h4 id="send-2"><a href="#send-2" class="headerlink" title="send"></a>send</h4><p>åœ¨sendå‡½æ•°ä¸­ï¼Œä¸èƒ½åƒselfä¸€æ ·ç›´æ¥ç®€å•çš„è°ƒç”¨openmpiå†…éƒ¨çš„æ¥æ”¶å›è°ƒå‡½æ•°ï¼Œéœ€è¦å®é™…å‘é€ã€‚</p><p>é¦–å…ˆè®¾ç½®hdræ ‡å¿—ä½ï¼Œä¹‹ååˆ¤æ–­æ˜¯å¦fastboxå‘é€ã€‚</p><p>å¦‚æœæ˜¯fastboxå‘é€ï¼Œåˆ™ç›´æ¥é€šè¿‡fastboxå‘é€ã€‚</p><p>å¦‚æœä¸æ˜¯fastboxå‘é€ï¼Œåˆ™é€šè¿‡små®ç°çš„lock-freeçš„FIFOè¿›è¡Œå‘é€ã€‚</p><p>ä¹‹ååˆ¤æ–­æ˜¯å¦å‘é€æˆåŠŸï¼Œå¦‚æœä¸æˆåŠŸï¼Œåˆ™å°†è¯¥æ•°æ®æè¿°ç¬¦æ”¾åˆ°pending_listä¸­ã€‚</p><p>ç­‰å¾…åˆé€‚çš„æ—¶æœºå–å‡ºã€‚</p><p>å…·ä½“æ¡†å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922154113.png" alt="2025%2F09%2F22%2F20250922154113"/></div><h4 id="sendå®Œæ•´æ¡†å›¾"><a href="#sendå®Œæ•´æ¡†å›¾" class="headerlink" title="sendå®Œæ•´æ¡†å›¾"></a>sendå®Œæ•´æ¡†å›¾</h4><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922153900.png" alt="2025%2F09%2F22%2F20250922153900"/></div><h3 id="recv-1"><a href="#recv-1" class="headerlink" title="recv"></a>recv</h3><p>recvçš„æµç¨‹ä¸selfæ›´æ˜¯å¤§ç›¸å¾„åº­ï¼Œå› ä¸ºä¹‹å‰çš„selfçš„recvåªéœ€è¦ä»ompiæ¡†æ¶æ‹¿æ•°æ®å°±å¯ä»¥äº†ã€‚</p><p>ä½†æ˜¯smçš„recvéœ€è¦æ¥è¯»å–æ•°æ®æ˜¯å¦å‘é€å®Œæˆç­‰æ“ä½œï¼Œæ‰€ä»¥åœ¨component::opsé‡Œé¢å¼•å…¥äº†btl_progress()ã€‚</p><p>ä½†æ˜¯recvçš„è°ƒç”¨é“¾ä¸selfæ˜¯ç›¸åŒçš„ã€‚</p><h4 id="progress"><a href="#progress" class="headerlink" title="progress"></a>progress</h4><p>åœ¨progresså‡½æ•°ä¸­ï¼Œé¦–å…ˆæ£€æŸ¥fastboxæ˜¯å¦æœ‰æ•°æ®éœ€è¦å¤„ç†ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å¤„ç†.</p><p>ä¹‹åæ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®æè¿°ç¬¦æŒ‚åˆ°äº†pending_listä¸­ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°è¯•å°†ä»–ä»¬å†™å…¥çœŸæ­£çš„FIFOä¸­ã€‚</p><p>åœ¨è¿™é‡Œå†æ¬¡å¤±è´¥äº†ä¹Ÿæ²¡å…³ç³»ï¼Œå¤±è´¥çš„è¯å°±ä¸ä¼šä»pending_listä¸­æ‹¿å‡ºï¼Œä¸‹æ¬¡recvçš„æ—¶å€™ä¾ç„¶ä¼šå°è¯•å†æ¬¡å†™å…¥ã€‚</p><p>åœ¨æœ€åè°ƒç”¨poll_fifoæ¥æ£€æŸ¥fifoã€‚</p><p>å…·ä½“æ¡†å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922155248.png" style="zoom:50%" alt="2025%2F09%2F22%2F20250922155248"/></div><h5 id="poll-fifo"><a href="#poll-fifo" class="headerlink" title="poll_fifo"></a>poll_fifo</h5><p>åœ¨poll_fifoä¸­ï¼Œæ˜¯ä¸€ä¸ª31æ¬¡çš„å¾ªç¯è¯»fifoï¼Œè¿™ä¸ªå€¼æˆ‘å¹¶ä¸æ¸…æ¥šå…·ä½“å«ä¹‰ï¼Œå¯èƒ½æ˜¯æ€§èƒ½å’Œæ•ˆç‡çš„æƒè¡¡ã€‚</p><p>åœ¨å¾ªç¯ä¸­ï¼Œè¯»å–fifo,å¦‚æœå¤±è´¥åˆ™è¿”å›ã€‚</p><p>å¦‚æœè¯»å–fifoæˆåŠŸï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªå·²ç»å®Œæˆçš„fifoï¼Œå¦‚æœæ˜¯çš„è¯è°ƒç”¨æ•°æ®æè¿°ç¬¦çš„å›è°ƒå‡½æ•°ã€‚</p><p>å¦‚æœä¸æ˜¯å·²ç»å®Œæˆçš„fifo,åˆ™åˆ¤æ–­æ˜¯å¦ä¸ºsingle-copy.</p><p>å¦‚æœæ˜¯single-copy,åˆ™æ˜ å°„endpointçš„å…±äº«å†…å­˜åˆ°æœ¬åœ°ã€‚</p><p>å¦‚æœä¸æ˜¯ï¼Œç›´æ¥æ‰§è¡Œrecvçš„å›è°ƒå‡½æ•°ã€‚</p><p>ä¹‹åå°†è¯»å–çš„è¿™ä¸ªfifoè®¾ç½®completeæ ‡å¿—ä½ï¼Œå†å›å†™åˆ°epçš„fifoä¸­ã€‚</p><p>å…·ä½“æ¡†å›¾å¦‚ä¸‹:</p><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922155744.png" style="zoom:50%" alt="2025%2F09%2F22%2F20250922155744"/></div><h4 id="recvå®Œæ•´æ¡†å›¾"><a href="#recvå®Œæ•´æ¡†å›¾" class="headerlink" title="recvå®Œæ•´æ¡†å›¾"></a>recvå®Œæ•´æ¡†å›¾</h4><div align="center">  <img src="https://cdn.jsdelivr.net/gh/troyself/blog-img-bed//2025%2F09%2F22%2F20250922154754.png" alt="2025%2F09%2F22%2F20250922154754"/></div>]]></content>
      
      
      <categories>
          
          <category> openmpi </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openmpi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openmpi[3] btlæ¡†æ¶çš„selfç»„ä»¶åˆ†æ</title>
      <link href="/2025/09/08/openmpi-3-btl-mca-self/"/>
      <url>/2025/09/08/openmpi-3-btl-mca-self/</url>
      
        <content type="html"><![CDATA[<ol class="series-items"><li><a href="/2025/09/16/openmpi-0-openmpi-img-parse/" title="openmpi[0]-openmpi-img-parse">openmpi[0]-openmpi-img-parse</a></li><li><a href="/2025/09/08/openmpi-1-what-is-openmpi/" title="openmpi[1] ä»€ä¹ˆæ˜¯openmpi">openmpi[1] ä»€ä¹ˆæ˜¯openmpi</a></li><li><a href="/2025/09/08/openmpi-2-modular-component-architecture/" title="openmpi[2] æ¨¡å—åŒ–ç»„ä»¶æ¶æ„">openmpi[2] æ¨¡å—åŒ–ç»„ä»¶æ¶æ„</a></li><li><a href="/2025/09/08/openmpi-3-btl-mca-self/" title="openmpi[3] btlæ¡†æ¶çš„selfç»„ä»¶åˆ†æ">openmpi[3] btlæ¡†æ¶çš„selfç»„ä»¶åˆ†æ</a></li></ol><p>åœ¨openmpi[2]ä¸­ï¼Œå·²ç»åˆ†æäº†openmpiçš„æ¨¡å—åŒ–æ¶æ„ã€‚å¯¹äºæœ¬ç« èŠ‚æ¥è¯´ï¼Œä¸Šä¸€ç« æåˆ°çš„frameworkå¯¹åº”çš„æ˜¯btl;componentå¯¹åº”çš„å°±æ˜¯self; mcaçš„æ„æ€å°±æ˜¯mcaæ¨¡å—ğŸ¤£</p><h2 id="selfç»„ä»¶çš„åˆ†å±‚"><a href="#selfç»„ä»¶çš„åˆ†å±‚" class="headerlink" title="selfç»„ä»¶çš„åˆ†å±‚"></a>selfç»„ä»¶çš„åˆ†å±‚</h2><p>åœ¨opal&#x2F;mca&#x2F;btl&#x2F;selfç›®å½•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ btl_self.c</span><br><span class="line">â”œâ”€â”€ btl_self_component.c</span><br><span class="line">â”œâ”€â”€ btl_self_component.lo</span><br><span class="line">â”œâ”€â”€ btl_self_frag.c</span><br><span class="line">â”œâ”€â”€ btl_self_frag.h</span><br><span class="line">â”œâ”€â”€ btl_self_frag.lo</span><br><span class="line">â”œâ”€â”€ btl_self.h</span><br><span class="line">â”œâ”€â”€ btl_self.lo</span><br><span class="line">â”œâ”€â”€ libmca_btl_self.la</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ Makefile.am</span><br><span class="line">â”œâ”€â”€ Makefile.<span class="keyword">in</span></span><br><span class="line">â””â”€â”€ owner.txt</span><br></pre></td></tr></table></figure><p>é™¤å»ä¸éœ€è¦å…³å¿ƒçš„ç¼–è¯‘ç›¸å…³å’Œæ³¨é‡Šç›¸å…³ï¼Œæˆ‘ä»¬å‰©ä¸‹äº†è¿™ä¸‰ä¸ªå†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ btl_self.c</span><br><span class="line">â”œâ”€â”€ btl_self_component.c</span><br><span class="line">â”œâ”€â”€ btl_self_frag.c</span><br><span class="line">â”œâ”€â”€ btl_self_frag.h</span><br></pre></td></tr></table></figure><ul><li>btl_frag: ä¸ä¼ è¾“ç›¸å…³</li><li>btl_self_component: ç»„ä»¶åˆå§‹åŒ–åŠæ³¨å†Œ</li><li>btl_self: æä¾›opså‡½æ•°</li></ul><h2 id="component"><a href="#component" class="headerlink" title="component"></a>component</h2><p>åœ¨btl_self_component.cä¸­ï¼Œä¸€å…±åŒ…å«äº†å››ä¸ªå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_component_register</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_component_open</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_component_close</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SELF module initialization.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param num_btls (OUT)                  Number of BTLs returned in BTL array.</span></span><br><span class="line"><span class="comment"> * @param enable_progress_threads (IN)    Flag indicating whether BTL is allowed to have progress</span></span><br><span class="line"><span class="comment"> * threads</span></span><br><span class="line"><span class="comment"> * @param enable_mpi_threads (IN)         Flag indicating whether BTL must support multilple</span></span><br><span class="line"><span class="comment"> * simultaneous invocations from different threads</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">mca_btl_base_module_t</span> **</span><br><span class="line"><span class="title function_">mca_btl_self_component_init</span><span class="params">(<span class="type">int</span> *num_btls, <span class="type">bool</span> enable_progress_threads, <span class="type">bool</span> enable_mpi_threads)</span>;</span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨é¡ºåºå’Œå…³ç³»"><a href="#è°ƒç”¨é¡ºåºå’Œå…³ç³»" class="headerlink" title="è°ƒç”¨é¡ºåºå’Œå…³ç³»"></a>è°ƒç”¨é¡ºåºå’Œå…³ç³»</h3><p>è¿™å››ä¸ªå‡½æ•°åœ¨ Open MPI å¯åŠ¨è¿‡ç¨‹ä¸­æŒ‰ç…§ç‰¹å®šé¡ºåºè¢« MCA æ¡†æ¶è°ƒç”¨ï¼š</p><p>register â†’ open â†’ init â†’ close</p><h4 id="register"><a href="#register" class="headerlink" title="register"></a>register</h4><p>è°ƒç”¨æ—¶æœºï¼šMCA æ¡†æ¶åŠ è½½ç»„ä»¶æ—¶æœ€å…ˆè°ƒç”¨ï¼Œç”¨äºæ³¨å†Œç»„ä»¶å‚æ•°ã€‚</p><p>ä¸»è¦èŒè´£ï¼š</p><p>æ³¨å†Œç»„ä»¶åˆ° MCA å˜é‡ç³»ç»Ÿ<br>è®¾ç½® free list ç›¸å…³å‚æ•°ï¼ˆfree_list_numã€free_list_maxã€free_list_incï¼‰<br>é…ç½® BTL æ¨¡å—çš„æ€§èƒ½å‚æ•°ï¼ˆå¸¦å®½ã€å»¶è¿Ÿã€æ¶ˆæ¯å¤§å°é™åˆ¶ç­‰ï¼‰<br>è®¾ç½® BTL åŠŸèƒ½æ ‡å¿—ï¼ˆRDMAã€å°±åœ°å‘é€ç­‰ï¼‰</p><h4 id="open"><a href="#open" class="headerlink" title="open"></a>open</h4><p>è°ƒç”¨æ—¶æœºï¼šå‚æ•°æ³¨å†Œå®Œæˆåï¼Œåœ¨ç»„ä»¶åˆå§‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚</p><p>ä¸»è¦èŒè´£ï¼š</p><p>æ„é€ ä¸‰ä¸ª opal_free_list_t å¯¹è±¡ï¼ˆeagerã€sendã€rdma fragmentsï¼‰<br>ä¸ºåç»­çš„å†…å­˜æ± åˆå§‹åŒ–åšå‡†å¤‡<br>ä¸è¿›è¡Œå®é™…çš„å†…å­˜åˆ†é…ï¼Œåªæ˜¯å¯¹è±¡æ„é€ </p><h4 id="init"><a href="#init" class="headerlink" title="init"></a>init</h4><p>è°ƒç”¨æ—¶æœºï¼šç»„ä»¶æ‰“å¼€åï¼Œå½“ BTL æ¡†æ¶éœ€è¦å®é™…åˆ›å»º BTL æ¨¡å—æ—¶è°ƒç”¨ã€‚</p><p>ä¸»è¦èŒè´£ï¼š</p><p>åˆå§‹åŒ–ä¸‰ä¸ª free listï¼Œåˆ†é…å®é™…å†…å­˜æ± <br>ä¸ºä¸åŒç±»å‹çš„ fragment è®¾ç½®ä¸åŒçš„å¤§å°å’Œå¯¹é½è¦æ±‚<br>åˆ›å»ºå¹¶è¿”å› BTL æ¨¡å—æ•°ç»„ç»™ä¸Šå±‚ä½¿ç”¨<br>è¿™æ˜¯å”¯ä¸€è¿”å›å®é™…å¯ç”¨ BTL æ¨¡å—çš„å‡½æ•°</p><h4 id="close"><a href="#close" class="headerlink" title="close"></a>close</h4><p>è°ƒç”¨æ—¶æœºï¼šç¨‹åºç»“æŸæˆ–ç»„ä»¶å¸è½½æ—¶è°ƒç”¨ï¼Œç”¨äºæ¸…ç†èµ„æºã€‚</p><p>ä¸»è¦èŒè´£ï¼š</p><p>ææ„ä¸‰ä¸ª opal_free_list_t å¯¹è±¡<br>é‡Šæ”¾åœ¨ open é˜¶æ®µåˆ†é…çš„èµ„æº<br>ç¡®ä¿æ²¡æœ‰å†…å­˜æ³„æ¼</p><h3 id="å…³äºæ„é€ çš„å¼•å…¥"><a href="#å…³äºæ„é€ çš„å¼•å…¥" class="headerlink" title="å…³äºæ„é€ çš„å¼•å…¥"></a>å…³äºæ„é€ çš„å¼•å…¥</h3><p>åœ¨open&#x2F;closeä¸­ç¬¬ä¸€æ¬¡è§åˆ°äº†é¢å‘å¯¹è±¡çš„çœŸå®¹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_component_open</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* initialize objects */</span></span><br><span class="line">    OBJ_CONSTRUCT(&amp;mca_btl_self_component.self_frags_eager, <span class="type">opal_free_list_t</span>);</span><br><span class="line">    OBJ_CONSTRUCT(&amp;mca_btl_self_component.self_frags_send, <span class="type">opal_free_list_t</span>);</span><br><span class="line">    OBJ_CONSTRUCT(&amp;mca_btl_self_component.self_frags_rdma, <span class="type">opal_free_list_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OPAL_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * component cleanup - sanity checking of queue lengths</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_component_close</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    OBJ_DESTRUCT(&amp;mca_btl_self_component.self_frags_eager);</span><br><span class="line">    OBJ_DESTRUCT(&amp;mca_btl_self_component.self_frags_send);</span><br><span class="line">    OBJ_DESTRUCT(&amp;mca_btl_self_component.self_frags_rdma);</span><br><span class="line">    <span class="keyword">return</span> OPAL_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ¥çœ‹openå‡½æ•°ä¸­å¯¹opal_free_list_tè¿™ä¸ªç±»çš„æ„é€ å®æ˜¯å¦‚ä½•æ„æˆçš„:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_CONSTRUCT(object, type)                        \</span></span><br><span class="line"><span class="meta">    do &#123;                                                   \</span></span><br><span class="line"><span class="meta">        OBJ_CONSTRUCT_INTERNAL((object), OBJ_CLASS(type)); \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_CONSTRUCT_INTERNAL(object, type)                      \</span></span><br><span class="line"><span class="meta">    do &#123;                                                          \</span></span><br><span class="line"><span class="meta">        OBJ_SET_MAGIC_ID((object), OPAL_OBJ_MAGIC_ID);            \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (opal_class_init_epoch != (type)-&gt;cls_initialized) &#123;   \</span></span><br><span class="line"><span class="meta">            opal_class_initialize((type));                        \</span></span><br><span class="line"><span class="meta">        &#125;                                                         \</span></span><br><span class="line"><span class="meta">        ((opal_object_t *) (object))-&gt;obj_class = (type);         \</span></span><br><span class="line"><span class="meta">        ((opal_object_t *) (object))-&gt;obj_reference_count = 1;    \</span></span><br><span class="line"><span class="meta">        opal_obj_run_constructors((opal_object_t *) (object));    \</span></span><br><span class="line"><span class="meta">        OBJ_REMEMBER_FILE_AND_LINENO(object, __FILE__, __LINE__); \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br></pre></td></tr></table></figure><p>OBJ_CONSTRUCTæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨OBJ_CONSTRUCT_INTERNAL.</p><p>åœ¨OBJ_CONSTRUCT_INTERNALé‡Œé¢ï¼Œå…ˆè®¾ç½®ä¸€ä¸ªMAGIC_ID(å¦‚æœæ²¡ä½¿èƒ½DEBUGçš„è¯ï¼Œè¿™å°±æ˜¯nop)</p><p>ä¹‹åæ¥åˆ¤æ–­ä¸–ä»£è®¡æ•°å™¨ï¼Œè¿™é‡Œç¬”è€…ä¹Ÿæ²¡æœ‰ç»†ç©¶ä»£ç ï¼Œä¸è¿‡æ¥çœ‹æ˜¯opalè¿™ä¸ªå­ç³»ç»Ÿåˆå§‹åŒ–æˆ–è€…é‡Šæ”¾èµ„æºçš„æ—¶å€™ä¼šé‡æ–°è®¾ç½®è¿™ä¸ªepochçš„å˜é‡ã€‚åœ¨opal_class_initializeé‡Œé¢ä¼šåˆå§‹åŒ–opalçš„classç³»ç»Ÿï¼Œç„¶åè®¾ç½®epochå˜é‡ã€‚</p><p>æ ¹æ®opal_class_initializeçš„æ³¨é‡Šä¹Ÿèƒ½çœ‹å‡º:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Lazy initialization of class descriptor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">opal_class_initialize</span><span class="params">(<span class="type">opal_class_t</span> *cls)</span></span><br></pre></td></tr></table></figure><p>æ€è€ƒï¼šè¿™é‡Œä¼šå¸¦æ¥ç©ºé—´å ç”¨çš„é—®é¢˜ï¼Œå¦‚æœè°ƒç”¨OBJ_CONSTRUCT_INTERNALçš„å‡½æ•°å¤šäº†ï¼Œè¿™ç‚¹æ‡’åŠ è½½å¸¦æ¥çš„æ€§èƒ½æ”¹å˜æ˜¯å¦çœŸçš„å€¼å¾—ç”¨è¿™ä¹ˆå¤šç©ºé—´æ¢å—ï¼Ÿ</p><p>å³ç­”: å‡ åKBè€Œå·²ğŸ¤£</p><p>ä¹‹åä¼šè°ƒç”¨opal_obj_run_constructorså‡½æ•°æ¥è¿è¡Œæ„é€ å‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run the hierarchy of class constructors for this object, in a</span></span><br><span class="line"><span class="comment"> * parent-first order.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Do not use this function directly: use OBJ_CONSTRUCT() instead.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * WARNING: This implementation relies on a hardwired maximum depth of</span></span><br><span class="line"><span class="comment"> * the inheritance tree!!!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Hardwired for fairly shallow inheritance trees</span></span><br><span class="line"><span class="comment"> * @param size          Pointer to the object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">opal_obj_run_constructors</span><span class="params">(<span class="type">opal_object_t</span> *object)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">opal_construct_t</span> *cls_construct;</span><br><span class="line"></span><br><span class="line">    assert(<span class="literal">NULL</span> != object-&gt;obj_class);</span><br><span class="line"></span><br><span class="line">    cls_construct = object-&gt;obj_class-&gt;cls_construct_array;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">NULL</span> != *cls_construct) &#123;</span><br><span class="line">        (*cls_construct)(object);</span><br><span class="line">        cls_construct++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="frag"><a href="#frag" class="headerlink" title="frag"></a>frag</h2><p>frag.cè¿™ä¸ªæ–‡ä»¶æ˜¯ä¸ºäº†æŠ½è±¡å‡ºselfè¿™ä¸ªç»„ä»¶çš„ä¼ è¾“ç›¸å…³å†…å®¹ã€‚</p><p>æ ¹æ®selfçš„æºç æ¥çœ‹ï¼Œmca_btl_base_descriptor_tæ˜¯btlè¿›è¡Œä¼ è¾“çš„åŸºç¡€æè¿°ç¬¦ã€‚</p><p>fragç›¸å½“äºåœ¨è¿™ä¸ªåŸºç¡€æè¿°ç¬¦ä¸Šå¢åŠ äº†ä¸€äº›ä¸œè¥¿ã€‚</p><p>fragå®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * shared memory send fragment derived type.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_self_frag_t</span> &#123;</span></span><br><span class="line">    <span class="type">mca_btl_base_descriptor_t</span> base;</span><br><span class="line">    <span class="type">mca_btl_base_segment_t</span> segments[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_base_endpoint_t</span> *<span class="title">endpoint</span>;</span></span><br><span class="line">    <span class="type">opal_free_list_t</span> *<span class="built_in">list</span>;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> data[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_self_frag_t</span> <span class="title">mca_btl_self_frag_t</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_self_frag_t</span> <span class="title">mca_btl_self_frag_eager_t</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_self_frag_t</span> <span class="title">mca_btl_self_frag_send_t</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_self_frag_t</span> <span class="title">mca_btl_self_frag_rdma_t</span>;</span></span><br></pre></td></tr></table></figure><p>ç”±äºopenmpié‡‡ç”¨äº†é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œæ‰€ä»¥baseè¿™é‡Œå¯ä»¥çœ‹ä½œæ˜¯fragçš„çˆ¶å¯¹è±¡ã€‚</p><p><strong>segment</strong></p><p>è¿™é‡Œé¢æœ‰ä¸€ä¸ªsegmentéœ€è¦é¢å¤–æ³¨æ„ï¼Œå¦å¤–ä¸€ä¸ªendpointåœ¨selfè¿™ä¸ªç»„ä»¶ä¸­æ²¡æœ‰ç”¨åˆ°ã€‚</p><p>segmentå®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Describes a region/segment of memory that is addressable</span></span><br><span class="line"><span class="comment"> * by an BTL.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note: In many cases the alloc and prepare methods of BTLs</span></span><br><span class="line"><span class="comment"> * do not return a mca_btl_base_segment_t but instead return a</span></span><br><span class="line"><span class="comment"> * subclass. Extreme care should be used when modifying</span></span><br><span class="line"><span class="comment"> * BTL segments to prevent overwriting internal BTL data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * All BTLs MUST use base segments when calling registered</span></span><br><span class="line"><span class="comment"> * Callbacks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * BTL MUST use mca_btl_base_segment_t or a subclass and</span></span><br><span class="line"><span class="comment"> * MUST store their segment length in btl_seg_size. BTLs</span></span><br><span class="line"><span class="comment"> * MUST specify a segment no larger than MCA_BTL_SEG_MAX_SIZE.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_base_segment_t</span> &#123;</span></span><br><span class="line">    <span class="comment">/** Address of the memory */</span></span><br><span class="line">    <span class="type">opal_ptr_t</span> seg_addr;</span><br><span class="line">    <span class="comment">/** Length in bytes */</span></span><br><span class="line">    <span class="type">uint64_t</span> seg_len;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_base_segment_t</span> <span class="title">mca_btl_base_segment_t</span>;</span></span><br></pre></td></tr></table></figure><p>æ¯ä¸ª segment åŒ…å«ä¸¤ä¸ªå…³é”®å­—æ®µï¼š</p><ul><li>seg_addrï¼šæŒ‡å‘æ•°æ®çš„å†…å­˜åœ°å€</li><li>seg_lenï¼šæ•°æ®æ®µçš„é•¿åº¦</li></ul><p>fragè¿™é‡Œåˆç”¨åˆ°äº†æˆ‘ä»¬åœ¨componentä¸­æåˆ°çš„ç±»æ€æƒ³,åœ¨btl_self_frag.cä¸­å®ç°äº†ç±»çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">mca_btl_self_frag_constructor</span><span class="params">(<span class="type">mca_btl_self_frag_t</span> *frag)</span></span><br><span class="line">&#123;</span><br><span class="line">    frag-&gt;base.des_flags = <span class="number">0</span>;</span><br><span class="line">    frag-&gt;segments[<span class="number">0</span>].seg_addr.pval = (<span class="type">void</span> *) frag-&gt;data;</span><br><span class="line">    frag-&gt;segments[<span class="number">0</span>].seg_len = (<span class="type">uint32_t</span>) frag-&gt;size;</span><br><span class="line">    frag-&gt;base.des_segments = frag-&gt;segments;</span><br><span class="line">    frag-&gt;base.des_segment_count = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">mca_btl_self_frag_eager_constructor</span><span class="params">(<span class="type">mca_btl_self_frag_t</span> *frag)</span></span><br><span class="line">&#123;</span><br><span class="line">    frag-&gt;<span class="built_in">list</span> = &amp;mca_btl_self_component.self_frags_eager;</span><br><span class="line">    frag-&gt;size = mca_btl_self.btl_eager_limit;</span><br><span class="line">    mca_btl_self_frag_constructor(frag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">mca_btl_self_frag_send_constructor</span><span class="params">(<span class="type">mca_btl_self_frag_t</span> *frag)</span></span><br><span class="line">&#123;</span><br><span class="line">    frag-&gt;<span class="built_in">list</span> = &amp;mca_btl_self_component.self_frags_send;</span><br><span class="line">    frag-&gt;size = mca_btl_self.btl_max_send_size;</span><br><span class="line">    mca_btl_self_frag_constructor(frag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">mca_btl_self_frag_rdma_constructor</span><span class="params">(<span class="type">mca_btl_self_frag_t</span> *frag)</span></span><br><span class="line">&#123;</span><br><span class="line">    frag-&gt;<span class="built_in">list</span> = &amp;mca_btl_self_component.self_frags_rdma;</span><br><span class="line">    frag-&gt;size = MCA_BTL_SELF_MAX_INLINE_SIZE;</span><br><span class="line">    mca_btl_self_frag_constructor(frag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OBJ_CLASS_INSTANCE(<span class="type">mca_btl_self_frag_eager_t</span>, <span class="type">mca_btl_base_descriptor_t</span>,</span><br><span class="line">                   mca_btl_self_frag_eager_constructor, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">OBJ_CLASS_INSTANCE(<span class="type">mca_btl_self_frag_send_t</span>, <span class="type">mca_btl_base_descriptor_t</span>,</span><br><span class="line">                   mca_btl_self_frag_send_constructor, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">OBJ_CLASS_INSTANCE(<span class="type">mca_btl_self_frag_rdma_t</span>, <span class="type">mca_btl_base_descriptor_t</span>,</span><br><span class="line">                   mca_btl_self_frag_rdma_constructor, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>OBJ_CLASS_INSTANCEå®æ˜¯å®šä¹‰ç±»çš„å®ä¾‹ï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Static initializer for a class descriptor</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param NAME          Name of class</span></span><br><span class="line"><span class="comment"> * @param PARENT        Name of parent class</span></span><br><span class="line"><span class="comment"> * @param CONSTRUCTOR   Pointer to constructor</span></span><br><span class="line"><span class="comment"> * @param DESTRUCTOR    Pointer to destructor</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Put this in NAME.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_CLASS_INSTANCE(NAME, PARENT, CONSTRUCTOR, DESTRUCTOR) \</span></span><br><span class="line"><span class="meta">    opal_class_t NAME##_class = &#123;#NAME,                           \</span></span><br><span class="line"><span class="meta">                                 OBJ_CLASS(PARENT),               \</span></span><br><span class="line"><span class="meta">                                 (opal_construct_t) CONSTRUCTOR,  \</span></span><br><span class="line"><span class="meta">                                 (opal_destruct_t) DESTRUCTOR,    \</span></span><br><span class="line"><span class="meta">                                 0,                               \</span></span><br><span class="line"><span class="meta">                                 0,                               \</span></span><br><span class="line"><span class="meta">                                 NULL,                            \</span></span><br><span class="line"><span class="meta">                                 NULL,                            \</span></span><br><span class="line"><span class="meta">                                 sizeof(NAME)&#125;</span></span><br></pre></td></tr></table></figure><p>æ‹¿frag_eagerä¸¾ä¾‹ï¼Œfrag_eagerçš„å®šä¹‰åœ¨.hæ–‡ä»¶ä¸­ä¸º:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * shared memory send fragment derived type.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_self_frag_t</span> &#123;</span></span><br><span class="line">    <span class="type">mca_btl_base_descriptor_t</span> base;</span><br><span class="line">    <span class="type">mca_btl_base_segment_t</span> segments[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_base_endpoint_t</span> *<span class="title">endpoint</span>;</span></span><br><span class="line">    <span class="type">opal_free_list_t</span> *<span class="built_in">list</span>;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> data[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_self_frag_t</span> <span class="title">mca_btl_self_frag_t</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">mca_btl_self_frag_t</span> <span class="title">mca_btl_self_frag_eager_t</span>;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°frag_eagerå°±æ˜¯fragçš„aliasè€Œå·²ï¼Œæœ€ç»ˆä¼šè¢«OBJ_CLASS_INSTANCEå®šä¹‰ä¸ºmca_btl_self_frag_rdma_t_classçš„ä¸€ä¸ªç»“æ„ä½“ï¼Œçˆ¶å¯¹è±¡æ˜¯baseä¹Ÿå°±æ˜¯mca_btl_base_descriptor_t.</p><p>è¿™å¾ˆåˆç†ï¼Œå› ä¸ºfragç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜å°±æ˜¯base, åœ¨openmpiä¸­ä¼°è®¡ä¼šé€šè¿‡å¼ºåˆ¶ç±»å‹è½¬æ¢æ¥æ‹¿åˆ°çˆ¶å¯¹è±¡ã€‚</p><p>è¿™é‡Œæ³¨æ„ï¼Œå¹¶æ²¡æœ‰ææ„å‡½æ•°ï¼Œè¿™æ˜¯å› ä¸ºå¹¶æ²¡æœ‰ä»€ä¹ˆåŠ¨æ€ç”³è¯·çš„èµ„æºå¥½é‡Šæ”¾çš„ã€‚</p><p>åœ¨frag.hæ–‡ä»¶ä¸­è¿›è¡Œäº†ç±»çš„å£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">OBJ_CLASS_DECLARATION(<span class="type">mca_btl_self_frag_eager_t</span>);</span><br><span class="line">OBJ_CLASS_DECLARATION(<span class="type">mca_btl_self_frag_send_t</span>);</span><br><span class="line">OBJ_CLASS_DECLARATION(<span class="type">mca_btl_self_frag_rdma_t</span>);</span><br></pre></td></tr></table></figure><p>OBJ_CLASS_DECLARATIONçš„å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Declaration for class descriptor</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param NAME          Name of class</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Put this in NAME.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_CLASS_DECLARATION(NAME) extern opal_class_t NAME##_class</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­æ‹¿frag_eagerä¸¾ä¾‹ï¼Œå…¶å®å°±æ˜¯extern mca_btl_self_frag_rdma_t_classè¿™ä¸ªç»“æ„ä½“å˜é‡ã€‚</p><p>ä»¥ä¾¿èƒ½å¤Ÿåœ¨å…¶ä»–æ–‡ä»¶ä¸­è®¿é—®ã€‚è¿™é‡Œopenmpiæ¡†æ¶ä¼šåšå¥½äº’æ–¥è®¿é—®çš„ã€‚</p><p>ä½†æ˜¯ç¿»éäº†selfçš„æºç æ ‘ï¼Œä¹Ÿæ²¡å‘ç°åœ¨componenté‡Œé¢æ˜¾ç¤ºè°ƒç”¨çš„OBJ_CONSTRUCTå®ï¼Œä¹Ÿå°±æ˜¯æ²¡åœ°æ–¹è¿›å…¥fragçš„æ„é€ å‡½æ•°ã€‚åˆ«æ€¥ï¼Œæ¥ä¸‹æ¥è¿›å…¥opal_free_listçš„â€œé­”æ³•â€ï¼ˆå…¶å®å°±æ˜¯éšè—åœ¨apié‡Œé¢äº†ï¼‰</p><h2 id="opal-free-list"><a href="#opal-free-list" class="headerlink" title="opal_free_list"></a>opal_free_list</h2><p>opal_free_list æ˜¯ Open MPI ä¸­çš„ä¸€ä¸ªé«˜æ•ˆå†…å­˜ç®¡ç†æœºåˆ¶ï¼Œç”¨äºé¢„åˆ†é…å’Œé‡ç”¨å›ºå®šå¤§å°çš„å†…å­˜å—ã€‚</p><p>å®ƒåŸºäº LIFO (Last-In-First-Out) åŸç†ï¼Œæä¾›å¿«é€Ÿçš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾æ“ä½œã€‚</p><p>åœ¨componentçš„initå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å®é™…åˆå§‹åŒ–äº†opal_free_list, æ˜¯é€šè¿‡opal_free_list_initå‡½æ•°å®ç°çš„ã€‚</p><p>opal_free_list_initå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize a free list.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param free_list                (IN)  Free list.</span></span><br><span class="line"><span class="comment"> * @param frag_size                (IN)  Size of each element - allocated by malloc.</span></span><br><span class="line"><span class="comment"> * @param frag_alignment           (IN)  Fragment alignment.</span></span><br><span class="line"><span class="comment"> * @param frag_class               (IN)  opal_class_t of element - used to initialize allocated</span></span><br><span class="line"><span class="comment"> * elements.</span></span><br><span class="line"><span class="comment"> * @param payload_buffer_size      (IN)  Size of payload buffer - allocated from mpool.</span></span><br><span class="line"><span class="comment"> * @param payload_buffer_alignment (IN)  Payload buffer alignment.</span></span><br><span class="line"><span class="comment"> * @param num_elements_to_alloc    (IN)  Initial number of elements to allocate.</span></span><br><span class="line"><span class="comment"> * @param max_elements_to_alloc    (IN)  Maximum number of elements to allocate.</span></span><br><span class="line"><span class="comment"> * @param num_elements_per_alloc   (IN)  Number of elements to grow by per allocation.</span></span><br><span class="line"><span class="comment"> * @param mpool                    (IN)  Optional memory pool for allocations.</span></span><br><span class="line"><span class="comment"> * @param rcache_reg_flags         (IN)  Flags to pass to rcache registration function.</span></span><br><span class="line"><span class="comment"> * @param rcache                   (IN)  Optional registration cache.</span></span><br><span class="line"><span class="comment"> * @param item_init                (IN)  Optional item initialization function</span></span><br><span class="line"><span class="comment"> * @param ctx                      (IN)  Initialization function context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">OPAL_DECLSPEC <span class="type">int</span> <span class="title function_">opal_free_list_init</span><span class="params">(<span class="type">opal_free_list_t</span> *free_list, <span class="type">size_t</span> frag_size,</span></span><br><span class="line"><span class="params">                                      <span class="type">size_t</span> frag_alignment, <span class="type">opal_class_t</span> *frag_class,</span></span><br><span class="line"><span class="params">                                      <span class="type">size_t</span> payload_buffer_size, <span class="type">size_t</span> payload_buffer_alignment,</span></span><br><span class="line"><span class="params">                                      <span class="type">int</span> num_elements_to_alloc, <span class="type">int</span> max_elements_to_alloc,</span></span><br><span class="line"><span class="params">                                      <span class="type">int</span> num_elements_per_alloc,</span></span><br><span class="line"><span class="params">                                      <span class="keyword">struct</span> <span class="type">mca_mpool_base_module_t</span> *mpool, <span class="type">int</span> rcache_reg_flags,</span></span><br><span class="line"><span class="params">                                      <span class="keyword">struct</span> <span class="type">mca_rcache_base_module_t</span> *rcache,</span></span><br><span class="line"><span class="params">                                      <span class="type">opal_free_list_item_init_fn_t</span> item_init, <span class="type">void</span> *ctx)</span>;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‡½æ•°å‚æ•°æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬é€ä¸ªåˆ†æï¼š</p><ul><li>æ ¸å¿ƒå‚æ•°<ul><li>frag_sizeï¼šæ¯ä¸ªå…ƒç´ çš„å¤§å°ï¼Œé€šè¿‡ malloc åˆ†é…</li><li>frag_alignmentï¼šFragment çš„å†…å­˜å¯¹é½è¦æ±‚</li><li>frag_classï¼šç”¨äºåˆå§‹åŒ–åˆ†é…å…ƒç´ çš„ opal_class_t ç±»å‹</li><li>payload_buffer_sizeï¼šè´Ÿè½½ç¼“å†²åŒºå¤§å°ï¼Œä» mpool åˆ†é…</li><li>payload_buffer_alignmentï¼šè´Ÿè½½ç¼“å†²åŒºçš„å¯¹é½è¦æ±‚</li></ul></li><li>åˆ†é…æ§åˆ¶å‚æ•°<ul><li>num_elements_to_allocï¼šåˆå§‹åˆ†é…çš„å…ƒç´ æ•°é‡</li><li>max_elements_to_allocï¼šæœ€å¤§å¯åˆ†é…çš„å…ƒç´ æ•°é‡</li><li>num_elements_per_allocï¼šæ¯æ¬¡å¢é•¿æ—¶åˆ†é…çš„å…ƒç´ æ•°é‡</li></ul></li><li>é«˜çº§å‚æ•°<ul><li>mpoolï¼šå¯é€‰çš„å†…å­˜æ± ï¼Œç”¨äºåˆ†é…</li><li>rcache_reg_flagsï¼šä¼ é€’ç»™ rcache æ³¨å†Œå‡½æ•°çš„æ ‡å¿—</li><li>rcacheï¼šå¯é€‰çš„æ³¨å†Œç¼“å­˜</li><li>item_initï¼šå¯é€‰çš„å…ƒç´ åˆå§‹åŒ–å‡½æ•°</li><li>ctxï¼šåˆå§‹åŒ–å‡½æ•°çš„ä¸Šä¸‹æ–‡</li></ul></li></ul><p>å›åˆ°componentçš„è°ƒç”¨ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ret = opal_free_list_init(&amp;mca_btl_self_component.self_frags_eager,</span><br><span class="line">                          <span class="keyword">sizeof</span>(<span class="type">mca_btl_self_frag_eager_t</span>) + mca_btl_self.btl_eager_limit,</span><br><span class="line">                          opal_cache_line_size, OBJ_CLASS(<span class="type">mca_btl_self_frag_eager_t</span>), <span class="number">0</span>,</span><br><span class="line">                          opal_cache_line_size, mca_btl_self_component.free_list_num,</span><br><span class="line">                          mca_btl_self_component.free_list_max,</span><br><span class="line">                          mca_btl_self_component.free_list_inc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°frag_sizeä¸ºfrag_eagerçš„å¤§å° + eager_limitçš„å¤§å°ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>åœ¨fragçš„å®šä¹‰ä¸­æœ€åä¸€ä¸ªæˆå‘˜æ˜¯<code>unsigned char data[];</code>, æ‰€ä»¥è¿™eager_limitæ˜¯ä¸ºè¿™ä¸ªdataç”³è¯·çš„å†…å­˜ã€‚</p><p>å¦ä¸€ä¸ªéœ€è¦å…³å¿ƒçš„å†…å®¹æ˜¯frag_classå‚æ•°ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨äº†<code>OBJ_CLASS(mca_btl_self_frag_eager_t)</code>,è¿™ä¸ªå®åœ¨ä¸Šé¢å·²ç»è¯´è¿‡äº†ã€‚</p><h3 id="opal-free-listå®ç°æºå¸¦ç±»çš„ææ„"><a href="#opal-free-listå®ç°æºå¸¦ç±»çš„ææ„" class="headerlink" title="opal_free_listå®ç°æºå¸¦ç±»çš„ææ„"></a>opal_free_listå®ç°æºå¸¦ç±»çš„ææ„</h3><p>opal_free_liståªæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œéœ€è¦å®ç°çœŸæ­£æ•°æ®äº¤äº’è¿˜éœ€è¦æºå¸¦ä¸€ä¸ªç±»ã€‚</p><p>æºå¸¦ç±»æŒ‡çš„å°±æ˜¯è¿™ä¸ªæ„æ€ã€‚</p><p>åœ¨opal_free_list_initå‡½æ•°ä¸­ä¼šè°ƒç”¨ opal_free_list_grow_stå‡½æ•°</p><h4 id="opal-free-list-init"><a href="#opal-free-list-init" class="headerlink" title="opal_free_list_init"></a>opal_free_list_init</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">opal_free_list_init</span><span class="params">(<span class="type">opal_free_list_t</span> *flist, <span class="type">size_t</span> frag_size, <span class="type">size_t</span> frag_alignment,</span></span><br><span class="line"><span class="params">                        <span class="type">opal_class_t</span> *frag_class, <span class="type">size_t</span> payload_buffer_size,</span></span><br><span class="line"><span class="params">                        <span class="type">size_t</span> payload_buffer_alignment, <span class="type">int</span> num_elements_to_alloc,</span></span><br><span class="line"><span class="params">                        <span class="type">int</span> max_elements_to_alloc, <span class="type">int</span> num_elements_per_alloc,</span></span><br><span class="line"><span class="params">                        <span class="type">mca_mpool_base_module_t</span> *mpool, <span class="type">int</span> rcache_reg_flags,</span></span><br><span class="line"><span class="params">                        <span class="type">mca_rcache_base_module_t</span> *rcache, <span class="type">opal_free_list_item_init_fn_t</span> item_init,</span></span><br><span class="line"><span class="params">                        <span class="type">void</span> *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (frag_class) &#123;</span><br><span class="line">        flist-&gt;fl_frag_class = frag_class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num_elements_to_alloc) &#123;</span><br><span class="line">        <span class="keyword">return</span> opal_free_list_grow_st(flist, num_elements_to_alloc, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OPAL_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…¶ä¸­è°ƒç”¨<code> opal_free_list_grow_st</code>æ‰æ˜¯çœŸæ­£èƒ½å¤Ÿå®ç°æºå¸¦ç±»æ„é€ å‡½æ•°çš„å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">opal_free_list_grow_st</span><span class="params">(<span class="type">opal_free_list_t</span> *flist, <span class="type">size_t</span> num_elements,</span></span><br><span class="line"><span class="params">                           <span class="type">opal_free_list_item_t</span> **item_out)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; num_elements; ++i) &#123;</span><br><span class="line">        <span class="type">opal_free_list_item_t</span> *item = (<span class="type">opal_free_list_item_t</span> *) ptr;</span><br><span class="line">        item-&gt;registration = reg;</span><br><span class="line">        item-&gt;ptr = payload_ptr;</span><br><span class="line"></span><br><span class="line">        OBJ_CONSTRUCT_INTERNAL(item, flist-&gt;fl_frag_class);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¾ˆæ¸…æ™°äº†ï¼Œåœ¨opal_free_list_grow_stå‡½æ•°ä¸­è°ƒç”¨<code>OBJ_CONSTRUCT_INTERNAL</code>å®æ¥è¿›è¡Œæºå¸¦ç±»çš„æ„é€ ã€‚</p><p>æ‰€ä»¥æºå¸¦ç±»æ„é€ å‡½æ•°åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µè¢«æ‰§è¡Œ:</p><ul><li>åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼šå½“ opal_free_list_init è¢«è°ƒç”¨ä¸” num_elements_to_alloc &gt; 0 æ—¶ï¼Œä¼šç«‹å³è°ƒç”¨ opal_free_list_grow_st æ¥é¢„åˆ†é…å…ƒç´ ï¼š</li><li>åŠ¨æ€å¢é•¿æ—¶è°ƒç”¨ï¼šå½“ free list ä¸ºç©ºéœ€è¦å¢é•¿æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨æ„é€ å‡½æ•°åˆå§‹åŒ–æ–°åˆ†é…çš„å…ƒç´ ã€‚</li></ul><h4 id="opal-free-list-get"><a href="#opal-free-list-get" class="headerlink" title="opal_free_list_get"></a>opal_free_list_get</h4><p>opal_free_list_getå‡½æ•°å¯ä»¥ä»listä¸­æ‹¿åˆ°ä¸€ä¸ªæºå¸¦ç±»èµ„æºã€‚</p><h4 id="opal-free-list-return"><a href="#opal-free-list-return" class="headerlink" title="opal_free_list_return"></a>opal_free_list_return</h4><p>opal_free_list_returnå‡½æ•°å¯ä»¥é‡Šæ”¾ä¸€ä¸ªlistä¸­çš„æºå¸¦ç±»ã€‚</p><h2 id="module-ops"><a href="#module-ops" class="headerlink" title="module ops"></a>module ops</h2><p>æ¥ä¸‹æ¥å°±æ˜¯å®ç°å¯¹äºbtl frameworkéœ€è¦å®ç°çš„opsäº†ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* btl self module */</span></span><br><span class="line"><span class="type">mca_btl_base_module_t</span> mca_btl_self = &#123;.btl_component = &amp;mca_btl_self_component.super,</span><br><span class="line">                                      .btl_add_procs = mca_btl_self_add_procs,</span><br><span class="line">                                      .btl_del_procs = mca_btl_self_del_procs,</span><br><span class="line">                                      .btl_finalize = mca_btl_self_finalize,</span><br><span class="line">                                      .btl_alloc = mca_btl_self_alloc,</span><br><span class="line">                                      .btl_free = mca_btl_self_free,</span><br><span class="line">                                      .btl_prepare_src = mca_btl_self_prepare_src,</span><br><span class="line">                                      .btl_send = mca_btl_self_send,</span><br><span class="line">                                      .btl_sendi = mca_btl_self_sendi,</span><br><span class="line">                                      .btl_put = mca_btl_self_put,</span><br><span class="line">                                      .btl_get = mca_btl_self_get,</span><br><span class="line">                                      .btl_dump = mca_btl_base_dump&#125;;</span><br></pre></td></tr></table></figure><h3 id="btl-add-procs-è¿›ç¨‹æ·»åŠ "><a href="#btl-add-procs-è¿›ç¨‹æ·»åŠ " class="headerlink" title="btl_add_procs - è¿›ç¨‹æ·»åŠ "></a>btl_add_procs - è¿›ç¨‹æ·»åŠ </h3><p>BTL Self åªå¯¹è‡ªèº«è¿›ç¨‹è®¾ç½®å¯è¾¾æ€§ï¼Œé€šè¿‡æ¯”è¾ƒè¿›ç¨‹åç§°æ¥åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€è¿›ç¨‹ã€‚</p><p>add_procsè´Ÿè´£ï¼š</p><ul><li>è¿›ç¨‹å¯è¾¾æ€§æ£€æµ‹ï¼šç¡®å®šå“ªäº›è¿›ç¨‹å¯ä»¥é€šè¿‡å½“å‰ BTL æ¨¡å—åˆ°è¾¾</li><li>endpoint åˆ›å»ºï¼šä¸ºå¯è¾¾çš„è¿›ç¨‹åˆ›å»ºé€šä¿¡ç«¯ç‚¹</li><li>ä½å›¾è®¾ç½®ï¼šåœ¨ reachable ä½å›¾ä¸­æ ‡è®°å¯è¾¾çš„è¿›ç¨‹</li><li>è¿æ¥å»ºç«‹ï¼šå»ºç«‹ä¸è¿œç¨‹è¿›ç¨‹çš„å®é™…è¿æ¥ï¼ˆå¦‚ TCP è¿æ¥ï¼‰</li></ul><p>selfçš„add_procså®ç°éå¸¸ç®€å•, å› ä¸ºåªéœ€è¦å¤„ç†æœ¬è¿›ç¨‹å†…ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PML-&gt;BTL notification of change in the process list.</span></span><br><span class="line"><span class="comment"> * PML-&gt;BTL Notification that a receive fragment has been matched.</span></span><br><span class="line"><span class="comment"> * Called for message that is send from process with the virtual</span></span><br><span class="line"><span class="comment"> * address of the shared memory segment being different than that of</span></span><br><span class="line"><span class="comment"> * the receiver.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param btl (IN)</span></span><br><span class="line"><span class="comment"> * @param proc (IN)</span></span><br><span class="line"><span class="comment"> * @param peer (OUT)</span></span><br><span class="line"><span class="comment"> * @return     OPAL_SUCCESS or error status on failure.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_add_procs</span><span class="params">(<span class="keyword">struct</span> <span class="type">mca_btl_base_module_t</span> *btl, <span class="type">size_t</span> nprocs,</span></span><br><span class="line"><span class="params">                                  <span class="keyword">struct</span> <span class="type">opal_proc_t</span> **procs,</span></span><br><span class="line"><span class="params">                                  <span class="keyword">struct</span> <span class="type">mca_btl_base_endpoint_t</span> **peers,</span></span><br><span class="line"><span class="params">                                  <span class="type">opal_bitmap_t</span> *reachability)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>) nprocs; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == opal_compare_proc(procs[i]-&gt;proc_name, OPAL_PROC_MY_NAME)) &#123;</span><br><span class="line">            opal_bitmap_set_bit(reachability, i);</span><br><span class="line">            <span class="comment">/* need to return something to keep the bml from ignoring us */</span></span><br><span class="line">            peers[i] = (<span class="keyword">struct</span> <span class="type">mca_btl_base_endpoint_t</span> *) <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">/* there will always be only one ... */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OPAL_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®é€»è¾‘ï¼š</p><ul><li>éå†æ‰€æœ‰ä¼ å…¥çš„è¿›ç¨‹</li><li>é€šè¿‡ opal_compare_proc æ¯”è¾ƒè¿›ç¨‹åç§°ä¸å½“å‰è¿›ç¨‹</li><li>å¦‚æœæ˜¯åŒä¸€è¿›ç¨‹ï¼Œè®¾ç½®ä½å›¾å¹¶åˆ›å»ºè™šæ‹Ÿ endpoint</li><li>åªä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹åŒ¹é…ï¼ˆè‡ªå·±ï¼‰</li></ul><h4 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h4><p>ä½å›¾çš„ä½œç”¨: reachable ä½å›¾æ˜¯ä¸€ä¸ªå…³é”®çš„æ•°æ®ç»“æ„ï¼Œç”¨äºï¼š</p><ul><li>æ ‡è®°å¯è¾¾æ€§ï¼šæ¯ä¸ªä½å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ï¼Œè®¾ç½®ä¸º 1 è¡¨ç¤ºè¯¥è¿›ç¨‹å¯é€šè¿‡æ­¤ BTL åˆ°è¾¾</li><li>BTL é€‰æ‹©ï¼šä¸Šå±‚ï¼ˆBMLï¼‰æ ¹æ®ä½å›¾å†³å®šä½¿ç”¨å“ªäº› BTL ä¸ç‰¹å®šè¿›ç¨‹é€šä¿¡</li><li>è´Ÿè½½å‡è¡¡ï¼šå½“å¤šä¸ª BTL éƒ½èƒ½åˆ°è¾¾åŒä¸€è¿›ç¨‹æ—¶ï¼Œå¯ä»¥è¿›è¡Œé€‰æ‹©</li></ul><h3 id="btl-del-procs-è¿›ç¨‹åˆ é™¤"><a href="#btl-del-procs-è¿›ç¨‹åˆ é™¤" class="headerlink" title="btl_del_procs - è¿›ç¨‹åˆ é™¤"></a>btl_del_procs - è¿›ç¨‹åˆ é™¤</h3><p>ç”¨äºæ¸…ç†è¿›ç¨‹ç›¸å…³èµ„æº, selfçš„å®ç°å¾ˆç®€å•ï¼Œç›´æ¥è¿”å›æˆåŠŸï¼Œå› ä¸ºæ²¡æœ‰éœ€è¦æ¸…ç†çš„èµ„æºã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PML-&gt;BTL notification of change in the process list.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param btl (IN)     BTL instance</span></span><br><span class="line"><span class="comment"> * @param proc (IN)    Peer process</span></span><br><span class="line"><span class="comment"> * @param peer (IN)    Peer addressing information.</span></span><br><span class="line"><span class="comment"> * @return             Status indicating if cleanup was successful</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_del_procs</span><span class="params">(<span class="keyword">struct</span> <span class="type">mca_btl_base_module_t</span> *btl, <span class="type">size_t</span> nprocs,</span></span><br><span class="line"><span class="params">                                  <span class="keyword">struct</span> <span class="type">opal_proc_t</span> **procs,</span></span><br><span class="line"><span class="params">                                  <span class="keyword">struct</span> <span class="type">mca_btl_base_endpoint_t</span> **peers)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> OPAL_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="btl-alloc-å†…å­˜åˆ†é…"><a href="#btl-alloc-å†…å­˜åˆ†é…" class="headerlink" title="btl_alloc - å†…å­˜åˆ†é…"></a>btl_alloc - å†…å­˜åˆ†é…</h3><p>selfå®ç°å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate a segment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param btl (IN)      BTL module</span></span><br><span class="line"><span class="comment"> * @param size (IN)     Request segment size.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">mca_btl_base_descriptor_t</span> *<span class="title function_">mca_btl_self_alloc</span><span class="params">(<span class="keyword">struct</span> <span class="type">mca_btl_base_module_t</span> *btl,</span></span><br><span class="line"><span class="params">                                                     <span class="keyword">struct</span> <span class="type">mca_btl_base_endpoint_t</span> *endpoint,</span></span><br><span class="line"><span class="params">                                                     <span class="type">uint8_t</span> order, <span class="type">size_t</span> size, <span class="type">uint32_t</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">mca_btl_self_frag_t</span> *frag = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt;= MCA_BTL_SELF_MAX_INLINE_SIZE) &#123;</span><br><span class="line">        MCA_BTL_SELF_FRAG_ALLOC_RDMA(frag);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size &lt;= mca_btl_self.btl_eager_limit) &#123;</span><br><span class="line">        MCA_BTL_SELF_FRAG_ALLOC_EAGER(frag);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size &lt;= btl-&gt;btl_max_send_size) &#123;</span><br><span class="line">        MCA_BTL_SELF_FRAG_ALLOC_SEND(frag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (OPAL_UNLIKELY(<span class="literal">NULL</span> == frag)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    frag-&gt;segments[<span class="number">0</span>].seg_len = size;</span><br><span class="line">    frag-&gt;base.des_segment_count = <span class="number">1</span>;</span><br><span class="line">    frag-&gt;base.des_flags = flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;frag-&gt;base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ ¹æ®å†…å­˜å¤§å°è¿›è¡Œä¸åŒçš„é€‰æ‹©ï¼š</p><ul><li>&lt;&#x3D; MCA_BTL_SELF_MAX_INLINE_SIZE -&gt; rdma_frag</li><li>&lt;&#x3D; mca_btl_self.btl_eager_limit -&gt; eager_frag</li><li>&lt;&#x3D; btl_max_send_size -&gt; send_frag</li></ul><h3 id="btl-prepare-src-å‘é€å‡†å¤‡"><a href="#btl-prepare-src-å‘é€å‡†å¤‡" class="headerlink" title="btl_prepare_src - å‘é€å‡†å¤‡"></a>btl_prepare_src - å‘é€å‡†å¤‡</h3><p>prepare_src å¯ä»¥æ ¹æ®æ•°æ®ç‰¹æ€§é€‰æ‹©æœ€ä¼˜çš„å¤„ç†æ–¹å¼ã€‚æ¯”å¦‚å¯¹äºè¿ç»­æ•°æ®å¯ä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´ã€‚</p><p>è¿™ç‚¹æˆ‘ä»¬ä¼šåœ¨ä¸‹é¢çš„ä»£ç çœ‹åˆ°ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prepare data for send</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param btl (IN)      BTL module</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="type">mca_btl_base_descriptor_t</span> *<span class="title function_">mca_btl_self_prepare_src</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> <span class="type">mca_btl_base_module_t</span> *btl, <span class="keyword">struct</span> <span class="type">mca_btl_base_endpoint_t</span> *endpoint,</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> <span class="type">opal_convertor_t</span> *convertor, <span class="type">uint8_t</span> order, <span class="type">size_t</span> reserve, <span class="type">size_t</span> *size, <span class="type">uint32_t</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span> inline_send = !(opal_convertor_need_buffers(convertor) || opal_convertor_on_device(convertor));</span><br><span class="line">    <span class="type">size_t</span> buffer_len = reserve + (inline_send ? <span class="number">0</span> : *size);</span><br><span class="line">    <span class="type">mca_btl_self_frag_t</span> *frag;</span><br><span class="line"></span><br><span class="line">    frag = (<span class="type">mca_btl_self_frag_t</span> *) mca_btl_self_alloc(btl, endpoint, order, buffer_len, flags);</span><br><span class="line">    <span class="keyword">if</span> (OPAL_UNLIKELY(<span class="literal">NULL</span> == frag)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå…ˆè·å–æ˜¯å¦éœ€è¦å†…è”å‘é€ï¼Œå†…è”å‘é€çš„æ¡ä»¶æ˜¯:</p><ul><li>opal_convertor_need_buffers &#x3D; 0, ä¹Ÿå°±æ˜¯è¯´æ•°æ®æ˜¯è¿ç»­çš„ï¼Œä¸éœ€è¦é¢å¤–ç¼“å†²åŒºè¿›è¡Œæ‰“åŒ…</li><li>opal_convertor_on_device &#x3D; 0, æ•°æ®æ²¡æœ‰åœ¨è®¾å¤‡ä¸Šï¼Œæ¯”å¦‚GPU</li></ul><p>è¿™é‡Œåˆå¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ•°æ®ç»“æ„convertor, å®ƒå…¶å®å°±æ˜¯æ•°æ®bufferçš„ä¸€ä¸ªå°è£…ï¼Œä¸»è¦ä½œç”¨ï¼š</p><ul><li>å¤„ç†éè¿ç»­æ•°æ®ç±»å‹ï¼šå°†å¤æ‚çš„ MPI æ•°æ®ç±»å‹ï¼ˆå¦‚ç»“æ„ä½“ã€å‘é‡ç­‰ï¼‰è½¬æ¢ä¸ºå¯ä¼ è¾“çš„è¿ç»­å­—èŠ‚æµ</li><li>æ•°æ®æ‰“åŒ…&#x2F;è§£åŒ…ï¼šé€šè¿‡ opal_convertor_pack å’Œ opal_convertor_unpack å‡½æ•°è¿›è¡Œæ•°æ®è½¬æ¢</li><li>è·¨æ¶æ„æ”¯æŒï¼šå¤„ç†ä¸åŒæ¶æ„é—´çš„æ•°æ®æ ¼å¼è½¬æ¢</li></ul><p>åœ¨buffer_lenä¸­æ¯”è¾ƒè¿·æƒ‘çš„ä¸€ç‚¹å°±æ˜¯reserve, é¢„ç•™å†…å­˜å¤§å°ã€‚æ˜¯ä¸Šå±‚åè®®ï¼ˆå¦‚ PMLï¼‰éœ€è¦åœ¨æ•°æ®å‰é¢é¢„ç•™çš„å¤´éƒ¨ç©ºé—´ï¼Œç”¨äºå­˜æ”¾åè®®å¤´ä¿¡æ¯</p><p>æ¥ä¸‹æ¥ç”³è¯·ä¸€ä¸ªfragï¼Œä¹‹åå°±ä¼šé‡åˆ°ä¸¤ä¸ªè·¯å¾„ã€‚</p><p>è¿™é‡Œéœ€è¦å…ˆæå‰è¯´ä¸€ä¸‹segmentsçš„è§„èŒƒï¼š</p><ul><li>å½“ä¸ºè¿ç»­æ•°æ®çš„æ—¶å€™ï¼Œ segments[0]ä¸ºPMLå±‚çš„å¤´éƒ¨æ•°æ®ä¿ç•™ï¼Œ segments[1]æŒ‡å‘å®é™…æ•°æ®çš„æŒ‡é’ˆï¼ˆé›¶æ‹·è´ï¼‰</li><li>å½“ä¸ºéè¿ç»­æ•°æ®çš„æ—¶å€™ï¼Œ segments[0]ä¸ºPMLå±‚çš„å¤´éƒ¨æ•°æ®+å®é™…æ•°æ®ï¼Œ segments[1] æ²¡æœ‰ä½œç”¨ã€‚</li></ul><h4 id="è¿ç»­æ•°æ®å†…è”å‡†å¤‡å‘é€"><a href="#è¿ç»­æ•°æ®å†…è”å‡†å¤‡å‘é€" class="headerlink" title="è¿ç»­æ•°æ®å†…è”å‡†å¤‡å‘é€"></a>è¿ç»­æ•°æ®å†…è”å‡†å¤‡å‘é€</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">void</span> *data_ptr;</span><br><span class="line"></span><br><span class="line">    opal_convertor_get_current_pointer(convertor, &amp;data_ptr);</span><br><span class="line"></span><br><span class="line">    frag-&gt;segments[<span class="number">1</span>].seg_addr.pval = data_ptr;</span><br><span class="line">    frag-&gt;segments[<span class="number">1</span>].seg_len = *size;</span><br><span class="line">    frag-&gt;base.des_segment_count = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;frag-&gt;base;</span><br></pre></td></tr></table></figure><p>å½“inline_send &#x3D; trueçš„æ—¶å€™ï¼Œå°±èµ°çš„elseä¹Ÿå°±æ˜¯å†…è”å‘é€åˆ†æ”¯ã€‚</p><p>ä»UNLIKELYè¿™ä¸ªå®å¯ä»¥çœ‹å‡ºï¼Œç»å¤§éƒ¨åˆ†æ—¶é—´åº”è¯¥èµ°çš„æ˜¯è¿™ä¸ªåˆ†æ”¯ã€‚</p><p>åœ¨å†…è”å‘é€ä¸­ï¼Œå°†convertorçš„å½“å‰æŒ‡é’ˆæ‹¿åˆ°data_prtå˜é‡ä¸­ï¼Œç„¶åèµ‹å€¼ç»™segments[1]ã€‚</p><p>æœ€åç›´æ¥è¿”å›äº†fragçš„çˆ¶å¯¹è±¡ä¹Ÿå°±æ˜¯baseæè¿°ç¬¦çš„æŒ‡é’ˆã€‚</p><p>è¿™æ ·æ¥æ”¶æ–¹å¯ä»¥ç›´æ¥ä»convertoræŒ‡å‘çš„æŒ‡é’ˆä¸­ç›´æ¥æ‹¿æ•°æ®ï¼Œ0æ‹·è´ã€‚</p><h4 id="éè¿ç»­æ•°æ®æˆ–éæœ¬åœ°æ•°æ®ï¼ˆåœ¨è®¾å¤‡ä¸Šï¼‰å‡†å¤‡å‘é€"><a href="#éè¿ç»­æ•°æ®æˆ–éæœ¬åœ°æ•°æ®ï¼ˆåœ¨è®¾å¤‡ä¸Šï¼‰å‡†å¤‡å‘é€" class="headerlink" title="éè¿ç»­æ•°æ®æˆ–éæœ¬åœ°æ•°æ®ï¼ˆåœ¨è®¾å¤‡ä¸Šï¼‰å‡†å¤‡å‘é€"></a>éè¿ç»­æ•°æ®æˆ–éæœ¬åœ°æ•°æ®ï¼ˆåœ¨è®¾å¤‡ä¸Šï¼‰å‡†å¤‡å‘é€</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* non-contiguous data */</span></span><br><span class="line"><span class="keyword">if</span> (OPAL_UNLIKELY(!inline_send)) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123;.iov_len = *size,</span><br><span class="line">                        .iov_base = (IOVBASE_TYPE *) ((<span class="type">uintptr_t</span>) frag-&gt;data + reserve)&#125;;</span><br><span class="line">    <span class="type">size_t</span> max_data = *size;</span><br><span class="line">    <span class="type">uint32_t</span> iov_count = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line"></span><br><span class="line">    rc = opal_convertor_pack(convertor, &amp;iov, &amp;iov_count, &amp;max_data);</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        mca_btl_self_free(btl, &amp;frag-&gt;base);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *size = max_data;</span><br><span class="line">    frag-&gt;segments[<span class="number">0</span>].seg_len = reserve + max_data;</span><br></pre></td></tr></table></figure><p>å½“inline_send &#x3D; falseçš„æ—¶å€™ï¼Œå°±èµ°çš„ifåˆ†æ”¯ã€‚</p><p>æ­¤æ—¶éœ€è¦åˆ›å»ºä¸€ä¸ªiovecçš„æ•°æ®ç»“æ„ï¼Œiovec æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ I&#x2F;O å‘é‡ç»“æ„ï¼ŒåŒ…å« iov_baseï¼ˆæŒ‡é’ˆï¼‰å’Œ iov_lenï¼ˆé•¿åº¦ï¼‰ä¸¤ä¸ªå­—æ®µã€‚åœ¨å¤„ç†éè¿ç»­æ•°æ®æ—¶ï¼Œå®ƒç”¨äºæŒ‡å®š opal_convertor_pack å‡½æ•°å°†æ•°æ®æ‰“åŒ…åˆ°å“ªä¸ªç¼“å†²åŒºä½ç½®ã€‚</p><p>è¿™é‡Œçš„iovecçš„èµ‹å€¼æ›´åŠ ç¡®å®šäº†æˆ‘ä»¬ä¹‹å‰è§£é‡Šçš„segments.</p><p>å¯ä»¥çœ‹åˆ°iovecçš„iov_baseçš„åœ°å€è·³è¿‡äº†reserve, å……åˆ†è¯´æ˜æ˜¯ç»™PMLå±‚çš„å¤´éƒ¨é¢„ç•™çš„ç©ºé—´ã€‚</p><p>ä¹‹åé€šè¿‡<code>opal_convertor_pack</code>å‡½æ•°å°†æ•°æ®æ‰“åŒ…åˆ°iovecæŒ‡å‘çš„åœ°å€ä¸­ã€‚</p><p>æœ€åæ›´æ–°segments[0].seg_lenã€‚</p><p>è¿™é‡Œå¯èƒ½æ¯”è¾ƒç–‘æƒ‘segçš„addræ€ä¹ˆæ²¡æœ‰åƒè¿ç»­æ•°æ®é‚£æ ·è®¾ç½®ï¼Œå› ä¸ºåœ¨fragçš„æ„é€ å‡½æ•°ä¸­å·²ç»æŒ‡å‘äº†frag-&gt;dataäº†ï¼Œè€Œä¸Šé¢iovecæ‹·è´çš„ç›®æ ‡åœ°å€æ­£æ˜¯frag-&gt;data.</p><h3 id="btl-send-æ¶ˆæ¯å‘é€"><a href="#btl-send-æ¶ˆæ¯å‘é€" class="headerlink" title="btl_send - æ¶ˆæ¯å‘é€"></a>btl_send - æ¶ˆæ¯å‘é€</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initiate a send to the peer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param btl (IN)      BTL module</span></span><br><span class="line"><span class="comment"> * @param peer (IN)     BTL peer addressing</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_send</span><span class="params">(<span class="keyword">struct</span> <span class="type">mca_btl_base_module_t</span> *btl,</span></span><br><span class="line"><span class="params">                             <span class="keyword">struct</span> <span class="type">mca_btl_base_endpoint_t</span> *endpoint,</span></span><br><span class="line"><span class="params">                             <span class="keyword">struct</span> <span class="type">mca_btl_base_descriptor_t</span> *des, <span class="type">mca_btl_base_tag_t</span> tag)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">mca_btl_active_message_callback_t</span> *reg = mca_btl_base_active_message_trigger + tag;</span><br><span class="line">    <span class="type">mca_btl_base_receive_descriptor_t</span> recv_desc = &#123;.endpoint = endpoint,</span><br><span class="line">                                                   .des_segments = des-&gt;des_segments,</span><br><span class="line">                                                   .des_segment_count = des-&gt;des_segment_count,</span><br><span class="line">                                                   .tag = tag,</span><br><span class="line">                                                   .cbdata = reg-&gt;cbdata&#125;;</span><br><span class="line">    <span class="type">int</span> btl_ownership = (des-&gt;des_flags &amp; MCA_BTL_DES_FLAGS_BTL_OWNERSHIP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* upcall */</span></span><br><span class="line">    reg-&gt;cbfunc(btl, &amp;recv_desc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* send completion */</span></span><br><span class="line">    <span class="keyword">if</span> (des-&gt;des_flags &amp; MCA_BTL_DES_SEND_ALWAYS_CALLBACK) &#123;</span><br><span class="line">        des-&gt;des_cbfunc(btl, endpoint, des, OPAL_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (btl_ownership) &#123;</span><br><span class="line">        mca_btl_self_free(btl, des);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨sendå‡½æ•°ä¸­ï¼Œç”±äºselfç»„ä»¶æ˜¯åŒçº¿ç¨‹å†…ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸éœ€è¦ä»»ä½•çš„ä¼ é€æœºåˆ¶ã€‚</p><p>ç›´æ¥è°ƒç”¨å›è°ƒå‡½æ•°æ¨¡æ‹Ÿæ¥æ”¶å°±å¯ä»¥äº†ã€‚</p><p>MCA_BTL_DES_SEND_ALWAYS_CALLBACKå®ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨desçš„å›è°ƒã€‚</p><p>btl_ownershipç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ç”±btlå±‚é‡Šæ”¾æè¿°ç¬¦ã€‚</p><h3 id="btl-sendi-ç«‹å³å‘é€"><a href="#btl-sendi-ç«‹å³å‘é€" class="headerlink" title="btl_sendi - ç«‹å³å‘é€"></a>btl_sendi - ç«‹å³å‘é€</h3><p>sendiå‡½æ•°æ˜¯æŒ‡çš„ç«‹å³å‘é€ï¼Œä¹Ÿå°±æ˜¯å°†prepare_srcå’Œsendå‡½æ•°åˆå¹¶åˆ°ä¸€æ­¥â€åŸå­æ€§â€çš„å®Œæˆã€‚</p><p>å…ˆçœ‹ä¸€ä¸‹å‡½æ•°çš„å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_sendi</span><span class="params">(<span class="keyword">struct</span> <span class="type">mca_btl_base_module_t</span> *btl,</span></span><br><span class="line"><span class="params">                              <span class="keyword">struct</span> <span class="type">mca_btl_base_endpoint_t</span> *endpoint,</span></span><br><span class="line"><span class="params">                              <span class="keyword">struct</span> <span class="type">opal_convertor_t</span> *convertor, <span class="type">void</span> *header, <span class="type">size_t</span> header_size,</span></span><br><span class="line"><span class="params">                              <span class="type">size_t</span> payload_size, <span class="type">uint8_t</span> order, <span class="type">uint32_t</span> flags,</span></span><br><span class="line"><span class="params">                              <span class="type">mca_btl_base_tag_t</span> tag, <span class="type">mca_btl_base_descriptor_t</span> **descriptor)</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„å‡ ä¸ªå‚æ•°ï¼š</p><ul><li>payload_size: è´Ÿè½½æ•°æ®å¤§å°</li><li>header_size: åè®®å¤´å¤§å°</li></ul><p>endpointä¸éœ€è¦æ³¨æ„ï¼Œåœ¨add_procsé‡Œé¢æˆ‘ä»¬è®¾ç½®æˆ-1äº†ä¹Ÿå°±æ˜¯æ²¡ç”¨åˆ°è¿™ä¸œè¥¿</p><p>åœ¨sendiçš„å¼€å¤´ï¼Œå…ˆæ˜¯è¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!payload_size ||</span><br><span class="line">    !(opal_convertor_need_buffers(convertor) ||</span><br><span class="line">      opal_convertor_on_device(convertor))) &#123;</span><br><span class="line">    <span class="type">void</span> *data_ptr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (payload_size) &#123;</span><br><span class="line">        opal_convertor_get_current_pointer(convertor, &amp;data_ptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">mca_btl_base_segment_t</span> segments[<span class="number">2</span>] = &#123;&#123;.seg_addr.pval = header, .seg_len = header_size&#125;,</span><br><span class="line">                                          &#123;.seg_addr.pval = data_ptr, .seg_len = payload_size&#125;&#125;;</span><br><span class="line">    <span class="type">mca_btl_base_descriptor_t</span> des = &#123;.des_segments = segments,</span><br><span class="line">                                     .des_segment_count = payload_size ? <span class="number">2</span> : <span class="number">1</span>,</span><br><span class="line">                                     .des_flags = <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    (<span class="type">void</span>) mca_btl_self_send(btl, endpoint, &amp;des, tag);</span><br><span class="line">    <span class="keyword">return</span> OPAL_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ¡è·¯å¾„å°±æ˜¯å¿«é€Ÿè·¯å¾„ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ç›´æ¥ç”¨çš„ä¸´æ—¶å˜é‡deså’Œsegmentsï¼Œè€Œä¸æ˜¯ç”¨çš„allocçš„frag.</p><p>å› ä¸ºè°ƒç”¨ mca_btl_self_alloc éœ€è¦ä»å†…å­˜æ± ä¸­åˆ†é…ç‰‡æ®µï¼Œæ¶‰åŠå†…å­˜æ± æ“ä½œå’Œå¯èƒ½çš„é”ç«äº‰ã€‚</p><p>å¦‚æœè´Ÿè½½æ•°æ®å¤§å°ä¸º0 || (æ˜¯è¿ç»­çš„æ•°æ® &amp;&amp; æ•°æ®ä¸åœ¨è®¾å¤‡ä¸Š)ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¿™ä¸ªifå‡½æ•°ã€‚</p><p>äººè¯ï¼šè´Ÿè½½æ•°æ®å¤§å°ä¸º0æˆ–è€…å†…è”å‘é€</p><p>è¿›å…¥è¿™ä¸ªifçš„æ—¶å€™ä¼šå†æ¬¡åˆ¤æ–­æ˜¯å¦payload_sizeæ˜¯å¦ä¸ä¸º0,å¦‚æœä¸ä¸º0ï¼Œå°±è·å–convertorçš„æŒ‡é’ˆåˆ°data_pträ¸­ã€‚</p><p>å°è£…è¿›å…¥segments, è®¾ç½®åè®®å¤´åœ°å€å’Œå¤§å°&#x2F;æ•°æ®åœ°å€å’Œå¤§å°ã€‚</p><p>æœ€åå°†segmentsç»™åˆ°des, ç„¶åç›´æ¥è°ƒç”¨sendå‡½æ•°ã€‚</p><p>å¦‚æœæ²¡æœ‰æˆåŠŸè¿›å…¥å¿«é€Ÿè·¯å¾„çš„è¯ï¼Œå°±èµ°çš„å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">frag = mca_btl_self_prepare_src(btl, endpoint, convertor, order, header_size, &amp;payload_size,</span><br><span class="line">                                flags | MCA_BTL_DES_FLAGS_BTL_OWNERSHIP);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == frag) &#123;</span><br><span class="line">    <span class="keyword">if</span>( <span class="literal">NULL</span> != descriptor ) &#123;</span><br><span class="line">        *descriptor = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OPAL_ERR_OUT_OF_RESOURCE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>(frag-&gt;des_segments[<span class="number">0</span>].seg_addr.pval, header, header_size);</span><br><span class="line">(<span class="type">void</span>) mca_btl_self_send(btl, endpoint, frag, tag);</span><br><span class="line"><span class="keyword">return</span> OPAL_SUCCESS;</span><br></pre></td></tr></table></figure><p>æ…¢é€Ÿè·¯å¾„å…¶å®å°±æ˜¯å°†prepare_srcå’Œsendå‡½æ•°åˆå¹¶åˆ°ä¸€èµ·å¹¶æ²¡æœ‰åšæ€§èƒ½ä¼˜åŒ–ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„å°±æ˜¯é€šè¿‡<code>memcpy</code>å‡½æ•°è·å¾—äº†åè®®å¤´çš„æ•°æ®ã€‚</p><h3 id="btl-put-btl-get-RDMA-put-getæ“ä½œ"><a href="#btl-put-btl-get-RDMA-put-getæ“ä½œ" class="headerlink" title="btl_put&#x2F;btl_get - RDMA put&#x2F;getæ“ä½œ"></a>btl_put&#x2F;btl_get - RDMA put&#x2F;getæ“ä½œ</h3><p>selfç»„ä»¶å¯¹äºrdmaçš„å®ç°ç›¸å½“ç®€å•ç²—æš´ï¼Œå› ä¸ºéƒ½æ˜¯åŒä¸€ä¸ªè¿›ç¨‹å†…çš„å†…å­˜ï¼Œæ‰€ä»¥ç›´æ¥å¯ä»¥memcpy</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_put</span><span class="params">(<span class="type">mca_btl_base_module_t</span> *btl, <span class="keyword">struct</span> <span class="type">mca_btl_base_endpoint_t</span> *endpoint,</span></span><br><span class="line"><span class="params">                            <span class="type">void</span> *local_address, <span class="type">uint64_t</span> remote_address,</span></span><br><span class="line"><span class="params">                            <span class="type">mca_btl_base_registration_handle_t</span> *local_handle,</span></span><br><span class="line"><span class="params">                            <span class="type">mca_btl_base_registration_handle_t</span> *remote_handle, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">                            <span class="type">int</span> flags, <span class="type">int</span> order, <span class="type">mca_btl_base_rdma_completion_fn_t</span> cbfunc,</span></span><br><span class="line"><span class="params">                            <span class="type">void</span> *cbcontext, <span class="type">void</span> *cbdata)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">void</span> *) (<span class="type">intptr_t</span>) remote_address, local_address, size);</span><br><span class="line"></span><br><span class="line">    cbfunc(btl, endpoint, local_address, <span class="literal">NULL</span>, cbcontext, cbdata, OPAL_SUCCESS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OPAL_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mca_btl_self_get</span><span class="params">(<span class="type">mca_btl_base_module_t</span> *btl, <span class="keyword">struct</span> <span class="type">mca_btl_base_endpoint_t</span> *endpoint,</span></span><br><span class="line"><span class="params">                            <span class="type">void</span> *local_address, <span class="type">uint64_t</span> remote_address,</span></span><br><span class="line"><span class="params">                            <span class="type">mca_btl_base_registration_handle_t</span> *local_handle,</span></span><br><span class="line"><span class="params">                            <span class="type">mca_btl_base_registration_handle_t</span> *remote_handle, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">                            <span class="type">int</span> flags, <span class="type">int</span> order, <span class="type">mca_btl_base_rdma_completion_fn_t</span> cbfunc,</span></span><br><span class="line"><span class="params">                            <span class="type">void</span> *cbcontext, <span class="type">void</span> *cbdata)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(local_address, (<span class="type">void</span> *) (<span class="type">intptr_t</span>) remote_address, size);</span><br><span class="line"></span><br><span class="line">    cbfunc(btl, endpoint, local_address, <span class="literal">NULL</span>, cbcontext, cbdata, OPAL_SUCCESS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OPAL_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> openmpi </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openmpi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openmpi[2] æ¨¡å—åŒ–ç»„ä»¶æ¶æ„</title>
      <link href="/2025/09/08/openmpi-2-modular-component-architecture/"/>
      <url>/2025/09/08/openmpi-2-modular-component-architecture/</url>
      
        <content type="html"><![CDATA[<ol class="series-items"><li><a href="/2025/09/16/openmpi-0-openmpi-img-parse/" title="openmpi[0]-openmpi-img-parse">openmpi[0]-openmpi-img-parse</a></li><li><a href="/2025/09/08/openmpi-1-what-is-openmpi/" title="openmpi[1] ä»€ä¹ˆæ˜¯openmpi">openmpi[1] ä»€ä¹ˆæ˜¯openmpi</a></li><li><a href="/2025/09/08/openmpi-2-modular-component-architecture/" title="openmpi[2] æ¨¡å—åŒ–ç»„ä»¶æ¶æ„">openmpi[2] æ¨¡å—åŒ–ç»„ä»¶æ¶æ„</a></li><li><a href="/2025/09/08/openmpi-3-btl-mca-self/" title="openmpi[3] btlæ¡†æ¶çš„selfç»„ä»¶åˆ†æ">openmpi[3] btlæ¡†æ¶çš„selfç»„ä»¶åˆ†æ</a></li></ol><p>Open MPI æ˜¯ä¸€ä¸ªé«˜åº¦å¯å®šåˆ¶çš„ç³»ç»Ÿï¼›å®ƒå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ã€å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®ã€‚Open MPI é…ç½®ç³»ç»Ÿçš„ä¸»è¦åŠŸèƒ½æ˜¯é€šè¿‡æ¨¡å—åŒ–ç»„ä»¶æ¶æ„ (MCA) å®ç°çš„ã€‚</p><h2 id="ä¸€äº›æœ¯è¯­"><a href="#ä¸€äº›æœ¯è¯­" class="headerlink" title="ä¸€äº›æœ¯è¯­"></a>ä¸€äº›æœ¯è¯­</h2><p>æ¨¡å—åŒ–ç»„ä»¶æ¶æ„ (MCA) æ˜¯ Open MPI å¤§éƒ¨åˆ†åŠŸèƒ½çš„æ”¯æŸ±ã€‚å®ƒç”±ä¸€ç³»åˆ—é¡¹ç›® ã€ æ¡†æ¶ ã€ ç»„ä»¶å’Œæ¨¡å—åœ¨è¿è¡Œæ—¶ç»„è£…ä»¥åˆ›å»º MPI å®ç°ã€‚</p><p>MCA å‚æ•° ï¼ˆä¹Ÿç§°ä¸º MCA å˜é‡ ï¼‰ç”¨äºå®šåˆ¶ Open MPI åœ¨è¿è¡Œæ—¶çš„è¡Œä¸ºã€‚</p><h3 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h3><p>Projectæœ¬è´¨ä¸Šæ˜¯ Open MPI ä»£ç åº“ä¸­æœ€é«˜æŠ½è±¡å±‚çš„åˆ’åˆ†ã€‚</p><p>ä½†è¿™é‡Œçš„Projectå¯ä¸æ˜¯è¯´çš„é¡¹ç›®ï¼Œè€Œæ˜¯æŒ‡çš„Open MPI ä»£ç åº“ä¸­ä¸»è¦çš„ã€é¡¶å±‚çš„ä»£ç éƒ¨åˆ†</p><h3 id="Framework"><a href="#Framework" class="headerlink" title="Framework"></a>Framework</h3><p>MCA æ¡†æ¶åœ¨è¿è¡Œæ—¶ç®¡ç†é›¶ä¸ªæˆ–å¤šä¸ªç»„ä»¶ï¼Œå¹¶é’ˆå¯¹ç‰¹å®šä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼Œæä¾› MPI é›†åˆæ“ä½œåŠŸèƒ½ï¼‰ã€‚è™½ç„¶æ¯ä¸ª MCA æ¡†æ¶ä»…æ”¯æŒä¸€ç§ç±»å‹çš„ç»„ä»¶ï¼Œä½†å®ƒå¯ä»¥æ”¯æŒå¤šä¸ªè¯¥ç±»å‹çš„ç»„ä»¶ã€‚</p><p>æ¯”å¦‚btl frameworkä»…æ”¯æŒbtlç±»å‹çš„ç»„ä»¶ï¼Œä½†æ˜¯å®ƒå¯ä»¥æ”¯æŒå¤šä¸ªbtlç»„ä»¶ï¼Œæ¯”å¦‚openibã€tcpã€usnicç­‰ã€‚</p><p>ç”¨æˆ·å¯èƒ½æƒ³è‡ªå®šä¹‰æˆ–è€…æ›´æ”¹çš„frameworkå¦‚ä¸‹ï¼š</p><ul><li>btl: Byte Transport Layer (å­—èŠ‚ä¼ è¾“å±‚); è¿™äº›ç»„ä»¶ä¸“é—¨ç”¨ä½œ PML(ç‚¹å¯¹ç‚¹) ç»„ä»¶çš„åº•å±‚ä¼ è¾“ã€‚</li><li>coll: é›†åˆæ“ä½œå±‚ (Collection Operations Layer)ï¼›è¿™äº›ç»„ä»¶ä¸“é—¨ç”¨äºå®ç° MPI é›†åˆæ“ä½œã€‚</li><li>io: MPI I&#x2F;O</li><li>mtl: MPI åŒ¹é…ä¼ è¾“å±‚ (MPI Matching Transport Layer)ï¼›è¿™äº›ç»„ä»¶ä¸“é—¨ç”¨ä½œ cm PML ç»„ä»¶çš„åº•å±‚ä¼ è¾“ã€‚</li><li>pml: ç‚¹å¯¹ç‚¹æ¶ˆæ¯ä¼ é€’å±‚ (Point-to-point Messaging Layer) ã€‚è¿™äº›ç»„ä»¶ç”¨äºå®ç° MPI ç‚¹å¯¹ç‚¹æ¶ˆæ¯ä¼ é€’åŠŸèƒ½ã€‚</li></ul><h3 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h3><p>MCA ç»„ä»¶æ˜¯æ¡†æ¶æ­£å¼æ¥å£çš„å®ç°ã€‚å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ä»£ç é›†åˆï¼Œå¯ä»¥æ†ç»‘æˆæ’ä»¶ï¼Œå¹¶åœ¨è¿è¡Œæ—¶æˆ–ç¼–è¯‘æ—¶æ’å…¥åˆ° Open MPI ä»£ç åº“ä¸­ã€‚</p><p>Open MPI çš„Componentsæ¦‚å¿µçš„åŒä¹‰è¯æ˜¯â€œpluginâ€æˆ–â€œadd-onâ€ã€‚</p><h3 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h3><p>Moduleæ˜¯Componentçš„ä¸€ä¸ªå®ä¾‹ï¼ˆåœ¨ C++ æ„ä¹‰ä¸Š è¯â€œå®ä¾‹â€ï¼›Componentç±»ä¼¼äº C++ ç±»ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¿è¡Œ Open MPI åº”ç”¨ç¨‹åºçš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªä»¥å¤ªç½‘ NICï¼ŒOpen MPI åº”ç”¨ç¨‹åºå°†åŒ…å«ä¸€ä¸ª TCP MPI ç‚¹å¯¹ç‚¹ Component ï¼Œè€Œæ˜¯ä¸¤ä¸ª TCP ç‚¹å¯¹ç‚¹Modules ã€‚</p><h3 id="MCA-å‚æ•°"><a href="#MCA-å‚æ•°" class="headerlink" title="MCA å‚æ•°"></a>MCA å‚æ•°</h3><p>MCA å‚æ•° ï¼ˆæœ‰æ—¶ç§°ä¸º MCA å˜é‡ ï¼‰æ˜¯ Open MPI è¿è¡Œæ—¶è°ƒä¼˜çš„åŸºæœ¬å•ä½ã€‚å®ƒä»¬æ˜¯ç®€å•çš„â€œé”® &#x3D; å€¼â€å¯¹ï¼Œåœ¨ Open MPI ä¸­å¹¿æ³›ä½¿ç”¨ã€‚å¼€å‘äººå‘˜ä½¿ç”¨çš„ä¸€èˆ¬ç»éªŒè§„åˆ™æ˜¯ï¼š</p><ul><li>ä¸è¦å°†é‡è¦å€¼è®¾ä¸ºå¸¸æ•°ï¼Œè€Œåº”å°†å…¶è®¾ä¸º MCA å‚æ•°ã€‚</li><li>å¦‚æœä¸€ä¸ªä»»åŠ¡å¯ä»¥é€šè¿‡å¤šç§ç”¨æˆ·å¯è¾¨åˆ«çš„æ–¹å¼å®ç°ï¼Œåˆ™å°½å¯èƒ½å¤šåœ°å®ç°ï¼Œå¹¶ä½¿ç”¨ MCA å‚æ•°åœ¨è¿è¡Œæ—¶åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚</li></ul><h2 id="è®¾ç½®MCAå‚æ•°ï¼ˆå˜é‡ï¼‰"><a href="#è®¾ç½®MCAå‚æ•°ï¼ˆå˜é‡ï¼‰" class="headerlink" title="è®¾ç½®MCAå‚æ•°ï¼ˆå˜é‡ï¼‰"></a>è®¾ç½®MCAå‚æ•°ï¼ˆå˜é‡ï¼‰</h2><p>MCAå‚æ•°å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼è¿›è¡Œè®¾ç½®ï¼ŒæŒ‰ä¼˜å…ˆçº§åˆ—å‡ºï¼š</p><ol><li>å‘½ä»¤è¡Œ</li><li>ç¯å¢ƒå˜é‡</li><li>mcaå‚æ•°æ–‡ä»¶</li><li>é…ç½®æ–‡ä»¶</li></ol><h3 id="å‘½ä»¤è¡Œ"><a href="#å‘½ä»¤è¡Œ" class="headerlink" title="å‘½ä»¤è¡Œ"></a>å‘½ä»¤è¡Œ</h3><p>ä¼˜å…ˆçº§æœ€é«˜çš„æ–¹æ³•æ˜¯åœ¨å‘½ä»¤è¡Œä¸­è®¾ç½® MCA å‚æ•°ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell$ mpirun --mca mpi_show_handle_leaks 1 -np 4 a.out</span><br></pre></td></tr></table></figure><p>è¿™ä¼šåœ¨ä½¿ç”¨å››ä¸ªè¿›ç¨‹è¿è¡Œ a.out ä¹‹å‰ï¼Œå°† MCA å‚æ•° mpi_show_handle_leaks çš„å€¼è®¾ç½®ä¸º 1ã€‚é€šå¸¸ï¼Œå‘½ä»¤è¡Œä¸­ä½¿ç”¨çš„æ ¼å¼ä¸º â€“mca <param_name> <value> ã€‚</p><p>è®¾ç½®åŒ…å«ç©ºæ ¼çš„å€¼æ—¶ï¼Œéœ€è¦ä½¿ç”¨å¼•å·ï¼Œä»¥ç¡®ä¿ Shell èƒ½å¤Ÿå°†å¤šä¸ªæ ‡è®°ç†è§£ä¸ºä¸€ä¸ªå€¼ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell$ mpirun --mca param <span class="string">&quot;value with multiple words&quot;</span> ...</span><br></pre></td></tr></table></figure><h3 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h3><h3 id="mcaå‚æ•°æ–‡ä»¶"><a href="#mcaå‚æ•°æ–‡ä»¶" class="headerlink" title="mcaå‚æ•°æ–‡ä»¶"></a>mcaå‚æ•°æ–‡ä»¶</h3><p>å¯ä»¥ä½¿ç”¨ç®€å•çš„æ–‡æœ¬æ–‡ä»¶æ¥è®¾ç½®ç‰¹å®šåº”ç”¨ç¨‹åºçš„ MCA å‚æ•°å€¼ã€‚</p><p>mpirun â€“tune CLI é€‰é¡¹å…è®¸ç”¨æˆ·åœ¨å•ä¸ªæ–‡ä»¶ä¸­æŒ‡å®š MCA å‚æ•°å’Œç¯å¢ƒå˜é‡ã€‚</p><p>è°ƒæ•´å‚æ•°æ–‡ä»¶ä¸­è®¾ç½®çš„ MCA å‚æ•°å°†è¦†ç›–ä»»ä½• MCA å…¨å±€å‚æ•°æ–‡ä»¶ä¸­æä¾›çš„å‚æ•°ï¼ˆä¾‹å¦‚ï¼Œ $HOME&#x2F;.openmpi&#x2F;mca-params.conf )ï¼Œä½†ä¸æ˜¯å‘½ä»¤è¡Œæˆ–ç¯å¢ƒå‚æ•°ã€‚</p><p>å‡è®¾æœ‰ä¸€ä¸ªå·²è°ƒæ•´çš„å‚æ•°æ–‡ä»¶åä¸º foo.conf ï¼Œå®ƒä¸åº”ç”¨ç¨‹åº a.out æ”¾åœ¨åŒä¸€ç›®å½•ä¸­ã€‚ç”¨æˆ·é€šå¸¸ä¼šä»¥å¦‚ä¸‹æ–¹å¼è¿è¡Œè¯¥åº”ç”¨ç¨‹åºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell$ mpirun -np 2 a.out</span><br></pre></td></tr></table></figure><p>è¦ä½¿ç”¨ foo.conf è°ƒæ•´å‚æ•°æ–‡ä»¶ï¼Œæ­¤å‘½ä»¤è¡Œæ›´æ”¹ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell$ mpirun -np 2 --tune foo.conf a.out</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦ä½¿ç”¨å¤šä¸ªæ–‡ä»¶ï¼Œåˆ™å¯ä»¥å°†å·²è°ƒä¼˜çš„å‚æ•°æ–‡ä»¶ç»„åˆåœ¨ä¸€èµ·ã€‚å¦‚æœè¿˜æœ‰ä¸€ä¸ªåä¸º bar.conf çš„å·²è°ƒä¼˜å‚æ•°æ–‡ä»¶ï¼Œåˆ™å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼å°†å…¶æ·»åŠ åˆ°å‘½ä»¤è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell$ mpirun -np 2 --tune foo.conf,bar.conf a.out</span><br></pre></td></tr></table></figure><p>å·²è°ƒæ•´æ–‡ä»¶çš„å†…å®¹ç”±ä¸€è¡Œæˆ–å¤šè¡Œç»„æˆï¼Œæ¯è¡ŒåŒ…å«é›¶ä¸ªæˆ–å¤šä¸ª -x å’Œ â€“mca é€‰é¡¹ã€‚ä¸å…è®¸ä½¿ç”¨æ³¨é‡Šã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹å·²è°ƒæ•´æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-x envvar1=value1 -mca param1 value1 -x envvar2</span><br><span class="line">-mca param2 value2</span><br><span class="line">-x envvar3</span><br></pre></td></tr></table></figure><p>ç›¸å½“äº:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell$ mpirun \</span><br><span class="line">    -x envvar1=value1 -mca param1 value1 -x envvar2 \</span><br><span class="line">    -mca param2 value2</span><br><span class="line">    -x envvar3 \</span><br><span class="line">    ...rest of mpirun <span class="built_in">command</span> line...</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> openmpi </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openmpi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openmpi[1] ä»€ä¹ˆæ˜¯openmpi</title>
      <link href="/2025/09/08/openmpi-1-what-is-openmpi/"/>
      <url>/2025/09/08/openmpi-1-what-is-openmpi/</url>
      
        <content type="html"><![CDATA[<ol class="series-items"><li><a href="/2025/09/16/openmpi-0-openmpi-img-parse/" title="openmpi[0]-openmpi-img-parse">openmpi[0]-openmpi-img-parse</a></li><li><a href="/2025/09/08/openmpi-1-what-is-openmpi/" title="openmpi[1] ä»€ä¹ˆæ˜¯openmpi">openmpi[1] ä»€ä¹ˆæ˜¯openmpi</a></li><li><a href="/2025/09/08/openmpi-2-modular-component-architecture/" title="openmpi[2] æ¨¡å—åŒ–ç»„ä»¶æ¶æ„">openmpi[2] æ¨¡å—åŒ–ç»„ä»¶æ¶æ„</a></li><li><a href="/2025/09/08/openmpi-3-btl-mca-self/" title="openmpi[3] btlæ¡†æ¶çš„selfç»„ä»¶åˆ†æ">openmpi[3] btlæ¡†æ¶çš„selfç»„ä»¶åˆ†æ</a></li></ol><h2 id="ä»€ä¹ˆæ˜¯openmpi"><a href="#ä»€ä¹ˆæ˜¯openmpi" class="headerlink" title="ä»€ä¹ˆæ˜¯openmpi?"></a>ä»€ä¹ˆæ˜¯openmpi?</h2><p>MPIæ˜¯ä¸€å¥—é€šä¿¡æ ‡å‡†ï¼Œç”±MPI Forumåˆ›å»ºå¹¶ç»´æŠ¤ï¼ˆMPI Forumæ˜¯ä¸€ä¸ªå¼€æ”¾ç»„ç»‡ï¼Œç”±å·¥ä¸šã€å­¦æœ¯ç•Œçš„é«˜æ€§èƒ½è®¡ç®—é¢†åŸŸçš„ä¸“å®¶ç»„æˆï¼‰.<br>MPIæ˜¯è¿™æ ·ä¸€ç§APIï¼š</p><ul><li>å¯ç§»æ¤</li><li>é«˜æ€§èƒ½çš„IPCé€šä¿¡</li></ul><p>MPIä¸€èˆ¬ä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ä¼ é€’çš„ä¸­é—´ä»¶ï¼Œä¸Šå±‚åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨MPIæ¥å£æ¥æ‰§è¡Œæ¶ˆæ¯ä¼ é€’ã€‚<br>MPIå®šä¹‰äº†ä¸€ç³»åˆ—ä¸å¹³å°æ— å…³çš„ã€é«˜åº¦æŠ½è±¡çš„APIæ¥å£ï¼Œç”¨äºè¿›ç¨‹ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’(è¿™ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´å¯ä»¥åœ¨ä¸åŒä¸»æœºï¼Œä½†ä¸»æœºä¹‹é—´éœ€è¦æœ‰ä¸€ä¸ªé€šä¿¡çš„é€šé“, æ¯”å¦‚eth)ä¸¾ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œè¿›ç¨‹Xæ˜¯å‘é€è¿›ç¨‹ï¼Œåªéœ€æä¾›æ¶ˆæ¯å†…å®¹ï¼ˆä¾‹å¦‚ä¸€ä¸ªåŒç²¾åº¦æ•°ç»„ï¼‰ä»¥åŠå¦ä¸€ä¸ªæ¥æ”¶è¿›ç¨‹çš„æ ‡è¯†ï¼ˆä¾‹å¦‚è¿›ç¨‹Yï¼‰ï¼ŒåŒæ—¶æ¥æ”¶è¿›ç¨‹Yåªéœ€æä¾›å‘é€è¿›ç¨‹çš„æ ‡è¯†ï¼ˆä¾‹å¦‚è¿›ç¨‹Xï¼‰ï¼Œæ¶ˆæ¯å°±å¯ä»¥ä»Xä¼ é€’ç»™Yã€‚<br>æ³¨æ„è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ²¡æœ‰å»ºç«‹è¿æ¥ã€æ²¡æœ‰å­—èŠ‚æµçš„è½¬æ¢ã€æ²¡æœ‰ç½‘ç»œåœ°å€çš„äº¤æ¢ï¼ŒMPIå°†è¿™äº›ç»†èŠ‚éƒ½æŠ½è±¡å°è£…äº†èµ·æ¥ï¼Œä¸ä»…ä»…æ˜¯éšè—äº†å¤æ‚æ€§ï¼Œè€Œä¸”ä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿå…¼å®¹ä¸åŒçš„å¹³å°ã€ç¡¬ä»¶ä»¥åŠç½‘ç»œç±»å‹ã€‚<br>MPIæä¾›çš„é€šä¿¡æ¨¡å¼ï¼š</p><ul><li>point to point</li><li>collective</li><li>broadcast</li></ul><h2 id="openmpiçš„åŠŸèƒ½å’Œç‰¹æ€§"><a href="#openmpiçš„åŠŸèƒ½å’Œç‰¹æ€§" class="headerlink" title="openmpiçš„åŠŸèƒ½å’Œç‰¹æ€§"></a>openmpiçš„åŠŸèƒ½å’Œç‰¹æ€§</h2><p>åœ¨è¿™é‡Œæˆ‘å¹¶ä¸æƒ³è®¨è®ºMPIçš„æ ‡å‡†ä¸€è‡´æ€§ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è·³è¿‡ã€‚</p><h3 id="æ¨¡å—åŒ–ç»„ä»¶æ¶æ„-MCA"><a href="#æ¨¡å—åŒ–ç»„ä»¶æ¶æ„-MCA" class="headerlink" title="æ¨¡å—åŒ–ç»„ä»¶æ¶æ„(MCA)"></a>æ¨¡å—åŒ–ç»„ä»¶æ¶æ„(MCA)</h3><ul><li>é¡¹ç›®åˆ†å±‚ï¼šOPALï¼ˆå¯ç§»æ¤æ€§å±‚ï¼‰ã€OMPIï¼ˆMPI APIï¼‰ã€OSHMEMï¼ˆOpenSHMEM APIï¼‰</li><li>æ¡†æ¶ç³»ç»Ÿï¼šBTLï¼ˆå­—èŠ‚ä¼ è¾“å±‚ï¼‰ã€PMLï¼ˆç‚¹å¯¹ç‚¹æ¶ˆæ¯å±‚ï¼‰ã€Collï¼ˆé›†åˆæ“ä½œï¼‰ç­‰</li><li>ç»„ä»¶æ’ä»¶ï¼šæ”¯æŒè¿è¡Œæ—¶å’Œç¼–è¯‘æ—¶çš„ç»„ä»¶é€‰æ‹©</li></ul><p>å…³äºæ›´è¯¦ç»†çš„æ¡†æ¶ç³»ç»Ÿæˆ‘ä¼šåœ¨åé¢çš„ç« èŠ‚ä»‹ç»ã€‚</p><h3 id="å¤šç§ä¼ è¾“åè®®çš„æ”¯æŒ"><a href="#å¤šç§ä¼ è¾“åè®®çš„æ”¯æŒ" class="headerlink" title="å¤šç§ä¼ è¾“åè®®çš„æ”¯æŒ"></a>å¤šç§ä¼ è¾“åè®®çš„æ”¯æŒ</h3><p>å¾—ç›Šäºæ¡†æ¶ç³»ç»Ÿçš„åˆ†å±‚æ¶æ„ï¼Œopenmpié€šè¿‡btlæˆ–collå±‚æ”¯æŒäº†å¤šé‡ä¼ è¾“åè®®ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>self: ç”¨äºåŒä¸€èŠ‚ç‚¹åŒä¸€è¿›ç¨‹å†…çš„é€šä¿¡</li><li>å…±äº«å†…å­˜ï¼šç”¨äºåŒä¸€èŠ‚ç‚¹å†…è¿›ç¨‹é—´é«˜æ•ˆé€šä¿¡</li><li>TCP&#x2F;IPï¼šé€šç”¨ç½‘ç»œä¼ è¾“</li><li>é«˜æ€§èƒ½ç½‘ç»œï¼šInfiniBandã€Omni-Pathã€ä»¥å¤ªç½‘ç­‰</li></ul><h3 id="åŠ é€Ÿå™¨æ¡†æ¶"><a href="#åŠ é€Ÿå™¨æ¡†æ¶" class="headerlink" title="åŠ é€Ÿå™¨æ¡†æ¶"></a>åŠ é€Ÿå™¨æ¡†æ¶</h3><p>æ–°çš„åŠ é€Ÿå™¨æ¡†æ¶æ”¯æŒ CUDA å’Œ ROCm è®¾å¤‡ï¼Œæä¾›ç»Ÿä¸€çš„è®¾å¤‡æŠ½è±¡</p><h3 id="å¹³å°æ”¯æŒ"><a href="#å¹³å°æ”¯æŒ" class="headerlink" title="å¹³å°æ”¯æŒ"></a>å¹³å°æ”¯æŒ</h3><p>Open MPI æ”¯æŒå¹¿æ³›çš„å¹³å°ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿï¼šLinuxã€macOSã€Cygwinã€OpenBSD ç­‰</li><li>æ¶æ„ï¼šx86_64ã€ARMã€PowerPC ç­‰</li><li>è¿è¡Œæ—¶ç³»ç»Ÿï¼šSlurmã€PBSã€LSFã€SGE ç­‰</li></ul><p>è¿˜æœ‰ä¸€äº›å…¶ä»–æˆ‘ä¸å…³å¿ƒçš„ä¸œè¥¿æ²¡æœ‰åœ¨æ­¤å¤„åˆ—å‡ºï¼Œæ¯”å¦‚I&#x2F;Oå­ç³»ç»Ÿã€‚</p><h2 id="å¦‚ä½•å¼€å§‹"><a href="#å¦‚ä½•å¼€å§‹" class="headerlink" title="å¦‚ä½•å¼€å§‹"></a>å¦‚ä½•å¼€å§‹</h2><h3 id="å®‰è£…openmpi"><a href="#å®‰è£…openmpi" class="headerlink" title="å®‰è£…openmpi"></a>å®‰è£…openmpi</h3><p>ä½ å¯ä»¥ä»æºç ç¼–è¯‘å®‰è£…openmpiï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ã€‚</p><p>è¿™å¯¹ä¸€ä¸ªç¨³å®šçš„å‘è¡Œç‰ˆæ¥è¯´éƒ½å¾ˆå®¹æ˜“ï¼Œæ¯”å¦‚Ubuntuã€CentOSã€Arch Linuxç­‰ã€‚</p><p>å¦‚æœä½¿ç”¨æºç ç¼–è¯‘ï¼Œä½ å¯ä»¥è½»æ¾çš„é€šè¿‡ä»¥ä¸‹å‘½ä»¤åšåˆ°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./autogen.pl &amp;&amp; ./configure --prefix=/opt/openmpi &amp;&amp; make -j64 &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼Œå¦‚æœé€šè¿‡tarballä¸‹è½½çš„æºç è€Œä¸æ˜¯git repo, åˆ™ä¸éœ€è¦æ‰§è¡Œautogen.plå‘½ä»¤ã€‚</p><h3 id="ç¼–å†™MPIç¨‹åº"><a href="#ç¼–å†™MPIç¨‹åº" class="headerlink" title="ç¼–å†™MPIç¨‹åº"></a>ç¼–å†™MPIç¨‹åº</h3><p>å…ˆä»ç®€å•çš„helloworldå¼€å§‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mpi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line">    MPI_Init(&amp;argc, &amp;argv);</span><br><span class="line">    <span class="type">int</span> rank, size;</span><br><span class="line">    <span class="type">char</span> hostname[<span class="number">256</span>];</span><br><span class="line">    MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);</span><br><span class="line">    MPI_Comm_size(MPI_COMM_WORLD, &amp;size);</span><br><span class="line">    gethostname(hostname, <span class="keyword">sizeof</span>(hostname));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello from rank %d of %d on %s\n&quot;</span>, rank, size, hostname);</span><br><span class="line">    MPI_Finalize();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®å‰ä¸éœ€è¦ç†è§£ä»–ä»¬çš„å«ä¹‰ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåªæ˜¯ä½œä¸ºæ¼”ç¤ºã€‚</p><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mpicc -o helloworld helloworld.c</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œç¨‹åº"><a href="#è¿è¡Œç¨‹åº" class="headerlink" title="è¿è¡Œç¨‹åº"></a>è¿è¡Œç¨‹åº</h3><p>å¦‚æœä½ åªæœ‰ä¸€ä¸ªæœºå™¨ï¼Œä½ å¯ä»¥ç›´æ¥è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mpirun -np 2 --mca btl self,sm helloworld</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æœ‰å¤šä¸ªæœºå™¨ï¼Œå¤ªæ£’äº†ï¼Œå¯ä»¥ä½“éªŒç”¨å¤šä¸ªæœºå™¨å¹¶å‘ä»»åŠ¡äº†ã€‚</p><p>é¦–å…ˆéœ€è¦ä¿è¯ä»–ä»¬éƒ½å®‰è£…äº†openmpi, å¹¶ä¸”helloworldéƒ½åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚</p><p>ç„¶åç¼–å†™ä¸€ä¸ªhost fileå»æ¾„æ¸…ä»–ä»¬çš„ipåœ°å€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">192.168.1.101 slots=8</span><br><span class="line">192.168.1.102 slots=8</span><br></pre></td></tr></table></figure><p>slotsè¡¨ç¤ºæ¯å—æ¿å­èƒ½å¹¶è¡Œçš„æ ¸å¿ƒæ•°ï¼Œé€šå¸¸æ˜¯èŠ¯ç‰‡çš„cpuæ ¸å¿ƒæ•°</p><p>ç°åœ¨å¼€å§‹è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mpirun -np 2 --hostfile hosts.txt /home/troy/helloworld</span><br></pre></td></tr></table></figure><p>Enjoy :)</p>]]></content>
      
      
      <categories>
          
          <category> openmpi </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openmpi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sdä¸mmcåˆ·å†™æŒ‡å—</title>
      <link href="/2025/08/01/sd%E4%B8%8Emmc%E5%88%B7%E5%86%99%E6%8C%87%E5%8D%97/"/>
      <url>/2025/08/01/sd%E4%B8%8Emmc%E5%88%B7%E5%86%99%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h2><p>Host: Ubuntu 22.04</p><p>GParted 1.3.1</p><h2 id="SDå¡"><a href="#SDå¡" class="headerlink" title="SDå¡"></a>SDå¡</h2><p>é¦–å…ˆæ’å…¥sdå¡ï¼Œæ‰“å¼€GPartedå·¥å…·ï¼Œæ²¡æœ‰å¯ä»¥ä¸‹è½½ä¸€ä¸ªï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> apt install gpart</span><br></pre></td></tr></table></figure><p>é€‰æ‹©sdå¡è®¾å¤‡ï¼Œæˆ‘è¿™é‡Œæ˜¯sdbï¼Œå› æœºå™¨è€Œå¼‚ã€‚</p><p>é€‰æ‹©èœå•æ çš„<code>è®¾å¤‡</code>-&gt;<code>åˆ›å»ºåˆ†åŒºè¡¨</code>ï¼Œé€‰æ‹©msdosåˆ†åŒºè¡¨ã€‚</p><p><a href="https://i.postimg.cc/rFV6F05D/2024-09-20-17-52-19.png"><img src="https://i.postimg.cc/rFV6F05D/2024-09-20-17-52-19.png" alt="2024-09-20-17-52-19.png"></a></p><p>åˆ›å»ºå®Œæˆä¹‹åï¼Œæ–°å»ºä¸¤ä¸ªåˆ†åŒºã€‚</p><p>ä¸€ä¸ªfat16çš„ï¼Œç”¨äºæ”¾å†…æ ¸é•œåƒå’Œdtbæ–‡ä»¶ä»¥åŠubootä¿å­˜çš„envæ–‡ä»¶ã€‚</p><p><a href="https://postimg.cc/bSDT7QCh"><img src="https://i.postimg.cc/wMFGs2D7/2024-09-20-17-55-43.png" alt="2024-09-20-17-55-43.png"></a></p><p>ä¸€ä¸ªext4ç”¨æ¥å­˜æ”¾æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</p><p><a href="https://postimg.cc/w3yQTQ2K"><img src="https://i.postimg.cc/h4MysC7G/2024-09-20-17-55-55.png" alt="2024-09-20-17-55-55.png"></a></p><p>å®Œæˆä¹‹åç‚¹å‡»ç»¿è‰²å°å¯¹å‹¾ï¼Œè®©æ›´æ”¹ç”Ÿæ•ˆã€‚</p><p><a href="https://postimg.cc/Dm9dW4pS"><img src="https://i.postimg.cc/hPjC5991/2024-09-20-17-56-02.png" alt="2024-09-20-17-56-02.png"></a></p><p>ä¹‹åä¾¿å¯ä»¥åœ¨<code>/dev</code>ä¸‹çœ‹åˆ°å¯¹åº”çš„åˆ†åŒºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> /dev/sdb*</span><br><span class="line">/dev/sdb  /dev/sdb1  /dev/sdb2</span><br></pre></td></tr></table></figure><p>ä¸‹è½½ubooté•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> <span class="built_in">dd</span> <span class="keyword">if</span>=u-boot-sunxi-with-spl.bin of=/dev/sdb bs=1024 seek=8</span><br></pre></td></tr></table></figure><p>å­˜æ”¾å†…æ ¸é•œåƒå’Œè®¾å¤‡æ ‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â¯ sudo mount /dev/sdb1 /mnt</span><br><span class="line">â¯ sudo cp arch/arm/boot/zImage /mnt</span><br><span class="line">â¯ sudo cp arch/arm/boot/dts/allwinner/sun8i-a33-vstar.dtb /mnt</span><br><span class="line">â¯ sudo umount /mnt</span><br></pre></td></tr></table></figure><p>å­˜æ”¾æ ¹æ–‡ä»¶ç³»ç»Ÿï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> mount /dev/sdb2 /mnt</span><br><span class="line">â¯ <span class="built_in">sudo</span> tar -xvzf ubuntu22.04.tar.gz -C /mnt</span><br><span class="line">â¯ <span class="built_in">sudo</span> umount /mnt</span><br></pre></td></tr></table></figure><h2 id="EMMC"><a href="#EMMC" class="headerlink" title="EMMC"></a>EMMC</h2><p>å¯¹äºEMMCæ“ä½œå¤æ‚ä¸€äº›ï¼Œéœ€è¦ä¿®æ”¹ubootï¼Œæ‰“å¼€CONFIG_CMD_USB_MASS_STORAGEçš„é…ç½®é¡¹ã€‚</p><p>è¿›å…¥felæ¨¡å¼å°†ubootä¸‹è½½è¿›å…¥å†…å­˜å¹¶è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> sunxi-fel uboot ./u-boot-sunxi-with-spl.bin</span><br></pre></td></tr></table></figure><p>åœ¨ubootè‡ªåŠ¨å¯åŠ¨å†…æ ¸å‰æ‰“æ–­ï¼Œå¹¶ä¸”è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; ums 2 mmc 1</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤æ˜¯å°†mmcçš„1å·è®¾å¤‡é€šè¿‡usb 2å·æŒ‚è½½å‡ºå»ã€‚å°±ç›¸å½“äºç”µè„‘æ’äº†ä¸ªUç›˜ã€‚</p><p>æˆ‘è¿™é‡Œmmcçš„1å·è®¾å¤‡æ˜¯emmcï¼Œusb2å·æ˜¯otgæ¥å£ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ã€‚</p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯æŸ¥è¯¢å¯¹åº”çš„æ¥å£å·ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; mmc list</span><br><span class="line">=&gt; usb tree</span><br><span class="line"><span class="comment"># æˆ–è€…æ˜¯usb info</span></span><br></pre></td></tr></table></figure><p>ç„¶åç”µè„‘å°±èƒ½çœ‹åˆ°äº†<code>/dev/sdX</code>ï¼Œéšåçš„æ“ä½œä¸SDå¡ç›¸åŒã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>VirtualBoxé”™è¯¯</title>
      <link href="/2025/08/01/VirtualBox%E9%94%99%E8%AF%AF-1/"/>
      <url>/2025/08/01/VirtualBox%E9%94%99%E8%AF%AF-1/</url>
      
        <content type="html"><![CDATA[<p>å½“æˆ‘å°è¯•å¯åŠ¨è™šæ‹Ÿæœºæ—¶é‡åˆ°äº†å¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Kernel driver not installed (rc=-1908)</span><br><span class="line"></span><br><span class="line">The VirtualBox Linux kernel driver is either not loaded or not set up correctly. Please try setting it up again by executing</span><br><span class="line"></span><br><span class="line">&#x27;/sbin/vboxconfig&#x27;</span><br><span class="line"></span><br><span class="line">as root.</span><br><span class="line"></span><br><span class="line">If your system has EFI Secure Boot enabled you may also need to sign the kernel modules (vboxdrv, vboxnetflt, vboxnetadp, vboxpci) before you can load them. Please see your Linux system&#x27;s documentation for more information.</span><br><span class="line"></span><br><span class="line">where: suplibOsInit what: 3 VERR_VM_DRIVER_NOT_INSTALLED (-1908) - The support driver is not installed. On linux, open returned ENOENT. </span><br></pre></td></tr></table></figure><p>å°è¯•æ‰§è¡Œâ€™&#x2F;sbin&#x2F;vboxconfigâ€™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> /sbin/vboxconfig</span><br><span class="line">vboxdrv.sh: Stopping VirtualBox services.</span><br><span class="line">vboxdrv.sh: Starting VirtualBox services.</span><br><span class="line">vboxdrv.sh: You must sign these kernel modules before using VirtualBox:</span><br><span class="line">  vboxdrv vboxnetflt vboxnetadp</span><br><span class="line">See the documentation <span class="keyword">for</span> your Linux distribution..</span><br><span class="line">vboxdrv.sh: Building VirtualBox kernel modules.</span><br><span class="line">vboxdrv.sh: failed: Look at /var/log/vbox-setup.log to find out what went wrong.</span><br><span class="line"></span><br><span class="line">There were problems setting up VirtualBox.  To re-start the set-up process, run</span><br><span class="line">  /sbin/vboxconfig</span><br><span class="line">as root.  If your system is using EFI Secure Boot you may need to sign the</span><br><span class="line">kernel modules (vboxdrv, vboxnetflt, vboxnetadp, vboxpci) before you can load</span><br><span class="line">them. Please see your Linux system<span class="string">&#x27;s documentation for more information.</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹secure bootæ˜¯å¦å¼€å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ mokutil --sb-state</span><br><span class="line"></span><br><span class="line">SecureBoot enabled</span><br></pre></td></tr></table></figure><p>è¿›å…¥BIOSå…³é—­secure bootåé‡æ–°æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> /sbin/vboxconfig</span><br><span class="line"></span><br><span class="line">vboxdrv.sh: Stopping VirtualBox services.</span><br><span class="line">vboxdrv.sh: Starting VirtualBox services.</span><br><span class="line">vboxdrv.sh: Building VirtualBox kernel modules.</span><br><span class="line">vboxdrv.sh: failed: Look at /var/log/vbox-setup.log to find out what went wrong.</span><br><span class="line"></span><br><span class="line">There were problems setting up VirtualBox.  To re-start the set-up process, run</span><br><span class="line">  /sbin/vboxconfig</span><br><span class="line">as root.  If your system is using EFI Secure Boot you may need to sign the</span><br><span class="line">kernel modules (vboxdrv, vboxnetflt, vboxnetadp, vboxpci) before you can load</span><br><span class="line">them. Please see your Linux system<span class="string">&#x27;s documentation for more information.</span></span><br></pre></td></tr></table></figure><p>ä¸€æ ·çš„é”™è¯¯ï¼Œå°è¯•å®‰è£…ç¼–è¯‘å†…æ ¸æ¨¡å—æ‰€éœ€çš„è½¯ä»¶åŒ…ã€‚é€šå¸¸éœ€è¦ dkms å’Œ kernel-develåä¸€åˆ‡æ­£å¸¸ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> apt-get install dkms build-essential linux-headers-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>esp32åˆå§‹åŒ–ç»“æ„ä½“é—®é¢˜</title>
      <link href="/2025/08/01/esp32/"/>
      <url>/2025/08/01/esp32/</url>
      
        <content type="html"><![CDATA[<p>åœ¨<code>c++</code>ä½¿ç”¨<code>espidf</code>è¿›è¡Œ<code>wifi</code>è¿æ¥æ—¶ï¼Œå‘ç°å¦‚ä¸‹ä»£ç å¯ä»¥è¿æ¥ï¼š</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">wifi_config_t</span> wifi_config = &#123;</span><br><span class="line">            .sta = &#123;</span><br><span class="line">                    .ssid = <span class="string">&quot;HBDT-23F&quot;</span>,</span><br><span class="line">                    .password = <span class="string">&quot;hbishbis&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½†å¦‚ä¸‹ä»£ç ä¸å¯è¿æ¥ï¼š</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">wifi_config_t</span> wifi_config;</span><br><span class="line"><span class="built_in">strcpy</span>(wifi_config.sta.ssid, <span class="string">&quot;HBDT-23F&quot;</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(wifi_config.sta.password, <span class="string">&quot;hbishbis&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç»è¿‡æ’æŸ¥å‘ç°<code>espidf</code>å¯¹äºè¿æ¥é˜¶æ®µé™¤äº†<code>ssid</code>å’Œ<code>password</code>è¿˜ä½¿ç”¨åˆ°äº†å…¶ä»–å˜é‡ï¼Œæ‰€ä»¥åº”è¯¥æ¸…é›¶ç»“æ„ä½“å†…å­˜ï¼š</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">wifi_config_t</span> wifi_config&#123;&#125;;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå¾ˆä½çº§çš„é—®é¢˜â€¦è®°å½•ä¸‹æ¥æ—¶åˆ»è­¦é†’ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> mcu </category>
          
          <category> esp32 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mcu </tag>
            
            <tag> esp32 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IMPORTANT: lost blog notes</title>
      <link href="/2025/07/06/IMPORTANT-lost-blog-notes/"/>
      <url>/2025/07/06/IMPORTANT-lost-blog-notes/</url>
      
        <content type="html"><![CDATA[<h1 id="What-happened-to-my-blog"><a href="#What-happened-to-my-blog" class="headerlink" title="What happened to my blog?"></a>What happened to my blog?</h1><p>Due to unforeseen circumstances, some of the blog posts have been lost. I have only found the web page format, but the index for the homepage has been lost.</p><p>So there is the list:</p><h2 id="2025-year"><a href="#2025-year" class="headerlink" title="2025 year"></a>2025 year</h2><h3 id="April"><a href="#April" class="headerlink" title="April"></a>April</h3><h4 id="Day-10"><a href="#Day-10" class="headerlink" title="Day 10"></a>Day 10</h4><ul><li><a href="https://blog.troy-y.org/2025/04/10/vercel%E9%83%A8%E7%BD%B2twikoo%E5%90%8E%E8%AF%84%E8%AE%BA%E6%94%B6%E4%B8%8D%E5%88%B0%E9%80%9A%E7%9F%A5%E9%82%AE%E4%BB%B6%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">Vercel éƒ¨ç½² Twikoo åè¯„è®ºæ”¶ä¸åˆ°é€šçŸ¥é‚®ä»¶é—®é¢˜è§£å†³æ–¹æ³•</a></li></ul><h4 id="Day-12"><a href="#Day-12" class="headerlink" title="Day 12"></a>Day 12</h4><ul><li><a href="https://blog.troy-y.org/2025/04/12/linux%E7%9A%84initcall%E6%9C%BA%E5%88%B6/">Linux çš„ initcall æœºåˆ¶</a></li></ul><h4 id="Day-13"><a href="#Day-13" class="headerlink" title="Day 13"></a>Day 13</h4><ul><li><a href="https://blog.troy-y.org/2025/04/13/elf%E6%96%87%E4%BB%B6-0-section%E5%92%8Csegment%E7%9A%84%E5%8C%BA%E5%88%AB/">ELF æ–‡ä»¶ -0- section å’Œ segment çš„åŒºåˆ«</a></li><li><a href="https://blog.troy-y.org/2025/04/13/linux-i2c%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90-0/">Linux I2C é©±åŠ¨æ¡†æ¶åˆ†æ -0</a></li><li><a href="https://blog.troy-y.org/2025/04/13/linux-i2c%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90-1/">Linux I2C é©±åŠ¨æ¡†æ¶åˆ†æ -1</a></li></ul><h4 id="Day-20"><a href="#Day-20" class="headerlink" title="Day 20"></a>Day 20</h4><ul><li><a href="https://blog.troy-y.org/2025/04/20/platform-device-driver-0/">Platform Device Driver -0</a></li><li><a href="https://blog.troy-y.org/2025/04/20/platform-device-driver-1/">Platform Device Driver -1</a></li></ul><h4 id="Day-24"><a href="#Day-24" class="headerlink" title="Day 24"></a>Day 24</h4><ul><li><a href="https://blog.troy-y.org/2025/04/24/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E9%9D%A2%E7%BB%8F-%E9%9A%8F%E6%84%8F%E9%9A%8F%E7%BC%98%E4%B8%8D%E5%AE%8C%E6%95%B4%E7%89%88/">åµŒå…¥å¼ Linux é¢ç» - éšæ„éšç¼˜ä¸å®Œæ•´ç‰ˆ</a></li></ul><h4 id="Day-26"><a href="#Day-26" class="headerlink" title="Day 26"></a>Day 26</h4><ul><li><a href="https://blog.troy-y.org/2025/04/26/Linux%E8%AE%BE%E5%A4%87%E6%A0%91-0-%E7%90%86%E8%A7%A3dtb%E6%A0%BC%E5%BC%8F/">Linux è®¾å¤‡æ ‘ -0- ç†è§£ dtb æ ¼å¼</a></li><li><a href="https://blog.troy-y.org/2025/04/26/Linux%E8%AE%BE%E5%A4%87%E6%A0%91-1-%E8%A7%A3%E6%9E%90%E8%AE%BE%E5%A4%87%E6%A0%91/">Linux è®¾å¤‡æ ‘ -1- è§£æè®¾å¤‡æ ‘</a></li><li><a href="https://blog.troy-y.org/2025/04/26/Uboot%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92bootargs%E7%BB%99Linux/">U-Boot å¦‚ä½•ä¼ é€’ bootargs ç»™ Linux</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo: Deploy github and lose CNAME</title>
      <link href="/2025/07/04/hexo-Deploy-github-and-lose-CNAME/"/>
      <url>/2025/07/04/hexo-Deploy-github-and-lose-CNAME/</url>
      
        <content type="html"><![CDATA[<h1 id="Issue"><a href="#Issue" class="headerlink" title="Issue"></a>Issue</h1><p>I deployed my hexo blog to github pages, but I lost the custom domain in github pages.</p><p>I tried to re-add the custom domain in the repository settings and I found this operation will add CNAME file under the repository root directory.</p><h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>So I copy this file(or create a new one and only put custom domain into this file) to the <code>source</code> directory of my hexo blog, and then commit and push it to the repository.</p><p>Everything works fine!</p>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> github </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nvim plugin - MakrdownPreview: can&#39;t preview</title>
      <link href="/2025/07/04/nvim-plugin-MakrdownPreview-can-t-preview/"/>
      <url>/2025/07/04/nvim-plugin-MakrdownPreview-can-t-preview/</url>
      
        <content type="html"><![CDATA[<h2 id="Env"><a href="#Env" class="headerlink" title="Env:"></a>Env:</h2><p>Nvim: v0.11.2 &amp; Lazyvim</p><p>Terminal: Kitty</p><p>OS: Arch Linux</p><h2 id="How-did-I-do"><a href="#How-did-I-do" class="headerlink" title="How did I do"></a>How did I do</h2><p>Create a .lua file in the following directory: <code>~/.config/nvim/lua/plugins/markdown-preview.lua</code></p><p>Then add the following code:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">return &#123;</span><br><span class="line">&quot;iamcco/markdown-preview.nvim&quot;,</span><br><span class="line">cmd = &#123; &quot;MarkdownPreviewToggle&quot;, &quot;MarkdownPreview&quot;, &quot;MarkdownPreviewStop&quot; &#125;,</span><br><span class="line">ft = &#123; &quot;markdown&quot; &#125;,</span><br><span class="line">build = function()</span><br><span class="line">vim.fn[&quot;mkdp#util#install&quot;]()</span><br><span class="line">end,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Reopen nvim and run: <code>Lazy sync</code></p><p>Edit a markdown file:</p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># Hello</span></span><br><span class="line"><span class="section">## World</span></span><br><span class="line">![<span class="string">remote-img</span>](<span class="link">https://www.rust-lang.org/logos/rust-logo-512x512.png</span>)</span><br></pre></td></tr></table></figure><p>I got this message: <code>Nodejs v24.0.2</code> after run this command in nvim: <code>MarkdownPreview</code></p><p>Search in MarkdownPreview repo and found this issue: <a href="https://github.com/iamcco/markdown-preview.nvim/issues/695">https://github.com/iamcco/markdown-preview.nvim/issues/695</a></p><p>I tried like this issue and it worked!</p>]]></content>
      
      
      
        <tags>
            
            <tag> nvim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxæŒ‚è½½nfsæ ¹æ–‡ä»¶ç³»ç»Ÿå¤±è´¥</title>
      <link href="/2025/01/04/linux%E6%8C%82%E8%BD%BDnfs%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B1%E8%B4%A5/"/>
      <url>/2025/01/04/linux%E6%8C%82%E8%BD%BDnfs%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B1%E8%B4%A5/</url>
      
        <content type="html"><![CDATA[<p>æŒ‚åœ¨nfsæ ¹æ–‡ä»¶ç³»ç»Ÿæ—¶å‡ºç°å¦‚ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[    1.939157] VFS: Cannot open root device <span class="string">&quot;nfs&quot;</span> or unknown-block(0,255): error -6</span><br><span class="line">[    1.946989] Please append a correct <span class="string">&quot;root=&quot;</span> boot option; here are the available partitions:</span><br><span class="line">[    1.955765] Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,255)</span><br><span class="line">[    1.964493] ---[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,255) ]---</span><br></pre></td></tr></table></figure><p>æ ¹æ®å†…æ ¸æ—¥å¿—æ¥çœ‹<code>bootargs</code>æ˜¯è®¾ç½®æ­£ç¡®çš„ï¼Œç»è¿‡å¤šæ–¹æ’æŸ¥æ˜¯ä»¥ä¸‹é…ç½®æ²¡å¼€å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CONFIG_ROOT_NFS</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tmuxå¤åˆ¶åˆ°ç³»ç»Ÿå‰ªåˆ‡æ¿</title>
      <link href="/2024/11/30/tmux%E5%A4%8D%E5%88%B6%E5%88%B0%E7%B3%BB%E7%BB%9F%E5%89%AA%E5%88%87%E6%9D%BF/"/>
      <url>/2024/11/30/tmux%E5%A4%8D%E5%88%B6%E5%88%B0%E7%B3%BB%E7%BB%9F%E5%89%AA%E5%88%87%E6%9D%BF/</url>
      
        <content type="html"><![CDATA[<p>tmuxå¯ä»¥ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼š<a href="https://github.com/gpakosz/.tmux">oh my tmux</a></p><p>ç„¶ååœ¨<code>.tmux.conf.local</code>ä¸­å°†ä»¥ä¸‹é€‰é¡¹è®¾ç½®ä¸ºtrueï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -- clipboard -----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># in copy mode, copying selection also copies to the OS clipboard</span></span><br><span class="line"><span class="comment">#   - true</span></span><br><span class="line"><span class="comment">#   - false (default)</span></span><br><span class="line"><span class="comment">#   - disabled</span></span><br><span class="line"><span class="comment"># on Linux, this requires xsel, xclip or wl-copy</span></span><br><span class="line">tmux_conf_copy_to_os_clipboard=<span class="literal">true</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>lazyvimå¤åˆ¶åˆ°å‰ªåˆ‡æ¿</title>
      <link href="/2024/11/30/lazyvim%E5%A4%8D%E5%88%B6%E5%88%B0%E5%89%AA%E5%88%87%E6%9D%BF/"/>
      <url>/2024/11/30/lazyvim%E5%A4%8D%E5%88%B6%E5%88%B0%E5%89%AA%E5%88%87%E6%9D%BF/</url>
      
        <content type="html"><![CDATA[<p>åœ¨neovim(10.0.2)ä¸­ï¼Œå…¶å®å·²ç»é»˜è®¤å¼€å¯äº†yankæ’ä»¶ï¼Œä¹Ÿå°±æ˜¯å¤åˆ¶çš„å†…å®¹ä¼šè‡ªåŠ¨ä¼ å…¥å‰ªåˆ‡æ¿ã€‚</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜ä¼šæœ‰è¿™ç¯‡æ–‡ç« å‘¢ï¼Ÿå› ä¸ºlazyvimé»˜è®¤æœ‰è¿™æ ·ä¸€ä¸ªé…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opt.clipboard = vim.env.SSH_TTY and <span class="string">&quot;&quot;</span> or <span class="string">&quot;unnamedplus&quot;</span> -- Sync with system clipboard</span><br></pre></td></tr></table></figure><p>è¿™å¥çš„æ„æ€æŸ¥çœ‹ä½ çš„shellæ˜¯å¦æ˜¯ttyç±»å‹ï¼Œå¦‚æœæ˜¯ttyé‚£ä¹ˆå°±ä¸ä¼šè¿›å…¥ç³»ç»Ÿå‰ªåˆ‡æ¿ã€‚æ°å¥½sshå°±æ˜¯ttyç±»å‹ï¼Œæ‰€ä»¥sshè¿æ¥çš„shellåœ¨æ‰“å¼€nvimå¤åˆ¶çš„å†…å®¹æ˜¯ä¸ä¼šè¿›å…¥åˆ°ç³»ç»Ÿå‰ªåˆ‡æ¿çš„ã€‚</p><p>è¿›å…¥ç³»ç»Ÿå‰ªåˆ‡æ¿çš„ä½œç”¨ï¼š<a href="https://blog.troy-y.org/2024/11/30/ssh%E5%8F%8C%E5%90%91%E5%A4%8D%E5%88%B6/">here</a></p><p>æ‰€ä»¥è¦åœ¨<code>~/.config/nvim/lua/config/option.lua</code>ä¸­è¦†ç›–è¿™æ¡é»˜è®¤è®¾ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opt.clipboard = <span class="string">&quot;unnamedplus&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å³ä¾¿ttyä¹Ÿèƒ½å¤Ÿè¿›å…¥ç³»ç»Ÿå‰ªåˆ‡æ¿äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sshåŒå‘å¤åˆ¶</title>
      <link href="/2024/11/30/ssh%E5%8F%8C%E5%90%91%E5%A4%8D%E5%88%B6/"/>
      <url>/2024/11/30/ssh%E5%8F%8C%E5%90%91%E5%A4%8D%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ä¸»æœºAé€šè¿‡sshè¿æ¥åˆ°ä¸»æœºBæ—¶ï¼Œæˆ‘ä»¬åœ¨Aå†…å¤åˆ¶çš„æ–‡æœ¬å¯ä»¥é€šè¿‡Ctrl+Shift+vç²˜è´´åˆ°Bï¼Œä½†æ˜¯Bå†…å¤åˆ¶çš„å´ä¸èƒ½ä¸Aå…±äº«ã€‚</p><p>å¯èƒ½è¿™é‡Œä¼šé€ æˆä¸€ä¸ªç–‘æƒ‘ï¼šæ˜æ˜æˆ‘å¤åˆ¶sshçš„shellä¿¡æ¯ä¹Ÿå¯ä»¥ç²˜è´´å‡ºæ¥ã€‚å…¶å®è¿™é‡Œå¤åˆ¶å¤åˆ¶çš„æ˜¯ç»ˆç«¯ä¸Šçš„å­—ï¼Œå¹¶ä¸æ˜¯sshçš„shellå†…å¤åˆ¶ï¼Œè¿˜æ˜¯ç›¸å½“äºæœ¬æœºå¤åˆ¶ã€‚</p><p>è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡xselå·¥å…·åšéªŒè¯ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># A</span></span><br><span class="line">â¯ xsel --clipboard --output</span><br><span class="line"></span><br><span class="line">Linux troy-server 6.8.0-49-generic <span class="comment">#49~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Wed Nov  6 17:42:15 UTC 2 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">\ No newline at end of selection</span><br><span class="line"><span class="comment"># B</span></span><br><span class="line">â¯ xsel --clipboard --output    </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è™½ç„¶Aå¤åˆ¶çš„Bçš„ç»ˆç«¯è¾“å‡ºä¿¡æ¯ï¼Œä½†æ˜¯å´æ²¡æœ‰è¿›å…¥Bçš„å‰ªåˆ‡æ¿ï¼Œè€Œæ˜¯è¿›å…¥Açš„å‰ªåˆ‡æ¿ï¼Œè¯´æ˜å¤åˆ¶çš„æ˜¯ç»ˆç«¯ä¸Šçš„å­—ï¼Œå¹¶ä¸æ˜¯sshçš„shellå†…å¤åˆ¶ã€‚</p><p>å¦‚æœè¿™é‡Œåšä¸€ä¸ªå‡è®¾ï¼Œåœ¨Bçš„shellæ‰“å¼€ä¸€ä¸ªvimè¿›è¡Œå¤åˆ¶ï¼ˆå·²ç»é…ç½®å¥½vimå¤åˆ¶å†…å®¹è¿›å…¥å‰ªåˆ‡æ¿ï¼‰ï¼Œæ­¤æ—¶Bå¤åˆ¶çš„å†…å®¹Aè¿˜èƒ½ç²˜è´´å‡ºæ¥å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šä¸è¡Œçš„ï¼Œå› ä¸ºè¿›å…¥çš„æ˜¯Bçš„å‰ªåˆ‡æ¿è€Œä¸æ˜¯Açš„ã€‚</p><p>tmuxä¹Ÿæ˜¯åŒç†ï¼Œtmuxä¸­å¤åˆ¶è¿›å…¥çš„æ˜¯tmuxçš„buferï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é…ç½®æˆè¿›å…¥ç³»ç»Ÿå‰ªåˆ‡æ¿ã€‚ä½†æ— è®ºå¦‚ä½•ï¼Œå¼€åœ¨Bä¸Šé¢çš„tmuxæˆ–vimè¿›å…¥çš„éƒ½æ˜¯Bçš„ç³»ç»Ÿå‰ªåˆ‡æ¿ã€‚æ‰€ä»¥è¿™é‡Œè¦åšçš„å·¥ä½œå°±æ˜¯å°†Aå’ŒBçš„ç³»ç»Ÿå‰ªåˆ‡æ¿å…±äº«ã€‚</p><h2 id="X11è½¬å‘é…ç½®"><a href="#X11è½¬å‘é…ç½®" class="headerlink" title="X11è½¬å‘é…ç½®"></a>X11è½¬å‘é…ç½®</h2><p>é¦–å…ˆç¡®ä¿Bä¸Šé¢å®‰è£…äº†X11è½¯ä»¶åŒ…(å¦‚æœæ˜¯serverç‰ˆæœ¬å¯èƒ½å¹¶æ²¡æœ‰å®‰è£…)ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> apt install xorg xauth x11-apps xterm</span><br></pre></td></tr></table></figure><p>åœ¨Bä¸Šé¢ä¿®æ”¹<code>/etc/ssh/sshd_config</code>ä»¥æ”¯æŒX11è½¬å‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">X11Forwarding <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>é‡å¯sshdæœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯<span class="built_in">sudo</span> systemctl restart sshd</span><br></pre></td></tr></table></figure><p>åœ¨Aä¸Šé¢é€šè¿‡sshè¿æ¥å¯ç”¨X11è½¬å‘æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>æ–¹å¼1: <code>ssh -Y &lt;username&gt;@&lt;ip-addr&gt;</code></li><li>æ–¹å¼2: æ·»åŠ <code>ForwardX11 yes</code>åˆ°config</li></ul><p>æ­¤æ—¶ä»Aè¿›å…¥åˆ°Bçš„shellä¸­åï¼Œå°±å¯ä»¥è¿è¡Œå¦‚ä¸‹å‘½ä»¤æµ‹è¯•x11æ˜¯å¦è½¬å‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ xclock</span><br></pre></td></tr></table></figure><h2 id="ç›¸å…³é˜…è¯»"><a href="#ç›¸å…³é˜…è¯»" class="headerlink" title="ç›¸å…³é˜…è¯»"></a>ç›¸å…³é˜…è¯»</h2><p>åœ¨æœåŠ¡å™¨é…åˆè¿™ä¸¤ä¸ªæ–‡æ¡£åŸºæœ¬å¯ä»¥æ¨ªç€èµ°ï¼š</p><p><a href="https://blog.troy-y.org/2024/11/30/tmux%E5%A4%8D%E5%88%B6%E5%88%B0%E7%B3%BB%E7%BB%9F%E5%89%AA%E5%88%87%E6%9D%BF/">tmuxå¤åˆ¶åˆ°å‰ªåˆ‡æ¿</a><br><a href="https://blog.troy-y.org/2024/11/30/lazyvim%E5%A4%8D%E5%88%B6%E5%88%B0%E5%89%AA%E5%88%87%E6%9D%BF/">lazyvimå¤åˆ¶åˆ°å‰ªåˆ‡æ¿</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå‘½ä»¤è¡Œè¿è¡Œclash-verge</title>
      <link href="/2024/11/29/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%BF%90%E8%A1%8Cclash-verge/"/>
      <url>/2024/11/29/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%BF%90%E8%A1%8Cclash-verge/</url>
      
        <content type="html"><![CDATA[<p>ç”±äºå¤ªæ‡’ï¼Œä¸æƒ³é…ç½®clash coreæˆ–è€…mihomoï¼Œå°±ä¸‹äº†ä¸ªclash vergeï¼Œé…ç½®å¥½ä¹‹åæ–­æ‰æ˜¾ç¤ºå™¨å¯åŠ¨ç”µè„‘å´å‘ç°clash-vergeæ²¡æœ‰è¿è¡Œã€‚</p><p>åœ¨Linuxå‘½ä»¤è¡Œä¸­ï¼ˆtty, æ²¡æœ‰displayï¼‰æ˜¯æ— æ³•è¿è¡Œclash-vergeçš„ï¼Œå¦‚æœç›´æ¥è¿è¡Œï¼Œä¼šå‡ºç°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ clash-verge</span><br><span class="line"></span><br><span class="line">(clash-verge:4357): Gtk-WARNING **: 20:22:40.304: cannot open display:</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è™šæ‹Ÿæ˜¾ç¤ºå™¨è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> apt install xvfb</span><br><span class="line">â¯ Xvfb :1 -screen 0 1024x768x16 &amp;</span><br><span class="line">â¯ <span class="built_in">export</span> DISPLAY=:1 </span><br><span class="line">â¯ clash-verge &amp;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è¿˜ä¸èƒ½ç§‘å­¦ï¼Œéœ€è¦ç­‰å¾…1åˆ°3ç§’å·¦å³ï¼Œç­‰å¾…å®ŒæˆåæŸ¥è¯¢ç«¯å£æ˜¯å¦ç›‘å¬æˆåŠŸï¼ˆvergeç›‘å¬7897ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ netstat -tuln | grep 7897</span><br><span class="line"></span><br><span class="line">tcp        0      0 127.0.0.1:7897          0.0.0.0:*               LISTEN</span><br><span class="line">udp        0      0 127.0.0.1:7897          0.0.0.0:*</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntuç½‘çº¿è¿æ¥å¼€å‘æ¿åæ— æ³•ä¸Šç½‘</title>
      <link href="/2024/11/28/Ubuntu%E7%BD%91%E7%BA%BF%E8%BF%9E%E6%8E%A5%E5%BC%80%E5%8F%91%E6%9D%BF%E5%90%8E%E6%97%A0%E6%B3%95%E4%B8%8A%E7%BD%91/"/>
      <url>/2024/11/28/Ubuntu%E7%BD%91%E7%BA%BF%E8%BF%9E%E6%8E%A5%E5%BC%80%E5%8F%91%E6%9D%BF%E5%90%8E%E6%97%A0%E6%B3%95%E4%B8%8A%E7%BD%91/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ ip route</span><br><span class="line"></span><br><span class="line">default via 192.168.8.1 dev enx00e099a751b1 proto static metric 100</span><br><span class="line">default via 192.168.5.1 dev wlp1s0 proto dhcp metric 600</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å…¶ä¸­enx00e099a751b1æ˜¯è¿æ¥å¼€å‘æ¿çš„æœ‰çº¿ç½‘å¡ï¼Œwlp1s0æ˜¯æ— çº¿ç½‘å¡ã€‚<br>ä»–ä»¬ä¸¤ä¸ªéƒ½èµ°äº†defaultçš„é»˜è®¤è·¯ç”±ã€‚ä½†æ˜¯è¿æ¥å¼€å‘æ¿çš„æœ‰çº¿ç½‘å¡æ˜¯æ‰‹åŠ¨é…ç½®çš„é™æ€IPï¼Œè‚¯å®šä¸èƒ½ä¸Šç½‘çš„ï¼Œå¦‚æœç”±enx00e099a751b1å»è·¯ç”±æµé‡ï¼Œè‚¯å®šå°±ä¸èƒ½ä¸Šç½‘äº†ã€‚<br>æ‰€ä»¥æˆ‘ä»¬è¦åˆ é™¤è¿™ä¸ªè·¯ç”±ï¼Œå°†enx00e099a751b1åªè·¯ç”±192.168.8.xçš„æµé‡ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> ip route del default via 192.168.8.1 dev enx00e099a751b1</span><br><span class="line">â¯ <span class="built_in">sudo</span> ip route add 192.168.8.0/24 dev enx00e099a751b1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nextcloud aio + cloudflare tunnel</title>
      <link href="/2024/11/23/nextcloud-aio-cloudflare-tunnel/"/>
      <url>/2024/11/23/nextcloud-aio-cloudflare-tunnel/</url>
      
        <content type="html"><![CDATA[<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://blog.laoda.de/archives/docker-compose-install-nextcloud-aio">https://blog.laoda.de/archives/docker-compose-install-nextcloud-aio</a><br><a href="https://github.com/nextcloud/all-in-one">https://github.com/nextcloud/all-in-one</a><br><a href="https://github.com/nextcloud/all-in-one#how-to-change-the-default-location-of-nextclouds-datadir">https://github.com/nextcloud/all-in-one#how-to-change-the-default-location-of-nextclouds-datadir</a><br><a href="https://github.com/nextcloud/all-in-one/blob/main/reverse-proxy.md">https://github.com/nextcloud/all-in-one/blob/main/reverse-proxy.md</a><br><a href="https://help.nextcloud.com/t/using-nextcloud-aio-via-cloudflare-argo-tunnel/141376/4">https://help.nextcloud.com/t/using-nextcloud-aio-via-cloudflare-argo-tunnel/141376/4</a><br><a href="https://github.com/nextcloud/all-in-one/discussions/2845">https://github.com/nextcloud/all-in-one/discussions/2845</a><br><a href="https://github.com/nextcloud/all-in-one#how-to-run-nextcloud-behind-a-cloudflare-tunnel">https://github.com/nextcloud/all-in-one#how-to-run-nextcloud-behind-a-cloudflare-tunnel</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Google cloud consoleå…è´¹shellç©æ³•</title>
      <link href="/2024/10/31/Goold-cloud-consle%E5%85%8D%E8%B4%B9shell%E7%8E%A9%E6%B3%95/"/>
      <url>/2024/10/31/Goold-cloud-consle%E5%85%8D%E8%B4%B9shell%E7%8E%A9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="Prep"><a href="#Prep" class="headerlink" title="Prep"></a>Prep</h2><p>Google cloud consoleæˆ‘å¹¶ä¸æ¸…æ¥šæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œç”±<a href="https://github.com/per1cycle">percycle</a>æä¾›ç»™æˆ‘ã€‚ç›´åˆ°ç°åœ¨ï¼Œæˆ‘åªçŸ¥é“æˆ‘èƒ½é€šè¿‡å®ƒåˆ›å»º12ä¸ªshellé…é¢ã€‚</p><p>æ­¤<code>shell</code>è¿è¡Œåœ¨<code>docker</code>ä¸­ï¼Œå¹¶æ²¡æœ‰æä¾›<code>å…¬ç½‘IP</code>ï¼Œè¿™æ„å‘³ç€å¯ç©æ€§å¤§å¤§é™ä½ï¼Œä¸èƒ½å½“ä½œ<code>server</code>ä½¿ç”¨ã€‚</p><p>ç›®å‰å·²çŸ¥çš„ç©æ³•ï¼š</p><ul><li>Tailscale exit node</li></ul><p>Link here: <a href="https://console.cloud.google.com/">https://console.cloud.google.com/</a></p><p><strong>PS:æœ¬æ–‡å‡è®¾æ‚¨å·²ç»æ³¨å†Œäº†tailscaleå¹¶ä¸”äº†è§£tailscaleä¸tailscale exit nodeæ˜¯ä»€ä¹ˆ</strong></p><h2 id="Tailscale"><a href="#Tailscale" class="headerlink" title="Tailscale"></a>Tailscale</h2><p>é¦–å…ˆåˆ›å»ºæ­¤æ–‡ä»¶ä»¥æ‘†è„±çƒ¦äººçš„è­¦å‘Šï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p ~/.cloudshell/</span><br><span class="line">$ <span class="built_in">touch</span> ~/.cloudshell/no-apt-get-warning</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…tailscale:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -fsSL https://tailscale.com/install.sh | sh</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æ”¶åˆ°è°ƒç”¨<code>tailscale up</code>è¿›è¡Œç™»é™†ï¼Œä½†è¿™é‡Œä¸è¦ç›´æ¥ä½¿ç”¨è¯¥å‘½ä»¤ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä½œä¸º<code>exit node</code>ä½¿ç”¨ï¼Œæ‰€ä»¥è¦é€šè¿‡å¦‚ä¸‹å‘½ä»¤:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> tailscale up --advertise-exit-node</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¯¥å‘½ä»¤ååº”è¯¥ä¼šæ”¶åˆ°ä¸€æ¡æç¤ºï¼Œæç¤º<code>tailscaled</code>å¹¶æ²¡æœ‰è¿è¡Œï¼Œè¿™å¯èƒ½æ˜¯å› ä¸º<code>tailscaled</code>é»˜è®¤ä½¿ç”¨<code>systemd</code>å¯åŠ¨ï¼Œè€Œè¿™ä¸ªå®¹å™¨å¹¶æ²¡æœ‰æä¾›<code>systemd</code>ã€‚</p><p>å¯ä»¥ç›´æ¥è°ƒç”¨<code>tailscaled</code>æˆ–è€…ä½¿ç”¨<code>service</code>å¯åŠ¨ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> tailscaled</span><br><span class="line"><span class="comment"># $ sudo service tailscaled start</span></span><br></pre></td></tr></table></figure><p>é‡æ–°è¿è¡Œupå‘½ä»¤ï¼Œæ­¤æ—¶åº”è¯¥æ”¶åˆ°ä¸€æ¡æç¤ºç™»å½•çš„æ¶ˆæ¯ï¼Œåœ¨ç”µè„‘ä¸Šæ‰“å¼€è¯¥é“¾æ¥è¿›è¡Œç™»å½•ã€‚</p><p>ç™»å½•ä¹‹åéœ€è¦åœ¨<code>tailscale</code>æ§åˆ¶å°æ‰“å¼€è¯¥<code>exit node</code>ï¼š</p><p><a href="https://postimg.cc/k2m5Yh4G"><img src="https://i.postimg.cc/7ZCT6Fr3/2024-10-31-23-03-38.png" alt="2024-10-31-23-03-38.png"></a></p><p><a href="https://postimg.cc/gXQzVgQY"><img src="https://i.postimg.cc/gjkxP5K6/2024-10-31-23-04-11.png" alt="2024-10-31-23-04-11.png"></a></p><p>æ­¤æ—¶å°±åº”è¯¥å°†æµé‡è½¬å‘åˆ°<code>exit node</code>äº†ï¼Œè¿™ä¸ªå®¹å™¨åº”è¯¥ä¼šæ ¹æ®ä½ å¼€çš„æ¢¯çš„IPåœ°å€æ‰€å¼€å¯ï¼Œæˆ‘å¼€çš„æ˜¯å°æ¹¾çš„æ¢¯ï¼Œå®¹å™¨å°±æ˜¯å°æ¹¾çš„ã€‚è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡<code>ip138</code>ç¡®è®¤æ˜¯å¦æµé‡è½¬å‘æˆåŠŸ:</p><p><a href="https://postimg.cc/PNDTGz0w"><img src="https://i.postimg.cc/2jc6Z0w2/2024-10-31-22-17-23.png" alt="2024-10-31-22-17-23.png"></a></p><p>æ­¤å¤–ï¼Œè¯¥å®¹å™¨æ²¡æœ‰å¤–ç½‘ipï¼Œå¯ä»¥ä½¿ç”¨<code>tailscale</code>æä¾›çš„å±€åŸŸç½‘ipè¿›è¡Œè¿æ¥ï¼Œä¸è¿‡å…³é—­äº†å¯†ç è¿æ¥ï¼Œæˆ‘ä»¬ä¹Ÿä¸çŸ¥é“å¯†ç ã€‚å¯ä»¥ä½¿ç”¨<code>ssh key</code>è¿›è¡Œè¿æ¥ï¼Œè¿™ç‚¹æ˜¯å¾ˆé€šå¸¸çš„æ“ä½œï¼Œæˆ‘ç•™ç»™ä½ å»è‡ªå·±å®Œæˆã€‚</p><p>æä¾›æˆåŠŸ<code>ssh</code>æˆªå›¾ï¼š</p><p><a href="https://postimg.cc/kB4rJQps"><img src="https://i.postimg.cc/CLCw4JC3/2024-10-31-22-39-31.png" alt="2024-10-31-22-39-31.png"></a></p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://tailscale.com/download">https://tailscale.com/download</a><br><a href="https://tailscale.com/kb/1103/exit-nodes?tab=linux">https://tailscale.com/kb/1103/exit-nodes?tab=linux</a></p>]]></content>
      
      
      <categories>
          
          <category> network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568åˆ·å†™openharmony4.1</title>
      <link href="/2024/10/29/rk3568%E5%88%B7%E5%86%99openharmony4-1/"/>
      <url>/2024/10/29/rk3568%E5%88%B7%E5%86%99openharmony4-1/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> upgrade_tool di -p parameter.txt</span><br><span class="line"><span class="built_in">sudo</span> upgrade_tool UL MiniLoaderAll.bin -noreset</span><br><span class="line"><span class="built_in">sudo</span> upgrade_tool di -u uboot.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -boot_linux boot_linux.img&amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -system system.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -vendor vendor.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -userdata userdata.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -ramdisk ramdisk.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -resource resource.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -sys-prod sys_prod.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -chip-prod chip_prod.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -eng_system eng_system.img&amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -updater updater.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -chip_ckm chip_ckm.img</span><br><span class="line"><span class="built_in">sudo</span> upgrade_tool rd </span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> openHarmony </tag>
            
            <tag> rk3568 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu22.04.4LTSå®‰è£…AMDæ˜¾å¡é©±åŠ¨</title>
      <link href="/2024/10/05/Ubuntu22-04-4LTS%E5%AE%89%E8%A3%85AMD%E6%98%BE%E5%8D%A1%E9%A9%B1%E5%8A%A8/"/>
      <url>/2024/10/05/Ubuntu22-04-4LTS%E5%AE%89%E8%A3%85AMD%E6%98%BE%E5%8D%A1%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<p>AMD 7840HS core GPU driver: <a href="https://github.com/TroyMitchell911/Ubuntu-config/blob/main/deb/amdgpu-install_6.1.60103-1_all.deb">https://github.com/TroyMitchell911/Ubuntu-config/blob/main/deb/amdgpu-install_6.1.60103-1_all.deb</a> </p>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[TMUX]å¤åˆ¶å†…å®¹åˆ°ç³»ç»Ÿå‰ªåˆ‡æ¿</title>
      <link href="/2024/10/05/TMUX-%E5%A4%8D%E5%88%B6%E5%86%85%E5%AE%B9%E5%88%B0%E7%B3%BB%E7%BB%9F%E5%89%AA%E5%88%87%E6%9D%BF/"/>
      <url>/2024/10/05/TMUX-%E5%A4%8D%E5%88%B6%E5%86%85%E5%AE%B9%E5%88%B0%E7%B3%BB%E7%BB%9F%E5%89%AA%E5%88%87%E6%9D%BF/</url>
      
        <content type="html"><![CDATA[<p>å®‰è£…è½¯ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install xclip  <span class="comment"># æˆ–è€…ä½¿ç”¨ xsel</span></span><br></pre></td></tr></table></figure><p>åœ¨&#96;&#96;ï½&#x2F;.tmux.conf<code>æˆ–è€…</code>~&#x2F;.tmux.conf.local&#96;ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel <span class="string">&quot;xclip -sel clip -i&quot;</span></span><br></pre></td></tr></table></figure><p>é‡æ–°åŠ è½½<code>tmux</code>é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tmux source-file ~/.tmux.conf</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> tmux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[VIM]plug coc.nvim</title>
      <link href="/2024/10/03/VIM-plug-coc-nvim-1/"/>
      <url>/2024/10/03/VIM-plug-coc-nvim-1/</url>
      
        <content type="html"><![CDATA[<p>åœ¨coc.nvimæ›´æ–°åˆ°0.0.82ä¹‹åï¼Œshortcutæ˜ å°„æ–¹å¼æ”¹å˜ã€‚</p><p>.vimrcé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span>! CheckBackSpace() abort</span><br><span class="line">  <span class="built_in">let</span> col = col(<span class="string">&#x27;.&#x27;</span>) - 1</span><br><span class="line">  <span class="built_in">return</span> !col || getline(<span class="string">&#x27;.&#x27;</span>)[col - 1]  =~ <span class="string">&#x27;\s&#x27;</span></span><br><span class="line">endfunction</span><br><span class="line">inoremap &lt;silent&gt;&lt;<span class="built_in">expr</span>&gt; &lt;TAB&gt;</span><br><span class="line">      \ coc#pum#visible() ? coc#pum#next(1):</span><br><span class="line">      \ CheckBackSpace() ? <span class="string">&quot;\&lt;Tab&gt;&quot;</span> :</span><br><span class="line">      \ coc#refresh()</span><br><span class="line">inoremap &lt;<span class="built_in">expr</span>&gt;&lt;S-TAB&gt; coc#pum#visible() ? coc#pum#prev(1) : <span class="string">&quot;\&lt;C-h&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot; below is for using ENTER for completion, I actually don&#x27;t like it, CTRL+Y works better for me, you can omit this part if you are like me</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">inoremap &lt;silent&gt;&lt;expr&gt; &lt;cr&gt; coc#pum#visible() &amp;&amp; coc#pum#info()[&#x27;index&#x27;] != -1 ? coc#pum#confirm() :</span></span><br><span class="line"><span class="string">        \ &quot;</span>\&lt;C-g&gt;u\&lt;CR&gt;\&lt;c-r&gt;=coc#on_enter()\&lt;CR&gt;<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•å°†sdå¡æˆ–è€…emmcé•œåƒå¯¼å‡º</title>
      <link href="/2024/09/21/%E5%A6%82%E4%BD%95%E5%B0%86sd%E5%8D%A1%E6%88%96%E8%80%85emmc%E9%95%9C%E5%83%8F%E5%AF%BC%E5%87%BA/"/>
      <url>/2024/09/21/%E5%A6%82%E4%BD%95%E5%B0%86sd%E5%8D%A1%E6%88%96%E8%80%85emmc%E9%95%9C%E5%83%8F%E5%AF%BC%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="SDå¡"><a href="#SDå¡" class="headerlink" title="SDå¡"></a>SDå¡</h2><p>æ’å…¥<code>sdå¡</code>åï¼Œä¼šåœ¨<code>/dev</code>ä¸‹çœ‹åˆ°<code>sdX</code>çš„æ–‡ä»¶ï¼Œæˆ‘è¿™é‡Œæ˜¯<code>sdb</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> /dev/sdb*</span><br><span class="line">/dev/sdb  /dev/sdb1  /dev/sdb2</span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªä¿¡æ¯å¯ä»¥çŸ¥é“é•œåƒè‡³å°‘åˆ†åŒºä¸ºäº†<code>boot</code>å’Œ<code>rootfsåˆ†åŒº</code>.</p><p>ä½¿ç”¨ddå‘½ä»¤å¯¼å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdb of=sd.img bs=4M status=progress</span><br><span class="line">[<span class="built_in">sudo</span>] troy çš„å¯†ç ï¼š </span><br><span class="line">63753420800å­—èŠ‚ï¼ˆ64 GBï¼Œ59 GiBï¼‰å·²å¤åˆ¶ï¼Œ652 sï¼Œ97.8 MB/s </span><br><span class="line">è®°å½•äº†15218+1 çš„è¯»å…¥</span><br><span class="line">è®°å½•äº†15218+1 çš„å†™å‡º</span><br><span class="line">63831015424å­—èŠ‚ï¼ˆ64 GBï¼Œ59 GiBï¼‰å·²å¤åˆ¶ï¼Œ653.304 sï¼Œ97.7 MB/s</span><br></pre></td></tr></table></figure><p>å¯¼å‡ºåéœ€è¦<a href="##%E7%BC%A9%E5%87%8F%E5%88%86%E5%8C%BA">ç¼©å‡åˆ†åŒº</a></p><h2 id="EMMC"><a href="#EMMC" class="headerlink" title="EMMC"></a>EMMC</h2><p>å¯¹äºEMMCæ“ä½œå¤æ‚ä¸€äº›ï¼Œéœ€è¦ä¿®æ”¹ubootï¼Œæ‰“å¼€CONFIG_CMD_USB_MASS_STORAGEçš„é…ç½®é¡¹ã€‚</p><p>è¿›å…¥felæ¨¡å¼å°†ubootä¸‹è½½è¿›å…¥å†…å­˜å¹¶è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> sunxi-fel uboot ./u-boot-sunxi-with-spl.bin</span><br></pre></td></tr></table></figure><p>åœ¨ubootè‡ªåŠ¨å¯åŠ¨å†…æ ¸å‰æ‰“æ–­ï¼Œå¹¶ä¸”è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; ums 2 mmc 1</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤æ˜¯å°†mmcçš„1å·è®¾å¤‡é€šè¿‡usb 2å·æŒ‚è½½å‡ºå»ã€‚å°±ç›¸å½“äºç”µè„‘æ’äº†ä¸ªUç›˜ã€‚</p><p>æˆ‘è¿™é‡Œmmcçš„1å·è®¾å¤‡æ˜¯emmcï¼Œusb2å·æ˜¯otgæ¥å£ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ã€‚</p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯æŸ¥è¯¢å¯¹åº”çš„æ¥å£å·ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; mmc list</span><br><span class="line">=&gt; usb tree</span><br><span class="line"><span class="comment"># æˆ–è€…æ˜¯usb info</span></span><br></pre></td></tr></table></figure><p>ç„¶åç”µè„‘å°±èƒ½çœ‹åˆ°äº†<code>/dev/sdX</code>ï¼Œéšåçš„æ“ä½œä¸SDå¡ç›¸åŒã€‚</p><h2 id="ç¼©å‡åˆ†åŒº"><a href="#ç¼©å‡åˆ†åŒº" class="headerlink" title="ç¼©å‡åˆ†åŒº"></a>ç¼©å‡åˆ†åŒº</h2><p>ç”±äºé•œåƒä¸­æœ‰å¤šä¸ªåˆ†åŒºï¼Œæ‰€ä»¥å…ˆå…³è”åˆ°å›ç¯è®¾å¤‡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> losetup -Pf sd.img</span><br><span class="line">â¯ <span class="built_in">ls</span> /dev/loop*p*</span><br><span class="line">/dev/loop15p1  /dev/loop15p2</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æŒ‚å‡ºæ¥äº†ä¸¤ä¸ªåˆ†åŒºï¼Œ<code>p1</code>æ˜¯<code>boot</code>ï¼Œ<code>p2</code>æ˜¯<code>rootfs</code>ï¼Œæˆ‘ä»¬ä»…éœ€è¦å°†rootfsåˆ†åŒºç¼©å‡ï¼Œå› ä¸ºä»–æ˜¯å¤§å¤´ã€‚</p><p>æ‰“å¼€<code>Ubuntu</code>è‡ªå¸¦çš„ç£ç›˜å·¥å…·ï¼Œè°ƒæ•´<code>rootfs</code>å¤§å°ä¸ºæœ€å°:</p><p><a href="https://postimg.cc/mtbsrLJx"><img src="https://i.postimg.cc/yYRYvWTN/2024-09-21-11-30-46.png" alt="2024-09-21-11-30-46.png"></a></p><p>è°ƒæ•´å®Œæˆåå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><a href="https://postimg.cc/XGSM64dz"><img src="https://i.postimg.cc/ZR0J3qR4/2024-09-21-11-32-23.png" alt="2024-09-21-11-32-23.png"></a></p><p>å·²ç»æˆåŠŸè°ƒæ•´äº†åˆ†åŒº <code>/dev/loop15p2</code> çš„å¤§å°åˆ° 1.7GBï¼Œä½† <code>sd.img</code> ä»ç„¶ä¿æŒ 60GBï¼ŒåŸå› æ˜¯æ–‡ä»¶ç³»ç»Ÿå’Œåˆ†åŒºçš„å¤§å°ç¡®å®å·²ç»æ”¹å˜ï¼Œä½†é•œåƒæ–‡ä»¶æœ¬èº«çš„å¤§å°å¹¶æ²¡æœ‰è‡ªåŠ¨ç¼©å‡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> fdisk -l /dev/loop15</span><br><span class="line">Disk /dev/loop15ï¼š59.45 GiBï¼Œ63831015424 å­—èŠ‚ï¼Œ124669952 ä¸ªæ‰‡åŒº</span><br><span class="line">å•å…ƒï¼šæ‰‡åŒº / 1 * 512 = 512 å­—èŠ‚</span><br><span class="line">æ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚</span><br><span class="line">I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚</span><br><span class="line">ç£ç›˜æ ‡ç­¾ç±»å‹ï¼šdos</span><br><span class="line">ç£ç›˜æ ‡è¯†ç¬¦ï¼š0x8c4a4ad7</span><br><span class="line"></span><br><span class="line">è®¾å¤‡          å¯åŠ¨  èµ·ç‚¹    æœ«å°¾    æ‰‡åŒº  å¤§å° Id ç±»å‹</span><br><span class="line">/dev/loop15p1       2048   67583   65536   32M  6 FAT16</span><br><span class="line">/dev/loop15p2      67584 3588095 3520512  1.7G 83 Linux</span><br><span class="line">â¯ <span class="built_in">ls</span> -lh sd.img</span><br><span class="line">-rw-r--r-- 1 root root 60G  9æœˆ 21 11:31 sd.img</span><br></pre></td></tr></table></figure><p>éœ€è¦æ‰‹åŠ¨ç¼©å‡é•œåƒæ–‡ä»¶çš„å¤§å°ï¼Œä½¿å…¶åŒ¹é…å®é™…ä½¿ç”¨çš„åˆ†åŒºå¤§å°ã€‚</p><p> <code>/dev/loop15p2</code> çš„ç»“æŸä½ç½®æ˜¯æ‰‡åŒº <code>3588095</code>ï¼Œé•œåƒæ–‡ä»¶çš„å¤§å°å¯ä»¥é€šè¿‡è¿™ä¸ªç»“æŸä½ç½®æ¥ç¡®å®šã€‚</p><p>ç”±äºæ¯ä¸ªæ‰‡åŒºå¤§å°ä¸º 512 å­—èŠ‚ï¼Œå¯ä»¥è®¡ç®—å‡ºæ–°çš„é•œåƒæ–‡ä»¶å¤§å°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ–°é•œåƒå¤§å° = (æœ€åä¸€ä¸ªæ‰‡åŒºå· + 1) * æ‰‡åŒºå¤§å°</span><br></pre></td></tr></table></figure><p>æœ€åä¸€ä¸ªæ‰‡åŒºæ˜¯ <code>3588095</code>ï¼Œæ‰€ä»¥æ–°çš„é•œåƒå¤§å°ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ–°é•œåƒå¤§å° = (3588095 + 1) * 512 = 1838080512 å­—èŠ‚</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>truncate</code>ç¼©å‡é•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> <span class="built_in">truncate</span> --size=$(( (<span class="number">3588095</span> + <span class="number">1</span>) * <span class="number">512</span> )) sd.img</span><br><span class="line">â¯ <span class="built_in">ls</span> -lh sd.img</span><br><span class="line">-rw-r--r-- 1 root root 1.8G  9æœˆ 21 11:35 sd.img</span><br></pre></td></tr></table></figure><p>å®Œæˆåè§£é™¤å›ç¯è®¾å¤‡å…³è”ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> losetup -d /dev/loop15</span><br></pre></td></tr></table></figure><h2 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h2><p>å°†åˆšæ‰åˆ¶ä½œå¥½çš„é•œåƒçƒ§å†™è¿›å…¥ï¼Œè¿™é‡Œä»¥sdå¡ä¸ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> <span class="built_in">dd</span> <span class="keyword">if</span>=sd.img of=/dev/sdb status=progress</span><br><span class="line">1827463680å­—èŠ‚ï¼ˆ1.8 GBï¼Œ1.7 GiBï¼‰å·²å¤åˆ¶ï¼Œ230 sï¼Œ7.9 MB/s </span><br><span class="line">è®°å½•äº†3588096+0 çš„è¯»å…¥</span><br><span class="line">è®°å½•äº†3588096+0 çš„å†™å‡º</span><br><span class="line">1837105152å­—èŠ‚ï¼ˆ1.8 GBï¼Œ1.7 GiBï¼‰å·²å¤åˆ¶ï¼Œ230.959 sï¼Œ8.0 MB/s</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ç³»ç»ŸæŸ¥çœ‹æ˜¯å¦æ­£ç¡®ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@a33-vstar:~# lsblk</span><br><span class="line">NAME         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS</span><br><span class="line">mmcblk0      179:0    0 59.4G  0 disk </span><br><span class="line">â”œâ”€mmcblk0p1  179:1    0   32M  0 part </span><br><span class="line">â””â”€mmcblk0p2  179:2    0  1.7G  0 part /</span><br><span class="line">mmcblk1      179:8    0  3.7G  0 disk </span><br><span class="line">â”œâ”€mmcblk1p1  179:9    0   32M  0 part </span><br><span class="line">â””â”€mmcblk1p2  179:10   0  3.7G  0 part </span><br><span class="line">mmcblk1boot0 179:16   0    2M  1 disk </span><br><span class="line">mmcblk1boot1 179:24   0    2M  1 disk </span><br><span class="line">root@a33-vstar:~# <span class="built_in">df</span> -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/root       1.4G  568M  741M  44% /</span><br><span class="line">tmpfs           232M     0  232M   0% /dev/shm</span><br><span class="line">tmpfs            93M  2.8M   90M   3% /run</span><br><span class="line">tmpfs           5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs            47M     0   47M   0% /run/user/0</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°mmcblk0p2ç¡®å®å˜æˆäº†1.7Gï¼Œä½†æ˜¯å‰©ä½™çš„ç©ºé—´å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°ï¼Œæ­¤æ—¶å°±éœ€è¦æ‰©å±•æ–‡ä»¶ç³»ç»Ÿåˆ†åŒºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@a33-vstar:~# <span class="built_in">sudo</span> parted /dev/mmcblk0 --script resizepart 2 100%</span><br><span class="line">Kernel not configured <span class="keyword">for</span> semaphores (System V IPC). Not using udev synchronisation code.</span><br><span class="line">root@a33-vstar:~# <span class="built_in">sudo</span> resize2fs /dev/mmcblk0p2</span><br><span class="line">resize2fs 1.46.5 (30-Dec-2021)</span><br><span class="line">Filesystem at /dev/mmcblk0p2 is mounted on /; on-line resizing required</span><br><span class="line">old_desc_blocks = 1, new_desc_blocks = 4</span><br><span class="line">The filesystem on /dev/mmcblk0p2 is now 15575296 (4k) blocks long.</span><br><span class="line">root@a33-vstar:~# lsblk</span><br><span class="line">NAME         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS</span><br><span class="line">mmcblk0      179:0    0 59.4G  0 disk </span><br><span class="line">â”œâ”€mmcblk0p1  179:1    0   32M  0 part </span><br><span class="line">â””â”€mmcblk0p2  179:2    0 59.4G  0 part /</span><br><span class="line">mmcblk1      179:8    0  3.7G  0 disk </span><br><span class="line">â”œâ”€mmcblk1p1  179:9    0   32M  0 part </span><br><span class="line">â””â”€mmcblk1p2  179:10   0  3.7G  0 part </span><br><span class="line">mmcblk1boot0 179:16   0    2M  1 disk </span><br><span class="line">mmcblk1boot1 179:24   0    2M  1 disk</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
            <tag> linux </tag>
            
            <tag> kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[rootfs]åˆ¶ä½œUbuntuæ ¹æ–‡ä»¶ç³»ç»Ÿ</title>
      <link href="/2024/09/20/rootfs-%E5%88%B6%E4%BD%9CUbuntu%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
      <url>/2024/09/20/rootfs-%E5%88%B6%E4%BD%9CUbuntu%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<p><strong>Requirements</strong></p><ol><li>An x86_64 machine with Ubuntu or another Linux distribution installed.</li><li><code>debootstrap</code> tool.</li><li>Internet connection.</li><li>Basic knowledge of using the terminal.</li></ol><p><strong>Steps to Create Ubuntu 20.04 Rootfs for ARMhf</strong></p><p><strong>1. Install Required Tools</strong></p><p>First, ensure that <code>debootstrap</code> and <code>qemu-user-static</code> are installed. <code>qemu-user-static</code> allows you to run ARM binaries on your x86_64 machine.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install debootstrap qemu-user-static</span><br></pre></td></tr></table></figure><p><strong>2. Create a Directory for the Rootfs</strong></p><p>Create a directory where the root filesystem will be built.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p ~/ubuntu-armhf-rootfs</span><br></pre></td></tr></table></figure><p><strong>3. Run Debootstrap</strong></p><p>Use <code>debootstrap</code> to create the root filesystem. Specify the architecture (<code>armhf</code>), the Ubuntu release (<code>focal</code>), and the target directory.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo debootstrap --arch=armhf --foreign focal ./ubuntu-armhf-rootfs https://mirrors.bfsu.edu.cn/ubuntu-ports/</span><br></pre></td></tr></table></figure><p><strong>4. Copy QEMU Binary</strong></p><p>Copy the <code>qemu-arm-static</code> binary into the <code>usr/bin</code> directory of the new rootfs to enable emulation.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo cp /usr/bin/qemu-arm-static ./ubuntu-armhf-rootfs/usr/bin/</span><br></pre></td></tr></table></figure><p><strong>5. Chroot into the New Rootfs</strong></p><p>Change root into the new root filesystem to complete the second stage of debootstrap.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo chroot ./ubuntu-armhf-rootfs</span><br></pre></td></tr></table></figure><p><strong>6. Complete Debootstrap Second Stage</strong></p><p>Inside the chroot environment, run the second stage of debootstrap.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/debootstrap/debootstrap --second-stage</span><br></pre></td></tr></table></figure><p><strong>7. Configure the Rootfs</strong></p><p>Now configure the basic settings of your new root filesystem.</p><p>- <strong>Set the hostname:</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;ubuntu-armhf&quot; &gt; /etc/hostname</span><br></pre></td></tr></table></figure><p>- <strong>Set up the hosts file:</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOL &gt; /etc/hosts</span><br><span class="line">127.0.0.1   localhost</span><br><span class="line">127.0.1.1   ubuntu-armhf</span><br><span class="line">EOL</span><br></pre></td></tr></table></figure><p>- <strong>Create fstab:</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOL &gt; /etc/fstab</span><br><span class="line">proc            /proc           proc    defaults        0       0</span><br><span class="line">sysfs           /sys            sysfs   defaults        0       0</span><br><span class="line">devpts          /dev/pts        devpts  gid=5,mode=620  0       0</span><br><span class="line">tmpfs           /run            tmpfs   defaults        0       0</span><br><span class="line">tmpfs           /run/lock       tmpfs   nodev,nosuid,noexec 0   0</span><br><span class="line">EOL</span><br></pre></td></tr></table></figure><p>- <strong>Set up networking:</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOL &gt; /etc/network/interfaces</span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet dhcp</span><br><span class="line">EOL</span><br></pre></td></tr></table></figure><p>- <strong>Set the root password:</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">passwd</span><br></pre></td></tr></table></figure><p>- <strong>Create a user:</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">adduser ubuntu</span><br><span class="line">usermod -aG sudo ubuntu</span><br></pre></td></tr></table></figure><p>- <strong>Install essential packages:</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install sudo nano ssh net-tools network-manager usbutils</span><br></pre></td></tr></table></figure><p><strong>8. Exit the Chroot</strong></p><p>Exit the chroot environment.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure><p><strong>9. Clean Up</strong></p><p>Remove the <code>qemu-arm-static</code> binary from the rootfs.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo rm ./ubuntu-armhf-rootfs/usr/bin/qemu-arm-static</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[å…¨å¿—A33-Vstar]Kernel</title>
      <link href="/2024/09/20/%E5%85%A8%E5%BF%97A33-Vstar-Kernel/"/>
      <url>/2024/09/20/%E5%85%A8%E5%BF%97A33-Vstar-Kernel/</url>
      
        <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ç« åŸºäºè¯¥ubootå¯åŠ¨</strong>ï¼š<a href="https://blog.troy-y.org/2024/09/13/%E5%85%A8%E5%BF%97A33-Uboot/">ä¼ é€é—¨</a></p><h2 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h2><p>cpu: allwinner a33<br>board: vstar<br>host: ubuntu 22.04</p><p>éœ€è¦å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> apt install gcc-arm-none-eabi</span><br></pre></td></tr></table></figure><h2 id="mainline"><a href="#mainline" class="headerlink" title="mainline"></a>mainline</h2><p>é¦–å…ˆä¸‹è½½ä¸»çº¿kernelçš„æºç ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git <span class="built_in">clone</span> git@github.com:torvalds/linux.git</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶çš„è¯ï¼Œåœ¨<code>arch/arm/configs</code>ç›®å½•ä¸‹åªæœ‰ä¸€ä¸ª<code>sunxi_defconfig</code>æ˜¯æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨çš„ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä½œä¸ºåŸºå‡†ã€‚</p><p>è®¾å¤‡æ ‘å°±é€‰æ‹©sinlinxçš„ï¼Œä¸vstarå¼€å‘æ¿ç›¸è¿‘ã€‚</p><p>ä¸ubootå¥—è·¯ç±»ä¼¼ï¼Œå…ˆæ‹·è´ä¸€ä»½é…ç½®æ–‡ä»¶å’Œè®¾å¤‡æ ‘ä½œä¸ºvstarå¼€å‘æ¿çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cp</span> <span class="built_in">arch</span>/arm/configs/sunxi_defconfig <span class="built_in">arch</span>/arm/configs/a33_vstar_defconfig</span><br><span class="line">â¯ <span class="built_in">cp</span> <span class="built_in">arch</span>/arm/boot/dts/allwinner/sun8i-a33-sinlinx-sina33.dts <span class="built_in">arch</span>/arm/boot/dts/allwinner/sun8i-a33-vstar.dts</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹Makefileæ”¯æŒè¯¥è®¾å¤‡æ ‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">diff --git a/arch/arm/boot/dts/allwinner/Makefile b/arch/arm/boot/dts/allwinner/Makefile</span><br><span class="line">index cd0d044882cf..d548f4a2621a 100644</span><br><span class="line">--- a/arch/arm/boot/dts/allwinner/Makefile</span><br><span class="line">+++ b/arch/arm/boot/dts/allwinner/Makefile</span><br><span class="line">@@ -215,6 +215,7 @@ dtb-$(CONFIG_MACH_SUN8I) += \</span><br><span class="line">        sun8i-a33-olinuxino.dtb \</span><br><span class="line">        sun8i-a33-q8-tablet.dtb \</span><br><span class="line">        sun8i-a33-sinlinx-sina33.dtb \</span><br><span class="line">+       sun8i-a33-vstar.dtb \</span><br><span class="line">        sun8i-a83t-allwinner-h8homlet-v2.dtb \</span><br><span class="line">        sun8i-a83t-bananapi-m3.dtb \</span><br><span class="line">        sun8i-a83t-cubietruck-plus.dtb \</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨åˆšæ‰æ‹·è´çš„é…ç½®æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- a33_vstar_defconfig</span><br><span class="line">â¯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é•œåƒæ–‡ä»¶å’Œè®¾å¤‡æ ‘éƒ½å·²ç»ç”Ÿæˆï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> <span class="built_in">arch</span>/arm/boot/zImage</span><br><span class="line"><span class="built_in">arch</span>/arm/boot/zImage</span><br><span class="line">â¯ <span class="built_in">ls</span> <span class="built_in">arch</span>/arm/boot/dts/allwinner/sun8i-a33-vstar.dtb</span><br><span class="line"><span class="built_in">arch</span>/arm/boot/dts/allwinner/sun8i-a33-vstar.dtb</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<a href="https://blog.troy-y.org/2024/09/20/sd%E4%B8%8Emmc%E5%88%B7%E5%86%99%E6%8C%87%E5%8D%97/">è¿™ç¯‡æ–‡ç« </a>çš„æŠ€å·§å°†kernelå’Œdtbè£…å…¥sdå¡bootåˆ†åŒºï¼Œè£…å…¥emmcçš„bootåˆ†åŒºä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p><strong>PSï¼šå…¶å®è¿™é‡Œä½¿ç”¨tftpæ›´åŠ åˆç†ï¼Œä½†åœ¨å®¶ä¸­æ²¡æœ‰ç½‘å£ç¯å¢ƒï¼Œæ‰€ä»¥åªèƒ½é€€è€Œæ±‚å…¶æ¬¡è¿™æ ·è°ƒè¯•äº†ã€‚</strong></p><p>åœ¨ubootä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹bootåˆ†åŒºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; fatls mmc 0:1</span><br><span class="line">    65536   uboot.env</span><br><span class="line">    23345   sun8i-a33-vstar.dtb</span><br><span class="line">  5496008   zImage</span><br><span class="line"></span><br><span class="line">3 file(s), 0 <span class="built_in">dir</span>(s)</span><br></pre></td></tr></table></figure><p>ç°åœ¨æ–‡ä»¶å·²ç»è£…å¥½äº†ï¼Œå°±å·®è£…è½½åœ°å€äº†ï¼Œåœ¨ubootä¸­æŸ¥çœ‹kernelçš„åŠ è½½åœ°å€å’Œdtbçš„åŠ è½½åœ°å€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> kernel_addr_r </span><br><span class="line">kernel_addr_r=0x42000000</span><br><span class="line">=&gt; <span class="built_in">printenv</span> fdt_addr_r </span><br><span class="line">fdt_addr_r=0x43000000</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç¡®å®šå†…æ ¸çš„åŠ è½½åœ°å€æ˜¯<code>0x42000000</code>ï¼Œè®¾å¤‡æ ‘çš„åŠ è½½åœ°å€æ˜¯<code>0x43000000</code>.</p><p>ä½¿ç”¨loadå‘½ä»¤åŠ è½½ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; load mmc 0:1 0x42000000 zImage</span><br><span class="line">5496008 bytes <span class="built_in">read</span> <span class="keyword">in</span> 229 ms (22.9 MiB/s)</span><br><span class="line">=&gt; load mmc 0:1 0x43000000 sun8i-a33-vstar.dtb</span><br><span class="line">23345 bytes <span class="built_in">read</span> <span class="keyword">in</span> 3 ms (7.4 MiB/s)</span><br></pre></td></tr></table></figure><p>ç”±äºå†…æ ¸é•œåƒæ˜¯ç»è¿‡å‹ç¼©çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨<code>bootz</code>å‘½ä»¤è¿›è¡Œå¯åŠ¨ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; bootz 0x42000000 - 0x43000000</span><br><span class="line">Kernel image @ 0x42000000 [ 0x000000 - 0x53dcc8 ]</span><br><span class="line"><span class="comment">## Flattened Device Tree blob at 43000000</span></span><br><span class="line">   Booting using the fdt blob at 0x43000000</span><br><span class="line">Working FDT <span class="built_in">set</span> to 43000000</span><br><span class="line">   Loading Device Tree to 49ff7000, end 49fffb30 ... OK</span><br><span class="line">Working FDT <span class="built_in">set</span> to 49ff7000</span><br><span class="line"></span><br><span class="line">Starting kernel ...</span><br><span class="line"></span><br><span class="line">cyclic <span class="keyword">function</span> video_init took too long: 27000us vs 5000us max</span><br><span class="line">[    0.000000] Booting Linux on physical CPU 0x0</span><br><span class="line">[    0.000000] Linux version 6.11.0-rc6-00309-gd2742e387fe4 (troy@troy-WUJIE14-PRO) (arm-linux-gnueabihf-gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0, GNU ld (GNU Bin</span><br><span class="line">utils <span class="keyword">for</span> Ubuntu) 2.38) <span class="comment">#4 SMP Fri Sep 20 22:58:32 CST 2024</span></span><br><span class="line">[    0.000000] CPU: ARMv7 Processor [410fc075] revision 5 (ARMv7), cr=10c5387d</span><br><span class="line">[    0.000000] CPU: div instructions available: patching division code</span><br><span class="line">[    0.000000] CPU: PIPT / VIPT nonaliasing data cache, VIPT aliasing instruction cache</span><br><span class="line">[    0.000000] OF: fdt: Machine model: Sinlinx SinA33</span><br><span class="line">[    0.000000] Memory policy: Data cache writealloc</span><br><span class="line">[    0.000000] cma: Reserved 16 MiB at 0x5d000000 on node -1</span><br><span class="line">[    0.000000] Zone ranges:</span><br><span class="line">[    0.000000]   Normal   [mem 0x0000000040000000-0x000000005dffffff]</span><br><span class="line">[    0.000000]   HighMem  empty</span><br><span class="line">[    0.000000] Movable zone start <span class="keyword">for</span> each node</span><br><span class="line">[    0.000000] Early memory node ranges</span><br><span class="line">[    0.000000]   node   0: [mem 0x0000000040000000-0x000000005dffffff]</span><br><span class="line">[    0.000000] Initmem setup node 0 [mem 0x0000000040000000-0x000000005dffffff]</span><br><span class="line">[    0.000000] psci: probing <span class="keyword">for</span> conduit method from DT.</span><br><span class="line">[    0.000000] psci: Using PSCI v0.1 Function IDs from DT</span><br><span class="line">[    0.000000] percpu: Embedded 13 pages/cpu s20876 r8192 d24180 u53248</span><br><span class="line">[    0.000000] Kernel <span class="built_in">command</span> line: </span><br><span class="line">[    0.000000] Dentry cache <span class="built_in">hash</span> table entries: 65536 (order: 6, 262144 bytes, linear)</span><br><span class="line">[    0.000000] Inode-cache <span class="built_in">hash</span> table entries: 32768 (order: 5, 131072 bytes, linear)</span><br><span class="line">[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 122880</span><br><span class="line">[    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off</span><br><span class="line">[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=4, Nodes=1</span><br><span class="line">[    0.000000] rcu: Hierarchical RCU implementation.</span><br><span class="line">[    0.000000] rcu:     RCU restricting CPUs from NR_CPUS=8 to nr_cpu_ids=4.</span><br><span class="line">[    0.000000] rcu: RCU calculated value of scheduler-enlistment delay is 10 jiffies.</span><br><span class="line">[    0.000000] rcu: Adjusting geometry <span class="keyword">for</span> rcu_fanout_leaf=16, nr_cpu_ids=4</span><br><span class="line">[    0.000000] NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16</span><br><span class="line">[    0.000000] GIC: Using <span class="built_in">split</span> EOI/Deactivate mode</span><br><span class="line">[    0.000000] rcu: srcu_init: Setting srcu_struct sizes based on contention.</span><br><span class="line">[    0.000000] arch_timer: cp15 timer(s) running at 24.00MHz (phys).</span><br><span class="line">[    0.000000] clocksource: arch_sys_counter: mask: 0xffffffffffffff max_cycles: 0x588fe9dc0, max_idle_ns: 440795202592 ns</span><br><span class="line">[    0.000002] sched_clock: 56 bits at 24MHz, resolution 41ns, wraps every 4398046511097ns</span><br><span class="line">[    0.000018] Switching to timer-based delay loop, resolution 41ns</span><br><span class="line">[    0.000214] clocksource: timer: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 79635851949 ns</span><br><span class="line">[    0.000716] Console: colour dummy device 80x30</span><br><span class="line">[    0.000737] printk: legacy console [tty0] enabled</span><br><span class="line">[    0.001150] Calibrating delay loop (skipped), value calculated using timer frequency.. 48.00 BogoMIPS (lpj=240000)</span><br><span class="line">[    0.001186] CPU: Testing write buffer coherency: ok</span><br><span class="line">[    0.001256] pid_max: default: 32768 minimum: 301</span><br><span class="line">[    0.001462] Mount-cache <span class="built_in">hash</span> table entries: 1024 (order: 0, 4096 bytes, linear)</span><br><span class="line">[    0.001501] Mountpoint-cache <span class="built_in">hash</span> table entries: 1024 (order: 0, 4096 bytes, linear)</span><br><span class="line">[    0.002532] /cpus/cpu@0 missing clock-frequency property</span><br><span class="line">[    0.002602] /cpus/cpu@1 missing clock-frequency property</span><br><span class="line">[    0.002636] /cpus/cpu@2 missing clock-frequency property</span><br><span class="line">[    0.002669] /cpus/cpu@3 missing clock-frequency property</span><br><span class="line">[    0.002694] CPU0: thread -1, cpu 0, socket 0, mpidr 80000000</span><br><span class="line">[    0.003911] Setting up static identity map <span class="keyword">for</span> 0x40100000 - 0x40100060</span><br><span class="line">[    0.004138] rcu: Hierarchical SRCU implementation.</span><br><span class="line">[    0.004168] rcu:     Max phase no-delay instances is 1000.</span><br><span class="line">[    0.004475] Timer migration: 1 hierarchy levels; 8 children per group; 1 crossnode level</span><br><span class="line">[    0.005197] smp: Bringing up secondary CPUs ...</span><br><span class="line">[    0.006381] CPU1: thread -1, cpu 1, socket 0, mpidr 80000001</span><br><span class="line">[    0.007615] CPU2: thread -1, cpu 2, socket 0, mpidr 80000002</span><br><span class="line">[    0.008778] CPU3: thread -1, cpu 3, socket 0, mpidr 80000003</span><br><span class="line">[    0.008903] smp: Brought up 1 node, 4 CPUs</span><br><span class="line">[    0.008972] SMP: Total of 4 processors activated (192.00 BogoMIPS).</span><br><span class="line">[    0.008993] CPU: All CPU(s) started <span class="keyword">in</span> HYP mode.</span><br><span class="line">[    0.009008] CPU: Virtualization extensions available.</span><br><span class="line">[    0.009739] Memory: 455244K/491520K available (8192K kernel code, 954K rwdata, 2404K rodata, 1024K init, 261K bss, 18116K reserved, 16384K cma-reserved, 0K high</span><br><span class="line">mem)</span><br><span class="line">[    0.010473] devtmpfs: initialized</span><br><span class="line">[    0.016216] VFP support v0.3: implementor 41 architecture 2 part 30 variant 7 rev 5</span><br><span class="line">[    0.016523] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns</span><br><span class="line">[    0.016574] futex <span class="built_in">hash</span> table entries: 1024 (order: 4, 65536 bytes, linear)</span><br><span class="line">[    0.017387] pinctrl core: initialized pinctrl subsystem</span><br><span class="line">[    0.019573] NET: Registered PF_NETLINK/PF_ROUTE protocol family</span><br><span class="line">[    0.020760] DMA: preallocated 256 KiB pool <span class="keyword">for</span> atomic coherent allocations</span><br><span class="line">[    0.021844] thermal_sys: Registered thermal governor <span class="string">&#x27;step_wise&#x27;</span></span><br><span class="line">[    0.022011] hw-breakpoint: found 5 (+1 reserved) breakpoint and 4 watchpoint registers.</span><br><span class="line">[    0.022063] hw-breakpoint: maximum watchpoint size is 8 bytes.</span><br><span class="line">[    0.026636] platform 1c0c000.lcd-controller: Fixed dependency cycle(s) with /soc/drc@1e70000</span><br><span class="line">[    0.029751] platform 1e00000.display-frontend: Fixed dependency cycle(s) with /soc/display-backend@1e60000</span><br><span class="line">[    0.030124] platform 1e00000.display-frontend: Fixed dependency cycle(s) with /soc/display-backend@1e60000</span><br><span class="line">[    0.030236] platform 1e60000.display-backend: Fixed dependency cycle(s) with /soc/drc@1e70000</span><br><span class="line">[    0.030272] platform 1e60000.display-backend: Fixed dependency cycle(s) with /soc/display-frontend@1e00000</span><br><span class="line">[    0.030575] platform 1e60000.display-backend: Fixed dependency cycle(s) with /soc/drc@1e70000</span><br><span class="line">[    0.030674] platform 1c0c000.lcd-controller: Fixed dependency cycle(s) with /soc/drc@1e70000</span><br><span class="line">[    0.030773] platform 1e70000.drc: Fixed dependency cycle(s) with /soc/lcd-controller@1c0c000</span><br><span class="line">[    0.030874] platform 1e70000.drc: Fixed dependency cycle(s) with /soc/display-backend@1e60000</span><br><span class="line">[    0.033511] platform 1c0c000.lcd-controller: Fixed dependency cycle(s) with /panel</span><br><span class="line">[    0.033627] platform panel: Fixed dependency cycle(s) with /soc/lcd-controller@1c0c000</span><br><span class="line">[    0.037105] SCSI subsystem initialized</span><br><span class="line">[    0.037662] usbcore: registered new interface driver usbfs</span><br><span class="line">[    0.037724] usbcore: registered new interface driver hub</span><br><span class="line">[    0.037801] usbcore: registered new device driver usb</span><br><span class="line">[    0.038063] mc: Linux media interface: v0.10</span><br><span class="line">[    0.038129] videodev: Linux video capture interface: v2.00</span><br><span class="line">[    0.038229] pps_core: LinuxPPS API ver. 1 registered</span><br><span class="line">[    0.038250] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti &lt;giometti@linux.it&gt;</span><br><span class="line">[    0.038287] PTP clock support registered</span><br><span class="line">[    0.038843] Advanced Linux Sound Architecture Driver Initialized.</span><br><span class="line">[    0.040004] clocksource: Switched to clocksource arch_sys_counter</span><br><span class="line">[    0.049575] NET: Registered PF_INET protocol family</span><br><span class="line">[    0.049898] IP idents <span class="built_in">hash</span> table entries: 8192 (order: 4, 65536 bytes, linear)</span><br><span class="line">[    0.051275] tcp_listen_portaddr_hash <span class="built_in">hash</span> table entries: 512 (order: 0, 4096 bytes, linear)</span><br><span class="line">[    0.051335] Table-perturb <span class="built_in">hash</span> table entries: 65536 (order: 6, 262144 bytes, linear)</span><br><span class="line">[    0.051366] TCP established <span class="built_in">hash</span> table entries: 4096 (order: 2, 16384 bytes, linear)</span><br><span class="line">[    0.051427] TCP <span class="built_in">bind</span> <span class="built_in">hash</span> table entries: 4096 (order: 4, 65536 bytes, linear)</span><br><span class="line">[    0.051643] TCP: Hash tables configured (established 4096 <span class="built_in">bind</span> 4096)</span><br><span class="line">[    0.051791] UDP <span class="built_in">hash</span> table entries: 256 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    0.051856] UDP-Lite <span class="built_in">hash</span> table entries: 256 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    0.052082] NET: Registered PF_UNIX/PF_LOCAL protocol family</span><br><span class="line">[    0.052808] RPC: Registered named UNIX socket transport module.</span><br><span class="line">[    0.052855] RPC: Registered udp transport module.</span><br><span class="line">[    0.052873] RPC: Registered tcp transport module.</span><br><span class="line">[    0.052888] RPC: Registered tcp-with-tls transport module.</span><br><span class="line">[    0.052904] RPC: Registered tcp NFSv4.1 backchannel transport module.</span><br><span class="line">[    0.054149] workingset: timestamp_bits=30 max_order=17 bucket_order=0</span><br><span class="line">[    0.055164] NFS: Registering the id_resolver key <span class="built_in">type</span></span><br><span class="line">[    0.055249] Key <span class="built_in">type</span> id_resolver registered</span><br><span class="line">[    0.055269] Key <span class="built_in">type</span> id_legacy registered</span><br><span class="line">[    0.055406] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 246)</span><br><span class="line">[    0.055436] io scheduler mq-deadline registered</span><br><span class="line">[    0.055455] io scheduler kyber registered</span><br><span class="line">[    0.055487] io scheduler bfq registered</span><br><span class="line">[    0.123068] Serial: 8250/16550 driver, 8 ports, IRQ sharing disabled</span><br><span class="line">[    0.132571] panel-simple panel: Specify missing connector_type</span><br><span class="line">[    0.140190] lima 1c40000.gpu: gp - mali400 version major 1 minor 1</span><br><span class="line">[    0.140335] lima 1c40000.gpu: pp0 - mali400 version major 1 minor 1</span><br><span class="line">[    0.140452] lima 1c40000.gpu: pp1 - mali400 version major 1 minor 1</span><br><span class="line">[    0.140513] lima 1c40000.gpu: l2_cache0 64K, 4-way, 64byte cache line, 64bit external bus</span><br><span class="line">[    0.140619] lima 1c40000.gpu: bus rate = 200000000</span><br><span class="line">[    0.140646] lima 1c40000.gpu: mod rate = 384000000</span><br><span class="line">[    0.140761] lima 1c40000.gpu: error -ENODEV: _opp_set_regulators: no regulator (mali) found</span><br><span class="line">[    0.141326] lima 1c40000.gpu: Failed to register cooling device</span><br><span class="line">[    0.141920] [drm] Initialized lima 1.1.0 <span class="keyword">for</span> 1c40000.gpu on minor 0</span><br><span class="line">[    0.146975] CAN device driver interface</span><br><span class="line">[    0.150247] sun6i-rtc 1f00000.rtc: registered as rtc0</span><br><span class="line">[    0.150323] sun6i-rtc 1f00000.rtc: setting system clock to 1970-01-01T00:43:53 UTC (2633)</span><br><span class="line">[    0.150930] i2c_dev: i2c /dev entries driver</span><br><span class="line">[    0.153101] sunxi-wdt 1c20ca0.watchdog: Watchdog enabled (<span class="built_in">timeout</span>=16 sec, nowayout=0)</span><br><span class="line">[    0.154435] sun4i-ss 1c15000.crypto-engine: Die ID 5</span><br><span class="line">[    0.155623] usbcore: registered new interface driver usbhid</span><br><span class="line">[    0.155654] usbhid: USB HID core driver</span><br><span class="line">[    0.161519] cedrus 1c0e000.video-codec: Device registered as /dev/video0</span><br><span class="line">[    0.165699] NET: Registered PF_PACKET protocol family</span><br><span class="line">[    0.165755] can: controller area network core</span><br><span class="line">[    0.165827] NET: Registered PF_CAN protocol family</span><br><span class="line">[    0.165851] can: raw protocol</span><br><span class="line">[    0.165869] can: broadcast manager protocol</span><br><span class="line">[    0.165891] can: netlink gateway - max_hops=1</span><br><span class="line">[    0.166091] Key <span class="built_in">type</span> dns_resolver registered</span><br><span class="line">[    0.166263] Registering SWP/SWPB emulation handler</span><br><span class="line">[    0.188378] gpio gpiochip0: Static allocation of GPIO base is deprecated, use dynamic allocation.</span><br><span class="line">[    0.190314] sun8i-a23-r-pinctrl 1f02c00.pinctrl: initialized sunXi PIO driver</span><br><span class="line">[    0.191090] gpio gpiochip1: Static allocation of GPIO base is deprecated, use dynamic allocation.</span><br><span class="line">[    0.193964] sun8i-a33-pinctrl 1c20800.pinctrl: initialized sunXi PIO driver</span><br><span class="line">[    0.194633] sun8i-a33-pinctrl 1c20800.pinctrl: supply vcc-pb not found, using dummy regulator</span><br><span class="line">[    0.216310] 1c28000.serial: ttyS0 at MMIO 0x1c28000 (irq = 140, base_baud = 1500000) is a U6_16550A</span><br><span class="line">[    0.216423] printk: legacy console [ttyS0] enabled</span><br><span class="line">[    1.162066] sun8i-a33-pinctrl 1c20800.pinctrl: supply vcc-pd not found, using dummy regulator</span><br><span class="line">[    1.171186] sun4i-drm display-engine: bound 1e00000.display-frontend (ops 0xc095450c)</span><br><span class="line">[    1.179400] sun4i-drm display-engine: bound 1e60000.display-backend (ops 0xc0953c78)</span><br><span class="line">[    1.187285] sun4i-drm display-engine: bound 1e70000.drc (ops 0xc09537a8)</span><br><span class="line">[    1.194715] sun4i-drm display-engine: bound 1c0c000.lcd-controller (ops 0xc0952418)</span><br><span class="line">[    1.203810] [drm] Initialized sun4i-drm 1.0.0 <span class="keyword">for</span> display-engine on minor 1</span><br><span class="line">[    1.212105] usb_phy_generic usb_phy_generic.1.auto: dummy supplies not allowed <span class="keyword">for</span> exclusive requests (<span class="built_in">id</span>=vbus)</span><br><span class="line">[    1.225635] ehci-platform 1c1a000.usb: EHCI Host Controller</span><br><span class="line">[    1.231359] ehci-platform 1c1a000.usb: new USB bus registered, assigned bus number 1</span><br><span class="line">[    1.232634] sun8i-a23-r-pinctrl 1f02c00.pinctrl: supply vcc-pl not found, using dummy regulator</span><br><span class="line">[    1.232655] ohci-platform 1c1a400.usb: Generic Platform OHCI controller</span><br><span class="line">[    1.232680] ohci-platform 1c1a400.usb: new USB bus registered, assigned bus number 2</span><br><span class="line">[    1.262744] sunxi-rsb 1f03400.rsb: RSB running at 3000000 Hz</span><br><span class="line">[    1.268854] axp20x-rsb sunxi-rsb-3a3: AXP20x variant AXP223 found</span><br><span class="line">[    1.269008] ohci-platform 1c1a400.usb: irq 144, io mem 0x01c1a400</span><br><span class="line">[    1.278800] input: axp20x-pek as /devices/platform/soc/1f03400.rsb/sunxi-rsb-3a3/axp221-pek/input/input0</span><br><span class="line">[    1.291724] axp20x-adc axp22x-adc: DMA mask not <span class="built_in">set</span></span><br><span class="line">[    1.297302] ehci-platform 1c1a000.usb: irq 143, io mem 0x01c1a000</span><br><span class="line">[    1.297733] axp20x-battery-power-supply axp20x-battery-power-supply: DMA mask not <span class="built_in">set</span></span><br><span class="line">[    1.312539] axp20x-ac-power-supply axp20x-ac-power-supply: DMA mask not <span class="built_in">set</span></span><br><span class="line">[    1.324341] axp20x-rsb sunxi-rsb-3a3: AXP20X driver loaded</span><br><span class="line">[    1.330230] ehci-platform 1c1a000.usb: USB 2.0 started, EHCI 1.00</span><br><span class="line">[    1.332049] input: 1c22800.lradc as /devices/platform/soc/1c22800.lradc/input/input1</span><br><span class="line">[    1.337352] hub 1-0:1.0: USB hub found</span><br><span class="line">[    1.348018] hub 1-0:1.0: 1 port detected</span><br><span class="line">[    1.358445] sun8i-a33-pinctrl 1c20800.pinctrl: supply vcc-pf not found, using dummy regulator</span><br><span class="line">[    1.358514] clk: Disabling unused clocks</span><br><span class="line">[    1.358756] hub 2-0:1.0: USB hub found</span><br><span class="line">[    1.358820] hub 2-0:1.0: 1 port detected</span><br><span class="line">[    1.358836] sun8i-a33-pinctrl 1c20800.pinctrl: supply vcc-pc not found, using dummy regulator</span><br><span class="line">[    1.387380] ALSA device list:</span><br><span class="line">[    1.390398]   No soundcards found.</span><br><span class="line">[    1.394999] sunxi-mmc 1c0f000.mmc: Got CD GPIO</span><br><span class="line">[    1.419939] sunxi-mmc 1c11000.mmc: initialized, max. request size: 16384 KB</span><br><span class="line">[    1.423106] sunxi-mmc 1c0f000.mmc: initialized, max. request size: 16384 KB</span><br><span class="line">[    1.434628] /dev/root: Can<span class="string">&#x27;t open blockdev</span></span><br><span class="line"><span class="string">[    1.438774] VFS: Cannot open root device &quot;&quot; or unknown-block(0,0): error -6</span></span><br><span class="line"><span class="string">[    1.445782] Please append a correct &quot;root=&quot; boot option; here are the available partitions:</span></span><br><span class="line"><span class="string">[    1.454156] List of all bdev filesystems:</span></span><br><span class="line"><span class="string">[    1.458168]  ext3</span></span><br><span class="line"><span class="string">[    1.458174]  ext2</span></span><br><span class="line"><span class="string">[    1.460115]  ext4</span></span><br><span class="line"><span class="string">[    1.462045]  vfat</span></span><br><span class="line"><span class="string">[    1.463974] </span></span><br><span class="line"><span class="string">[    1.467258] mmc1: host does not support reading read-only switch, assuming write-enable</span></span><br><span class="line"><span class="string">[    1.467391] Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)</span></span><br><span class="line"><span class="string">[    1.467401] CPU: 3 UID: 0 PID: 1 Comm: swapper/0 Not tainted 6.11.0-rc6-00309-gd2742e387fe4 #4</span></span><br><span class="line"><span class="string">[    1.467411] Hardware name: Allwinner sun8i Family</span></span><br><span class="line"><span class="string">[    1.467416] Call trace: </span></span><br><span class="line"><span class="string">[    1.467430]  unwind_backtrace from show_stack+0x10/0x14</span></span><br><span class="line"><span class="string">[    1.467465]  show_stack from dump_stack_lvl+0x50/0x64</span></span><br><span class="line"><span class="string">[    1.467484]  dump_stack_lvl from panic+0x10c/0x344</span></span><br><span class="line"><span class="string">[    1.467497]  panic from mount_root_generic+0x1d4/0x278</span></span><br><span class="line"><span class="string">[    1.467513]  mount_root_generic from prepare_namespace+0x1fc/0x258</span></span><br><span class="line"><span class="string">[    1.467527]  prepare_namespace from kernel_init+0x1c/0x12c</span></span><br><span class="line"><span class="string">[    1.467542]  kernel_init from ret_from_fork+0x14/0x28</span></span><br><span class="line"><span class="string">[    1.467554] Exception stack(0xde821fb0 to 0xde821ff8)</span></span><br><span class="line"><span class="string">[    1.467565] 1fa0:                                     00000000 00000000 00000000 00000000</span></span><br><span class="line"><span class="string">[    1.467574] 1fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span></span><br><span class="line"><span class="string">[    1.467582] 1fe0: 00000000 00000000 00000000 00000000 00000013 00000000</span></span><br><span class="line"><span class="string">[    1.564419] ---[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0) ]---</span></span><br></pre></td></tr></table></figure><p>å†…æ ¸ç›´æ¥æŠ¥äº†<code>panic</code>ï¼Œç»è¿‡å®šä½ï¼Œå¯ä»¥ç¡®å®šå¦‚ä¸‹ä¸€æ¡ä¾æ®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[    1.445782] Please append a correct <span class="string">&quot;root=&quot;</span> boot option; here are the available partitions:</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ„æ€å°±æ˜¯æˆ‘ä»¬æ²¡æœ‰æŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£ä¸€å®šæ˜¯bootargså‡ºäº†é—®é¢˜ï¼Œå¤ä½è¿›å…¥ubootï¼ŒæŸ¥çœ‹bootargsçš„å‚æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> bootargs</span><br><span class="line"><span class="comment">## Error: &quot;bootargs&quot; not defined</span></span><br></pre></td></tr></table></figure><p>å±…ç„¶æ²¡æœ‰è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œæƒ³åˆ°äº†armbianæ˜¯æœ‰å¯¹a33è¿›è¡Œæ”¯æŒçš„ï¼Œæˆ‘ä»¬å¯ä»¥å»è„±ä¸€ä¸‹armbiançš„bootargsã€‚</p><p>ä¸‹è½½<a href="https://github.com/armbian/community/releases/download/24.11.0-trunk.66/Armbian_community_24.11.0-trunk.66_Lime-a33_bookworm_current_6.6.44_minimal.img.xz">armbian</a>çš„é•œåƒä¹‹åé€šè¿‡<code>balenaEtcher</code>å·¥å…·åˆ·å…¥sdå¡ï¼Œè¿›å…¥ç³»ç»Ÿåæå–<code>boot</code>åˆ†åŒºä¸­çš„<code>boot.scr</code>ã€‚</p><p>è¯¥è„šæœ¬ä¸­æœ‰è¿™ä¹ˆä¸€å¥è¯ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">setenv bootargs <span class="string">&quot;root=<span class="variable">$&#123;rootdev&#125;</span> rootwait rootfstype=<span class="variable">$&#123;rootfstype&#125;</span> <span class="variable">$&#123;consoleargs&#125;</span> hdmi.audio=EDID:0 disp.screen0_output_mode=<span class="variable">$&#123;disp_mode&#125;</span> consoleblank=0 loglevel=<span class="variable">$&#123;verbosity&#125;</span> ubootpart=<span class="variable">$&#123;partuuid&#125;</span> ubootsource=<span class="variable">$&#123;devtype&#125;</span> usb-storage.quirks=<span class="variable">$&#123;usbstoragequirks&#125;</span> <span class="variable">$&#123;extraargs&#125;</span> <span class="variable">$&#123;extraboardargs&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><p>åœ¨<code>armbian</code>çš„<code>uboot</code>ä¸­ä¸€å¥å¥å¯¹ç…§envï¼Œå¹¶ä¸”åˆ å‡ä¸€äº›æ— å…³é¡¹åå¾—åˆ°å¦‚ä¸‹<code>bootargs</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; setenv bootargs <span class="string">&#x27;earlycon earlyprintk root=/dev/mmcblk0p2 rootwait rw rootfstype=ext4 console=ttyS2,115200 consoleblank=0 loglevel=8&#x27;</span></span><br><span class="line">=&gt; <span class="built_in">printenv</span> bootargs </span><br><span class="line">bootargs=earlycon earlyprintk root=/dev/mmcblk0p2 rootwait rw rootfstype=ext4 console=ttyS2,115200 consoleblank=0 loglevel=8</span><br><span class="line">=&gt; saveenv</span><br><span class="line">Saving Environment to FAT... OK</span><br></pre></td></tr></table></figure><p>é‡æ–°åŠ è½½å¹¶ä¸”å¯åŠ¨åå‘ç°logåˆ°Starting kernelå°±åœæ­¢äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; load mmc 0:1 0x42000000 zImage</span><br><span class="line">5496008 bytes <span class="built_in">read</span> <span class="keyword">in</span> 229 ms (22.9 MiB/s)</span><br><span class="line">=&gt; load mmc 0:1 0x43000000 sun8i-a33-vstar.dtb</span><br><span class="line">23345 bytes <span class="built_in">read</span> <span class="keyword">in</span> 2 ms (11.1 MiB/s)</span><br><span class="line">=&gt; bootz 0x42000000 - 0</span><br><span class="line">Kernel image @ 0x42000000 [ 0x000000 - 0x53dcc8 ]</span><br><span class="line">ERROR: Did not find a cmdline Flattened Device Tree</span><br><span class="line">Could not find a valid device tree</span><br><span class="line">=&gt; bootz 0x42000000 - 0x43000000</span><br><span class="line">Kernel image @ 0x42000000 [ 0x000000 - 0x53dcc8 ]</span><br><span class="line"><span class="comment">## Flattened Device Tree blob at 43000000</span></span><br><span class="line">   Booting using the fdt blob at 0x43000000</span><br><span class="line">Working FDT <span class="built_in">set</span> to 43000000</span><br><span class="line">   Loading Device Tree to 49ff7000, end 49fffb30 ... OK</span><br><span class="line">Working FDT <span class="built_in">set</span> to 49ff7000</span><br><span class="line"></span><br><span class="line">Starting kernel ...</span><br><span class="line"></span><br><span class="line">cyclic <span class="keyword">function</span> video_init took too long: 27000us vs 5000us max</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹ä¸²å£"><a href="#ä¿®æ”¹ä¸²å£" class="headerlink" title="ä¿®æ”¹ä¸²å£"></a>ä¿®æ”¹ä¸²å£</h3><p>è¿™å¾ˆå®¹æ˜“åˆ¤æ–­ï¼Œæˆ‘ä»¬ç¡¬ä»¶ç”µæ°”è¿æ¥çš„æ˜¯uart2, è‚¯å®šæ˜¯ä¸²å£çš„é—®é¢˜äº†ï¼ŒæŸ¥çœ‹è®¾å¤‡æ ‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cat</span> <span class="built_in">arch</span>/arm/boot/dts/allwinner/sun8i-a33-vstar.dts | grep serial</span><br><span class="line">serial0 = &amp;uart0;</span><br><span class="line">stdout-path = <span class="string">&quot;serial0:115200n8&quot;</span>;</span><br></pre></td></tr></table></figure><p>æœç„¶ï¼Œè®¾å¤‡æ ‘ä¸­æ˜¯ä¸²å£0,ä¸ºäº†é¿å…å’Œsdå¡å¼•è„šå¤ç”¨å†²çªï¼ˆ<strong>è¯¥éƒ¨åˆ†åœ¨ubootå·²ç»è¯´æ˜è¿‡</strong>ï¼‰, å°†å…¶ä¿®æ”¹æˆuart2,å¹¶ä¸”æˆ‘ä»¬çš„bootargsä¸­æŒ‡å®šçš„ä¹Ÿæ˜¯uart2.</p><p>ä¿®æ”¹åçš„å·®å¼‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">diff --git a/arch/arm/boot/dts/allwinner/sun8i-a33-vstar.dts b/arch/arm/boot/dts/allwinner/sun8i-a33-vstar.dts</span><br><span class="line">index 0c82ff3c7cb4..7bb29d78c77f 100644</span><br><span class="line">--- a/arch/arm/boot/dts/allwinner/sun8i-a33-vstar.dts</span><br><span class="line">+++ b/arch/arm/boot/dts/allwinner/sun8i-a33-vstar.dts</span><br><span class="line">@@ -54,11 +54,11 @@ / &#123;</span><br><span class="line"> compatible = <span class="string">&quot;sinlinx,sina33&quot;</span>, <span class="string">&quot;allwinner,sun8i-a33&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> aliases &#123;</span><br><span class="line">-serial0 = &amp;uart0;</span><br><span class="line">+serial2 = &amp;uart2;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> chosen &#123;</span><br><span class="line">-stdout-path = <span class="string">&quot;serial0:115200n8&quot;</span>;</span><br><span class="line">+stdout-path = <span class="string">&quot;serial2:115200n8&quot;</span>;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> panel &#123;</span><br><span class="line">@@ -261,6 +261,12 @@ tcon0_out_panel: endpoint@0 &#123;</span><br><span class="line"> &amp;uart0 &#123;</span><br><span class="line"> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"> pinctrl-0 = &lt;&amp;uart0_pb_pins&gt;;</span><br><span class="line">+status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+&amp;uart2 &#123;</span><br><span class="line">+pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">+pinctrl-0 = &lt;&amp;uart2_pins&gt;;</span><br><span class="line"> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line">@@ -273,3 +279,10 @@ &amp;usbphy &#123;</span><br><span class="line"> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"> usb1_vbus-supply = &lt;&amp;reg_vcc5v0&gt;; /* USB1 VBUS is always on */</span><br><span class="line"> &#125;;</span><br><span class="line">+</span><br><span class="line">+&amp;pio &#123;</span><br><span class="line">+uart2_pins: uart2-pins &#123;</span><br><span class="line">+pins = <span class="string">&quot;PB0&quot;</span>, <span class="string">&quot;PB1&quot;</span>;</span><br><span class="line">+<span class="keyword">function</span> = <span class="string">&quot;uart2&quot;</span>;</span><br><span class="line">+&#125;;</span><br><span class="line">+&#125;;</span><br></pre></td></tr></table></figure><p>é‡æ–°å¯åŠ¨åå¯ä»¥æ­£å¸¸çœ‹åˆ°è¾“å‡ºäº†ï¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[    1.242405] Waiting <span class="keyword">for</span> root device /dev/mmcblk0p2...</span><br><span class="line">[    1.278711] mmc1: host does not support reading read-only switch, assuming write-enable</span><br><span class="line">[    1.296810] mmc1: new high speed SDXC card at address 59b4</span><br><span class="line">[    1.307496] mmcblk1: mmc1:59b4 SD64G 59.4 GiB</span><br><span class="line">[    1.326969]  mmcblk1: p1 p2</span><br><span class="line">[    1.381752] mmc0: new DDR MMC card at address 0001</span><br><span class="line">[    1.387723] mmcblk0: mmc0:0001 004G60 3.69 GiB</span><br><span class="line">[    1.405833]  mmcblk0: p1 p2</span><br><span class="line">[    1.414082] mmcblk0boot0: mmc0:0001 004G60 2.00 MiB</span><br><span class="line">[    1.421045] mmcblk0boot1: mmc0:0001 004G60 2.00 MiB</span><br><span class="line">[    1.447615] usb 1-1: new high-speed USB device number 2 using ehci-platform</span><br><span class="line">[    1.462789] EXT4-fs (mmcblk0p2): recovery complete</span><br><span class="line">[    1.467843] EXT4-fs (mmcblk0p2): mounted filesystem 3cdb3fe9-0a84-41be-9519-ec406d029db6 r/w with ordered data mode. Quota mode: disabled.</span><br><span class="line">[    1.480404] VFS: Mounted root (ext4 filesystem) on device 179:10.</span><br><span class="line">[    1.487217] devtmpfs: error mounting -2</span><br><span class="line">[    1.496557] Freeing unused kernel image (initmem) memory: 1024K</span><br><span class="line">[    1.502730] Run /sbin/init as init process</span><br><span class="line">[    1.506831]   with arguments:</span><br><span class="line">[    1.509826]     /sbin/init</span><br><span class="line">[    1.512536]     earlyprintk</span><br><span class="line">[    1.515329]   with environment:</span><br><span class="line">[    1.518489]     HOME=/</span><br><span class="line">[    1.520938]     TERM=linux</span><br><span class="line">[    1.523983] Run /etc/init as init process</span><br><span class="line">[    1.528010]   with arguments:</span><br><span class="line">[    1.531062]     /etc/init</span><br><span class="line">[    1.533975]     earlyprintk</span><br><span class="line">[    1.536766]   with environment:</span><br><span class="line">[    1.539921]     HOME=/</span><br><span class="line">[    1.542366]     TERM=linux</span><br><span class="line">[    1.545366] Run /bin/init as init process</span><br><span class="line">[    1.549385]   with arguments:</span><br><span class="line">[    1.552349]     /bin/init</span><br><span class="line">[    1.554966]     earlyprintk</span><br><span class="line">[    1.557768]   with environment:</span><br><span class="line">[    1.560905]     HOME=/</span><br><span class="line">[    1.563261]     TERM=linux</span><br><span class="line">[    1.565979] Run /bin/sh as init process</span><br><span class="line">[    1.569826]   with arguments:</span><br><span class="line">[    1.572790]     /bin/sh</span><br><span class="line">[    1.575233]     earlyprintk</span><br><span class="line">[    1.578042]   with environment:</span><br><span class="line">[    1.581179]     HOME=/</span><br><span class="line">[    1.583537]     TERM=linux</span><br><span class="line">[    1.586247] Kernel panic - not syncing: No working init found.  Try passing init= option to kernel. See Linux Documentation/admin-guide/init.rst <span class="keyword">for</span> guidance.</span><br><span class="line">[    1.600399] CPU: 1 UID: 0 PID: 1 Comm: swapper/0 Not tainted 6.11.0-rc6-00309-gd2742e387fe4-dirty <span class="comment">#5</span></span><br><span class="line">[    1.609523] Hardware name: Allwinner sun8i Family</span><br><span class="line">[    1.614222] Call trace: </span><br><span class="line">[    1.614238]  unwind_backtrace from show_stack+0x10/0x14</span><br><span class="line">[    1.622013]  show_stack from dump_stack_lvl+0x50/0x64</span><br><span class="line">[    1.627074]  dump_stack_lvl from panic+0x10c/0x344</span><br><span class="line">[    1.631869]  panic from _cpu_down+0x0/0x6a0</span><br><span class="line">[    1.636155] ---[ end Kernel panic - not syncing: No working init found.  Try passing init= option to kernel. See Linux Documentation/admin-guide/init.rst <span class="keyword">for</span> gu</span><br><span class="line">idance. ]---</span><br></pre></td></tr></table></figure><h3 id="å›ºå®šmmcåºå·"><a href="#å›ºå®šmmcåºå·" class="headerlink" title="å›ºå®šmmcåºå·"></a>å›ºå®šmmcåºå·</h3><p>ä½†è¿™é‡Œè¿˜æ˜¯å‡ºç°äº†<code>pannic</code>ï¼Œé‡ç‚¹è§‚å¯Ÿåˆ°å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[    1.242405] Waiting <span class="keyword">for</span> root device /dev/mmcblk0p2...</span><br><span class="line">[    1.278711] mmc1: host does not support reading read-only switch, assuming write-enable</span><br><span class="line">[    1.296810] mmc1: new high speed SDXC card at address 59b4</span><br><span class="line">[    1.307496] mmcblk1: mmc1:59b4 SD64G 59.4 GiB</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¯´æ˜¯ç­‰å¾…mmcblk0è®¾å¤‡ä½†æ˜¯sdå¡ç¡®å®mmc1, å¹¶ä¸”æˆ‘æ¯æ¬¡å¤ä½sdå¡çš„åºå·éƒ½ä¸ä¸€æ ·ï¼Œå¯èƒ½æ˜¯mmc0ä¹Ÿå¯èƒ½æ˜¯mmc1, è¿™å¯ä¸è¡Œï¼Œå› ä¸ºrootfsçš„åˆ†åŒºæ˜¯æˆ‘ä»¬åœ¨bootargsé‡Œé¢å®šæ­»äº†çš„ï¼Œæ‰€ä»¥åªèƒ½å›ºå®šmmcåºå·ã€‚</p><p>ä¿®æ”¹è®¾å¤‡æ ‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">diff --git a/arch/arm/boot/dts/allwinner/sun8i-a33-vstar.dts b/arch/arm/boot/dts/allwinner/sun8i-a33-vstar.dts</span><br><span class="line">index f89a005227d9..95a7c7f394b8 100644</span><br><span class="line">--- a/arch/arm/boot/dts/allwinner/sun8i-a33-vstar.dts</span><br><span class="line">+++ b/arch/arm/boot/dts/allwinner/sun8i-a33-vstar.dts</span><br><span class="line">@@ -55,6 +55,10 @@ / &#123;</span><br><span class="line"> </span><br><span class="line">        aliases &#123;</span><br><span class="line">                serial2 = &amp;uart2;</span><br><span class="line">+               /* SD Card */</span><br><span class="line">+               mmc0 = &amp;mmc0;</span><br><span class="line">+               /* emmc */</span><br><span class="line">+               mmc1 = &amp;mmc2;</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        chosen &#123;</span><br></pre></td></tr></table></figure><h3 id="TODO-è¯¦ç»†è§£é‡Šä¸ºä½•è¿™æ ·ä¿®æ”¹å°±å¯ä»¥å›ºå®šåºå·"><a href="#TODO-è¯¦ç»†è§£é‡Šä¸ºä½•è¿™æ ·ä¿®æ”¹å°±å¯ä»¥å›ºå®šåºå·" class="headerlink" title="TODO : è¯¦ç»†è§£é‡Šä¸ºä½•è¿™æ ·ä¿®æ”¹å°±å¯ä»¥å›ºå®šåºå·"></a>TODO : è¯¦ç»†è§£é‡Šä¸ºä½•è¿™æ ·ä¿®æ”¹å°±å¯ä»¥å›ºå®šåºå·</h3><p>é‡æ–°çƒ§å½•å¯ä»¥çœ‹åˆ°æ— è®ºé‡å¯å¤šå°‘æ¬¡ï¼Œmmcçš„åºå·éƒ½æ˜¯å›ºå®šä¸å˜çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[    1.244304] Waiting <span class="keyword">for</span> root device /dev/mmcblk0p2...</span><br><span class="line">[    1.284821] mmc0: host does not support reading read-only switch, assuming write-enable</span><br><span class="line">[    1.294664] mmc0: new high speed SDXC card at address 59b4</span><br><span class="line">[    1.307075] mmcblk0: mmc0:59b4 SD64G 59.4 GiB</span><br><span class="line">[    1.323511]  mmcblk0: p1 p2</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯ç´§æ€¥åˆ¶ä½œä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼š<a href="https://blog.troy-y.org/2024/09/20/rootfs-%E5%88%B6%E4%BD%9CUbuntu%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">ä¼ é€é—¨</a></p><p>åˆ¶ä½œå¥½æ ¹æ–‡ä»¶ç³»ç»Ÿä¹‹åå°†æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å†…å®¹æ”¾å…¥rootfsåˆ†åŒºï¼Œä¸çŸ¥é“æ€ä¹ˆæ”¾å¯ä»¥å‚è€ƒè¿™é‡Œï¼š<a href="https://blog.troy-y.org/2024/09/20/sd%E4%B8%8Emmc%E5%88%B7%E5%86%99%E6%8C%87%E5%8D%97/">ä¼ é€é—¨</a></p><p>é‡æ–°å¯åŠ¨å°±å·²ç»å¯ä»¥è¿›å…¥æ ¹æ–‡ä»¶ç³»ç»Ÿäº†ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Ubuntu 22.04 LTS a33-vstar ttyS2</span><br><span class="line"></span><br><span class="line">a33-vstar login: root</span><br><span class="line">Password: </span><br><span class="line">Welcome to Ubuntu 22.04 LTS (GNU/Linux 6.11.0-rc6-00311-g9be470523bd2-dirty armv7l)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line">Last login: Thu Apr  7 19:28:32 UTC 2022 on ttyS2</span><br><span class="line">root@a33-vstar:~# <span class="built_in">uname</span></span><br><span class="line">Linux</span><br><span class="line">root@a33-vstar:~# <span class="built_in">uname</span> -a</span><br><span class="line">Linux a33-vstar 6.11.0-rc6-00311-g9be470523bd2-dirty <span class="comment">#6 SMP Fri Sep 20 23:40:53 CST 2024 armv7l armv7l armv7l GNU/Linux</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> kernel </tag>
            
            <tag> a33 </tag>
            
            <tag> allwinner </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxåˆ†åŒºæ¢å¤</title>
      <link href="/2024/09/13/Linux%E5%88%86%E5%8C%BA%E6%81%A2%E5%A4%8D/"/>
      <url>/2024/09/13/Linux%E5%88%86%E5%8C%BA%E6%81%A2%E5%A4%8D/</url>
      
        <content type="html"><![CDATA[<p>åœ¨åˆ é™¤Uç›˜åˆ†åŒºçš„æ—¶å€™ï¼Œå¿˜äº†æ’Uç›˜ï¼Œç›´æ¥æŠŠUbuntuçš„efiåˆ†åŒºåˆ æ‰äº†ã€‚</p><p>ç›´æ¥åŸåœ°çº¢æ¸©â€¦</p><p>ä¸è¿‡è¿˜å¥½åˆ é™¤çš„æ˜¯åˆ†åŒºä¸æ˜¯æ•°æ®ï¼Œè¿˜æœ‰çš„æ•‘â€¦</p><p><strong>æ³¨æ„è¿™æ—¶å€™åƒä¸‡ä¸è¦é‡å¯ç³»ç»Ÿï¼ï¼ï¼</strong></p><p>æŸ¥çœ‹åˆ†åŒºæŒ‚è½½ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ lsblk</span><br><span class="line">NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span><br><span class="line">...</span><br><span class="line">nvme0n1     259:0    0 953.9G  0 disk </span><br><span class="line">â””â”€nvme0n1p2 259:2    0 953.4G  0 part /</span><br></pre></td></tr></table></figure><p>å·²ç»çœ‹ä¸è§p1äº†ï¼Œä½†æ˜¯ï¼</p><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å®‰è£…ä¼—ç¥ä¹‹çˆ¶<code>testdisk</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> apt install testdisk </span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå·¥å…·éå¸¸å¥½ç”¨ï¼Œå¯ä»¥è‡ªå®šä¹‰æ£€æµ‹åˆ†åŒºè¡¨ï¼Œå¹¶ä¸”æ£€æµ‹ä¸¢å¤±çš„åˆ†åŒºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> testdisk /dev/nvme0n1</span><br></pre></td></tr></table></figure><p>è¿›å…¥å¦‚ä¸‹ç•Œé¢, è¿™é‡Œæ˜¯é€‰æ‹©ç£ç›˜ï¼Œæˆ‘åªæœ‰ä¸€ä¸ªç›˜ï¼Œæ‰€ä»¥å°±ç›´æ¥æŒ‰enteräº†ï¼š</p><p><a href="https://postimg.cc/DWBKtmzw"><img src="https://i.postimg.cc/26f8LZRh/2024-09-13-14-24-41.png" alt="2024-09-13-14-24-41.png"></a></p><p>é€‰æ‹©ç£ç›˜åéœ€è¦é€‰æ‹©ä½ çš„ç£ç›˜åˆ†åŒºè¡¨ç±»å‹ï¼ŒIntelæ˜¯è‡ªåŠ¨é€‰æ‹©ï¼ŒæŒ‰é“ç†åº”è¯¥æ˜¯GPTåˆ†åŒºï¼Œä½†æ˜¯ä¸å¤ªè‡ªä¿¡ï¼Œæ‰€ä»¥é€‰æ‹©äº†Intelè¿›å…¥ï¼š</p><p><a href="https://postimg.cc/qg7vjFWy"><img src="https://i.postimg.cc/nV49cbkR/2024-09-13-14-24-47.png" alt="2024-09-13-14-24-47.png"></a></p><p>è¿™é‡Œæ˜¾ç¤ºæ£€æµ‹åˆ°äº†GPTåˆ†åŒºï¼Œç›´æ¥æŒ‰Enterè¿›å…¥ï¼š</p><p><a href="https://postimg.cc/jCCRz7Jh"><img src="https://i.postimg.cc/qBxgHcJW/2024-09-13-14-25-08.png" alt="2024-09-13-14-25-08.png"></a></p><p>åœ¨å¦‚ä¸‹ç•Œé¢ä¸­ç›´æ¥é€‰ä¸­Analyseå›è½¦ï¼š</p><p><a href="https://postimg.cc/Kkww74d9"><img src="https://i.postimg.cc/J0z8LkKW/2024-09-13-14-48-06.png" alt="2024-09-13-14-48-06.png"></a></p><p>éšåæ£€æµ‹åˆ°åˆ†åŒºç»“æ„å¦‚ä¸‹ï¼Œç›´æ¥é€‰æ‹©Quick Searchå›è½¦ï¼š</p><p><a href="https://postimg.cc/bsX4sD0r"><img src="https://i.postimg.cc/qMgrD2zs/2024-09-13-14-51-29.png" alt="2024-09-13-14-51-29.png"></a></p><p>æ¥ä¸‹æ¥æ£€æµ‹åˆ°ä¸€ä¸ªå¯æ¢å¤åˆ†åŒºFATï¼Œå›è½¦è¿›å…¥åé€‰æ‹©Writeï¼Œé€‰æ‹©Writeåªä¼šé‡å†™ä½ çš„åˆ†åŒºä¿¡æ¯ï¼Œè€Œä¸ä¼šåˆ é™¤ä½ çš„åˆ†åŒºæ•°æ®ï¼Œæ‰€ä»¥å¤§å¯æ”¾å¿ƒã€‚</p><p>é€‰æ‹©Writeä¹‹åä¼šè¯¢é—®ä½ æ˜¯å¦ç¡®è®¤ï¼Œè¾“å…¥Yå³å¯ã€‚</p><p><a href="https://postimg.cc/VSNV3jwG"><img src="https://i.postimg.cc/3wjQ0BcT/2024-09-13-14-25-12.png" alt="2024-09-13-14-25-12.png"></a></p><p>å†™å…¥ä¹‹åé‡å¯ç³»ç»Ÿï¼Œå°±å¯ä»¥çœ‹åˆ°å¿ƒå¿ƒå¿µå¿µçš„efiäº†ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ lsblk</span><br><span class="line">NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span><br><span class="line">...</span><br><span class="line">nvme0n1     259:0    0 953.9G  0 disk </span><br><span class="line">â”œâ”€nvme0n1p1 259:1    0   512M  0 part /boot/efi</span><br><span class="line">â””â”€nvme0n1p2 259:2    0 953.4G  0 part /</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[å…¨å¿—A33-Vstar]Uboot</title>
      <link href="/2024/09/13/%E5%85%A8%E5%BF%97A33-Uboot/"/>
      <url>/2024/09/13/%E5%85%A8%E5%BF%97A33-Uboot/</url>
      
        <content type="html"><![CDATA[<h2 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h2><p>cpu: allwinner a33<br>board: vstar<br>host: ubuntu 22.04</p><p>éœ€è¦å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> apt install gcc-arm-linux-gnueabihf</span><br></pre></td></tr></table></figure><h2 id="FELæ¨¡å¼"><a href="#FELæ¨¡å¼" class="headerlink" title="FELæ¨¡å¼"></a>FELæ¨¡å¼</h2><p>é€šè¿‡FELæ¨¡å¼å¯ä»¥å¯åŠ¨ubootæˆ–å°†å†…æ ¸é•œåƒç­‰æ–‡ä»¶ä¸‹è½½åˆ°å†…å­˜ï¼Œæ˜¯ä¸ªå¾ˆæ–¹ä¾¿çš„åŠŸèƒ½ã€‚</p><p>è‹¥è¦ä½¿ç”¨felç³»åˆ—çš„å·¥å…·ï¼Œéœ€è¦å…ˆå®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> apt-get install sunxi-tools</span><br></pre></td></tr></table></figure><p>vstarå¼€å‘æ¿è¿›å…¥felçš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ul><li>æŒ‰ä½poweré”®ä¸æ¾æ‰‹ï¼ŒéšåæŒ‰resetï¼Œç­‰å¾…1såæ”¾å¼€poweré”®</li><li>æŒ‰ä½vol + é”®ä¸æ¾æ‰‹ï¼ŒéšåæŒ‰resetï¼Œè¿ç»­çŸ­æŒ‰5-10æ¬¡poweré”®åæœ‰ä¸€ä¸ªç¯é—ªçƒä¸€ä¸‹ï¼Œæ­¤æ—¶æ¾å¼€vol+é”®å³å¯è¿›å…¥ã€‚</li></ul><p>felçƒ§å†™ubootå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">sudo</span> sunxi-fel uboot ./u-boot-sunxi-with-spl.bin</span><br></pre></td></tr></table></figure><h2 id="uboot-sunxiä»“åº“è¯•é”™"><a href="#uboot-sunxiä»“åº“è¯•é”™" class="headerlink" title="uboot-sunxiä»“åº“è¯•é”™"></a>uboot-sunxiä»“åº“è¯•é”™</h2><p><strong>è¯¥ç« èŠ‚å¹¶æ²¡æœ‰æˆåŠŸï¼Œæ‰€ä»¥å¦‚æœæƒ³å­¦ä¹ å¯ä»¥çœ‹çœ‹ï¼Œåªæ˜¯æƒ³ç§»æ¤ubootå°±å¯ä»¥è·³åˆ°ä¸‹ä¸€ä¸ªç« èŠ‚</strong></p><p>è¦ç§»æ¤ubooté¦–å…ˆæƒ³åˆ°çš„è‚¯å®šæ˜¯å…¨å¿—çš„ubootä»“åº“ï¼Œå…ˆæ‹‰ä¸‹æ¥ä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git <span class="built_in">clone</span> https://github.com/linux-sunxi/u-boot-sunxi </span><br><span class="line">â¯ <span class="built_in">cd</span> u-boot-sunxi </span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸€ä¸ªA33èŠ¯ç‰‡çš„æ¿å­çš„configè¿›è¡Œé…ç½®å¹¶ç¼–è¯‘ï¼Œç»è¿‡æµ‹è¯•, A33-OLinuXino_defconfigè¿™ä¸ªé…ç½®æ–‡ä»¶æ²¡æ”¯æŒemmcï¼Œåªæ”¯æŒäº†sdï¼Œè¿™é‡Œé€‰æ‹©sinlinxçš„configï¼Œä¸vstarå¼€å‘æ¿ç›¸è¿‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- Sinlinx_SinA33_defconfig</span><br><span class="line">â¯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘é‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼Œçœ‹èµ·æ¥å¾ˆç†Ÿæ‚‰ï¼Œå¥½åƒå½“å¹´æf1c200sçš„æ—¶å€™ä¹Ÿé‡è§äº†è¿™ä¸ªé”™è¯¯â€¦</p><p>ç»™lichee piçš„ä»“åº“æäº¤äº†prï¼Œä½†å·²ç»è¿‡å»äº†ä¸€å¹´å¤šï¼Œä¹Ÿæ²¡æœ‰ç†æˆ‘â€¦</p><p>è¯¥é”™è¯¯å¯é€šè¿‡è¯¥prä¿®å¤ï¼š<a href="https://github.com/Lichee-Pi/u-boot/pull/7">æˆ‘æ˜¯PR</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">usr/bin/ld: scripts/dtc/dtc-parser.tab.o:(.bss+0x10): multiple definition of `yylloc<span class="string">&#x27;; scripts/dtc/dtc-lexer.lex.o:(.bss+0x0): first defined here</span></span><br><span class="line"><span class="string">  UPD     include/generated/version_autogenerated.h</span></span><br><span class="line"><span class="string">  CC      lib/asm-offsets.s</span></span><br><span class="line"><span class="string">  CC      arch/arm/lib/asm-offsets.s</span></span><br><span class="line"><span class="string">collect2: error: ld returned 1 exit status</span></span><br><span class="line"><span class="string">make[2]: *** [scripts/Makefile.host:106ï¼šscripts/dtc/dtc] é”™è¯¯ 1</span></span><br><span class="line"><span class="string">make[2]: *** æ­£åœ¨ç­‰å¾…æœªå®Œæˆçš„ä»»åŠ¡....</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­ç¼–è¯‘ï¼Œåˆ°äº†æœ€åé˜¶æ®µå´é‡åˆ°äº†å¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">  MKSUNXI spl/sunxi-spl.bin</span><br><span class="line">  BINMAN  u-boot-sunxi-with-spl.bin</span><br><span class="line">binman: No module named _libfdt</span><br><span class="line">make: *** [Makefile:1348ï¼šu-boot-sunxi-with-spl.bin] é”™è¯¯ 1</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥pythonæ˜¯å¦æœ‰è¿™ä¸ªmodule:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ python -m pip list | grep pylibfdt</span><br><span class="line">pylibfdt                           1.7.0.post1</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™å·²ç»å¼€å§‹æ€€ç–‘æ˜¯è¿™ä¸ªmoduleçš„ç‰ˆæœ¬é—®é¢˜äº†ï¼Œåœ¨<a href="https://pypi.org/project/pylibfdt/#history">è¿™é‡Œ</a>æ‰¾åˆ°äº†å†å²ç‰ˆæœ¬ä¿¡æ¯ï¼Œé€ä¸ªå°è¯•å®‰è£…è¿˜æ˜¯ä¸è¡Œâ€¦</p><p>æœ€ç»ˆåœ¨<a href="https://lore.kernel.org/buildroot/bug-11706-163@https.bugs.busybox.net%2F/T/">è¿™é‡Œ</a>æ‰¾åˆ°äº†é—®é¢˜çš„åŸå› ï¼Œæ˜¯pythonç‰ˆæœ¬çš„é—®é¢˜ã€‚</p><p>åœ¨<a href="https://blog.csdn.net/qq_34752070/article/details/125182978">è¿™é‡Œ</a>æ‰¾åˆ°äº†é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œé‡æ–°é“¾æ¥åè§£å†³é—®é¢˜ã€‚</p><p>è¿æ¥å¼€å‘æ¿ä¸²å£0ä¹‹åé€šè¿‡è¿›å…¥felå¯åŠ¨ubootï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git <span class="built_in">clone</span> git@github.com:u-boot/u-boot.git</span><br><span class="line">â¯ <span class="built_in">sudo</span> sunxi-fel uboot ./u-boot-sunxi-with-spl.bin</span><br></pre></td></tr></table></figure><p>ä¹‹åå‘ç°emmcå’Œsdå¡éƒ½æ— æ³•ä½¿ç”¨â€¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; mmc dev 0</span><br><span class="line">Card did not respond to voltage <span class="keyword">select</span>!</span><br><span class="line">=&gt; mmc dev 1</span><br><span class="line">Card did not respond to voltage <span class="keyword">select</span>!</span><br><span class="line">=&gt; mmc dev 0</span><br><span class="line">MMC: no card present</span><br><span class="line">=&gt; mmc dev 1</span><br><span class="line">Card did not respond to voltage <span class="keyword">select</span>!</span><br></pre></td></tr></table></figure><p><strong>fuck you allwinner! mainline start!</strong></p><h2 id="mainline"><a href="#mainline" class="headerlink" title="mainline"></a>mainline</h2><h3 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h3><p>æ‹‰å–ubootä¸»çº¿ä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git <span class="built_in">clone</span> git@github.com:u-boot/u-boot.git </span><br><span class="line">â¯ <span class="built_in">cd</span> u-boot</span><br></pre></td></tr></table></figure><p>ä¾æ—§ä½¿ç”¨ä¹‹å‰çš„Sinlinxçš„é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- Sinlinx_SinA33_defconfig</span><br><span class="line">â¯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡å‘ç°æ—¥å¿—åˆ°MMCå°±ç»“æŸäº†ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">U-Boot 2024.10-rc4-g5f0449324136-dirty (Sep 14 2024 - 15:47:46 +0800) Allwinner Technology</span><br><span class="line"></span><br><span class="line">CPU:   Allwinner A33 (SUN8I 1667)</span><br><span class="line">Model: Sinlinx SinA33</span><br><span class="line">DRAM:  512 MiB</span><br><span class="line">Core:  64 devices, 21 uclasses, devicetree: separate</span><br><span class="line">WDT:   Not starting watchdog@1c20ca0</span><br><span class="line">MMC: </span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸€å¼€å§‹ä¸€ç›´æ€€ç–‘ubootå¡æ­»äº†ï¼Œæ’æŸ¥ä¸€æ®µæ—¶é—´åå‘ç°å…¶å®å¹¶ä¸æ˜¯ã€‚</p><p>å¯ä»¥è§‚å¯Ÿåˆ°<code>Model: Sinlinx SinA33</code>è¿™ä¸€è¡Œï¼ŒæŒ‰æ‰¾è¿™ä¸ªæŸ¥æ‰¾å¯¹åº”è®¾å¤‡æ ‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ find -name <span class="string">&quot;*.dts*&quot;</span> -<span class="built_in">exec</span> grep -n <span class="string">&quot;Sinlinx SinA33&quot;</span> &#123;&#125; +</span><br><span class="line">./arch/arm/dts/sun8i-a33-sinlinx-sina33.dts:53:model = <span class="string">&quot;Sinlinx SinA33&quot;</span>;</span><br><span class="line">./dts/upstream/src/arm/allwinner/sun8i-a33-sinlinx-sina33.dts:53:model = <span class="string">&quot;Sinlinx SinA33&quot;</span>;</span><br></pre></td></tr></table></figure><p>æŸ¥åˆ°ä¸¤ä¸ªdtsï¼ŒæŸ¥è¯¢dtb:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> ./arch/arm/dts/sun8i-a33-sinlinx-sina33.dtb</span><br><span class="line">./arch/arm/dts/sun8i-a33-sinlinx-sina33.dtb</span><br><span class="line">â¯ <span class="built_in">ls</span> ./dts/upstream/src/arm/allwinner/sun8i-a33-sinlinx-sina33.dtb</span><br><span class="line"><span class="built_in">ls</span>: æ— æ³•è®¿é—® <span class="string">&#x27;./dts/upstream/src/arm/allwinner/sun8i-a33-sinlinx-sina33.dtb&#x27;</span>: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç¡®å®šå°±æ˜¯<code>./arch/arm/dts/sun8i-a33-sinlinx-sina33.dtb</code>è¿™ä¸ªæ–‡ä»¶ï¼ŒæŸ¥è¯¢å…¶å¯¹åº”çš„dtså¯ä»¥å‘ç°æŒ‡å®šçš„å°±æ˜¯uart0ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">aliases &#123;</span><br><span class="line">serial0 = &amp;uart0;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">chosen &#123;</span><br><span class="line">stdout-path = <span class="string">&quot;serial0:115200n8&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹uart0èŠ‚ç‚¹åŠå…¶å¯¹åº”çš„gpioï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// ./arch/arm/dts/sun8i-a33-sinlinx-sina33.dts</span><br><span class="line">&amp;uart0 &#123;</span><br><span class="line">pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">pinctrl-0 = &lt;&amp;uart0_pb_pins&gt;;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//./arch/arm/dts/sun8i-a33.dtsi</span><br><span class="line">&amp;pio &#123;</span><br><span class="line">compatible = <span class="string">&quot;allwinner,sun8i-a33-pinctrl&quot;</span>;</span><br><span class="line">interrupts = &lt;GIC_SPI 15 IRQ_TYPE_LEVEL_HIGH&gt;,</span><br><span class="line">     &lt;GIC_SPI 17 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line"></span><br><span class="line">uart0_pb_pins: uart0-pb-pins &#123;</span><br><span class="line">pins = <span class="string">&quot;PB0&quot;</span>, <span class="string">&quot;PB1&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> = <span class="string">&quot;uart0&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŒ‡å®šäº†uart0çš„å¼•è„šä½¿ç”¨PB0ä½œtxï¼ŒPB1ä½œrxï¼ŒæŸ¥çœ‹åŸç†å›¾è¿™ä¸¤ä¸ªå¼•è„šåŸæ¥åœ¨æ˜¯uart2,å°†uart2çš„å¼•è„šå¤ç”¨æˆuart0äº†</p><p><a href="https://postimg.cc/TK34JS2T"><img src="https://i.postimg.cc/dV2cwPzZ/2024-09-14-16-44-32.png" alt="2024-09-14-16-44-32.png"></a></p><p>é‚£ä¹ˆè¿™æ ·å°±å¯ä»¥åˆ†æå‡ºæ¥åŸå› äº†ï¼Œç”±äºchosenæŒ‡å®šçš„è¾“å‡ºç«¯å£æ˜¯uart0,æ‰€ä»¥åœ¨æ²¡æœ‰uart2çš„gpioå¤ç”¨æˆuart0çš„åŠŸèƒ½ä¹‹å‰ï¼Œå°±ç”±uart0é»˜è®¤çš„å¯¹åº”å¼•è„šPF2 PF4è¾“å‡ºï¼Œå¤ç”¨ä¹‹åå°±ä½¿ç”¨äº†uart2çš„gpioä½œuart0ã€‚</p><p>è¿æ¥ä¸Šuart2ä¹‹åæœç„¶å¯ä»¥çœ‹åˆ°å®Œæ•´logï¼Œä½†è¿™é‡Œè¿˜æ˜¯ä¿®æ”¹ä¸€ä¸‹å§ã€‚</p><h3 id="ä¸²å£ä¿®æ”¹"><a href="#ä¸²å£ä¿®æ”¹" class="headerlink" title="ä¸²å£ä¿®æ”¹"></a>ä¸²å£ä¿®æ”¹</h3><p>åœ¨ä¿®æ”¹ä¹‹å‰ï¼Œå…ˆå¤åˆ¶ä¸€ä»½dtså’Œé…ç½®æ–‡ä»¶ï¼Œä½œä¸ºæˆ‘ä»¬è‡ªå·±çš„vstarçš„ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cp</span> ./arch/arm/dts/sun8i-a33-sinlinx-sina33.dts ./arch/arm/dts/sun8i-a33-vstar.dts</span><br><span class="line">â¯ <span class="built_in">cp</span> ./configs/Sinlinx_SinA33_defconfig ./configs/VStar_A33_defconfig</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹Makefileæ”¯æŒdts:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">diff --git a/arch/arm/dts/Makefile b/arch/arm/dts/Makefile</span><br><span class="line">index 2d931c23fc8..1cf745f8027 100644</span><br><span class="line">--- a/arch/arm/dts/Makefile</span><br><span class="line">+++ b/arch/arm/dts/Makefile</span><br><span class="line">@@ -607,6 +607,7 @@ dtb-$(CONFIG_MACH_SUN8I_A33) += \</span><br><span class="line">        sun8i-a33-olinuxino.dtb \</span><br><span class="line">        sun8i-a33-q8-tablet.dtb \</span><br><span class="line">        sun8i-a33-sinlinx-sina33.dtb \</span><br><span class="line">+       sun8i-a33-vstar.dtb \</span><br><span class="line">        sun8i-r16-bananapi-m2m.dtb \</span><br><span class="line">        sun8i-r16-nintendo-nes-classic.dtb \</span><br><span class="line">        sun8i-r16-nintendo-super-nes-classic.dtb \</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹configé€‰æ‹©ç”Ÿæˆé•œåƒå†…çš„è®¾å¤‡æ ‘æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ diff configs/VStar_A33_defconfig configs/Sinlinx_SinA33_defconfig</span><br><span class="line">3c3</span><br><span class="line">&lt; CONFIG_DEFAULT_DEVICE_TREE=<span class="string">&quot;sun8i-a33-vstar&quot;</span></span><br><span class="line">---</span><br><span class="line">&gt; CONFIG_DEFAULT_DEVICE_TREE=<span class="string">&quot;sun8i-a33-sinlinx-sina33&quot;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è‡ªå·±çš„é…ç½®æ–‡ä»¶ç¼–è¯‘ä¸€æ¬¡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- VStar_A33_defconfig</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># configuration written to .config</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">â¯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æˆåŠŸï¼Œç°åœ¨æ¥ä¿®æ”¹dtsä»¥è®©ä»–å…¨éƒ¨èµ°uart2,è¿™æ ·uart0å°±æ²¡æœ‰ä»»ä½•è¾“å‡ºäº†ã€‚</p><p>ä¸ç„¶æ˜æ˜è¿æ¥çš„uart2,ç»“æœuart0æ˜¾ç¤ºä¸€æ®µæ„Ÿè§‰æ€ªæ€ªçš„ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">diff --git a/arch/arm/dts/sun8i-a33-vstar.dts b/arch/arm/dts/sun8i-a33-vstar.dts</span><br><span class="line">index d54a067fc76..23d73f4f62f 100644</span><br><span class="line">--- a/arch/arm/dts/sun8i-a33-vstar.dts</span><br><span class="line">+++ b/arch/arm/dts/sun8i-a33-vstar.dts</span><br><span class="line">@@ -54,11 +54,11 @@</span><br><span class="line"> compatible = <span class="string">&quot;sinlinx,sina33&quot;</span>, <span class="string">&quot;allwinner,sun8i-a33&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> aliases &#123;</span><br><span class="line">-serial0 = &amp;uart0;</span><br><span class="line">+serial2 = &amp;uart2;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> chosen &#123;</span><br><span class="line">-stdout-path = <span class="string">&quot;serial0:115200n8&quot;</span>;</span><br><span class="line">+stdout-path = <span class="string">&quot;serial2:115200n8&quot;</span>;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> panel &#123;</span><br><span class="line">@@ -261,6 +261,12 @@</span><br><span class="line"> &amp;uart0 &#123;</span><br><span class="line"> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"> pinctrl-0 = &lt;&amp;uart0_pb_pins&gt;;</span><br><span class="line">+status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+&amp;uart0 &#123;</span><br><span class="line">+pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">+pinctrl-0 = &lt;&amp;uart2_pins&gt;;</span><br><span class="line"> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line">@@ -273,3 +279,10 @@</span><br><span class="line"> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"> usb1_vbus-supply = &lt;&amp;reg_vcc5v0&gt;; /* USB1 VBUS is always on */</span><br><span class="line"> &#125;;</span><br><span class="line">+</span><br><span class="line">+&amp;pio &#123;</span><br><span class="line">+uart2_pins: uart2-pins &#123;</span><br><span class="line">+pins = <span class="string">&quot;PB0&quot;</span>, <span class="string">&quot;PB1&quot;</span>;</span><br><span class="line">+<span class="keyword">function</span> = <span class="string">&quot;uart2&quot;</span>;</span><br><span class="line">+&#125;;</span><br><span class="line">+&#125;;</span><br><span class="line">diff --git a/configs/VStar_A33_defconfig b/configs/VStar_A33_defconfig</span><br><span class="line">index a428e68725f..c6ea136733c 100644</span><br><span class="line">--- a/configs/VStar_A33_defconfig</span><br><span class="line">+++ b/configs/VStar_A33_defconfig</span><br><span class="line">@@ -15,6 +15,7 @@ CONFIG_VIDEO_LCD_BL_PWM=<span class="string">&quot;PH0&quot;</span></span><br><span class="line"> CONFIG_CMD_DFU=y</span><br><span class="line"> CONFIG_DFU_RAM=y</span><br><span class="line"> CONFIG_FASTBOOT_CMD_OEM_FORMAT=y</span><br><span class="line">+CONFIG_CONS_INDEX=3</span><br><span class="line"> CONFIG_USB_EHCI_HCD=y</span><br><span class="line"> CONFIG_USB_OHCI_HCD=y</span><br><span class="line"> CONFIG_USB_MUSB_GADGET=y</span><br></pre></td></tr></table></figure><h3 id="ç½‘å£ä½¿èƒ½"><a href="#ç½‘å£ä½¿èƒ½" class="headerlink" title="ç½‘å£ä½¿èƒ½"></a>ç½‘å£ä½¿èƒ½</h3><p>æŸ¥çœ‹åŸç†å›¾å¯ä»¥å‘ç°ç½‘å£ä½¿ç”¨äº†rtl8152èŠ¯ç‰‡ï¼Œè¿™ä¸ªèŠ¯ç‰‡é€šè¿‡usbé€šè®¯ï¼Œæ‰€ä»¥dtsä¸­æ ¹æœ¬å°±ä¸ç”¨æ”¹åŠ¨ï¼Œconfigä¸­ä½¿èƒ½è¯¥é©±åŠ¨å°±å¯ä»¥ï¼š</p><p><a href="https://postimg.cc/w12Gtj8D"><img src="https://i.postimg.cc/YSBKsvdD/2024-09-14-17-12-17.png" alt="2024-09-14-17-12-17.png"></a></p><p>åœ¨menuconfigä¸­ä½¿èƒ½è¯¥é©±åŠ¨ï¼Œä»¥ä¸‹æ˜¯ä½¿èƒ½è¯¥é©±åŠ¨ä¹‹åconfigæ–‡ä»¶çš„å˜æ›´ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ diff defconfig configs/VStar_A33_defconfig</span><br><span class="line">22,23d21</span><br><span class="line">&lt; CONFIG_USB_HOST_ETHER=y</span><br><span class="line">&lt; CONFIG_USB_ETHER_RTL8152=y</span><br></pre></td></tr></table></figure><p>é‡æ–°ç¼–è¯‘ä¸‹è½½ï¼Œä½¿ç”¨dhcpè·å–ip:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; dhcp</span><br><span class="line">musb-hdrc: peripheral reset irq lost!</span><br><span class="line">high speed config <span class="comment">#2: 2 mA, Ethernet Gadget, using RNDIS</span></span><br><span class="line">USB RNDIS network up!</span><br><span class="line">BOOTP broadcast 1</span><br><span class="line">BOOTP broadcast 2</span><br><span class="line">BOOTP broadcast 3</span><br><span class="line">BOOTP broadcast 4</span><br></pre></td></tr></table></figure><p>ä»€ä¹ˆé¬¼ï¼Œçœ‹èµ·æ¥èµ°äº†å¦ä¸€ä¸ªç½‘å£ï¼Œä½†æ˜¯å“ªæ¥çš„ç½‘å£ï¼Œå”¯ä¸€æ€€ç–‘çš„å°±æ˜¯usbå£çš„otgæ¨¡å¼ï¼Œrndisåè®®æ¨¡æ‹Ÿç½‘å£äº†ã€‚</p><p>æŸ¥çœ‹è®¾å¤‡æ ‘æœç„¶æœ‰è¿™ä¹ˆä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°†å…¶æ”¹æˆdisabledï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&amp;usb_otg &#123;</span><br><span class="line">dr_mode = <span class="string">&quot;peripheral&quot;</span>;</span><br><span class="line">status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é‡æ–°ç¼–è¯‘ä¸‹è½½å‘ç°dhcpæ˜¾ç¤ºæ²¡æœ‰ç½‘å£ï¼Œé‚£ä¹ˆçœ‹æ¥ç½‘å£æ— æ³•è¯†åˆ«ï¼Œæ³¨æ„åˆ°ubootå¯åŠ¨æ—¶æœ‰ä¸€è¡Œæ˜¾ç¤ºmacåœ°å€æ— æ•ˆï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Error: r8152_eth No valid MAC address found.</span><br></pre></td></tr></table></figure><p>åœ¨<a href="https://blog.csdn.net/weixin_43479963/article/details/107073502">è¿™é‡Œ</a>æ‰¾åˆ°äº†èµ„æ–™ï¼Œä»€ä¹ˆï¼ï¼Ÿ macè¿˜éœ€è¦è´­ä¹°åé€šè¿‡ä¸“ç”¨å·¥å…·çƒ§å†™ï¼Œå»ä½ çš„å§ï¼Œè¿™ç¯‡åšæ–‡å°±ä»é©±åŠ¨ä¿®æ”¹å…¥æ‰‹ç›´æ¥å†™å…¥äº†macåœ°å€ï¼Œä½†ä»–é‚£æ˜¯linuxçš„é©±åŠ¨ï¼Œè·Ÿæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯æŸ¥å¾ˆå¤šçš„ï¼Œæˆ‘ä»¬è¿™é‡Œå°±æ²¡æœ‰writeå‡½æ•°ï¼Œè‡ªå·±å®ç°èµ·æ¥è´¹åŠ›ä¸è®¨å¥½ï¼Œè€Œä¸”rtl8152çš„registerçš„datasheetæ²¡æœ‰æ‰¾åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä»readå…¥æ‰‹ã€‚</p><p>é¦–å…ˆåœ¨readå‡½æ•°ä¸­åŠ å…¥æ‰“å°å‡½æ•°ï¼ŒæŸ¥çœ‹ä¸€ä¸‹è·å–åˆ°çš„macåœ°å€ï¼Œæœç„¶å…¨æ˜¯0ã€‚</p><p>é‚£ä¹ˆå¾ˆç®€å•ï¼Œæ—¢ç„¶è¯»ä¸åˆ°macï¼Œé‚£ä¹ˆæˆ‘å°±é€ ä¸€ä¸ªï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">diff --git a/drivers/usb/eth/r8152.c b/drivers/usb/eth/r8152.c</span><br><span class="line">index e3f20e08c33..672b8dac8a6 100644</span><br><span class="line">--- a/drivers/usb/eth/r8152.c</span><br><span class="line">+++ b/drivers/usb/eth/r8152.c</span><br><span class="line">@@ -625,10 +625,14 @@ static int r8152_read_mac(struct r8152 *tp, unsigned char *macaddr)</span><br><span class="line">        int ret;</span><br><span class="line">        unsigned char enetaddr[8] = &#123;0&#125;;</span><br><span class="line"> </span><br><span class="line">        ret = pla_ocp_read(tp, PLA_IDR, 8, enetaddr);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; 0)</span><br><span class="line">                <span class="built_in">return</span> ret;</span><br><span class="line"> </span><br><span class="line">+       <span class="keyword">if</span>(is_zero_ethaddr(enetaddr) || !is_valid_ethaddr(enetaddr))</span><br><span class="line">+               net_random_ethaddr(enetaddr);</span><br><span class="line">+</span><br><span class="line">        memcpy(macaddr, enetaddr, ETH_ALEN);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line"> &#125;</span><br><span class="line">(END)</span><br></pre></td></tr></table></figure><p>æ·»åŠ çš„å†…å®¹å°±æ˜¯åˆ¤æ–­å¦‚æœmacåœ°å€æ— æ•ˆçš„æƒ…å†µä¸‹ä¼ªé€ ä¸€ä¸ªfake-macï¼Œè¿™æ ·å°±å¯ä»¥äº†ã€‚</p><p>é‡æ–°ç¼–è¯‘çƒ§å†™ï¼Œæœç„¶æ²¡æœ‰é‚£ä¸€è¡ŒæŠ¥é”™äº†ï¼Œé€šè¿‡dhcpå‘½ä»¤åŠ¨æ€è·å–ip:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; dhcp</span><br><span class="line">BOOTP broadcast 1</span><br><span class="line">DHCP client bound to address 192.168.230.34 (36 ms)</span><br><span class="line">*** Warning: no boot file name; using <span class="string">&#x27;C0A8E622.img&#x27;</span></span><br><span class="line">Using r8152_eth device</span><br><span class="line">TFTP from server 192.168.230.1; our IP address is 192.168.230.34</span><br><span class="line">Filename <span class="string">&#x27;C0A8E622.img&#x27;</span>.</span><br><span class="line">Load address: 0x42000000</span><br><span class="line">Loading: *</span><br><span class="line">TFTP error: <span class="string">&#x27;File not found&#x27;</span> (1)</span><br><span class="line">Not retrying...</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡æœç„¶æˆåŠŸè·å–åˆ°ipäº†ï¼Œè¿™ä¸‹å¯ä»¥ä½¿ç”¨tftpç½‘ç»œè·å–å†…æ ¸äº†ï¼Œè°ƒè¯•æ–¹ä¾¿å¾ˆå¤šã€‚</p><p>ä½†æ˜¯è¿™é‡ŒæŠ¥äº†ä¸€äº›æ‰¾ä¸åˆ°æ–‡ä»¶çš„é”™è¯¯ï¼Œè¿™æ˜¯ubootæœºåˆ¶ï¼Œè®¾ç½®ä¸€ä¸ªç¯å¢ƒå˜é‡å°±å¯ä»¥è§£å†³äº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; setenv <span class="built_in">autoload</span> no</span><br></pre></td></tr></table></figure><p>ç”±äºæ˜¯felæ¨¡å¼ï¼Œçƒ§å†™è¿›å…¥çš„æ˜¯ramï¼Œæ‰ç”µä¼šä¸¢å¤±ï¼Œæ‰€ä»¥saveenvä¿å­˜ä¸äº†å‚æ•°ï¼Œé‚£ä¹ˆç›´æ¥æŠŠautoloadç¯å¢ƒå˜é‡åšåˆ°ubootæºç é‡Œé¢ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p>åªéœ€è¦ä¿®æ”¹<code>include/configs/sunxi-common.h</code>æ–‡ä»¶å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">diff --git a/include/configs/sunxi-common.h b/include/configs/sunxi-common.h</span><br><span class="line">index b29a25d5617..fefc2e291eb 100644</span><br><span class="line">--- a/include/configs/sunxi-common.h</span><br><span class="line">+++ b/include/configs/sunxi-common.h</span><br><span class="line">@@ -297,6 +297,7 @@</span><br><span class="line">        <span class="string">&quot;uuid_gpt_system=&quot;</span> UUID_GPT_SYSTEM <span class="string">&quot;\0&quot;</span> \</span><br><span class="line">        <span class="string">&quot;partitions=&quot;</span> PARTS_DEFAULT <span class="string">&quot;\0&quot;</span> \</span><br><span class="line">        BOOTCMD_SUNXI_COMPAT \</span><br><span class="line">-       BOOTENV</span><br><span class="line">+       BOOTENV \</span><br><span class="line">+       <span class="string">&quot;autoload=no&quot;</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">#endif /* _SUNXI_COMMON_CONFIG_H */</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> uboot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> uboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntuä½¿ç”¨å‘½ä»¤è¡Œä¿®æ”¹åˆ†è¾¨ç‡</title>
      <link href="/2024/09/12/Ubuntu%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BF%AE%E6%94%B9%E5%88%86%E8%BE%A8%E7%8E%87/"/>
      <url>/2024/09/12/Ubuntu%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BF%AE%E6%94%B9%E5%88%86%E8%BE%A8%E7%8E%87/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ xrandr</span><br><span class="line">Screen 0: minimum 320 x 200, current 1920 x 1080, maximum 3840 x 2160</span><br><span class="line">HDMI-1 connected primary 1920x1080+0+0 (normal left inverted right x axis y axis) 477mm x 268mm</span><br><span class="line">   1920x1080     60.00*+</span><br><span class="line">   1680x1050     60.00  </span><br><span class="line">   1280x1024     60.00  </span><br><span class="line">   ...</span><br><span class="line">eDP-1 connected (normal left inverted right x axis y axis)</span><br><span class="line">   1366x768      60.00*+</span><br><span class="line">   1280x720      60.00  </span><br><span class="line">   1024x768      60.00  </span><br><span class="line">   ...</span><br><span class="line">$ xrandr --output HDMI-1 --mode 1920x1080</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dockerä¸Šä¼ è‡³hub</title>
      <link href="/2024/09/06/docker%E4%B8%8A%E4%BC%A0%E8%87%B3hub/"/>
      <url>/2024/09/06/docker%E4%B8%8A%E4%BC%A0%E8%87%B3hub/</url>
      
        <content type="html"><![CDATA[<h2 id="å°†å·²æœ‰å®¹å™¨æäº¤ä¸ºé•œåƒ"><a href="#å°†å·²æœ‰å®¹å™¨æäº¤ä¸ºé•œåƒ" class="headerlink" title="å°†å·²æœ‰å®¹å™¨æäº¤ä¸ºé•œåƒ"></a>å°†å·²æœ‰å®¹å™¨æäº¤ä¸ºé•œåƒ</h2><p>å¦‚æœä½ å½“å‰æœ‰çš„æ˜¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„<code>Docker</code>å®¹å™¨ï¼Œè€Œä¸æ˜¯é•œåƒï¼Œä½ å¯ä»¥å°†è¿™ä¸ªå®¹å™¨ä¿å­˜ä¸ºé•œåƒï¼Œç„¶åå†ä¸Šä¼ åˆ° <code>Docker Hub</code>ã€‚</p><p>å¯ä»¥ä½¿ç”¨<code>docker commit</code>å‘½ä»¤ï¼Œå°†å½“å‰å®¹å™¨ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„ Docker é•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ docker commit &lt;container-id&gt; &lt;new-image-name&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ çš„å®¹å™¨ ID æ˜¯ <code>abc123</code>ï¼Œå¹¶ä¸”ä½ æƒ³æŠŠå®ƒä¿å­˜ä¸ºåä¸º <code>my-app-image</code> çš„é•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ docker commit abc123 my-app-image</span><br></pre></td></tr></table></figure><p><strong>å¦‚æœä½ éœ€è¦é™„åŠ ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨-mé€‰é¡¹æ·»åŠ ä½ è¦æäº¤çš„ä¿¡æ¯</strong></p><p>ä½¿ç”¨<code>docker images</code>å¯ä»¥æŸ¥çœ‹ç”Ÿæˆçš„é•œåƒã€‚</p><h2 id="æ ‡è®°é•œåƒ"><a href="#æ ‡è®°é•œåƒ" class="headerlink" title="æ ‡è®°é•œåƒ"></a>æ ‡è®°é•œåƒ</h2><p>ç°åœ¨å·²ç»æœ‰äº†ä¸€ä¸ªé•œåƒï¼Œå³ä¾¿æ²¡æœ‰ï¼Œæ˜¯å®¹å™¨çš„è¯ï¼Œç»è¿‡ä¸Šä¸€æ­¥éª¤ä¹Ÿåº”è¯¥æœ‰äº†é•œåƒï¼Œç°åœ¨éœ€è¦ç»™é•œåƒæ‰“æ ‡ç­¾æ ‡è®°ç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ docker tag &lt;new-image-name&gt; &lt;hub-username&gt;/&lt;repository-name&gt;:&lt;tag&gt;</span><br></pre></td></tr></table></figure><h2 id="æ¨é€é•œåƒ"><a href="#æ¨é€é•œåƒ" class="headerlink" title="æ¨é€é•œåƒ"></a>æ¨é€é•œåƒ</h2><p>ç°åœ¨å¯ä»¥å°†æ ‡è®°çš„é•œåƒæ¨é€åˆ°<code>docker hub</code>äº†:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ docker push &lt;hub-username&gt;/&lt;repository-name&gt;:&lt;tag&gt;</span><br></pre></td></tr></table></figure><h2 id="å¤šä¸ªæ ‡è®°"><a href="#å¤šä¸ªæ ‡è®°" class="headerlink" title="å¤šä¸ªæ ‡è®°"></a>å¤šä¸ªæ ‡è®°</h2><p>åœ¨ <code>Docker Hub </code>ä¸­ï¼Œä½ å¯ä»¥ä¸ºåŒä¸€ä¸ªé•œåƒåˆ›å»ºå¤šä¸ªæ ‡ç­¾ï¼ˆ<code>tags</code>ï¼‰ï¼Œä¾‹å¦‚ <code>latest</code>ã€<code>v1.1</code>ã€<code>v1.2 </code>ç­‰ï¼Œè¿™æ ·å¯ä»¥æ ‡è¯†ä¸åŒçš„ç‰ˆæœ¬ï¼ŒåŒæ—¶ä¿æŒ <code>latest </code>ä½œä¸ºæœ€æ–°ç‰ˆæœ¬çš„æ ‡è¯†ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ docker tag &lt;new-image-name&gt; &lt;hub-username&gt;/&lt;repository-name&gt;:latest</span><br><span class="line">â¯ docker tag &lt;new-image-name&gt; &lt;hub-username&gt;/&lt;repository-name&gt;:v1.1</span><br><span class="line">â¯ docker push &lt;hub-username&gt;/&lt;repository-name&gt;:latest</span><br><span class="line">â¯ docker push myusername/&lt;repository-name&gt;:v1.1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨pxelinuxå¯åŠ¨å†…æ ¸</title>
      <link href="/2024/09/06/%E4%BD%BF%E7%94%A8pxelinux%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8/"/>
      <url>/2024/09/06/%E4%BD%BF%E7%94%A8pxelinux%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8/</url>
      
        <content type="html"><![CDATA[<h2 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h2><p>Board: BPI-F3 based on k1 of SpaceMit</p><p><strong>Note: æœ¬æ–‡é»˜è®¤å·²ç»åœ¨ä¸»æœºå¾…å»ºæˆåŠŸtftpæœåŠ¡</strong></p><h2 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h2><h3 id="è®¾ç½®IP"><a href="#è®¾ç½®IP" class="headerlink" title="è®¾ç½®IP"></a>è®¾ç½®IP</h3><p>åœ¨ä¸»æœºä¸ŠæŸ¥è¯¢<code>ip</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ ifconfig</span><br><span class="line">enx00e099a751b1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.230.28  netmask 255.255.255.0  broadcast 192.168.230.255</span><br><span class="line">        inet6 fe80::7d95:76be:c484:17b6  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:e0:99:a7:51:b1  txqueuelen 1000  (ä»¥å¤ªç½‘)</span><br><span class="line">        RX packets 223389  bytes 75866217 (75.8 MB)</span><br><span class="line">        RX errors 0  dropped 94  overruns 0  frame 0</span><br><span class="line">        TX packets 196725  bytes 223909969 (223.9 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸»æœº<code>ip</code>æ˜¯<code>192.168.230.28</code>ï¼Œæ¿å­<code>ip</code>ç¡®ä¿åœ¨ä¸€ä¸ªå±€åŸŸç½‘å†…å°±å¥½ã€‚</p><p>æ¥ä¸‹æ¥è¿›å…¥<code>uboot</code>è®¾ç½®<code>ip</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; setenv ipaddr 192.168.230.4</span><br><span class="line">=&gt; setenv serverip 192.168.230.28</span><br><span class="line">=&gt; [ 723.486] <span class="built_in">printenv</span> ipaddr </span><br><span class="line">ipaddr=192.168.230.4</span><br><span class="line">=&gt; [ 727.153] <span class="built_in">printenv</span> serverip</span><br><span class="line">serverip=192.168.230.28</span><br><span class="line">=&gt; saveenv</span><br></pre></td></tr></table></figure><h3 id="é…ç½®pxeæ–‡ä»¶"><a href="#é…ç½®pxeæ–‡ä»¶" class="headerlink" title="é…ç½®pxeæ–‡ä»¶"></a>é…ç½®pxeæ–‡ä»¶</h3><p>åœ¨ä¸»æœºä¸Šè¿›å…¥<code>tftp</code>æ–‡ä»¶å¤¹ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ Image</span><br><span class="line">â”œâ”€â”€ k1-x_deb1.dtb</span><br><span class="line">â””â”€â”€ pxelinux.cfg</span><br><span class="line">    â””â”€â”€ 01-fe-fe-fe-81-b4-a8</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>pxelinux.cfg</code>æ˜¯å­˜æ”¾<code>pxeé…ç½®æ–‡ä»¶</code>çš„æ–‡ä»¶å¤¹ï¼Œç”±äº<code>TFTP</code>æœåŠ¡å¯èƒ½ä¼šè¢«å¤šä¸ªå¼€å‘æ¿ä½¿ç”¨ï¼Œå› æ­¤<code>PXEé…ç½®æ–‡ä»¶</code>çš„åç§°å–å†³äº<code>U-boot</code>å‚æ•°(æ¿çš„ç¡¬ä»¶åœ°å€&#x2F; IPåœ°å€)ã€‚</p><p>ä¼˜å…ˆçº§æœ€é«˜çš„æ˜¯<code>mac</code>åœ°å€ï¼Œåœ¨<code>uboot</code>ä¸­æŸ¥çœ‹<code>mac</code>åœ°å€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; [ 898.685] <span class="built_in">printenv</span> ethaddr </span><br><span class="line">ethaddr=FE:FE:FE:81:B4:A8</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥<code>cfg</code>çš„åå­—å°±åº”è¯¥æ˜¯:  <code>01-fe-fe-fe-81-b4-a8</code></p><p>è¿™ä¸ª<code>01</code>æˆ‘ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ„æ€ï¼Œåæ­£å¿…é¡»åŠ ä¸Šã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯ä¿®æ”¹ <code>01-fe-fe-fe-81-b4-a8</code>è¿™ä¸ªæ–‡ä»¶äº†ï¼Œæ–‡ä»¶å†…å®¹æ ¼å¼è·Ÿ<a href="https://blog.troy-y.org/2024/08/26/%E9%87%8E%E7%81%ABuboot%E4%BD%BF%E7%94%A8extboot%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8%E6%B5%81%E7%A8%8B/#cfg%E6%96%87%E4%BB%B6">extlinux</a>æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><p>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cat</span> pxelinux.cfg/01-fe-fe-fe-81-b4-a8</span><br><span class="line">default linux</span><br><span class="line"></span><br><span class="line">label linux</span><br><span class="line">kernel Image</span><br><span class="line">fdt k1-x_deb1.dtb</span><br><span class="line">append earlycon=sbi earlyprintk quiet splash plymouth.ignore-serial-consoles plymouth.prefer-fbcon console=ttyS0,115200 loglevel=8 clk_ignore_unused swiotlb=65536 rdinit=/init workqueue.default_affinity_scope=system root=/dev/mmcblk2p6 rootwait rootfstype=ext4</span><br></pre></td></tr></table></figure><h2 id="pxeå¯åŠ¨"><a href="#pxeå¯åŠ¨" class="headerlink" title="pxeå¯åŠ¨"></a>pxeå¯åŠ¨</h2><p>åœ¨<code>uboot</code>ä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pxe get</span><br><span class="line">pxe boot</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä»¥ä¸Šå‘½ä»¤æŒ‰é“ç†æ¥è¯´å°±å¯ä»¥å¯åŠ¨å†…æ ¸äº†ï¼Œä½†æ˜¯å‘ç°å¯åŠ¨åˆ°ä¸€åŠå¡æ­»äº†ï¼Œçœ‹<code>log</code>å‘ç°è²Œä¼¼æ˜¯è®¾å¤‡æ ‘æ²¡æœ‰åŠ è½½ï¼Œä»–ä½¿ç”¨äº†ä¸€ä¸ªåœ°å€<code>0x7deb2e10</code>çš„è®¾å¤‡æ ‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=&gt; [1976.087] pxe get</span><br><span class="line">missing environment variable: pxeuuid</span><br><span class="line">[1978.023] Retrieving file: pxelinux.cfg/01-fe-fe-fe-81-b4-a8</span><br><span class="line">[1978.171] ethernet@cac80000 Waiting for PHY auto negotiation to complete...... done</span><br><span class="line">[1981.637] emac_adjust_link link:1 speed:1000 duplex:full</span><br><span class="line">[1981.659] Using ethernet@cac80000 device</span><br><span class="line">[1981.660] TFTP from server 192.168.230.28; our IP address is 192.168.230.4</span><br><span class="line">Filename &#x27;pxelinux.cfg/01-fe-fe-fe-81-b4-a8&#x27;.</span><br><span class="line">Load address: 0xc200000</span><br><span class="line">Loading: #</span><br><span class="line">         [1981.682] 39.1 KiB/s</span><br><span class="line">done</span><br><span class="line">Bytes transferred = 322 (142 hex)</span><br><span class="line">[1981.685] Config file &#x27;&lt;NULL&gt;&#x27; found</span><br><span class="line">=&gt; [1982.858] pxe boot</span><br><span class="line">1:      linux</span><br><span class="line">[1984.100] Retrieving file: Image</span><br><span class="line">[1984.244] ethernet@cac80000 Waiting for PHY auto negotiation to complete...... done</span><br><span class="line">[1987.710] emac_adjust_link link:1 speed:1000 duplex:full</span><br><span class="line">[1987.732] Using ethernet@cac80000 device</span><br><span class="line">[1987.733] TFTP from server 192.168.230.28; our IP address is 192.168.230.4</span><br><span class="line">Filename &#x27;Image&#x27;.</span><br><span class="line">Load address: 0x11000000</span><br><span class="line">Loading: #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #################################################################</span><br><span class="line">         #####</span><br><span class="line">         [2011.448] 1.4 MiB/s</span><br><span class="line">done</span><br><span class="line">Bytes transferred = 34423808 (20d4400 hex)</span><br><span class="line">[2011.451] append: earlycon=sbi earlyprintk quiet splash plymouth.ignore-serial-consoles plymouth.prefer-fbcon console=ttyS0,115200 loglevel=8 clk_igno</span><br><span class="line">re_unused swiotlb=65536 rdinit=/init workqueue.default_affinity_scope=system root=/dev/mmcblk2p6 rootwait rootfstype=ext4</span><br><span class="line">[2011.475] Moving Image from 0x11000000 to 0x200000, end=2358000</span><br><span class="line">[2011.493] ## Flattened Device Tree blob at 7deb2e10</span><br><span class="line">[2011.495]    Booting using the fdt blob at 0x7deb2e10</span><br><span class="line">[2011.500]    Loading Device Tree to 000000007dd8f000, end 000000007dd9cf27 ... OK</span><br></pre></td></tr></table></figure><p>è¿™å°±å¾ˆå¥‡æ€ªäº†ï¼Œä½†è¿æ°”ä½¿ç„¶ï¼Œåœ¨<code>uboot</code>ä¸­å‘ç°äº†è¿™ä¹ˆä¸€ä¸ªå˜é‡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt;  <span class="built_in">printenv</span> fdtcontroladdr </span><br><span class="line">fdtcontroladdr=7deb2e10</span><br></pre></td></tr></table></figure><p>è¿™å’Œåˆšæ‰åœ¨å†…å­˜ä¸­åŠ è½½çš„è®¾å¤‡æ ‘çš„åœ°å€ä¸€æ¨¡ä¸€æ ·ï¼Œä½†å°è¯•å°†ä»–æ¸…ç©ºå†æ‰§è¡Œ<code>pxe</code>ï¼Œsame thingï¼Œçœ‹æ¥æœ‰ç‚¹è¿æ°”ï¼Œä½†ä¸å¤šã€‚</p><p>ç»è¿‡æŸ¥è¯¢èµ„æ–™å‘ç°ï¼Œ<code>pxe</code>ä¼šå°†<code>conf</code>æŒ‡å®šçš„<code>Image</code>åŠ è½½åˆ°<code>kernel_addr_r</code>å¤„ï¼Œå°†<code>dtb</code>åŠ è½½åˆ°<code>fdt_addr_r</code>å¤„ï¼Œé‚£ä¹ˆæ˜¯å¦æˆ‘ä»¬çš„<code>uboot</code>é»˜è®¤åªè®¾ç½®äº†<code>kernel</code>çš„åœ°å€è€Œæ²¡æœ‰<code>dtb</code>çš„åœ°å€ï¼Œåœ¨<code>uboot</code>ä¸­è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; [  58.262] <span class="built_in">printenv</span> kernel_addr_r </span><br><span class="line">kernel_addr_r=0x11000000</span><br><span class="line">=&gt; [  59.428] <span class="built_in">printenv</span> dtb_addr_r    </span><br><span class="line"><span class="comment">## Error: &quot;dtb_addr_r&quot; not defined</span></span><br></pre></td></tr></table></figure><p>æœç„¶..ï¼Œå¢åŠ <code>fdt_addr_r</code>å˜é‡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> dtb_addr </span><br><span class="line">dtb_addr=0x31000000</span><br><span class="line">=&gt; setenv fdt_addr_r 0x31000000</span><br><span class="line">=&gt; saveenv</span><br><span class="line">Saving Environment to MMC... Writing to MMC(2)... OK</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å†é€šè¿‡<code>pxe</code>å¯åŠ¨å°±æ²¡æœ‰ä»»ä½•é—®é¢˜äº†ã€‚</p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://blog.csdn.net/weixin_35808698/article/details/117274748">https://blog.csdn.net/weixin_35808698/article/details/117274748</a></p>]]></content>
      
      
      <categories>
          
          <category> uboot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenHarmonyæ ‡å‡†ç³»ç»Ÿè®¤è¯</title>
      <link href="/2024/09/04/OpenHarmony%E6%A0%87%E5%87%86%E7%B3%BB%E7%BB%9F%E8%AE%A4%E8%AF%81/"/>
      <url>/2024/09/04/OpenHarmony%E6%A0%87%E5%87%86%E7%B3%BB%E7%BB%9F%E8%AE%A4%E8%AF%81/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p><strong>è¯¥éƒ¨åˆ†åœ¨Windowsä¸Šå®Œæˆ</strong></p><p>ç¡®ä¿<code>python</code>ç‰ˆæœ¬ä¸º<code>3.7</code>ä»¥ä¸Šï¼Œ<code>3.7.8</code>æ˜¯æ¨èçš„ï¼Œä½†ä¸æ˜¯ç»å¯¹çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python --version</span><br><span class="line">Python 3.7.8</span><br></pre></td></tr></table></figure><p>å®‰è£…åŒ…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple setuptools</span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pyserial</span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple rsa</span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple python-dateutil</span><br></pre></td></tr></table></figure><h2 id="Actsåº”ç”¨å…¼å®¹æ€§æµ‹è¯•"><a href="#Actsåº”ç”¨å…¼å®¹æ€§æµ‹è¯•" class="headerlink" title="Actsåº”ç”¨å…¼å®¹æ€§æµ‹è¯•"></a>Actsåº”ç”¨å…¼å®¹æ€§æµ‹è¯•</h2><p>åœ¨<a href="https://www.openharmony.cn/certification/document/xts/">è¿™é‡Œ</a>é€‰æ‹©<code>OH</code>å¯¹åº”çš„ç‰ˆæœ¬çš„å¥—ä»¶å’Œèµ„æºæ–‡ä»¶ã€‚</p><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œ<code>Acts</code>å¥—ä»¶å¦‚æœæ˜¯<code>arm32</code>å¯ä»¥ç›´æ¥ä¸‹è½½ï¼Œä½†æ˜¯å…¶ä»–çš„éœ€è¦åœ¨<code>OH</code>æºä»£ç ç›®å½•è¿›è¡Œç¼–è¯‘ã€‚</p><p>ç”±äºè¿™é‡Œæ˜¯arm64, æ‰€ä»¥è¦ç¼–è¯‘ä¸€ä¸‹<code>Acts</code>å¥—ä»¶ã€‚</p><p>è¿›å…¥<code>OH</code>çš„æºç æ ¹ç›®å½•åï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="built_in">test</span>/xts/acts</span><br><span class="line">$ ./build.sh product_name=rk3568 system_size=standard</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆåç”Ÿæˆç›®å½•ï¼š</p><pre><code>- æµ‹è¯•ç”¨ä¾‹è¾“å‡ºç›®å½•: out/rk3568/suites/acts/testcases- æµ‹è¯•æ¡†æ¶&amp;ç”¨ä¾‹æ•´ä½“è¾“å‡ºç›®å½•: out/rk3568/suites/acts</code></pre><p>å¤åˆ¶<code>out/rk3568/suites/acts</code>åˆ°ä¸»æœºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cp</span> -r acts ~/VirtualBox\ VMsWin10/share/oh</span><br></pre></td></tr></table></figure><p>è§£å‹ä¸‹è½½çš„èµ„æºæ–‡ä»¶å‹ç¼©åŒ…åˆ°<code>acts</code>æ–‡ä»¶å¤¹é‡Œé¢ã€‚</p><p>å®Œæˆä¹‹åç›®å½•å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ tree -L 1</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”œâ”€â”€ resource</span><br><span class="line">â”œâ”€â”€ run.bat</span><br><span class="line">â”œâ”€â”€ run.sh</span><br><span class="line">â”œâ”€â”€ testcases</span><br><span class="line">â””â”€â”€ tools</span><br><span class="line"></span><br><span class="line">4 directories, 2 files</span><br></pre></td></tr></table></figure><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://www.openharmony.cn/certification/document/guid">https://www.openharmony.cn/certification/document/guid</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> openHarmony </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568ç§»æ¤ä¸»çº¿å†…æ ¸</title>
      <link href="/2024/09/03/rk3568%E7%A7%BB%E6%A4%8D%E4%B8%BB%E7%BA%BF%E5%86%85%E6%A0%B8/"/>
      <url>/2024/09/03/rk3568%E7%A7%BB%E6%A4%8D%E4%B8%BB%E7%BA%BF%E5%86%85%E6%A0%B8/</url>
      
        <content type="html"><![CDATA[<h2 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h2><p>Board: Lubancat-2io</p><p>è¿™ç¯‡æ–‡ç« éœ€è¦ç”¨åˆ°ä¹‹å‰ç§»æ¤çš„<a href="https://blog.troy-y.org/2024/08/26/rk3568%E7%A7%BB%E6%A4%8Duboot-1/">uboot</a>å’Œ<a href="https://blog.troy-y.org/2024/08/26/%E9%87%8E%E7%81%ABuboot%E4%BD%BF%E7%94%A8extboot%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8%E6%B5%81%E7%A8%8B/">extlinux</a>çš„åŸºç¡€çŸ¥è¯†ã€‚</p><h2 id="Get-source"><a href="#Get-source" class="headerlink" title="Get source"></a>Get source</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git <span class="built_in">clone</span> git@github.com:torvalds/linux.git </span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸€ä¸‹<code>dts</code>çš„å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> <span class="built_in">arch</span>/arm64/boot/dts/rockchip/rk3568* | grep lubancat</span><br><span class="line"><span class="built_in">arch</span>/arm64/boot/dts/rockchip/rk3568-lubancat-2.dts</span><br></pre></td></tr></table></figure><p>ä¸»çº¿æ˜¯æœ‰<code>lubancat-2</code>çš„è®¾å¤‡æ ‘çš„ï¼Œè¿™å°±å¾ˆå¤§çš„æ–¹ä¾¿äº†æˆ‘ä»¬ï¼Œå¯ä»¥ç¨ä½œä¿®æ”¹è®¾å¤‡æ ‘å³å¯å®Œç¾åœ¨<code>2io</code>ä¸Šå…¨é€‚é…ã€‚</p><h2 id="å†…æ ¸configé…ç½®"><a href="#å†…æ ¸configé…ç½®" class="headerlink" title="å†…æ ¸configé…ç½®"></a>å†…æ ¸configé…ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> <span class="built_in">arch</span>/arm64/configs</span><br><span class="line">defconfig  hardening.config   virt.config</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¹¶æ²¡æœ‰<code>rk3568 evb</code>æ¿å­çš„é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å…ˆä½¿ç”¨<code>defconfig</code>å°±å¥½ï¼Œé‡åˆ°ä»€ä¹ˆé—®é¢˜å†è§£å†³ä»€ä¹ˆé—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig</span><br><span class="line">â¯ make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j32</span><br><span class="line">â¯ <span class="built_in">ls</span> <span class="built_in">arch</span>/arm64/boot/dts/rockchip/rk3568-lubancat-2.dtb</span><br><span class="line"><span class="built_in">arch</span>/arm64/boot/dts/rockchip/rk3568-lubancat-2.dtb</span><br><span class="line">â¯ <span class="built_in">ls</span> <span class="built_in">arch</span>/arm64/boot/Image</span><br><span class="line"><span class="built_in">arch</span>/arm64/boot/Image</span><br></pre></td></tr></table></figure><p>ä¾æ®<a href="https://blog.troy-y.org/2024/08/26/%E9%87%8E%E7%81%ABuboot%E4%BD%BF%E7%94%A8extboot%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8%E6%B5%81%E7%A8%8B/">extlinux</a>çš„ç»éªŒï¼Œæœ‰äº†å†…æ ¸å’Œè®¾å¤‡æ ‘ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦<code>extlinux.conf</code>æ–‡ä»¶å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">mkdir</span> -p extboot &amp;&amp; <span class="built_in">cp</span> <span class="built_in">arch</span>/arm64/boot/dts/rockchip/rk3568-lubancat-2.dtb extboot &amp;&amp; <span class="built_in">cp</span> <span class="built_in">arch</span>/arm64/boot/Image extboot/Image-master</span><br><span class="line">â¯ <span class="built_in">mkdir</span> -p extboot/extlinux/extlinux.conf</span><br></pre></td></tr></table></figure><p>åœ¨<code>extboot/extlinux/extlinux.conf</code>æ–‡ä»¶ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">label rockchip-master</span><br><span class="line">    kernel /Image-master</span><br><span class="line">    fdt /rk3568-lubancat-2.dtb</span><br><span class="line">    append root=dev/mmcblk0p3 earlyprintk console=ttyFIQ0 console=tty1 consoleblank=0 loglevel=7 rootwait rw rootfstype=ext4 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory swapaccount=1 switolb=1 coherent_pool=1m</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>append</code>çš„<code>bootargs</code>æ¥è‡ªäº<code>lubancat</code>çš„<code>extlinux.conf</code>ï¼Œåˆ›å»ºå¥½ä¹‹åæŸ¥çœ‹ä¸€ä¸‹ç›®å½•æ–‡ä»¶ç»“æ„ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ tree extboot</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ extlinux</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ extlinux.conf</span><br><span class="line">â”œâ”€â”€ Image-master</span><br><span class="line">â”œâ”€â”€ rk3568-lubancat-2.dtb</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br></pre></td></tr></table></figure><p>ä¸€åˆ‡æ— è¯¯åï¼Œå°±å¯ä»¥ç”Ÿæˆbootåˆ†åŒºçš„é•œåƒäº†ï¼Œæ³¨æ„ï¼Œè¿™ä¸ªæ“ä½œä¸è¦åœ¨<code>extboot</code>æ–‡ä»¶å¤¹ä¸‹æ“ä½œï¼Œå¦åˆ™å°±ä¼šé€’å½’ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ genext2fs -b 32768 -B $((<span class="number">64</span>*<span class="number">1024</span>*<span class="number">1024</span>/<span class="number">32768</span>)) -d ./extboot -i 8192 -U boot.img</span><br></pre></td></tr></table></figure><p>åˆ·å†™è¿›å…¥ç³»ç»ŸåæŸ¥çœ‹åˆ°å¦‚ä¸‹<code>log</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Found /extlinux/extlinux.conf</span><br><span class="line">Retrieving file: /extlinux/extlinux.conf</span><br><span class="line">929 bytes <span class="built_in">read</span> <span class="keyword">in</span> 3 ms (301.8 KiB/s)</span><br><span class="line">3:      rockchip-6.10</span><br><span class="line">Retrieving file: /Image-6.10</span><br><span class="line">24766472 bytes <span class="built_in">read</span> <span class="keyword">in</span> 153 ms (154.4 MiB/s)</span><br><span class="line">append: dev/mmcblk0p3 earlyprintk console=ttyFIQ0 console=tty1 consoleblank=0 loglevel=7 rootwait rw rootfstype=ext4 cgroup_enable=cpuset cgroup_memory</span><br><span class="line">=1 cgroup_enable=memory swapaccount=1 switolb=1 coherent_pool=1m</span><br><span class="line">Retrieving file: /rk3568-lubancat-2.dtb</span><br><span class="line">60473 bytes <span class="built_in">read</span> <span class="keyword">in</span> 3 ms (19.2 MiB/s)</span><br><span class="line">Fdt Ramdisk skip relocation</span><br><span class="line">No misc partition</span><br><span class="line"><span class="comment">## Flattened Device Tree blob at 0x0a100000</span></span><br><span class="line">   Booting using the fdt blob at 0x0a100000</span><br><span class="line">   Using Device Tree <span class="keyword">in</span> place at 000000000a100000, end 000000000a111c38</span><br><span class="line">can<span class="string">&#x27;t found rockchip,drm-logo, use rockchip,fb-logo</span></span><br><span class="line"><span class="string">WARNING: could not set reg FDT_ERR_BADOFFSET.</span></span><br><span class="line"><span class="string">failed to reserve fb-loader-logo memory</span></span><br><span class="line"><span class="string">WARNING: could not set reg FDT_ERR_BADOFFSET.</span></span><br><span class="line"><span class="string">Adding bank: 0x00200000 - 0x08400000 (size: 0x08200000)</span></span><br><span class="line"><span class="string">Adding bank: 0x09400000 - 0xf0000000 (size: 0xe6c00000)</span></span><br><span class="line"><span class="string">Adding bank: 0x1f0000000 - 0x200000000 (size: 0x10000000)</span></span><br><span class="line"><span class="string">Total: 494.4/538.906 ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Starting kernel ...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">I/TC: Secondary CPU 1 initializing</span></span><br><span class="line"><span class="string">I/TC: Secondary CPU 1 switching to normal world boot</span></span><br><span class="line"><span class="string">I/TC: Secondary CPU 2 initializing</span></span><br><span class="line"><span class="string">I/TC: Secondary CPU 2 switching to normal world boot</span></span><br><span class="line"><span class="string">I/TC: Secondary CPU 3 initializing</span></span><br><span class="line"><span class="string">I/TC: Secondary CPU 3 switching to normal world boot</span></span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ²¡æœ‰ç„¶åäº†â€¦ï¼Œçœ‹èµ·æ¥åº”è¯¥æ˜¯<code>earlycon</code>ä¸å¯¹ï¼Œå¹¶ä¸”<code>console</code>ä¹Ÿæ²¡èµ·æ¥ï¼Œä¸ç„¶ä¸åº”è¯¥ä»€ä¹ˆè¾“å‡ºéƒ½æ²¡æœ‰çš„ã€‚</p><p>æŸ¥çœ‹ä¸»çº¿å†…æ ¸ä¸‹çš„è®¾å¤‡æ ‘æ–‡ä»¶å‘ç°chosenèŠ‚ç‚¹ä¸€ç©·äºŒç™½ï¼š</p><p><img src="https://i.imghippo.com/files/QsQIj1725352719.png" alt="chosen"></p><p>å‚ç…§é²ç­çŒ«çš„<code>sdk</code>çš„è®¾å¤‡æ ‘å¯ä»¥å‘ç°<code>earlycon</code>è¢«æŒ‡å®šäº†ä¸€ä¸ª<code>uart8250</code>:</p><p><img src="https://i.imghippo.com/files/6o5uV1725353015.png" alt="chosen"></p><p>å‚ç…§é²ç­çŒ«çš„<code>sdk</code>çš„è®¾å¤‡æ ‘ç¼–å†™<code>extlinux.conf</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">label rockchip-master</span><br><span class="line">    kernel /Image-master</span><br><span class="line">    fdt /rk3568-lubancat-2.dtb</span><br><span class="line">    append root=dev/mmcblk0p3 earlycon=uart8250,mmio32,0xfe660000 console=ttyFIQ0 console=tty1 consoleblank=0 loglevel=7 rootwait rw rootfstype=ext4 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory swapaccount=1 switolb=1 coherent_pool=1m</span><br></pre></td></tr></table></figure><p>é‡æ–°åˆ¶ä½œé•œåƒåçƒ§å†™ï¼Œå‘ç°ç¡®å®åœ¨<code>CPU switch</code>ä¹‹å‰å°±èƒ½çœ‹åˆ°<code>log</code>äº†ï¼Œä½†æ˜¯ä¹‹åå´æ²¡æœ‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[    0.000000] GICv3: MBI range [229:259]</span><br><span class="line">[    0.000000] GICv3: MBI range [289:319]</span><br><span class="line">[    0.000000] GICv3: Using MBI frame 0x00000000fd410000</span><br><span class="line">[    0.000000] Root IRQ handler: gic_handle_irq</span><br><span class="line">[    0.000000] GICv3: GICv3 features: 16 PPIs</span><br><span class="line">[    0.000000] GICv3: GICD_CTRL.DS=0, SCR_EL3.FIQ=1</span><br><span class="line">[    0.000000] GICv3: CPU0: found redistributor 0 region 0:0x00000000fd460000</span><br><span class="line">[    0.000000] ITS: No ITS available, not enabling LPIs</span><br><span class="line">[    0.000000] rcu: srcu_init: Setting srcu_struct sizes based on contention.</span><br><span class="line">[    0.000000] arch_timer: cp15 timer(s) running at 24.00MHz (phys).</span><br><span class="line">[    0.000000] clocksource: arch_sys_counter: mask: 0xffffffffffffff max_cycles: 0x588fe9dc0, max_idle_ns: 440795202592 ns</span><br><span class="line">[    0.000001] sched_clock: 56 bits at 24MHz, resolution 41ns, wraps every 4398046511097ns</span><br><span class="line">[    0.001817] Console: colour dummy device 80x25</span><br><span class="line">[    0.002270] printk: legacy console [tty1] enabled</span><br><span class="line">[    0.002741] printk: legacy bootconsole [uart8250] disabled</span><br><span class="line">I/TC: Secondary CPU 1 initializing</span><br><span class="line">I/TC: Secondary CPU 1 switching to normal world boot</span><br><span class="line">I/TC: Secondary CPU 2 initializing</span><br><span class="line">I/TC: Secondary CPU 2 switching to normal world boot</span><br><span class="line">I/TC: Secondary CPU 3 initializing</span><br><span class="line">I/TC: Secondary CPU 3 switching to normal world boot</span><br></pre></td></tr></table></figure><p>åœ¨<code>extlinux.conf</code>æ–‡ä»¶ä¸­å®šä¹‰äº†è¿™ä¹ˆä¸€å¥è¯<code>console=ttyFIQ0</code>ï¼Œå¹¶ä¸”åœ¨é²ç­çŒ«<code>sdk</code>é‡Œé¢èƒ½å¤Ÿçœ‹åˆ°è¯¥èŠ‚ç‚¹å¹¶ä¸”æœ‰å¯¹åº”çš„é©±åŠ¨:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cat</span> <span class="built_in">arch</span>/arm64/boot/dts/rockchip/rk3568-lubancat-2.dtsi | grep fiq-debug</span><br><span class="line">fiq-debugger &#123;</span><br><span class="line">compatible = <span class="string">&quot;rockchip,fiq-debugger&quot;</span>;</span><br><span class="line">â¯ find -name <span class="string">&quot;*.c&quot;</span> -<span class="built_in">exec</span> grep -n <span class="string">&quot;rockchip,fiq-debugger&quot;</span> &#123;&#125; +</span><br><span class="line">./drivers/soc/rockchip/rk_fiq_debugger.c:894:&#123; .compatible = <span class="string">&quot;rockchip,fiq-debugger&quot;</span>, &#125;,</span><br></pre></td></tr></table></figure><p>åœ¨ä¸»çº¿å†…æ ¸çš„è®¾å¤‡æ ‘å’Œé©±åŠ¨é‡Œé¢éƒ½æ˜¯æ²¡æœ‰è¿™gäº›ä¸œè¥¿çš„ï¼Œæ‰€ä»¥ç›´æ¥å°†<code>ttyFIQ0</code>æ”¹æˆ<code>ttyS2,1500000</code>å°±è¡Œäº†ï¼Œä¸èµ°è¿™ä¸ªé©±åŠ¨äº†ã€‚</p><p>è¿™ä¸¤ä¸ªç¡¬ä»¶ä¸Šæ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œæ›´æ”¹åçš„<code>conf</code>æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">label rockchip-master</span><br><span class="line">    kernel /Image-master</span><br><span class="line">    fdt /rk3568-lubancat-2.dtb</span><br><span class="line">    append root=dev/mmcblk0p3 earlycon=uart8250,mmio32,0xfe660000 console=ttyS2,1500000 consoleblank=0 loglevel=7 rootwait rw rootfstype=ext4 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory swapaccount=1 switolb=1 coherent_pool=1m</span><br></pre></td></tr></table></figure><p>é‡æ–°æ‰“åŒ…é•œåƒå¹¶çƒ§å†™ï¼Œå¯ä»¥å‘ç°<code>log</code>å…¨éƒ¨éƒ½æœ‰äº†ä½†æ˜¯æ— æ³•è¿›å…¥ç³»ç»Ÿï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[    0.998974] mmcblk1rpmb: mmc1:0001 SC6311 4.00 MiB, chardev (239:0)</span><br><span class="line">[   10.939202] platform fe2b0000.mmc: deferred probe pending: platform: <span class="built_in">wait</span> <span class="keyword">for</span> supplier /i2c@fdd40000/pmic@20/regulators/LDO_REG5</span><br><span class="line">[   10.940228] platform fe720000.saradc: deferred probe pending: platform: <span class="built_in">wait</span> <span class="keyword">for</span> supplier /i2c@fdd40000/pmic@20/regulators/LDO_REG7</span><br><span class="line">[   10.941259] platform hdmi-sound: deferred probe pending: asoc-simple-card: parse error</span><br><span class="line">[   10.941969] platform fdc20000.syscon:io-domains: deferred probe pending: platform: <span class="built_in">wait</span> <span class="keyword">for</span> supplier /i2c@fdd40000/pmic@20/regulators/SWITCH_REG1</span><br><span class="line">[   10.943105] platform fe0a0000.hdmi: deferred probe pending: platform: <span class="built_in">wait</span> <span class="keyword">for</span> supplier /i2c@fdd40000/pmic@20/regulators/LDO_REG9</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥æ˜¯<code>regulator</code>çš„é—®é¢˜ï¼ŒæŸ¥è¯¢è®¾å¤‡æ ‘ä¸­<code>pmic</code>èŠ‚ç‚¹èŠ¯ç‰‡å¯¹åº”çš„æ˜¯<code>rk809</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&amp;i2c0 &#123;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">rk809: pmic@20 &#123;</span><br><span class="line">compatible = <span class="string">&quot;rockchip,rk809&quot;</span>;</span><br><span class="line">reg = &lt;0x20&gt;;</span><br><span class="line">interrupt-parent = &lt;&amp;gpio0&gt;;</span><br><span class="line">interrupts = &lt;RK_PA3 IRQ_TYPE_LEVEL_LOW&gt;;</span><br><span class="line">assigned-clocks = &lt;&amp;cru I2S1_MCLKOUT_TX&gt;;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>è¯¥è®¾å¤‡æ˜¯ä¸€ä¸ª<code>i2c</code>è®¾å¤‡ï¼ŒæŸ¥æ‰¾è¯¥è®¾å¤‡å¯¹åº”çš„é©±åŠ¨ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ find -name <span class="string">&quot;*.c&quot;</span> -<span class="built_in">exec</span> grep -n <span class="string">&quot;rockchip,rk809&quot;</span> &#123;&#125; +</span><br><span class="line">./drivers/mfd/rk8xx-i2c.c:230:&#123; .compatible = <span class="string">&quot;rockchip,rk809&quot;</span>, .data = &amp;rk809_data &#125;,</span><br><span class="line">â¯ <span class="built_in">cat</span> ./drivers/mfd/Makefile | grep rk8xx</span><br><span class="line">obj-$(CONFIG_MFD_RK8XX)+= rk8xx-core.o</span><br><span class="line">obj-$(CONFIG_MFD_RK8XX_I2C)+= rk8xx-i2c.o</span><br><span class="line">obj-$(CONFIG_MFD_RK8XX_SPI)+= rk8xx-spi.o</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰“å¼€<code>CONFIG_MFD_RK8XX</code>å’Œ<code>CONFIG_MFD_RK8XX_I2C</code>è¿™ä¸¤ä¸ªé©±åŠ¨é…ç½®ã€‚</p><p>çƒ§å½•åˆ°å¼€å‘æ¿ä¸­å‘ç°ä¾æ—§å¡æ­»ï¼Œä½†æ˜¯<code>log</code>å‘ç”Ÿäº†å˜åŒ–ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[    1.015937] dwmmc_rockchip fe2b0000.mmc: Version ID is 270a</span><br><span class="line">[    1.016498] dwmmc_rockchip fe2b0000.mmc: DW MMC controller at irq 73,32 bit host data width,256 deep fifo</span><br><span class="line">[   11.158200] platform fe720000.saradc: deferred probe pending: rockchip-saradc: failed to get regulator</span><br><span class="line">[   11.159081] platform hdmi-sound: deferred probe pending: asoc-simple-card: parse error</span><br><span class="line">[   11.159808] platform fdc20000.syscon:io-domains: deferred probe pending: (reason unknown)</span><br><span class="line">[   11.159863] dwmmc_rockchip fe2b0000.mmc: IDMAC supports 32-bit address mode.</span><br><span class="line">[   11.160624] platform fe0a0000.hdmi: deferred probe pending: (reason unknown)</span><br><span class="line">[   11.161303] dwmmc_rockchip fe2b0000.mmc: Using internal DMA controller.</span><br><span class="line">[   11.162464] dwmmc_rockchip fe2b0000.mmc: Version ID is 270a</span><br><span class="line">[   11.163053] dwmmc_rockchip fe2b0000.mmc: DW MMC controller at irq 73,32 bit host data width,256 deep fifo</span><br></pre></td></tr></table></figure><p>æ ¹æ®å¤šå¹´å¡æ­»ç»éªŒç›´æ¥åˆ¤æ–­æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿæ— æ³•æŒ‚è½½ï¼Œä½†æ˜¯æ¢å›ä¹‹å‰é²ç­çŒ«çš„å†…æ ¸å°±åˆå¥½äº†ï¼Œè¯´æ˜ä¸æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„åŸå› ã€‚</p><p>è¿›å…¥<code>uboot</code>æŸ¥çœ‹<code>emmc</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; mmc list</span><br><span class="line">dwmmc@fe2b0000: 1</span><br><span class="line">dwmmc@fe2c0000: 2</span><br><span class="line">sdhci@fe310000: 0 (eMMC)</span><br><span class="line">=&gt; mmc info</span><br><span class="line">Device: sdhci@fe310000</span><br><span class="line">Manufacturer ID: ea</span><br><span class="line">OEM: 2d00</span><br><span class="line">Name: SC631 </span><br><span class="line">Timing Interface: HS200</span><br><span class="line">Tran Speed: 200000000</span><br><span class="line">Rd Block Len: 512</span><br><span class="line">MMC version 5.1</span><br><span class="line">High Capacity: Yes</span><br><span class="line">Capacity: 29.1 GiB</span><br><span class="line">Bus Width: 8-bit</span><br><span class="line">Erase Group Size: 512 KiB</span><br><span class="line">HC WP Group Size: 8 MiB</span><br><span class="line">User Capacity: 29.1 GiB WRREL</span><br><span class="line">Boot Capacity: 4 MiB ENH</span><br><span class="line">RPMB Capacity: 4 MiB ENH</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>emmc</code>èµ°çš„æ˜¯<code>sdhci</code>ï¼ŒæŸ¥çœ‹è®¾å¤‡æ ‘å‘ç°<code>aliases</code>å±…ç„¶æŠŠ<code>sdhci</code>ææˆäº†<code>mmc1</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">aliases &#123;</span><br><span class="line">ethernet0 = &amp;gmac0;</span><br><span class="line">ethernet1 = &amp;gmac1;</span><br><span class="line">mmc0 = &amp;sdmmc0;</span><br><span class="line">mmc1 = &amp;sdhci;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è°ƒæ¢<code>sdhci</code>å’Œ<code>sdmmc0</code>çš„é¡ºåºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">aliases &#123;</span><br><span class="line">ethernet0 = &amp;gmac0;</span><br><span class="line">ethernet1 = &amp;gmac1;</span><br><span class="line">mmc1 = &amp;sdmmc0;</span><br><span class="line">mmc0 = &amp;sdhci;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆåŠŸè¿›å…¥ç³»ç»Ÿï¼š</p><p><img src="https://i.imghippo.com/files/aqjXi1725354302.png" alt="system"></p>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568çš„minipcieæ— æ³•ä½¿ç”¨usbåŠŸèƒ½</title>
      <link href="/2024/08/30/rk3568%E7%9A%84minipcie%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8usb%E5%8A%9F%E8%83%BD/"/>
      <url>/2024/08/30/rk3568%E7%9A%84minipcie%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8usb%E5%8A%9F%E8%83%BD/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">From a8f5220957ebf1e7b45b9093319e4a5a9da13024 Mon Sep 17 00:00:00 2001</span><br><span class="line">From: Troy Mitchell &lt;TroyMitchell988@gmail.com&gt;</span><br><span class="line">Date: Fri, 30 Aug 2024 14:11:28 +0800</span><br><span class="line">Subject: [PATCH 1/1] modify rk3568-hbis-p68.dtsi: add usb hub regulator</span><br><span class="line"> node and the controling gpio that enables the hub.</span><br><span class="line"></span><br><span class="line">Signed-off-by: Troy Mitchell &lt;TroyMitchell988@gmail.com&gt;</span><br><span class="line">---</span><br><span class="line"> .../rk3568/kernel/dts/rk3568-hbis-p68.dtsi    | 86 +++++++++++++++++--</span><br><span class="line"> 1 file changed, 81 insertions(+), 5 deletions(-)</span><br><span class="line"></span><br><span class="line">diff --git a/device/board/hihope/rk3568/kernel/dts/rk3568-hbis-p68.dtsi b/device/board/hihope/rk3568/kernel/dts/rk3568-hbis-p68.dtsi</span><br><span class="line">index 7bc2f81..fa5c3d4 100644</span><br><span class="line">--- a/device/board/hihope/rk3568/kernel/dts/rk3568-hbis-p68.dtsi</span><br><span class="line">+++ b/device/board/hihope/rk3568/kernel/dts/rk3568-hbis-p68.dtsi</span><br><span class="line">@@ -38,9 +38,9 @@</span><br><span class="line"> &#125;;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line">-dc_5v: dc-5v &#123;</span><br><span class="line">+dc_12v: dc-12v &#123;</span><br><span class="line"> compatible = <span class="string">&quot;regulator-fixed&quot;</span>;</span><br><span class="line">-regulator-name = <span class="string">&quot;dc_5v&quot;</span>;</span><br><span class="line">+regulator-name = <span class="string">&quot;dc_12v&quot;</span>;</span><br><span class="line"> regulator-always-on;</span><br><span class="line"> regulator-boot-on;</span><br><span class="line"> regulator-min-microvolt = &lt;5000000&gt;;</span><br><span class="line">@@ -54,7 +54,7 @@</span><br><span class="line"> regulator-boot-on;</span><br><span class="line"> regulator-min-microvolt = &lt;5000000&gt;;</span><br><span class="line"> regulator-max-microvolt = &lt;5000000&gt;;</span><br><span class="line">-vin-supply = &lt;&amp;dc_5v&gt;;</span><br><span class="line">+vin-supply = &lt;&amp;dc_12v&gt;;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> vcc3v3_sys: vcc3v3-sys &#123;</span><br><span class="line">@@ -66,7 +66,17 @@</span><br><span class="line"> regulator-max-microvolt = &lt;3300000&gt;;</span><br><span class="line"> vin-supply = &lt;&amp;vcc5v0_sys&gt;;</span><br><span class="line"> &#125;;</span><br><span class="line">-</span><br><span class="line">+</span><br><span class="line">+vcc5v0_usb: vcc5v0-usb &#123;</span><br><span class="line">+compatible = <span class="string">&quot;regulator-fixed&quot;</span>;</span><br><span class="line">+regulator-name = <span class="string">&quot;vcc5v0_usb&quot;</span>;</span><br><span class="line">+regulator-always-on;</span><br><span class="line">+regulator-boot-on;</span><br><span class="line">+regulator-min-microvolt = &lt;5000000&gt;;</span><br><span class="line">+regulator-max-microvolt = &lt;5000000&gt;;</span><br><span class="line">+vin-supply = &lt;&amp;dc_12v&gt;;</span><br><span class="line">+&#125;;</span><br><span class="line">+/*</span><br><span class="line"> vcc5v0_usb20_host: vcc5v0-usb20-host-regulator &#123;</span><br><span class="line"> compatible = <span class="string">&quot;regulator-fixed&quot;</span>;</span><br><span class="line"> enable-active-high;</span><br><span class="line">@@ -98,6 +108,51 @@</span><br><span class="line"> pinctrl-0 = &lt;&amp;vcc5v0_otg_vbus_en&gt;;</span><br><span class="line"> regulator-name = <span class="string">&quot;vcc5v0_otg_vbus&quot;</span>;</span><br><span class="line"> &#125;;</span><br><span class="line">+*/</span><br><span class="line">+</span><br><span class="line">+vcc5v0_usb20_hub: vcc5v0-usb20-hub-regulator &#123;</span><br><span class="line">+compatible = <span class="string">&quot;regulator-fixed&quot;</span>;</span><br><span class="line">+enable-active-high;</span><br><span class="line">+gpio = &lt;&amp;gpio3 RK_PA6 GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">+pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">+pinctrl-0 = &lt;&amp;usb20_hub_pwr_en&gt;;</span><br><span class="line">+regulator-name = <span class="string">&quot;vcc5v0_usb20_hub&quot;</span>;</span><br><span class="line">+regulator-always-on;</span><br><span class="line">+vin-supply = &lt;&amp;vcc5v0_usb&gt;;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+vcc5v0_usb30_host: vcc5v0-usb30-host-regulator &#123;</span><br><span class="line">+compatible = <span class="string">&quot;regulator-fixed&quot;</span>;</span><br><span class="line">+enable-active-high;</span><br><span class="line">+gpio = &lt;&amp;gpio0 RK_PD6 GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">+pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">+pinctrl-0 = &lt;&amp;usb30_host1_pwr_en&gt;;</span><br><span class="line">+regulator-name = <span class="string">&quot;vcc5v0_usb30_host&quot;</span>;</span><br><span class="line">+regulator-always-on;</span><br><span class="line">+vin-supply = &lt;&amp;vcc5v0_usb&gt;;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+vcc5v0_usb20_host: vcc5v0-usb20-host-regulator &#123;</span><br><span class="line">+compatible = <span class="string">&quot;regulator-fixed&quot;</span>;</span><br><span class="line">+enable-active-high;</span><br><span class="line">+gpio = &lt;&amp;gpio0 RK_PD5 GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">+pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">+pinctrl-0 = &lt;&amp;usb20_host2_pwr_en&gt;;</span><br><span class="line">+regulator-name = <span class="string">&quot;vcc5v0_usb20_host2&quot;</span>;</span><br><span class="line">+regulator-always-on;</span><br><span class="line">+vin-supply = &lt;&amp;vcc5v0_usb&gt;;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+vcc5v0_otg_vbus: vcc5v0-otg-vbus-regulator &#123;</span><br><span class="line">+compatible = <span class="string">&quot;regulator-fixed&quot;</span>;</span><br><span class="line">+enable-active-high;</span><br><span class="line">+gpio = &lt;&amp;gpio0 RK_PD4 GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">+pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">+pinctrl-0 = &lt;&amp;usb_otg_vbus_en&gt;;</span><br><span class="line">+regulator-name = <span class="string">&quot;vcc5v0_otg&quot;</span>;</span><br><span class="line">+vin-supply = &lt;&amp;vcc5v0_usb&gt;;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line"> </span><br><span class="line"> mini_pcie_3v3: mini-pcie-3v3-regulator &#123;</span><br><span class="line"> compatible = <span class="string">&quot;regulator-fixed&quot;</span>;</span><br><span class="line">@@ -1173,7 +1228,27 @@</span><br><span class="line"> rockchip,pins = &lt;0 RK_PB0 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line"> &#125;;</span><br><span class="line"> &#125;;</span><br><span class="line">-</span><br><span class="line">+</span><br><span class="line">+usb &#123;</span><br><span class="line">+usb20_hub_pwr_en: usb20-hub-pwr-en &#123;</span><br><span class="line">+rockchip,pins = &lt;3 RK_PA6 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+usb30_host1_pwr_en: usb30-host1-pwr-en &#123;</span><br><span class="line">+rockchip,pins =&lt;0 RK_PD6 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+usb20_host2_pwr_en: usb20-host2-pwr-en &#123;</span><br><span class="line">+rockchip,pins = &lt;0 RK_PD5 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+usb_otg_vbus_en: usb-otg-vbus-en &#123;</span><br><span class="line">+rockchip,pins = &lt;0 RK_PD4 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line">+&#125;;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line">+/*</span><br><span class="line"> usb &#123;</span><br><span class="line"> vcc5v0_usb20_host_en: vcc5v0-usb20-host-en &#123;</span><br><span class="line"> rockchip,pins = &lt;0 RK_PD5 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line">@@ -1187,6 +1262,7 @@</span><br><span class="line"> rockchip,pins = &lt;0 RK_PD3 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line"> &#125;;</span><br><span class="line"> &#125;;</span><br><span class="line">+*/</span><br><span class="line"> /*</span><br><span class="line"> usb &#123;</span><br><span class="line"> vcc5v0_usb20_host_en: vcc5v0-usb20-host-en &#123;</span><br><span class="line">-- </span><br><span class="line">2.34.1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rk3568 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é‡ç«ubootä½¿ç”¨extbootå¯åŠ¨å†…æ ¸æµç¨‹</title>
      <link href="/2024/08/26/%E9%87%8E%E7%81%ABuboot%E4%BD%BF%E7%94%A8extboot%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8%E6%B5%81%E7%A8%8B/"/>
      <url>/2024/08/26/%E9%87%8E%E7%81%ABuboot%E4%BD%BF%E7%94%A8extboot%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p>æŸ¥çœ‹é‡ç«<code>uboot</code>å‚æ•°:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> bootcmd</span><br><span class="line">bootcmd=run distro_bootcmd;boot_android <span class="variable">$&#123;devtype&#125;</span> <span class="variable">$&#123;devnum&#125;</span>;boot_fit;bootrkp;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªå‘½ä»¤æ˜¯<code>distro_bootcmd</code>ï¼Œäº‹å®ä¸Šï¼Œé‡ç«çš„<code>extboot</code>ä¹Ÿå°±æ˜¯ä»è¿™é‡Œå¯åŠ¨çš„:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> distro_bootcmd </span><br><span class="line">distro_bootcmd=<span class="keyword">for</span> target <span class="keyword">in</span> <span class="variable">$&#123;boot_targets&#125;</span>; <span class="keyword">do</span> run bootcmd_<span class="variable">$&#123;target&#125;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>å…³äº<code>distro_bootcmd</code>æ›´è¯¦ç»†çš„å†…å®¹å¯ä»¥æŸ¥çœ‹ï¼š<a href="https://blog.troy-y.org/2024/08/23/Rockchip-%E7%B3%BB%E5%88%97%E8%8A%AF%E7%89%87uboot-distro-cmd/">https://blog.troy-y.org/2024/08/23/Rockchip-%E7%B3%BB%E5%88%97%E8%8A%AF%E7%89%87uboot-distro-cmd/</a></p><p>è¿™é‡Œç›´æ¥è¿›å…¥åˆ°<code>bootcmd_mmc0</code>ï¼Œä¹Ÿå°±æ˜¯ä»<code>emmc</code>å¯åŠ¨ï¼Œ<code>sd</code>å¡å¤§åŒå°å¼‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> bootcmd_mmc0</span><br><span class="line">bootcmd_mmc0=setenv devnum 0; run mmc_boot</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>bootcmd_mmc0</code>å°±æ˜¯è®¾ç½®å¥½<code>devnum</code>å˜é‡ï¼Œç„¶åæ‰§è¡Œäº†<code>mmc_boot</code>ï¼Œè¿™æ˜¯ä¸ºäº†å°†<code>sd</code>å¡å’Œ<code>emmc</code>è¿›è¡ŒæŠ½è±¡ï¼ŒæŸ¥çœ‹<code>mmc_boot</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> mmc_boot</span><br><span class="line">mmc_boot=<span class="keyword">if</span> mmc dev <span class="variable">$&#123;devnum&#125;</span>; <span class="keyword">then</span> setenv devtype mmc; run scan_dev_for_boot_part; <span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>åœ¨<code>mmc_boot</code>é˜¶æ®µï¼Œè®¾ç½®äº†å˜é‡<code>devtype</code>ä¸º<code>mmc</code>ï¼Œç„¶åæ‰§è¡Œ<code>scan_dev_for_boot_part</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> scan_dev_for_boot_part</span><br><span class="line">scan_dev_for_boot_part=part list <span class="variable">$&#123;devtype&#125;</span> <span class="variable">$&#123;devnum&#125;</span> -bootable devplist; <span class="built_in">env</span> exists devplist || setenv devplist 1; <span class="keyword">for</span> distro_bootpart <span class="keyword">in</span> <span class="variable">$&#123;devplist&#125;</span>;</span><br><span class="line"> <span class="keyword">do</span> <span class="keyword">if</span> fstype <span class="variable">$&#123;devtype&#125;</span> <span class="variable">$&#123;devnum&#125;</span>:<span class="variable">$&#123;distro_bootpart&#125;</span> bootfstype; <span class="keyword">then</span> run scan_dev_for_boot; <span class="keyword">fi</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="scan-dev-for-boot-part"><a href="#scan-dev-for-boot-part" class="headerlink" title="scan_dev_for_boot_part"></a>scan_dev_for_boot_part</h2><p>åœ¨<code>scan_dev_for_boot_part</code>é˜¶æ®µå°±æ¯”è¾ƒå¤æ‚äº†ï¼Œåœ¨ubootä¸­ä¸æ–¹ä¾¿æŸ¥çœ‹ï¼Œæˆ‘ä»¬è½¬åˆ°å¤´æ–‡ä»¶æŸ¥çœ‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: ./include/config_distro_bootcmd.h</span></span><br><span class="line"><span class="string">&quot;scan_dev_for_boot_part=&quot;</span>                                         \</span><br><span class="line"><span class="string">&quot;part list $&#123;devtype&#125; $&#123;devnum&#125; -bootable devplist; &quot;</span>     \</span><br><span class="line"><span class="string">&quot;env exists devplist || setenv devplist 1; &quot;</span>              \</span><br><span class="line"><span class="string">&quot;for distro_bootpart in $&#123;devplist&#125;; do &quot;</span>                 \</span><br><span class="line"><span class="string">&quot;if fstype $&#123;devtype&#125; &quot;</span>                           \</span><br><span class="line"><span class="string">&quot;$&#123;devnum&#125;:$&#123;distro_bootpart&#125; &quot;</span>   \</span><br><span class="line"><span class="string">&quot;bootfstype; then &quot;</span>               \</span><br><span class="line"><span class="string">&quot;run scan_dev_for_boot; &quot;</span>                 \</span><br><span class="line"><span class="string">&quot;fi; &quot;</span>                                            \</span><br><span class="line"><span class="string">&quot;done\0&quot;</span>                                                  \</span><br></pre></td></tr></table></figure><p>è¯¸è¡Œåˆ†æï¼š<br>    - åˆ—å‡º<code>$&#123;devtype&#125; $&#123;devnum&#125; </code>ä¸‹æ‰€æœ‰<code>bootable</code>çš„åˆ†åŒºå¹¶ä¸”å°†å…¶æ”¾åˆ°<code>devplist</code>å˜é‡ä¸­<br>    - åˆ¤æ–­<code>devplist</code>æ˜¯å¦å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€æ­¥æ˜¯å¦æˆåŠŸï¼Œå¦‚æœä¸æˆåŠŸè®¾ç½®ä¸º<code>1</code><br>    - ä½¿ç”¨<code>distro_bootpart</code>å˜é‡éå†<code>devplist</code>ï¼Œå‡å¦‚<code>devplist</code>æ˜¯<code>2</code>,é‚£ä¹ˆ<code>distro_bootpart</code>ä¼šæ˜¯<code>0,1,2</code><br>    - åœ¨<code>for</code>å¾ªç¯ä¸­è¾“å‡º<code>$&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125;</code>çš„æ–‡ä»¶ç±»å‹ç»™<code>bootfstype</code>å˜é‡<br>    - è¿è¡Œ<code>scan_dev_for_boot</code></p><h2 id="scan-dev-for-boot"><a href="#scan-dev-for-boot" class="headerlink" title="scan_dev_for_boot"></a>scan_dev_for_boot</h2><p>æŸ¥çœ‹<code>scan_dev_for_boot</code>:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: ./include/config_distro_bootcmd.h</span></span><br><span class="line"><span class="string">&quot;scan_dev_for_boot=&quot;</span>                                              \</span><br><span class="line"><span class="string">&quot;echo Scanning $&#123;devtype&#125; &quot;</span>                               \</span><br><span class="line"><span class="string">&quot;$&#123;devnum&#125;:$&#123;distro_bootpart&#125;...; &quot;</span>       \</span><br><span class="line"><span class="string">&quot;for prefix in $&#123;boot_prefixes&#125;; do &quot;</span>                     \</span><br><span class="line"><span class="string">&quot;run scan_dev_for_scripts; &quot;</span>                      \</span><br><span class="line"><span class="string">&quot;run scan_dev_for_extlinux; &quot;</span>                     \</span><br><span class="line"><span class="string">&quot;done;&quot;</span>                                                   \</span><br><span class="line">SCAN_DEV_FOR_EFI                                          \</span><br><span class="line"><span class="string">&quot;\0&quot;</span>                                                      \</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…¶å®å°±æ˜¯æ‰“å°ä¸€ä¸ªè°ƒè¯•ä¿¡æ¯ï¼Œç„¶åéå†<code>boot_prefixes</code>å»è¿è¡Œä¸¤ä¸ªå‘½ä»¤ã€‚</p><p>æŸ¥çœ‹<code>boot_prefixes</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> boot_prefixes </span><br><span class="line">boot_prefixes=/ /boot/</span><br></pre></td></tr></table></figure><p>å°±æ˜¯ä¸€ä¸ª<code>boot</code>çš„å‰ç¼€ï¼Œä¸€ä¸ªæ˜¯<code>/</code>ä¸€ä¸ªæ˜¯<code>/boot/</code>ã€‚</p><h2 id="scan-dev-for-scripts"><a href="#scan-dev-for-scripts" class="headerlink" title="scan_dev_for_scripts"></a>scan_dev_for_scripts</h2><p>æŸ¥çœ‹<code>scan_dev_for_scripts</code>:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: ./include/config_distro_bootcmd.h</span></span><br><span class="line"><span class="string">&quot;scan_dev_for_scripts=&quot;</span>                                           \</span><br><span class="line"><span class="string">&quot;for script in $&#123;boot_scripts&#125;; do &quot;</span>                      \</span><br><span class="line"><span class="string">&quot;if test -e $&#123;devtype&#125; &quot;</span>                          \</span><br><span class="line"><span class="string">&quot;$&#123;devnum&#125;:$&#123;distro_bootpart&#125; &quot;</span>   \</span><br><span class="line"><span class="string">&quot;$&#123;prefix&#125;$&#123;script&#125;; then &quot;</span>       \</span><br><span class="line"><span class="string">&quot;echo Found U-Boot script &quot;</span>               \</span><br><span class="line"><span class="string">&quot;$&#123;prefix&#125;$&#123;script&#125;; &quot;</span>            \</span><br><span class="line"><span class="string">&quot;run boot_a_script; &quot;</span>                     \</span><br><span class="line"><span class="string">&quot;echo SCRIPT FAILED: continuing...; &quot;</span>     \</span><br><span class="line"><span class="string">&quot;fi; &quot;</span>                                            \</span><br><span class="line"><span class="string">&quot;done\0&quot;</span>                                                  \</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ¶‰åŠåˆ°ä¸€ä¸ªå˜é‡ä¸º<code>boot_scripts</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> boot_scripts </span><br><span class="line">boot_scripts=boot.scr.uimg boot.scr</span><br></pre></td></tr></table></figure><p>è¯¸è¡Œåˆ†æ<code>scan_dev_for_scripts</code>ï¼š<br>    - ä½¿ç”¨<code>script</code>å˜é‡éå†<code>boot_scripts</code><br>    - åˆ¤æ–­<code>$&#123;devnum&#125;:$&#123;distro_bootpart&#125; $&#123;prefix&#125;$&#123;script&#125;</code> æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br>    - å¦‚æœå­˜åœ¨è¿è¡Œ<code>boot_a_script</code></p><p>æŸ¥çœ‹<code>boot_a_script</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> boot_a_script </span><br><span class="line">boot_a_script=load <span class="variable">$&#123;devtype&#125;</span> <span class="variable">$&#123;devnum&#125;</span>:<span class="variable">$&#123;distro_bootpart&#125;</span> <span class="variable">$&#123;scriptaddr&#125;</span> <span class="variable">$&#123;prefix&#125;</span><span class="variable">$&#123;script&#125;</span>; <span class="built_in">source</span> <span class="variable">$&#123;scriptaddr&#125;</span></span><br></pre></td></tr></table></figure><p>å°†åˆšæ‰çš„<code>script</code>æ–‡ä»¶åŠ è½½åˆ°<code>scriptaddr</code>ï¼Œå¹¶ä¸”è¿è¡Œè¯¥è„šæœ¬ï¼Œ<code>source</code>å‘½ä»¤å°±æ˜¯è¿è¡Œè„šæœ¬ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> scriptaddr</span><br><span class="line">scriptaddr=0x00c00000</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹é‡ç«bootåˆ†åŒºä¸‹è„šæœ¬æ–‡ä»¶"><a href="#æŸ¥çœ‹é‡ç«bootåˆ†åŒºä¸‹è„šæœ¬æ–‡ä»¶" class="headerlink" title="æŸ¥çœ‹é‡ç«bootåˆ†åŒºä¸‹è„šæœ¬æ–‡ä»¶"></a>æŸ¥çœ‹é‡ç«bootåˆ†åŒºä¸‹è„šæœ¬æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@lubancat:/boot# <span class="built_in">ls</span> *.scr</span><br><span class="line">boot.scr</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±ä¸åˆ†æè¯¥å†…å®¹äº†ï¼Œè¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if test -e $&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125; /uEnv/uEnv.txt; then  </span><br><span class="line"> </span><br><span class="line">    echo [boot.cmd] load $&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125; $&#123;env_addr_r&#125; //</span><br><span class="line">uEnv/uEnv.txt ...; </span><br><span class="line">    load $&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125; $&#123;env_addr_r&#125; /uEnv/uEnv.txt; </span><br><span class="line"> </span><br><span class="line">    echo [boot.cmd] Importing environment from $&#123;devtype&#125; ... </span><br><span class="line">    env import -t $&#123;env_addr_r&#125; 0x8000 </span><br><span class="line"> </span><br><span class="line">    setenv bootargs $&#123;bootargs&#125; root=/dev/mmcblk$&#123;devnum&#125;p3 $&#123;cmdline&#125; </span><br><span class="line">    printenv bootargs </span><br><span class="line"> </span><br><span class="line">    echo [boot.cmd] load $&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125; $&#123;ramdisk_addr__</span><br><span class="line">r&#125; /initrd-$&#123;uname_r&#125; ... </span><br><span class="line">    load $&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125; $&#123;ramdisk_addr_r&#125; /initrd-$&#123;unaa</span><br><span class="line">me_r&#125; </span><br><span class="line"> </span><br><span class="line">    echo [boot.cmd] loading $&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125; $&#123;kernel_addd</span><br><span class="line">r_r&#125; /Image-$&#123;uname_r&#125; ... </span><br><span class="line">    load $&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125; $&#123;kernel_addr_r&#125; /Image-$&#123;unamee</span><br><span class="line">_r&#125;</span><br><span class="line"></span><br><span class="line">    echo [boot.cmd] loading default rk-kernel.dtb</span><br><span class="line">    load $&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125; $&#123;fdt_addr_r&#125; /rk-kernel.dtb</span><br><span class="line"></span><br><span class="line">    fdt addr  $&#123;fdt_addr_r&#125;</span><br><span class="line">    fdt set /chosen bootargs</span><br><span class="line"></span><br><span class="line">    echo [boot.cmd] dtoverlay from /uEnv/uEnv.txt</span><br><span class="line">    setenv dev_bootpart $&#123;devnum&#125;:$&#123;distro_bootpart&#125;</span><br><span class="line">    dtfile $&#123;fdt_addr_r&#125; $&#123;fdt_over_addr&#125;  /uEnv/uEnv.txt $&#123;env_addr_r&#125;</span><br><span class="line"></span><br><span class="line">    echo [boot.cmd] [$&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125;] ...</span><br><span class="line">    echo [boot.cmd] [booti] ...</span><br><span class="line">    booti $&#123;kernel_addr_r&#125; $&#123;ramdisk_addr_r&#125; $&#123;fdt_addr_r&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo [boot.cmd] run boot.cmd scripts failed ...;</span><br><span class="line"></span><br><span class="line"># Recompile with:</span><br><span class="line"># mkimage -C none -A arm -T script -d /boot/boot.cmd /boot/boot.scr</span><br></pre></td></tr></table></figure><h2 id="scan-dev-for-extlinux"><a href="#scan-dev-for-extlinux" class="headerlink" title="scan_dev_for_extlinux"></a>scan_dev_for_extlinux</h2><p>æŸ¥çœ‹<code>scan_dev_for_extlinux</code>:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: ./include/config_distro_bootcmd.h</span></span><br><span class="line"><span class="string">&quot;scan_dev_for_extlinux=&quot;</span>                                          \</span><br><span class="line"><span class="string">&quot;if test -e $&#123;devtype&#125; &quot;</span>                                  \</span><br><span class="line"><span class="string">&quot;$&#123;devnum&#125;:$&#123;distro_bootpart&#125; &quot;</span>           \</span><br><span class="line"><span class="string">&quot;$&#123;prefix&#125;extlinux/extlinux.conf; then &quot;</span>  \</span><br><span class="line"><span class="string">&quot;echo Found $&#123;prefix&#125;extlinux/extlinux.conf; &quot;</span>    \</span><br><span class="line"><span class="string">&quot;run boot_extlinux; &quot;</span>                             \</span><br><span class="line"><span class="string">&quot;echo SCRIPT FAILED: continuing...; &quot;</span>             \</span><br><span class="line"><span class="string">&quot;fi\0&quot;</span>                                                    \</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯åˆ¤æ–­<code>$&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125; $&#123;prefix&#125;extlinux/extlinux.conf</code>æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œå°±å»è¿è¡Œ<code>boot_extlinux</code>ã€‚</p><h2 id="boot-extlinux"><a href="#boot-extlinux" class="headerlink" title="boot_extlinux"></a>boot_extlinux</h2><p>æŸ¥çœ‹<code>boot_extlinux</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> boot_extlinux </span><br><span class="line">boot_extlinux=sysboot <span class="variable">$&#123;devtype&#125;</span> <span class="variable">$&#123;devnum&#125;</span>:<span class="variable">$&#123;distro_bootpart&#125;</span> any <span class="variable">$&#123;scriptaddr&#125;</span> <span class="variable">$&#123;prefix&#125;</span>extlinux/extlinux.conf</span><br></pre></td></tr></table></figure><p><code>boot_extlinux</code>ä¸­å®é™…è°ƒç”¨äº†<code>sysboot</code>å‘½ä»¤ï¼Œ<code>sysboot</code> æ˜¯ä¸€ä¸ª <code>U-Boot</code> å‘½ä»¤ï¼Œç”¨äºä»ç‰¹å®šè®¾å¤‡å’Œæ–‡ä»¶ç³»ç»ŸåŠ è½½å¹¶å¯åŠ¨ <code>Syslinux</code> å¼•å¯¼æ–‡ä»¶ã€‚<code>Syslinux</code> æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å¼•å¯¼åŠ è½½ç¨‹åºï¼Œé€šå¸¸ç”¨äºå¼•å¯¼ <code>Linux</code> å†…æ ¸ã€‚</p><h3 id="sysboot"><a href="#sysboot" class="headerlink" title="sysboot"></a>sysboot</h3><p>å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysboot [-p] &lt;interface&gt; &lt;dev[:part]&gt; &lt;ext2|fat|any&gt; [addr] [filename]</span><br></pre></td></tr></table></figure><ul><li>-p: å¯é€‰å‚æ•°ï¼Œè¡¨ç¤ºä½¿ç”¨ â€œpxelinuxâ€ æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚</li><li><interface>: è®¾å¤‡æ¥å£ç±»å‹ï¼Œä¾‹å¦‚ mmcã€usbã€scsiã€eth ç­‰ã€‚</li><li>&lt;dev[:part]&gt;: è®¾å¤‡å·å’Œå¯é€‰çš„åˆ†åŒºå·ã€‚ä¾‹å¦‚ï¼Œ0:1 è¡¨ç¤ºè®¾å¤‡ 0 çš„ç¬¬ 1 åˆ†åŒºã€‚</li><li>&lt;ext2|fat|any&gt;: æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œå¯ä»¥æ˜¯ ext2ã€fat æˆ– anyã€‚å…¶ä¸­ any ä¼šè‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</li><li></li><li>[filename]: å¯é€‰å‚æ•°ï¼Œè¦åŠ è½½å’Œè§£æçš„ Syslinux é…ç½®æ–‡ä»¶åï¼Œé€šå¸¸æ˜¯ syslinux.cfg æˆ– extlinux.confã€‚</li></ul><p>æ‰€ä»¥<code>boot_extlinux</code>ä¸­å°±æ˜¯å°†<code>$&#123;devtype&#125; $&#123;devnum&#125;:$&#123;distro_bootpart&#125;</code>åˆ†åŒºä¸­çš„<code>$&#123;prefix&#125;extlinux/extlinux.conf</code>æ–‡ä»¶åŠ è½½åˆ°<code>&#123;scriptaddr&#125;</code>å»ç”¨<code>sysboot</code>è¿è¡Œï¼Œè¯¥åˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹è®¾ç½®ä¸º<code>any</code>æ„æ€å°±æ˜¯è®©<code>uboot</code>è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</p><h3 id="cfgæ–‡ä»¶"><a href="#cfgæ–‡ä»¶" class="headerlink" title="cfgæ–‡ä»¶"></a>cfgæ–‡ä»¶</h3><p>Syslinux é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸å‘½åä¸º syslinux.cfg æˆ– extlinux.confï¼‰ç”¨äºæŒ‡å®šå¯åŠ¨é¡¹å’Œç›¸å…³å‚æ•°ã€‚è¿™ä¸ªæ–‡ä»¶çš„æ ¼å¼æ¯”è¾ƒç®€å•ï¼Œé€šå¸¸åŒ…å«å¯åŠ¨èœå•å’Œå†…æ ¸å¯åŠ¨é€‰é¡¹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹çš„ syslinux.cfg é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DEFAULT linux</span><br><span class="line">PROMPT 0</span><br><span class="line">TIMEOUT 50</span><br><span class="line"></span><br><span class="line">LABEL linux</span><br><span class="line">    KERNEL /boot/vmlinuz</span><br><span class="line">    APPEND root=/dev/sda1 ro quiet</span><br><span class="line">    INITRD /boot/initrd.img</span><br></pre></td></tr></table></figure><ul><li>DEFAULT: æŒ‡å®šé»˜è®¤å¯åŠ¨é¡¹çš„æ ‡ç­¾ï¼ˆå¦‚ LABEL ä¸­å®šä¹‰çš„åç§°ï¼‰ã€‚</li><li>PROMPT: è®¾ç½®æ˜¯å¦æ˜¾ç¤ºå¼•å¯¼èœå•ã€‚0 è¡¨ç¤ºä¸æ˜¾ç¤ºï¼Œç›´æ¥å¯åŠ¨é»˜è®¤é¡¹ï¼›1 è¡¨ç¤ºæ˜¾ç¤ºå¼•å¯¼èœå•ã€‚</li><li>TIMEOUT: è®¾ç½®ç­‰å¾…æ—¶é—´ï¼ˆä»¥1&#x2F;10ç§’ä¸ºå•ä½ï¼‰ã€‚ä¾‹å¦‚ï¼Œ50 è¡¨ç¤ºç­‰å¾…5ç§’ï¼Œç„¶åå¯åŠ¨é»˜è®¤é¡¹ã€‚</li><li>LABEL: å®šä¹‰ä¸€ä¸ªå¯åŠ¨é¡¹ï¼Œå¹¶ç»™å®ƒä¸€ä¸ªåç§°ï¼ˆå¦‚ linuxï¼‰ã€‚<ul><li>KERNEL: æŒ‡å®šè¦å¯åŠ¨çš„å†…æ ¸æ–‡ä»¶è·¯å¾„ã€‚</li><li>APPEND: å‘å†…æ ¸ä¼ é€’çš„å¯åŠ¨å‚æ•°ã€‚ä¾‹å¦‚ï¼Œroot&#x3D;&#x2F;dev&#x2F;sda1 ro quiet è¡¨ç¤ºæ ¹æ–‡ä»¶ç³»ç»Ÿåœ¨ &#x2F;- dev&#x2F;sda1ï¼Œåªè¯»æŒ‚è½½ï¼Œå¹¶ä¸”å¯åŠ¨æ—¶ä¿æŒé™é»˜æ¨¡å¼ã€‚</li><li>INITRD: æŒ‡å®šåˆå§‹ RAM ç£ç›˜æ˜ åƒï¼ˆinitrdï¼‰æ–‡ä»¶çš„è·¯å¾„ï¼Œé€šå¸¸ç”¨äºåŠ è½½å¿…è¦çš„é©±åŠ¨ç¨‹åºå’Œæ–‡ä»¶ç³»ç»Ÿæ”¯æŒã€‚</li></ul></li></ul><p>è¿˜å¯ä»¥ä½¿ç”¨<strong>æ›´é«˜çº§çš„é€‰é¡¹</strong>ï¼š</p><ul><li>SAY: æ˜¾ç¤ºæ¶ˆæ¯ç»™ç”¨æˆ·ã€‚</li><li>MENU DEFAULT: æŒ‡å®šä¸€ä¸ªèœå•é¡¹ä¸ºé»˜è®¤é€‰é¡¹ã€‚</li><li>FALLBACK: åœ¨é»˜è®¤å¯åŠ¨é¡¹å¤±è´¥æ—¶ï¼ŒæŒ‡å®šä¸€ä¸ªåå¤‡å¯åŠ¨é¡¹ã€‚</li><li>MENU LABEL: ç»™æ¯ä¸ªå¯åŠ¨é¡¹è®¾ç½®ä¸€ä¸ªæ˜¾ç¤ºåœ¨èœå•ä¸­çš„åç§°ã€‚</li><li>single: åœ¨ APPEND ä¸­æ·»åŠ  single å‚æ•°å°† Linux ä»¥å•ç”¨æˆ·æ¨¡å¼å¯åŠ¨ï¼Œé€šå¸¸ç”¨äºæ•…éšœæ’æŸ¥ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DEFAULT linux</span><br><span class="line">PROMPT 1</span><br><span class="line">TIMEOUT 100</span><br><span class="line"></span><br><span class="line">SAY Hello! Welcome to the Syslinux bootloader.</span><br><span class="line"></span><br><span class="line">LABEL linux</span><br><span class="line">    MENU LABEL Start Linux</span><br><span class="line">    KERNEL /boot/vmlinuz</span><br><span class="line">    APPEND root=/dev/sda1 ro quiet</span><br><span class="line">    INITRD /boot/initrd.img</span><br><span class="line">    MENU DEFAULT</span><br><span class="line"></span><br><span class="line">LABEL fallback</span><br><span class="line">    MENU LABEL Fallback Linux</span><br><span class="line">    KERNEL /boot/vmlinuz</span><br><span class="line">    APPEND root=/dev/sda2 ro single</span><br><span class="line">    INITRD /boot/initrd.img</span><br><span class="line">    FALLBACK</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦é‡ç‚¹è¯´æ˜çš„æ˜¯è®¾å¤‡æ ‘ç›¸å…³çš„é—®é¢˜ï¼Œå¦‚æœæƒ³æŒ‡å®šè®¾å¤‡æ ‘ï¼Œéœ€è¦ä»¥è¿™æ ·çš„æ ¼å¼è¿›è¡ŒæŒ‡å®šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FDT /your-device-tree.dtb</span><br></pre></td></tr></table></figure><p>æˆ–è€…ä¸æ˜ç¡®æŒ‡å®šè®¾å¤‡æ ‘ï¼Œä½†æŒ‡å®šè®¾å¤‡æ ‘æ‰€å­˜åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯ä»¥ç”¨<code>devicetreedir</code>æˆ–è€…<code>fdtdir</code>å»æŒ‡å®šã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">devicetreedir /</span><br></pre></td></tr></table></figure><p>æˆ–è€…æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fdtdir/</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ä½¿ç”¨æŒ‡å®šè®¾å¤‡æ ‘æ–‡ä»¶å¤¹ï¼Œä¸æ˜ç¡®æŒ‡å®šè®¾å¤‡æ ‘çš„æ–¹å¼ï¼Œ<code>uboot</code>ä¼šä½¿ç”¨ä»¥ä¸‹ç­–ç•¥æ¥æŸ¥æ‰¾è®¾å¤‡æ ‘ï¼š</p><ul><li>è‡ªåŠ¨é€‰æ‹©: U-Boot å¯èƒ½ä¼šè‡ªåŠ¨é€‰æ‹©ä¸å†…æ ¸æ–‡ä»¶åŒåæˆ–ç±»ä¼¼åç§°çš„ .dtb æ–‡ä»¶ã€‚å¦‚æœå†…æ ¸åæ˜¯ Image-4.19.232ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šå°è¯•æŸ¥æ‰¾ Image-4.19.232.dtb æˆ–å…¶ä»–ç±»ä¼¼åç§°çš„è®¾å¤‡æ ‘æ–‡ä»¶ã€‚</li><li>åœ¨ U-Boot ä¸­ï¼Œå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ï¼ˆå¦‚ fdtfileï¼‰æŒ‡å®šè®¾å¤‡æ ‘æ–‡ä»¶çš„è·¯å¾„ã€‚å¦‚æœæ²¡æœ‰åœ¨ extlinux.conf ä¸­æ˜ç¡®æŒ‡å®šè®¾å¤‡æ ‘ï¼ŒU-Boot å¯èƒ½ä¼šä½¿ç”¨è¿™äº›ç¯å¢ƒå˜é‡ä¸­å®šä¹‰çš„è·¯å¾„ã€‚</li></ul><h3 id="æŸ¥çœ‹é‡ç«bootåˆ†åŒºä¸‹extlinux-conf"><a href="#æŸ¥çœ‹é‡ç«bootåˆ†åŒºä¸‹extlinux-conf" class="headerlink" title="æŸ¥çœ‹é‡ç«bootåˆ†åŒºä¸‹extlinux.conf"></a>æŸ¥çœ‹é‡ç«bootåˆ†åŒºä¸‹extlinux.conf</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@lubancat:/boot# <span class="built_in">cat</span> extlinux/extlinux.conf </span><br><span class="line">label kernel-4.19.232</span><br><span class="line">        kernel /Image-4.19.232</span><br><span class="line">        devicetreedir /</span><br><span class="line">        append  root=/dev/mmcblk0p3 earlyprintk console=ttyFIQ0 console=tty1 consoleblank=0 loglevel=7 rootwait rw rootfstype=ext4 cgroup_enable=cpuset</span><br><span class="line"> cgroup_memory=1 cgroup_enable=memory swapaccount=1 switolb=1 coherent_pool=1m</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é‡ç«çš„<code>conf</code>æ–‡ä»¶å¹¶æ²¡æœ‰æ˜ç¡®æŒ‡å®šè®¾å¤‡æ ‘ï¼Œè€Œæ˜¯æŒ‡å®šäº†ä¸€ä¸ªè®¾å¤‡æ ‘æ–‡ä»¶å¤¹ï¼ŒæŸ¥çœ‹è®¾å¤‡æ ‘æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@lubancat:/boot# <span class="built_in">ls</span> *.dtb</span><br><span class="line">rk-kernel.dtb</span><br><span class="line">root@lubancat:/boot# <span class="built_in">ls</span> Image-4.19.232 </span><br><span class="line">Image-4.19.232</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰ä¸å†…æ ¸åŒåçš„è®¾å¤‡æ ‘æ–‡ä»¶ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯ä½¿ç”¨äº†<code>fdtfile</code>å˜é‡æ¥æŒ‡å®šè®¾å¤‡æ ‘ã€‚</p><p>è¿›å…¥<code>uboot</code>æŸ¥çœ‹<code>fdtfile</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> fdtfile </span><br><span class="line">fdtfile=rk-kernel.dtb</span><br></pre></td></tr></table></figure><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://doc.embedfire.com/lubancat-mp157/build_and_deploy/zh/latest/building_image/use_uboot/use_uboot.html">https://doc.embedfire.com/lubancat-mp157/build_and_deploy/zh/latest/building_image/use_uboot/use_uboot.html</a></p>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rk3568 </tag>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568ç§»æ¤uboot</title>
      <link href="/2024/08/26/rk3568%E7%A7%BB%E6%A4%8Duboot-1/"/>
      <url>/2024/08/26/rk3568%E7%A7%BB%E6%A4%8Duboot-1/</url>
      
        <content type="html"><![CDATA[<h1 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h1><p>Systemt: Ubuntu 22.04</p><h2 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h2><p>é¦–å…ˆå…‹éš†ä»“åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git <span class="built_in">clone</span> --depth=1  https://github.com/Caesar-github/u-boot</span><br><span class="line"><span class="comment"># è¿™æ˜¯rkbinä»“åº“ï¼Œè‡³äºä¸ºä»€ä¹ˆå…‹éš†è§https://blog.troy-y.org/2024/08/23/rk3568%E7%A7%BB%E6%A4%8Duboot/</span></span><br><span class="line">â¯ git <span class="built_in">clone</span> --depth=1 git@github.com:Caesar-github/rkbin.git</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cd</span> uboot &amp;&amp; ./make.sh rk3568</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> rk356x_spl_loader_v1.13.112.bin</span><br><span class="line">rk356x_spl_loader_v1.13.112.bin</span><br><span class="line">â¯ <span class="built_in">ls</span> uboot.img</span><br><span class="line">uboot.img</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>rk356x_spl_loader_v1.13.112.bin</code>æ˜¯ç”±rkbinä»“åº“çš„<code>ddr init.bin</code>å’Œ<code>miniloader</code>åˆå¹¶æˆçš„ï¼Œäº†è§£åŸç†å¹¶æ‰‹åŠ¨åˆæˆå¯ä»¥çœ‹<a href="https://blog.troy-y.org/2024/08/23/rk3568%E7%A7%BB%E6%A4%8Duboot/">https://blog.troy-y.org/2024/08/23/rk3568%E7%A7%BB%E6%A4%8Duboot/</a></p><p><code>uboot.img</code>åˆ™æ˜¯ç”±<code>fit/u-boot.itb</code>æ‹·è´æ¥çš„ï¼Œ<code>fit/u-boot.itb</code>æ˜¯ä¸€ä¸ª<code>FIT</code>æ ¼å¼çš„é•œåƒæ–‡ä»¶ï¼Œç”±<code>fit/u-boot.its</code>æŒ‡å¯¼ç”Ÿæˆï¼Œè§‚å¯Ÿ<code>fit/u-boot.its</code>æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Copyright (C) 2020 Rockchip Electronic Co.,Ltd</span><br><span class="line"> *</span><br><span class="line"> * Simple U-boot fit <span class="built_in">source</span> file containing ATF/OP-TEE/U-Boot/dtb/MCU</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/dts-v1/;</span><br><span class="line"></span><br><span class="line">/ &#123;</span><br><span class="line">description = <span class="string">&quot;FIT Image with ATF/OP-TEE/U-Boot/MCU&quot;</span>;</span><br><span class="line"><span class="comment">#address-cells = &lt;1&gt;;</span></span><br><span class="line"></span><br><span class="line">images &#123;</span><br><span class="line"></span><br><span class="line">uboot &#123;</span><br><span class="line">description = <span class="string">&quot;U-Boot&quot;</span>;</span><br><span class="line">data = /incbin/(<span class="string">&quot;u-boot-nodtb.bin&quot;</span>);</span><br><span class="line"><span class="built_in">type</span> = <span class="string">&quot;standalone&quot;</span>;</span><br><span class="line"><span class="built_in">arch</span> = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line">os = <span class="string">&quot;U-Boot&quot;</span>;</span><br><span class="line">compression = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">load = &lt;0x00a00000&gt;;</span><br><span class="line"><span class="built_in">hash</span> &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">atf-1 &#123;</span><br><span class="line">description = <span class="string">&quot;ARM Trusted Firmware&quot;</span>;</span><br><span class="line">data = /incbin/(<span class="string">&quot;./bl31_0x00040000.bin&quot;</span>);</span><br><span class="line"><span class="built_in">type</span> = <span class="string">&quot;firmware&quot;</span>;</span><br><span class="line"><span class="built_in">arch</span> = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line">os = <span class="string">&quot;arm-trusted-firmware&quot;</span>;</span><br><span class="line">compression = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">load = &lt;0x00040000&gt;;</span><br><span class="line"><span class="built_in">hash</span> &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">atf-2 &#123;</span><br><span class="line">description = <span class="string">&quot;ARM Trusted Firmware&quot;</span>;</span><br><span class="line">data = /incbin/(<span class="string">&quot;./bl31_0xfdcc1000.bin&quot;</span>);</span><br><span class="line"><span class="built_in">type</span> = <span class="string">&quot;firmware&quot;</span>;</span><br><span class="line"><span class="built_in">arch</span> = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line">os = <span class="string">&quot;arm-trusted-firmware&quot;</span>;</span><br><span class="line">compression = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">load = &lt;0xfdcc1000&gt;;</span><br><span class="line"><span class="built_in">hash</span> &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">atf-3 &#123;</span><br><span class="line">description = <span class="string">&quot;ARM Trusted Firmware&quot;</span>;</span><br><span class="line">data = /incbin/(<span class="string">&quot;./bl31_0x0006a000.bin&quot;</span>);</span><br><span class="line"><span class="built_in">type</span> = <span class="string">&quot;firmware&quot;</span>;</span><br><span class="line"><span class="built_in">arch</span> = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line">os = <span class="string">&quot;arm-trusted-firmware&quot;</span>;</span><br><span class="line">compression = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">load = &lt;0x0006a000&gt;;</span><br><span class="line"><span class="built_in">hash</span> &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">atf-4 &#123;</span><br><span class="line">description = <span class="string">&quot;ARM Trusted Firmware&quot;</span>;</span><br><span class="line">data = /incbin/(<span class="string">&quot;./bl31_0xfdcd0000.bin&quot;</span>);</span><br><span class="line"><span class="built_in">type</span> = <span class="string">&quot;firmware&quot;</span>;</span><br><span class="line"><span class="built_in">arch</span> = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line">os = <span class="string">&quot;arm-trusted-firmware&quot;</span>;</span><br><span class="line">compression = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">load = &lt;0xfdcd0000&gt;;</span><br><span class="line"><span class="built_in">hash</span> &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">atf-5 &#123;</span><br><span class="line">description = <span class="string">&quot;ARM Trusted Firmware&quot;</span>;</span><br><span class="line">data = /incbin/(<span class="string">&quot;./bl31_0xfdcce000.bin&quot;</span>);</span><br><span class="line"><span class="built_in">type</span> = <span class="string">&quot;firmware&quot;</span>;</span><br><span class="line"><span class="built_in">arch</span> = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line">os = <span class="string">&quot;arm-trusted-firmware&quot;</span>;</span><br><span class="line">compression = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">load = &lt;0xfdcce000&gt;;</span><br><span class="line"><span class="built_in">hash</span> &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">atf-6 &#123;</span><br><span class="line">description = <span class="string">&quot;ARM Trusted Firmware&quot;</span>;</span><br><span class="line">data = /incbin/(<span class="string">&quot;./bl31_0x00068000.bin&quot;</span>);</span><br><span class="line"><span class="built_in">type</span> = <span class="string">&quot;firmware&quot;</span>;</span><br><span class="line"><span class="built_in">arch</span> = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line">os = <span class="string">&quot;arm-trusted-firmware&quot;</span>;</span><br><span class="line">compression = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">load = &lt;0x00068000&gt;;</span><br><span class="line"><span class="built_in">hash</span> &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">optee &#123;</span><br><span class="line">description = <span class="string">&quot;OP-TEE&quot;</span>;</span><br><span class="line">data = /incbin/(<span class="string">&quot;tee.bin&quot;</span>);</span><br><span class="line"><span class="built_in">type</span> = <span class="string">&quot;firmware&quot;</span>;</span><br><span class="line"><span class="built_in">arch</span> = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line">os = <span class="string">&quot;op-tee&quot;</span>;</span><br><span class="line">compression = <span class="string">&quot;none&quot;</span>;</span><br><span class="line"></span><br><span class="line">load = &lt;0x8400000&gt;;</span><br><span class="line"><span class="built_in">hash</span> &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">fdt &#123;</span><br><span class="line">description = <span class="string">&quot;U-Boot dtb&quot;</span>;</span><br><span class="line">data = /incbin/(<span class="string">&quot;./u-boot.dtb&quot;</span>);</span><br><span class="line"><span class="built_in">type</span> = <span class="string">&quot;flat_dt&quot;</span>;</span><br><span class="line"><span class="built_in">arch</span> = <span class="string">&quot;arm64&quot;</span>;</span><br><span class="line">compression = <span class="string">&quot;none&quot;</span>;</span><br><span class="line"><span class="built_in">hash</span> &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">configurations &#123;</span><br><span class="line">default = <span class="string">&quot;conf&quot;</span>;</span><br><span class="line">conf &#123;</span><br><span class="line">description = <span class="string">&quot;rk3568-evb&quot;</span>;</span><br><span class="line">rollback-index = &lt;0x0&gt;;</span><br><span class="line">firmware = <span class="string">&quot;atf-1&quot;</span>;</span><br><span class="line">loadables = <span class="string">&quot;uboot&quot;</span>, <span class="string">&quot;atf-2&quot;</span>, <span class="string">&quot;atf-3&quot;</span>, <span class="string">&quot;atf-4&quot;</span>, <span class="string">&quot;atf-5&quot;</span>, <span class="string">&quot;atf-6&quot;</span>, <span class="string">&quot;optee&quot;</span>;</span><br><span class="line"></span><br><span class="line">fdt = <span class="string">&quot;fdt&quot;</span>;</span><br><span class="line">signature &#123;</span><br><span class="line">algo = <span class="string">&quot;sha256,rsa2048&quot;</span>;</span><br><span class="line"></span><br><span class="line">key-name-hint = <span class="string">&quot;dev&quot;</span>;</span><br><span class="line">sign-images = <span class="string">&quot;fdt&quot;</span>, <span class="string">&quot;firmware&quot;</span>, <span class="string">&quot;loadables&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢å°†<code>bl31</code>æ–‡ä»¶åˆ†æˆäº†å¾ˆå¤šå—å’Œ<code>u-boot-nodtb.bin</code>è¿˜æœ‰<code>u-boot.dtb</code>æ”¾å…¥äº†<code>u-boot.itb</code>ï¼Œ<code>bl31</code>æ–‡ä»¶æ˜¯ä¸€ä¸ª<code>trust</code>æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯<code>ATF (Arm trust firmware)</code>ï¼Œ<code>ATF </code>ä¸»è¦è´Ÿè´£åœ¨å¯åŠ¨<code>uboot</code>ä¹‹å‰æŠŠ<code>CPU</code>ä»å®‰å…¨çš„<code>EL3</code>åˆ‡æ¢åˆ° <code>EL2</code>ï¼Œç„¶åè·³è½¬åˆ°<code>uboot</code>ï¼Œå¹¶ä¸”åœ¨å†…æ ¸å¯åŠ¨åè´Ÿè´£å¯åŠ¨å…¶ä»–çš„CPUã€‚</p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://www.cnblogs.com/zyly/p/17389525.html#_label0">https://www.cnblogs.com/zyly/p/17389525.html#_label0</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>dockeræ­å»ºçš„haæ— æ³•ä½¿ç”¨homekit bridge</title>
      <link href="/2024/08/26/docker%E6%90%AD%E5%BB%BA%E7%9A%84ha%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8homekit-bridge/"/>
      <url>/2024/08/26/docker%E6%90%AD%E5%BB%BA%E7%9A%84ha%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8homekit-bridge/</url>
      
        <content type="html"><![CDATA[<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://juejin.cn/post/7075383203820732430">https://juejin.cn/post/7075383203820732430</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> home-assistant </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>home assistantè¿œç¨‹è®¿é—®</title>
      <link href="/2024/08/24/home-assistant%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/"/>
      <url>/2024/08/24/home-assistant%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/</url>
      
        <content type="html"><![CDATA[<p>æ ¹æ®é“¾æ¥åˆ›å»ºå†…ç½‘ç©¿é€ï¼š<a href="https://sspai.com/post/79278">https://sspai.com/post/79278</a></p><p>æ­¤æ—¶æ‰“å¼€åŸŸåä¼šæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p><p><img src="https://developer.qcloudimg.com/http-save/yehe-10439143/0b96f1157a009111e282a8f2c97323b0.png" alt="bad request"></p><p>æŸ¥çœ‹<code>home assistant</code>çš„æ—¥å¿—ï¼š</p><p><img src="https://developer.qcloudimg.com/http-save/yehe-10439143/28809a086eb9acbfd4382ab534929919.png" alt="log"></p><p>æ­¤æ—¶å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>ip</code>ï¼Œè®°å½•ä¸‹æ¥ã€‚</p><p>æ‰“å¼€<code>homeassistant</code>çš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim </span><br><span class="line"><span class="comment"># æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹</span></span><br><span class="line">http:</span><br><span class="line">  use_x_forwarded_for: <span class="literal">true</span></span><br><span class="line">  trusted_proxies:</span><br><span class="line">    - &lt;<span class="built_in">log</span>ä¸­çš„ipåœ°å€&gt;</span><br></pre></td></tr></table></figure><p>é‡å¯<code>ha</code>ï¼Œé—®é¢˜è§£å†³</p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://cloud.tencent.com/developer/article/2260090">https://cloud.tencent.com/developer/article/2260090</a></p>]]></content>
      
      
      <categories>
          
          <category> home-assistant </category>
          
      </categories>
      
      
        <tags>
            
            <tag> home-assistant </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568 uboot distro_cmd</title>
      <link href="/2024/08/23/Rockchip-%E7%B3%BB%E5%88%97%E8%8A%AF%E7%89%87uboot-distro-cmd/"/>
      <url>/2024/08/23/Rockchip-%E7%B3%BB%E5%88%97%E8%8A%AF%E7%89%87uboot-distro-cmd/</url>
      
        <content type="html"><![CDATA[<h2 id="bootcmd"><a href="#bootcmd" class="headerlink" title="bootcmd"></a>bootcmd</h2><p>åœ¨<code>uboot</code>çš„<code>shell</code>ä¸­ä½¿ç”¨<code>printenv</code>å‘½ä»¤å¯ä»¥çœ‹åˆ°<code>bootcmd</code>çš„å­—ç¬¦ä¸²ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> bootcmd</span><br><span class="line">bootcmd=boot_android <span class="variable">$&#123;devtype&#125;</span> <span class="variable">$&#123;devnum&#125;</span>;boot_fit;bootrkp;run distro_bootcmd;</span><br></pre></td></tr></table></figure><p>å‘½ä»¤è§£æï¼š<br>    - <code>boot_android</code>: æŸ¥æ‰¾å¹¶å°è¯•å¯åŠ¨å®‰å“é•œåƒã€‚<br>    - <code>boot_fix</code>: æŸ¥æ‰¾å¹¶å°è¯•å¯åŠ¨fitæ ¼å¼é•œåƒã€‚<br>    - <code>bootrkp</code>: æŸ¥æ‰¾å¹¶å°è¯•å¯åŠ¨rkåˆ†åŒºé•œåƒã€‚<br>    - <code>run distro_bootcmd</code>: è¿™å°±æ˜¯è¿™ç¯‡æ–‡ç« çš„ä¸»è§’äº†ï¼Œdistro_bootcmdå¯ä»¥æ ¹æ®ä¸åŒä»‹è´¨å»å¯åŠ¨<code>kernel</code>å†…æ ¸ï¼Œæ¯”å¦‚<code>kernel</code>å¯ä»¥åœ¨sdå¡ï¼Œemmcä¸Šï¼Œéƒ½å¯ä»¥é¡ºåˆ©å¯åŠ¨ã€‚</p><p>ä»¥ä¸Šæåˆ°çš„<code>bootcmd</code>å¯ä»¥åœ¨<code>include/configs/rockchip-common.h</code>ä¸­çœ‹åˆ°ç›¸å…³å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_AVB_VBMETA_PUBLIC_KEY_VALIDATE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RKIMG_BOOTCOMMAND\</span></span><br><span class="line"><span class="meta"><span class="string">&quot;boot_android $&#123;devtype&#125; $&#123;devnum&#125;;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_FIT_SIGNATURE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RKIMG_BOOTCOMMAND\</span></span><br><span class="line"><span class="meta"><span class="string">&quot;boot_fit;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RKIMG_BOOTCOMMAND\</span></span><br><span class="line"><span class="meta"><span class="string">&quot;boot_android $&#123;devtype&#125; $&#123;devnum&#125;;&quot;</span>\</span></span><br><span class="line"><span class="meta"><span class="string">&quot;boot_fit;&quot;</span>\</span></span><br><span class="line"><span class="meta"><span class="string">&quot;bootrkp;&quot;</span>\</span></span><br><span class="line"><span class="meta"><span class="string">&quot;run distro_bootcmd;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h2 id="distro-bootcmd"><a href="#distro-bootcmd" class="headerlink" title="distro_bootcmd"></a>distro_bootcmd</h2><p>ç°åœ¨æ¥é‡ç‚¹åˆ†æä¸€ä¸‹<code>distro_bootcmd</code>ï¼Œé¦–å…ˆä½¿ç”¨æ‰“å°å‡º<code>distro_bootcmd</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> distro_bootcmd </span><br><span class="line">distro_bootcmd=<span class="keyword">for</span> target <span class="keyword">in</span> <span class="variable">$&#123;boot_targets&#125;</span>; <span class="keyword">do</span> run bootcmd_<span class="variable">$&#123;target&#125;</span>; <span class="keyword">done</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨<code>uboot</code>æºç ä¸­æ‰¾åˆ°å¯¹åº”å®ç°ï¼Œå¯ä»¥çœ‹åˆ°<code>BOOTENV_SET_SCSI_NEED_INIT</code>è¿™ä¸ªå®å®šä¹‰æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ä¸å¿…æ·±ç©¶ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV \</span></span><br><span class="line"><span class="meta">    BOOTENV_BOOT_TARGETS</span></span><br><span class="line">    ...</span><br><span class="line">BOOT_TARGET_DEVICES(BOOTENV_DEV)                                  \</span><br><span class="line">\</span><br><span class="line"><span class="string">&quot;distro_bootcmd=&quot;</span> BOOTENV_SET_SCSI_NEED_INIT                      \</span><br><span class="line"><span class="string">&quot;for target in $&#123;boot_targets&#125;; do &quot;</span>                      \</span><br><span class="line"><span class="string">&quot;run bootcmd_$&#123;target&#125;; &quot;</span>                         \</span><br><span class="line"><span class="string">&quot;done\0&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="BOOTENV"><a href="#BOOTENV" class="headerlink" title="BOOTENV"></a>BOOTENV</h3><p>åœ¨è¿™ä¸ª<code>BOOTENV</code>å®å®šä¹‰ä¸­ï¼Œå®šä¹‰äº†<code>distro_bootcmd</code>çš„å€¼ï¼Œ<code>BOOTENV</code>åœ¨<code>include/configs/rk3568_common.h</code>ä¸­è¢«ä½¿ç”¨åˆ°ï¼š</p><figure class="highlight plaintext"><figcaption><span>CONFIG_EXTRA_ENV_SETTINGS \</span></figcaption><table><tr><td class="code"><pre><span class="line">ENV_MEM_LAYOUT_SETTINGS \</span><br><span class="line">&quot;partitions=&quot; PARTS_RKIMG \</span><br><span class="line">ROCKCHIP_DEVICE_SETTINGS \</span><br><span class="line">RKIMG_DET_BOOTDEV \</span><br><span class="line">BOOTENV</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><p>è€Œ<code>CONFIG_EXTRA_ENV_SETTINGS</code>åˆåœ¨<code>include/env_default.h</code>ä¸­è¢«ä½¿ç”¨åˆ°ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEFAULT_ENV_INSTANCE_EMBEDDED</span></span><br><span class="line"><span class="type">env_t</span> environment __UBOOT_ENV_SECTION__ = &#123;</span><br><span class="line">ENV_CRC,<span class="comment">/* CRC Sum */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_REDUNDAND_ENVIRONMENT</span></span><br><span class="line"><span class="number">1</span>,<span class="comment">/* Flags: valid */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(DEFAULT_ENV_INSTANCE_STATIC)</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> default_environment[] = &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">const</span> uchar default_environment[] = &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>CONFIG_USE_BOOTARGS</span></span><br><span class="line"><span class="string">&quot;bootargs=&quot;</span>CONFIG_BOOTARGS<span class="string">&quot;\0&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>CONFIG_BOOTCOMMAND</span></span><br><span class="line"><span class="string">&quot;bootcmd=&quot;</span>CONFIG_BOOTCOMMAND<span class="string">&quot;\0&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>CONFIG_EXTRA_ENV_SETTINGS</span></span><br><span class="line">CONFIG_EXTRA_ENV_SETTINGS</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="string">&quot;\0&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEFAULT_ENV_INSTANCE_EMBEDDED</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h3 id="TODO-äº†è§£è¿™ä¸ªæ•°ç»„"><a href="#TODO-äº†è§£è¿™ä¸ªæ•°ç»„" class="headerlink" title="TODO äº†è§£è¿™ä¸ªæ•°ç»„"></a>TODO äº†è§£è¿™ä¸ªæ•°ç»„</h3><p>å›åˆ°<code>distro_bootcmd</code>ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV \</span></span><br><span class="line"><span class="meta">    BOOTENV_BOOT_TARGETS</span></span><br><span class="line">    ...</span><br><span class="line">BOOT_TARGET_DEVICES(BOOTENV_DEV)                                  \</span><br><span class="line">\</span><br><span class="line"><span class="string">&quot;distro_bootcmd=&quot;</span> BOOTENV_SET_SCSI_NEED_INIT                      \</span><br><span class="line"><span class="string">&quot;for target in $&#123;boot_targets&#125;; do &quot;</span>                      \</span><br><span class="line"><span class="string">&quot;run bootcmd_$&#123;target&#125;; &quot;</span>                         \</span><br><span class="line"><span class="string">&quot;done\0&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå¾ªç¯éå†<code> $&#123;boot_targets&#125;</code>å¹¶æ‰§è¡Œ<code>bootcmd_$&#123;target&#125;</code>,æŸ¥çœ‹<code> $&#123;boot_targets&#125;</code>ç›¸å…³å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: include/config_distro_bootcmd.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_DEV_NAME(devtypeu, devtypel, instance) \</span></span><br><span class="line"><span class="meta">BOOTENV_DEV_NAME_##devtypeu(devtypeu, devtypel, instance)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_BOOT_TARGETS \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;boot_targets=&quot;</span> BOOT_TARGET_DEVICES(BOOTENV_DEV_NAME) <span class="string">&quot;\0&quot;</span></span></span><br></pre></td></tr></table></figure><h3 id="BOOTENV-BOOT-TARGETSç”Ÿæˆboot-targetså­—ç¬¦ä¸²"><a href="#BOOTENV-BOOT-TARGETSç”Ÿæˆboot-targetså­—ç¬¦ä¸²" class="headerlink" title="BOOTENV_BOOT_TARGETSç”Ÿæˆboot_targetså­—ç¬¦ä¸²"></a>BOOTENV_BOOT_TARGETSç”Ÿæˆboot_targetså­—ç¬¦ä¸²</h3><p>é€šè¿‡<code>BOOTENV_BOOT_TARGETS</code>å®å®šä¹‰ç”Ÿæˆäº†<code>boot_targets</code>å­—ç¬¦ä¸²ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: include/config_distro_bootcmd.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_DEV_NAME(devtypeu, devtypel, instance) \</span></span><br><span class="line"><span class="meta">BOOTENV_DEV_NAME_##devtypeu(devtypeu, devtypel, instance)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_BOOT_TARGETS \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;boot_targets=&quot;</span> BOOT_TARGET_DEVICES(BOOTENV_DEV_NAME) <span class="string">&quot;\0&quot;</span></span></span><br></pre></td></tr></table></figure><blockquote><p>[!NOTE]<br>BOOTENV_BOOT_TARGETSä¹Ÿæ˜¯åœ¨BOOTENVä¸­å®šä¹‰çš„</p></blockquote><p><code>BOOTENV_BOOT_TARGETS</code>è°ƒç”¨äº†<code>BOOT_TARGET_DEVICES</code>å®å®šä¹‰ï¼Œ<code>BOOT_TARGET_DEVICES</code>å°±æ˜¯åœ¨å¯¹åº”çš„èŠ¯ç‰‡ä¸Šæˆ–èŠ¯ç‰‡ç³»åˆ—çš„å®šä¹‰äº†ï¼Œä¸åŒçš„èŠ¯ç‰‡åº”æœ‰ä¸åŒçš„å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: include/configs/rockchip-common.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOT_TARGET_DEVICES(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_MMC(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_MTD(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_RKNAND(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_USB(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_PXE(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_DHCP(func)</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®å®šä¹‰å®šä¹‰æˆäº†6ä¸ªå®ï¼Œè¿™é‡Œåªç ”ç©¶<code>BOOT_TARGET_MMC</code>ï¼Œå…¶ä»–éƒ½æ˜¯å·®ä¸å¤šçš„ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: include/configs/rockchip-common.h</span></span><br><span class="line"><span class="comment">/* First try to boot from SD (index 1), then eMMC (index 0) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(CMD_MMC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOT_TARGET_MMC(func) \</span></span><br><span class="line"><span class="meta">func(MMC, mmc, 1) \</span></span><br><span class="line"><span class="meta">func(MMC, mmc, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOT_TARGET_MMC(func)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>é€çº§å±•å¼€ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_DEV_NAME(devtypeu, devtypel, instance) \</span></span><br><span class="line"><span class="meta">BOOTENV_DEV_NAME_##devtypeu(devtypeu, devtypel, instance)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_BOOT_TARGETS \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;boot_targets=&quot;</span> BOOT_TARGET_DEVICES(BOOTENV_DEV_NAME) <span class="string">&quot;\0&quot;</span></span></span><br><span class="line"></span><br><span class="line">    -&gt;ï¼ˆè¿™é‡Œå°±åªå±•å¼€mmcäº†ï¼Œé“ç†éƒ½ä¸€æ ·ï¼‰</span><br><span class="line">    <span class="string">&quot;boot_targets=&quot;</span>  BOOT_TARGET_MMC(BOOTENV_DEV_NAME) <span class="string">&quot;\0&quot;</span></span><br><span class="line">    -&gt;</span><br><span class="line">    <span class="string">&quot;boot_targets=&quot;</span>  BOOTENV_DEV_NAME(MMC, mmc, <span class="number">1</span>) \</span><br><span class="line">                        BOOTENV_DEV_NAME(MMC, mmc, <span class="number">0</span>)<span class="string">&quot;\0&quot;</span></span><br><span class="line">    -&gt;</span><br><span class="line">    <span class="string">&quot;boot_targets=&quot;</span>  BOOTENV_DEV_NAME_MMC(MMC, mmc, <span class="number">1</span>) \</span><br><span class="line">                        BOOTENV_DEV_NAME_MMC(MMC, mmc, <span class="number">0</span>)<span class="string">&quot;\0&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>BOOTENV_DEV_NAME_MMC</code>å®å®šä¹‰:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: include/config_distro_bootcmd.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_DEV_NAME_BLKDEV(devtypeu, devtypel, instance) \</span></span><br><span class="line"><span class="meta">#devtypel #instance <span class="string">&quot; &quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_DEV_NAME_MMCBOOTENV_DEV_NAME_BLKDEV</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­å±•å¼€ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_DEV_NAME(devtypeu, devtypel, instance) \</span></span><br><span class="line"><span class="meta">BOOTENV_DEV_NAME_##devtypeu(devtypeu, devtypel, instance)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOTENV_BOOT_TARGETS \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;boot_targets=&quot;</span> BOOT_TARGET_DEVICES(BOOTENV_DEV_NAME) <span class="string">&quot;\0&quot;</span></span></span><br><span class="line"></span><br><span class="line">    -&gt;ï¼ˆè¿™é‡Œå°±åªå±•å¼€mmcäº†ï¼Œé“ç†éƒ½ä¸€æ ·ï¼‰</span><br><span class="line">    <span class="string">&quot;boot_targets=&quot;</span>  BOOT_TARGET_MMC(BOOTENV_DEV_NAME) <span class="string">&quot;\0&quot;</span></span><br><span class="line">    -&gt;</span><br><span class="line">    <span class="string">&quot;boot_targets=&quot;</span>  BOOTENV_DEV_NAME(MMC, mmc, <span class="number">1</span>) \</span><br><span class="line">                        BOOTENV_DEV_NAME(MMC, mmc, <span class="number">0</span>)<span class="string">&quot;\0&quot;</span></span><br><span class="line">    -&gt;</span><br><span class="line">    <span class="string">&quot;boot_targets=&quot;</span>  BOOTENV_DEV_NAME_MMC(MMC, mmc, <span class="number">1</span>) \</span><br><span class="line">                        BOOTENV_DEV_NAME_MMC(MMC, mmc, <span class="number">0</span>)<span class="string">&quot;\0&quot;</span></span><br><span class="line">    -&gt;</span><br><span class="line">    <span class="string">&quot;boot_targets=&quot;</span>  BOOTENV_DEV_NAME_BLKDEV(MMC, mmc, <span class="number">1</span>) \</span><br><span class="line">                        BOOTENV_DEV_NAME_BLKDEV(MMC, mmc, <span class="number">0</span>)<span class="string">&quot;\0&quot;</span></span><br><span class="line">        -&gt;</span><br><span class="line">    <span class="string">&quot;boot_targets=&quot;</span>  mmc1 mmc0  <span class="string">&quot;\0&quot;</span></span><br></pre></td></tr></table></figure><p>æœ€å<code>boot_targets</code>å°±å˜æˆäº†ä¸‹é¢è¿™æ ·ï¼ŒåŒæ—¶åœ¨<code>uboot</code>çš„<code>shell</code>ä¸­éªŒè¯ä¹Ÿæ˜¯è¿™æ ·ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">=&gt; <span class="built_in">printenv</span> boot_targets </span><br><span class="line">boot_targets=mmc1 mmc0 mtd2 mtd1 mtd0 usb0 pxe dhcp </span><br></pre></td></tr></table></figure><p><code>boot_targets</code>åˆ†æå®Œäº†ï¼Œä½†è¿™åªæ˜¯æˆ‘ä»¬<code>distro_bootcmd</code>å¾ªç¯çš„å˜é‡è€Œå·²ï¼Œè¿˜æœ‰ä¸€ä¸ª<code>run bootcmd_$&#123;target&#125;;</code>æ²¡æœ‰åˆ†æï¼Œé€šè¿‡<code>boot_targets</code>èƒ½çŸ¥é“ï¼Œè¿™è¿è¡Œçš„å¤§æ¦‚å°±æ˜¯<code>bootcmd_mmc0</code>, <code>bootcmd_mmc1</code>è¿™æ ·çš„ä¸œè¥¿ã€‚</p><h3 id="ç”Ÿæˆdistro-cmdè¿è¡Œå‘½ä»¤"><a href="#ç”Ÿæˆdistro-cmdè¿è¡Œå‘½ä»¤" class="headerlink" title="ç”Ÿæˆdistro_cmdè¿è¡Œå‘½ä»¤"></a>ç”Ÿæˆdistro_cmdè¿è¡Œå‘½ä»¤</h3><p>åœ¨<code>BOOTENV</code>ä¸­æœ‰ä¸€ä¸ªå®è°ƒç”¨æ˜¯<code>BOOT_TARGET_DEVICES(BOOTENV_DEV)</code>ï¼ˆä¸Šæ–‡BOOTENVä»£ç ä¸­è´´äº†ï¼‰ï¼Œç°åœ¨å›é¡¾ä¸€ä¸‹<code>BOOT_TARGET_DEVICES</code>: </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// path: include/configs/rockchip-common.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOOT_TARGET_DEVICES(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_MMC(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_MTD(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_RKNAND(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_USB(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_PXE(func) \</span></span><br><span class="line"><span class="meta">BOOT_TARGET_DHCP(func)</span></span><br></pre></td></tr></table></figure><p><code>BOOTENV_DEV</code>å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#define BOOTENV_DEV_BLKDEV(devtypeu, devtypel, instance) \</span><br><span class="line">&quot;bootcmd_&quot; #devtypel #instance &quot;=&quot; \</span><br><span class="line">&quot;setenv devnum &quot; #instance &quot;; &quot; \</span><br><span class="line">&quot;run &quot; #devtypel &quot;_boot\0&quot;</span><br></pre></td></tr></table></figure><p>é€çº§å±•å¼€ï¼ˆåªè®¨è®ºmmcï¼‰:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">   BOOT_TARGET_DEVICES(BOOTENV_DEV)</span><br><span class="line"></span><br><span class="line">   -&gt;ï¼ˆè¿™é‡Œå°±åªå±•å¼€mmcäº†ï¼Œé“ç†éƒ½ä¸€æ ·ï¼‰</span><br><span class="line">       BOOT_TARGET_MMC(BOOTENV_DEV) \</span><br><span class="line">   -&gt;</span><br><span class="line">   BOOTENV_DEV(MMC, mmc, <span class="number">1</span>) \</span><br><span class="line">BOOTENV_DEV(MMC, mmc, <span class="number">0</span>)<span class="string">&quot;\0&quot;</span></span><br><span class="line">   -&gt;</span><br><span class="line">   <span class="string">&quot;bootcmd_mmc1=setenv devnum 1;run mmc1_boot\0&quot;</span> \</span><br><span class="line">   <span class="string">&quot;bootcmd_mmc0=setenv devnum 0;run mmc0_boot\0&quot;</span> \</span><br></pre></td></tr></table></figure><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://blog.csdn.net/Andyshrk/article/details/89136721">https://blog.csdn.net/Andyshrk/article/details/89136721</a><br><a href="https://juejin.cn/post/7202851843488088125">https://juejin.cn/post/7202851843488088125</a></p>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rockchip ç³»åˆ—å¯åŠ¨æµç¨‹è§£è¯»</title>
      <link href="/2024/08/23/rk3568%E7%A7%BB%E6%A4%8Duboot/"/>
      <url>/2024/08/23/rk3568%E7%A7%BB%E6%A4%8Duboot/</url>
      
        <content type="html"><![CDATA[<h2 id="Socå¯åŠ¨æµç¨‹"><a href="#Socå¯åŠ¨æµç¨‹" class="headerlink" title="Socå¯åŠ¨æµç¨‹"></a>Socå¯åŠ¨æµç¨‹</h2><p>Socåœ¨ä¸Šç”µä¹‹åï¼Œç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ä»£ç æ˜¯èŠ¯ç‰‡æ˜¯<code>BootRom</code>ï¼Œé€šå¸¸æ¥è¯´ï¼ŒSoCå‚å®¶éƒ½ä¼šåšä¸€ä¸ª<code>ROM</code>åœ¨SoCçš„å†…éƒ¨ï¼Œè¿™ä¸ª<code>ROM</code>å¾ˆå°ï¼Œé‡Œé¢å›ºåŒ–äº†ä¸Šç”µå¯åŠ¨çš„ä»£ç ï¼ˆä¸€ç»å›ºåŒ–ï¼Œæ°¸ä¸èƒ½æ”¹ï¼Œæ˜¯èŠ¯ç‰‡åšçš„æ—¶å€™ï¼Œåšè¿›å»çš„ï¼‰ï¼›è¿™éƒ¨åˆ†ä»£ç å‘¢ï¼Œæˆ‘ä»¬ç®¡å®ƒå«åš<code>BootROM</code>ï¼Œä¹Ÿå«ä½œ<code>ä¸€çº§å¯åŠ¨ç¨‹åº</code>ã€‚</p><p>BootRoméœ€è¦åšçš„äº‹æƒ…ï¼šåˆå§‹åŒ–ç³»ç»Ÿï¼ŒCPUçš„é…ç½®ï¼Œå…³é—­çœ‹é—¨ç‹—ï¼Œåˆå§‹åŒ–æ—¶é’Ÿï¼Œåˆå§‹åŒ–ä¸€äº›å¤–è®¾ï¼ˆæ¯”å¦‚ <code>USB Controller</code>ã€<code>MMC Controller</code>ï¼Œ<code>Nand Controller</code>ç­‰ï¼‰ï¼›</p><p><code>BootROM</code>çš„ä»£ç é™¤äº†å»åˆå§‹åŒ–ç¡¬ä»¶ç¯å¢ƒä»¥å¤–ï¼Œè¿˜éœ€è¦å»å¤–éƒ¨å­˜å‚¨å™¨ä¸Šé¢ï¼Œå°†æ¥ä¸‹æ¥å¯æ‰§è¡Œçš„ç¨‹åºè¯»åˆ°å†…å­˜æ¥æ‰§è¡Œã€‚</p><p>ä½†æ­¤æ—¶<code>dram</code>è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç›´æ¥è¯»å–ç¨‹åºåˆ°<code>dram</code>ä¸Šæ‰§è¡Œï¼Œè¿™æ—¶å€™èŠ¯ç‰‡å†…éƒ¨è‡ªå¸¦çš„<code>sram</code>å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œä½†<code>sram</code>é€ ä»·é«˜æ˜‚ï¼Œæ‰€ä»¥é€šå¸¸å†…å­˜å®¹é‡è¾ƒå°ï¼Œåªèƒ½åŠ è½½ä¸€å°æ®µç¨‹åºåˆ°sramè¿è¡Œï¼Œè¿™ä¸€å°æ®µç¨‹åºåªéœ€è¦è´Ÿè´£åˆå§‹åŒ–<code>dram</code>ã€‚</p><p>åˆå§‹åŒ–å¥½<code>dram</code>ä¹‹åå°†è·³ä¼šåˆ°<code>BootRom</code>ï¼Œ<code>BootRom</code>å†åŠ è½½ä¸€æ®µç¨‹åºç”¨ä»¥å°†<code>uboot</code>å’Œ<code>trust</code>å¤åˆ¶åˆ°<code>dram</code>å¹¶è¿è¡Œã€‚</p><p>ä¸Šæ–‡æåˆ°äº†ä¸€ä¸ªä¸“ä¸šåè¯å«åš<code>trust</code>ï¼Œå› ä¸º<code>RK3399</code>æ˜¯<code>ARM64</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ç¼–è¯‘Â·<code>ATF (ARM Trust Firmware)</code>ï¼Œ<code>ATF</code>ä¸»è¦è´Ÿè´£åœ¨å¯åŠ¨<code>uboot</code>ä¹‹å‰æŠŠCPUä»å®‰å…¨çš„<code>EL3</code>åˆ‡æ¢åˆ°<code>EL2</code>ï¼Œç„¶åè·³è½¬åˆ°<code>uboot</code>ï¼Œå¹¶ä¸”åœ¨å†…æ ¸å¯åŠ¨åè´Ÿè´£å¯åŠ¨å…¶ä»–çš„CPUã€‚</p><h3 id="å¼€æºæ–¹å¼"><a href="#å¼€æºæ–¹å¼" class="headerlink" title="å¼€æºæ–¹å¼"></a>å¼€æºæ–¹å¼</h3><p>åœ¨å¼€æºæ–¹å¼ä¸­ï¼Œåˆå§‹åŒ–<code>dram</code>çš„ç¨‹åºå«åš<code>TPL</code>; å°†<code>uboot</code>åŠ è½½åˆ°<code>dram</code>ä¸­çš„ç¨‹åºå«åš<code>SPL</code>.</p><p>åœ¨<code>rockchip</code>ç§»æ¤å¥½çš„ubootä¸­å¼€å¯ä»¥ä¸‹é€‰é¡¹å³å¯ç¼–è¯‘å‡ºæ¥<code>TPL / SPL</code>æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPL / TPL</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_SUPPORT_SPL=y</span><br><span class="line">CONFIG_SUPPORT_TPL=y</span><br><span class="line">CONFIG_SPL=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_ADC_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_DECOMP_HEADER is not set</span></span><br><span class="line">CONFIG_SPL_BOARD_INIT=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_BOOTROM_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_RAW_IMAGE_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_LEGACY_IMAGE_SUPPORT is not set</span></span><br><span class="line">CONFIG_SPL_SYS_MALLOC_SIMPLE=y</span><br><span class="line"><span class="comment"># CONFIG_TPL_SYS_MALLOC_SIMPLE is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_STACK_R is not set</span></span><br><span class="line">CONFIG_SPL_SEPARATE_BSS=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_DISPLAY_PRINT is not set</span></span><br><span class="line">CONFIG_SPL_SKIP_RELOCATE=y</span><br><span class="line">CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_USE_SECTOR=y</span><br><span class="line">CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_SECTOR=0x4000</span><br><span class="line">CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_USE_PARTITION=y</span><br><span class="line">CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_PARTITION=1</span><br><span class="line">CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_PARTITION_NAME=<span class="string">&quot;uboot&quot;</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_CRC32_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_MD5_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_SHA1_SUPPORT is not set</span></span><br><span class="line">CONFIG_SPL_SHA256_SUPPORT=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_FIT_IMAGE_TINY is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_CPU_SUPPORT is not set</span></span><br><span class="line">CONFIG_SPL_CRYPTO_SUPPORT=y</span><br><span class="line">CONFIG_SPL_HASH_SUPPORT=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_DMA_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_ENV_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_EXT_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_FPGA_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_I2C_SUPPORT is not set</span></span><br><span class="line">CONFIG_SPL_MMC_WRITE=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_MPC8XXX_INIT_DDR_SUPPORT is not set</span></span><br><span class="line">CONFIG_SPL_MTD_SUPPORT=y</span><br><span class="line">CONFIG_MTD_BLK_U_BOOT_OFFS=0x4000</span><br><span class="line">CONFIG_SPL_MTD_WRITE=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_MUSB_NEW_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_NET_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_NO_CPU_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_NOR_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_XIP_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_ONENAND_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_OS_BOOT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_PCI_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_PCH_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_POST_MEM_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_POWER_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_PWM_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_RAM_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_RTC_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_SATA_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_RKNAND_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_SPI_FLASH_TINY is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_SPI_FLASH_SFDP_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_SPI_LOAD is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_USB_HOST_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_USB_GADGET is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_YMODEM_SUPPORT is not set</span></span><br><span class="line">CONFIG_SPL_ATF=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_OPTEE_SUPPORT is not set</span></span><br><span class="line">CONFIG_SPL_ATF_NO_PLATFORM_PARAM=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_OPTEE is not set</span></span><br><span class="line">CONFIG_SPL_AB=y</span><br><span class="line"><span class="comment"># CONFIG_SPL_LOAD_RKFW is not set</span></span><br><span class="line"><span class="comment"># CONFIG_SPL_KERNEL_BOOT is not set</span></span><br><span class="line">CONFIG_TPL=y</span><br><span class="line"><span class="comment"># CONFIG_TPL_BOARD_INIT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_TPL_NEEDS_SEPARATE_TEXT_BASE is not set</span></span><br><span class="line"><span class="comment"># CONFIG_TPL_NEEDS_SEPARATE_STACK is not set</span></span><br><span class="line"><span class="comment"># CONFIG_TPL_BOOTROM_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_TPL_DRIVERS_MISC_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_TPL_ENV_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_TPL_I2C_SUPPORT is not set</span></span><br><span class="line">CONFIG_TPL_TINY_FRAMEWORK=y</span><br><span class="line"><span class="comment"># CONFIG_TPL_MPC8XXX_INIT_DDR_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_TPL_MMC_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_TPL_NAND_SUPPORT is not set</span></span><br><span class="line">CONFIG_TPL_SERIAL_SUPPORT=y</span><br><span class="line"><span class="comment"># CONFIG_TPL_SPI_FLASH_SUPPORT is not set</span></span><br><span class="line"><span class="comment"># CONFIG_TPL_SPI_SUPPORT is not set</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> spl</span><br><span class="line"><span class="built_in">arch</span>   cmd     disk     dts  fs       lib         u-boot-spl      u-boot-spl.dtb      u-boot-spl.lds  u-boot-spl-nodtb.bin</span><br><span class="line">board  common  drivers  <span class="built_in">env</span>  include  u-boot.cfg  u-boot-spl.bin  u-boot-spl-dtb.bin  u-boot-spl.map  u-boot-spl.sym</span><br><span class="line">â¯ <span class="built_in">ls</span> tpl</span><br><span class="line"><span class="built_in">arch</span>   cmd     disk     dts  fs       lib         u-boot-spl.lds  u-boot-tpl.bin      u-boot-tpl.map        u-boot-tpl.sym</span><br><span class="line">board  common  drivers  <span class="built_in">env</span>  include  u-boot.cfg  u-boot-tpl      u-boot-tpl-dtb.bin  u-boot-tpl-nodtb.bin</span><br></pre></td></tr></table></figure><p>å°†è¿™ä¸¤ä¸ªæ–‡ä»¶æ‰“åŒ…æˆloaderé•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ tools/mkimage -n rk3399 -T rksd -d tpl/u-boot-tpl.bin idbloader.img</span><br><span class="line">Image Type:   Rockchip RK33 (SD/MMC) boot image</span><br><span class="line">Init Data Size: 2048 bytes</span><br><span class="line">â¯ ll idbloader.img</span><br><span class="line">-rw-rw-r-- 1 troy troy 4.0K  8æœˆ 23 16:39 idbloader.img</span><br><span class="line">â¯ <span class="built_in">cat</span> spl/u-boot-spl.bin &gt;&gt; idbloader.img</span><br><span class="line">â¯ ll idbloader.img</span><br><span class="line">-rw-rw-r-- 1 troy troy 244K  8æœˆ 23 16:39 idbloader.img</span><br></pre></td></tr></table></figure><h3 id="é—­æºæ–¹å¼"><a href="#é—­æºæ–¹å¼" class="headerlink" title="é—­æºæ–¹å¼"></a>é—­æºæ–¹å¼</h3><p>åœ¨å®˜æ–¹å›ºä»¶åŠ è½½æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬åŸºäº<code>Rockchip rkbin</code>å®˜æ–¹ç»™çš„<code>ddr.bin</code>ã€<code>miniloader.bin</code>æ¥å®ç°çš„: <a href="https://github.com/Caesar-github/rkbin">https://github.com/Caesar-github/rkbin</a></p><p>1.é€šè¿‡<code>tools/mkimage</code>å°†å®˜æ–¹å›ºä»¶<code>ddr</code>, <code>miniloader</code>æ‰“åŒ…æˆ<code>BootROM</code>ç¨‹åºå¯è¯†åˆ«çš„ã€å¸¦æœ‰<code>ID Block header</code>çš„æ–‡ä»¶<code>idbloader.img</code>ï¼›</p><p><code>ddr.bin</code>ï¼šç­‰ä»·äºä¸Šé¢è¯´çš„<code>TPL</code>ï¼Œç”¨äºåˆå§‹åŒ–<code>DDR</code>ï¼›<br>miniloader.binï¼šRockchipä¿®æ”¹çš„ä¸€ä¸ªbootloaderï¼Œç­‰ä»·äºä¸Šé¢è¯´çš„SPLï¼Œç”¨äºåŠ è½½ubootï¼›<br>è¿™ä¸ªæ–‡ä»¶æ‰“åŒ…å‡ºæ¥å®é™…ä¸Šä¹Ÿæ˜¯è¶…è¿‡192KBçš„ï¼Œå› æ­¤ä¹Ÿæ˜¯åˆ†ä¸ºäºŒé˜¶æ®µæ‰§è¡Œçš„ã€‚</p><ol start="2"><li>é€šè¿‡tools&#x2F;loaderimageå·¥å…·å°†u-boot.binæ‰“åŒ…æˆu-boot.imgï¼›å…¶ä¸­u-boot.binæ˜¯ç”±ubootæºç ç¼–è¯‘ç”Ÿæˆï¼›</li></ol><p>è¡¥å……è¯´æ˜ï¼šä½¿ç”¨Rockchip miniloaderçš„ idbloader æ—¶ï¼Œéœ€è¦å°†u-boot.biné€šè¿‡tools&#x2F;loaderimageè½¬æ¢ä¸ºå¯åŠ è½½çš„miniloaderæ ¼å¼ã€‚</p><p>3.ä½¿ç”¨Rockchipå·¥å…·tools&#x2F;trust_mergeå°†bl31.binæ‰“åŒ…æˆtrust.imgï¼›å…¶ä¸­bl31.binç”±ATFæºç ç¼–è¯‘ç”Ÿæˆï¼›</p><p>è¡¥å……è¯´æ˜ï¼šä½¿ç”¨Rockchip miniloaderçš„idbloader æ—¶ï¼Œéœ€è¦å°†bl31.biné€šè¿‡tools&#x2F;trust_mergeè½¬æ¢ä¸ºå¯åŠ è½½çš„miniloaderæ ¼å¼ã€‚</p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://www.cnblogs.com/zyly/p/17380243.html">https://www.cnblogs.com/zyly/p/17380243.html</a><br><a href="https://www.cnblogs.com/zyly/p/17389525.html#_label0">https://www.cnblogs.com/zyly/p/17389525.html#_label0</a><br><a href="https://github.com/Caesar-github/docs/tree/master/Common/UBOOT">https://github.com/Caesar-github/docs/tree/master/Common/UBOOT</a></p>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenHarmony on rk3568ä½¿èƒ½can</title>
      <link href="/2024/08/22/OpenHarmony-on-rk3568%E4%BD%BF%E8%83%BDcan/"/>
      <url>/2024/08/22/OpenHarmony-on-rk3568%E4%BD%BF%E8%83%BDcan/</url>
      
        <content type="html"><![CDATA[<h2 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h2><p>OH: v3.2.3<br>chip: rk3568</p><h2 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h2><p>é¦–å…ˆæŸ¥çœ‹æºç ä¸­æ˜¯å¦å…·æœ‰<code>CAN_ROCKCHIP</code>é€‰é¡¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ find -name <span class="string">&quot;Kconfig&quot;</span> -<span class="built_in">exec</span> grep -n <span class="string">&quot;CAN_ROCKCHIP&quot;</span> &#123;&#125; +</span><br><span class="line">â¯ </span><br></pre></td></tr></table></figure><p>å‘ç°ä»€ä¹ˆéƒ½æ²¡æœ‰..å¥½å§ï¼Œé‚£çœ‹åˆ°å®˜æ–¹çš„rk3568çš„è¡¥ä¸å¹¶æ²¡æœ‰æ‰“åˆ°è¿™é‡Œï¼Œéœ€è¦è‡ªå·±è¿›è¡Œé€‚é…ã€‚</p><p>å»rockchipçš„kernelä»“åº“æ‰¾åˆ°å…³äºcançš„éƒ¨åˆ†ï¼š<a href="https://github.com/rockchip-linux/kernel/blob/develop-5.10/drivers/net/can/rockchip/">https://github.com/rockchip-linux/kernel/blob/develop-5.10/drivers/net/can/rockchip/</a></p><p>è¿›å…¥åˆ°æˆ‘ä»¬çš„å†…æ ¸å·¥ä½œç›®å½•ï¼Œæ²¡æœ‰Makefileåˆ›å»ºçš„å¯ä»¥è§è¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.troy-y.org/2024/08/16/rk3568%E7%A7%BB%E6%A4%8DopenHarmony-v3-2-3-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/">https://blog.troy-y.org/2024/08/16/rk3568%E7%A7%BB%E6%A4%8DopenHarmony-v3-2-3-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/</a></p><p>å°†åˆšæ‰ä»“åº“çš„æ–‡ä»¶æ— è®ºç”¨ä»€ä¹ˆæ–¹å¼æ”¾åˆ°<code>driver/net/can/rockchip</code>ç›®å½•ä¸‹ï¼Œéšåè¿›è¡Œ<code>git</code>æ“ä½œ:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git add drivers/net/can/Makefile</span><br><span class="line">â¯ git add drivers/net/can/Kconfig</span><br><span class="line">â¯ git commit -m <span class="string">&quot;can init&quot;</span></span><br></pre></td></tr></table></figure><p>å¹¶ä¸”ä¿®æ”¹<code>driver/net/can/Makefile</code>å’Œ<code>driver/net/can/Kconfig</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ diff drivers/net/can/Makefile mmm</span><br><span class="line">32d31</span><br><span class="line">&lt; obj-$(CONFIG_CAN_ROCKCHIP)+= rockchip/</span><br><span class="line">â¯ diff drivers/net/can/Kconfig kkk</span><br><span class="line">181d180</span><br><span class="line">&lt; <span class="built_in">source</span> <span class="string">&quot;drivers/net/can/rockchip/Kconfig&quot;</span></span><br></pre></td></tr></table></figure><p>éšåä¿®æ”¹<code>config</code>æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ diff <span class="built_in">arch</span>/arm64/configs/rockchip_linux_defconfig ccc</span><br><span class="line">6858,6860d6857</span><br><span class="line">&lt; CONFIG_CAN=y</span><br><span class="line">&lt; CONFIG_CAN_ROFKCHIP=y</span><br><span class="line">&lt; CONFIG_CANFD_ROCKCHIP=y</span><br></pre></td></tr></table></figure><p>ç»§ç»­<code>git</code>æ“ä½œ:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git add drivers/net/can/Makefile</span><br><span class="line">â¯ git add drivers/net/can/Kconfig</span><br><span class="line">â¯ git add drivers/net/can/rockchip</span><br><span class="line">â¯ git commit -m <span class="string">&quot;add can support&quot;</span></span><br></pre></td></tr></table></figure><p>ç”Ÿæˆ<code>patch</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git format-patch --subject-prefix=<span class="string">&#x27;PATCH&#x27;</span> -n -s -1</span><br><span class="line">0001-add-can-support.patch</span><br><span class="line">â¯ <span class="built_in">cp</span> 0001-add-can-support.patch /mnt/v3.2.3/kernel/linux/patches/linux-5.10/rk3568_patch/add-can-support.patch &amp;&amp; <span class="built_in">rm</span> *.patch</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ç¼–è¯‘è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ diff device/board/hihope/rk3568/kernel/build_kernel.sh device/board/hihope/rk3568/kernel/build_kernel.sh.1</span><br><span class="line">34,35c34</span><br><span class="line">&lt; <span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10/rk3568_patch/add-jl201-drivers.patch</span><br><span class="line">&lt; <span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10/rk3568_patch/add-can-support.patch<span class="string">&quot;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">&gt; <span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10/rk3568_patch/add-jl201-drivers.patch&quot;</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹è®¾å¤‡æ ‘ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">â¯ vim device/board/hihope/rk3568/kernel/dts/rk3568-xxx.dtsi</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸‹å†…å®¹æ·»åŠ </span></span><br><span class="line">&amp;can2 &#123;</span><br><span class="line">compatible = <span class="string">&quot;rockchip,rk3568-can-2.0&quot;</span>;</span><br><span class="line">pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">pinctrl-0 = &lt;&amp;can2m0_pins&gt;;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://blog.troy-y.org/2024/08/16/rk3568%E7%A7%BB%E6%A4%8DopenHarmony-v3-2-3-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/">https://blog.troy-y.org/2024/08/16/rk3568%E7%A7%BB%E6%A4%8DopenHarmony-v3-2-3-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/</a><br><a href="https://github.com/rockchip-linux/kernel/blob/develop-5.10/drivers/net/can/rockchip/">https://github.com/rockchip-linux/kernel/blob/develop-5.10/drivers/net/can/rockchip/</a></p>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> openHarmony </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenHarmony on rk3568é©±åŠ¨intel 7260æ— çº¿ç½‘å¡</title>
      <link href="/2024/08/21/rk3568%E4%BD%BF%E7%94%A8mini-pcie%E9%A9%B1%E5%8A%A8intel-7260/"/>
      <url>/2024/08/21/rk3568%E4%BD%BF%E7%94%A8mini-pcie%E9%A9%B1%E5%8A%A8intel-7260/</url>
      
        <content type="html"><![CDATA[<h2 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h2><p>OH: v3.2.3<br>chip: rk3568</p><h2 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h2><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥æ‰¾<code>intel 7260</code>çš„é©±åŠ¨é…ç½®:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ find -name <span class="string">&quot;Kconfig&quot;</span> -<span class="built_in">exec</span> grep -n <span class="string">&quot;7260&quot;</span> &#123;&#125; +</span><br><span class="line">./drivers/watchdog/Kconfig:689:  Technologic Systems TS-7200, TS-7250 and TS-7260 boards have</span><br><span class="line">./drivers/net/wireless/intel/iwlwifi/Kconfig:22:Intel 7260 Wi-Fi Adapter</span><br></pre></td></tr></table></figure><p>åœ¨<code>./drivers/net/wireless/intel/iwlwifi/Kconfig</code>æ‰¾åˆ°äº†å…¶é…ç½®ï¼Œè¿›å»æŸ¥çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">config IWLWIFI</span><br><span class="line">tristate <span class="string">&quot;Intel Wireless WiFi Next Gen AGN - Wireless-N/Advanced-N/Ultimate-N (iwlwifi) &quot;</span></span><br><span class="line">depends on PCI &amp;&amp; HAS_IOMEM &amp;&amp; CFG80211</span><br><span class="line"><span class="keyword">select</span> FW_LOADER</span><br><span class="line"><span class="built_in">help</span></span><br><span class="line">  Select to build the driver supporting the:</span><br><span class="line"></span><br><span class="line">  Intel Wireless WiFi Link Next-Gen AGN</span><br><span class="line"></span><br><span class="line">  This option enables support <span class="keyword">for</span> use with the following hardware:</span><br><span class="line">Intel Wireless WiFi Link 6250AGN Adapter</span><br><span class="line">Intel 6000 Series Wi-Fi Adapters (6200AGN and 6300AGN)</span><br><span class="line">Intel WiFi Link 1000BGN</span><br><span class="line">Intel Wireless WiFi 5150AGN</span><br><span class="line">Intel Wireless WiFi 5100AGN, 5300AGN, and 5350AGN</span><br><span class="line">Intel 6005 Series Wi-Fi Adapters</span><br><span class="line">Intel 6030 Series Wi-Fi Adapters</span><br><span class="line">Intel Wireless WiFi Link 6150BGN 2 Adapter</span><br><span class="line">Intel 100 Series Wi-Fi Adapters (100BGN and 130BGN)</span><br><span class="line">Intel 2000 Series Wi-Fi Adapters</span><br><span class="line">Intel 7260 Wi-Fi Adapter</span><br><span class="line">Intel 3160 Wi-Fi Adapter</span><br><span class="line">Intel 7265 Wi-Fi Adapter</span><br><span class="line">Intel 8260 Wi-Fi Adapter</span><br><span class="line">Intel 3165 Wi-Fi Adapter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  This driver uses the kernel<span class="string">&#x27;s mac80211 subsystem.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  In order to use this driver, you will need a firmware</span></span><br><span class="line"><span class="string">  image for it. You can obtain the microcode from:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          &lt;https://wireless.wiki.kernel.org/en/users/Drivers/iwlwifi&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  The firmware is typically installed in /lib/firmware. You can</span></span><br><span class="line"><span class="string">  look in the hotplug script /etc/hotplug/firmware.agent to</span></span><br><span class="line"><span class="string">  determine which directory FIRMWARE_DIR is set to when the script</span></span><br><span class="line"><span class="string">  runs.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  If you want to compile the driver as a module ( = code which can be</span></span><br><span class="line"><span class="string">  inserted in and removed from the running kernel whenever you want),</span></span><br><span class="line"><span class="string">  say M here and read &lt;file:Documentation/kbuild/modules.rst&gt;.  The</span></span><br><span class="line"><span class="string">  module will be called iwlwifi.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if IWLWIFI</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">config IWLWIFI_LEDS</span></span><br><span class="line"><span class="string">bool</span></span><br><span class="line"><span class="string">depends on LEDS_CLASS=y || LEDS_CLASS=IWLWIFI</span></span><br><span class="line"><span class="string">depends on IWLMVM || IWLDVM</span></span><br><span class="line"><span class="string">select LEDS_TRIGGERS</span></span><br><span class="line"><span class="string">select MAC80211_LEDS</span></span><br><span class="line"><span class="string">default y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">config IWLDVM</span></span><br><span class="line"><span class="string">tristate &quot;Intel Wireless WiFi DVM Firmware support&quot;</span></span><br><span class="line"><span class="string">depends on MAC80211</span></span><br><span class="line"><span class="string">help</span></span><br><span class="line"><span class="string">  This is the driver that supports the DVM firmware. The list</span></span><br><span class="line"><span class="string">  of the devices that use this firmware is available here:</span></span><br><span class="line"><span class="string">  https://wireless.wiki.kernel.org/en/users/drivers/iwlwifi#firmware</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">config IWLMVM</span></span><br><span class="line"><span class="string">tristate &quot;Intel Wireless WiFi MVM Firmware support&quot;</span></span><br><span class="line"><span class="string">select WANT_DEV_COREDUMP</span></span><br><span class="line"><span class="string">depends on MAC80211</span></span><br><span class="line"><span class="string">help</span></span><br><span class="line"><span class="string">  This is the driver that supports the MVM firmware. The list</span></span><br><span class="line"><span class="string">  of the devices that use this firmware is available here:</span></span><br><span class="line"><span class="string">  https://wireless.wiki.kernel.org/en/users/drivers/iwlwifi#firmware</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ–‡ä»¶å¤¹å¹¶æ‹·è´<code>firmware</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p device/board/hihope/rk3568/kernel/firmware/ &amp;&amp; <span class="built_in">cp</span> &lt;firmware_path&gt; device/board/hihope/rk3568/kernel/firmware/</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ç¼–è¯‘è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ diff device/board/hihope/rk3568/kernel/build_kernel.sh device/board/hihope/rk3568/kernel/build_kernel.sh.1</span><br><span class="line">77,81d76</span><br><span class="line">&lt; <span class="comment"># firmware</span></span><br><span class="line">&lt; <span class="built_in">mkdir</span> -p <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/kernel/firmware</span><br><span class="line">&lt; <span class="built_in">cp</span>  -rf <span class="variable">$&#123;3&#125;</span>/kernel/firmware/* <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/kernel/firmware</span><br><span class="line">&lt; </span><br><span class="line">&lt; </span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ—¥å¿—åˆå§‹åŒ–æˆåŠŸï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dmesg | grep iwl</span></span><br><span class="line">[    2.899279] iwlwifi 0000:01:00.0: enabling device (0000 -&gt; 0002)</span><br><span class="line">[    2.902993] iwlwifi 0000:01:00.0: loaded firmware version 17.3216344376.0 7260-17.ucode op_mode iwlmvm</span><br><span class="line">[    2.903274] iwlwifi 0000:01:00.0: Detected Intel(R) Dual Band Wireless AC 7260, REV=0x144</span><br><span class="line">[    2.909365] iwlwifi 0000:01:00.0: reporting RF_KILL (radio disabled)</span><br><span class="line">[    2.909427] iwlwifi 0000:01:00.0: RF_KILL bit toggled to <span class="built_in">disable</span> radio.</span><br><span class="line">[    2.950167] iwlwifi 0000:01:00.0: base HW address: 80:86:f2:c3:ff:00</span><br><span class="line">[    2.969690] ieee80211 phy0: Selected rate control algorithm <span class="string">&#x27;iwl-mvm-rs&#x27;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>ifconfig</code>èƒ½å¤ŸæŸ¥çœ‹åˆ°ï¼Œä½†æ˜¯æ“ä½œå¤±è´¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ifconfig wlan0</span></span><br><span class="line">wlan0     Link encap:Ethernet  HWaddr 80:86:f2:c3:ff:00  Driver iwlwifi</span><br><span class="line">          BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0 </span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 </span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 TX bytes:0 </span><br><span class="line"></span><br><span class="line"><span class="comment"># ifconfig wlan0 up</span></span><br><span class="line">ifconfig: ioctl 8914: No error information</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨rfkillæŸ¥çœ‹çŠ¶æ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rfkill list</span></span><br><span class="line">0: phy0: wlan</span><br><span class="line">        Soft blocked: no</span><br><span class="line">        Hard blocked: <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>å‘ç°è¢«é”å®šäº†ï¼Œå°è¯•è§£é”ä½†æ˜¯å¤±è´¥äº†..ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rfkill unblock all</span></span><br><span class="line"><span class="comment"># rfkill list                                                                  </span></span><br><span class="line">0: phy0: wlan</span><br><span class="line">        Soft blocked: no</span><br><span class="line">        Hard blocked: <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®åŸç†å›¾å’Œè®¾å¤‡æ ‘ï¼Œæˆ‘ä»¬é”å®šä¸¤ä¸ªå¼•è„šï¼Œä¸€ä¸ªæ˜¯<code>reset</code>ä¸€ä¸ªæ˜¯<code>disable</code>:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* mini pcie */</span></span><br><span class="line">&amp;pcie2x1 &#123;</span><br><span class="line">reset-gpios = &lt;&amp;gpio3 RK_PC1 GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">disable-gpios = &lt;&amp;gpio3 RK_PC2 GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">vpcie3v3-supply = &lt;&amp;mini_pcie_3v3&gt;;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://i.postimg.cc/Y2TpH1Pq/2024-09-02-15-56-00.png" alt="2024-09-02-15-56-00.png"></p><p>ç»è¿‡ä¸‡ç”¨è¡¨æµ‹é‡<code>reset</code>å¼•è„šåœ¨è¿›å…¥<code>shell</code>åæ˜¯é«˜ç”µå¹³ï¼Œè€Œ<code>disable</code>å¼•è„šåˆ™ä»ä¸Šç”µåˆ°è¿›å…¥<code>shell</code>ä¸€ç›´éƒ½æ˜¯ä½ç”µå¹³ã€‚</p><p>é‚£ä¹ˆåº”è¯¥å¯ä»¥ç¡®å®šé—®é¢˜æ‰€åœ¨äº†ï¼Œå°±æ˜¯<code>disable</code>æå¾—é¬¼ã€‚</p><p>æŸ¥çœ‹æ–‡æ¡£<code>Documentation/devicetree/bindings/pci/rockchip-pcie-host.txt</code>ä¸­å¹¶æ²¡æœ‰å…³äº<code>disable</code>çš„è¯´æ˜ï¼Œè¿™è®©æˆ‘å¤§æ„Ÿå¥‡æ€ªï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cat</span> Documentation/devicetree/bindings/pci/rockchip-pcie-host.txt | grep <span class="built_in">disable</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™ä¸ªè®¾å¤‡æ ‘çš„åŸºå‡†æ–‡ä»¶æ¥è‡ªäºé‡ç«<code>sdk</code>çš„<code>4.19</code>ç‰ˆæœ¬ï¼Œæ‰€ä»¥è¿™æ—¶å€™è¿˜åœ¨æ€€ç–‘æ˜¯ä¸æ˜¯<code>5.10</code>å†…æ ¸çš„é©±åŠ¨ä¸­å–æ¶ˆäº†è¿™ä¸€ä¸ªèŠ‚ç‚¹å±æ€§æ¢æˆå…¶ä»–åå­—çš„äº†ï¼Œäºæ˜¯åˆå»<code>4.19</code>çš„æ–‡æ¡£çœ‹äº†ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯æ²¡æœ‰<code>disable</code>çš„è¯´æ˜ï¼Œæ­¤æ—¶å¿ƒä¸­å·²ç»è­¦æƒ•äº†ï¼Œæ„Ÿè§‰å°±æ˜¯é‡ç«æ”¹äº†é©±åŠ¨ã€‚</p><p>æŸ¥æ‰¾è¯¥é©±åŠ¨çš„cæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ find -name <span class="string">&quot;*.c&quot;</span> -<span class="built_in">exec</span> grep -n <span class="string">&quot;rockchip,rk3568-pcie&quot;</span> &#123;&#125; +</span><br><span class="line">./drivers/phy/rockchip/phy-rockchip-snps-pcie3.c:262:&#123; .compatible = <span class="string">&quot;rockchip,rk3568-pcie3-phy&quot;</span>, .data = &amp;rk3568_ops &#125;,</span><br><span class="line">./drivers/pci/controller/dwc/pcie-dw-rockchip.c:1324:.compatible = <span class="string">&quot;rockchip,rk3568-pcie&quot;</span>,</span><br><span class="line">./drivers/pci/controller/dwc/pcie-dw-rockchip.c:1328:.compatible = <span class="string">&quot;rockchip,rk3568-pcie-ep&quot;</span>,</span><br></pre></td></tr></table></figure><p>é”å®š<code>./drivers/pci/controller/dwc/pcie-dw-rockchip.c</code>æ–‡ä»¶ï¼Œè¿›å»ä¸€çœ‹ï¼Œæœç„¶â€¦:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">rk_pcie_resource_get</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev,</span></span><br><span class="line"><span class="params"> <span class="keyword">struct</span> rk_pcie *rk_pcie)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">rk_pcie-&gt;dis_gpio = devm_gpiod_get_optional(&amp;pdev-&gt;dev, <span class="string">&quot;disable&quot;</span>,</span><br><span class="line">    GPIOD_OUT_LOW);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(rk_pcie-&gt;dis_gpio)) &#123;</span><br><span class="line">dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;invalid disable-gpios property in node\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(rk_pcie-&gt;rst_gpio);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å—ä¸­çš„å†…å®¹æ˜¯é‡ç«å¢åŠ çš„<code>disable</code>å¼•è„šèµ„æºè·å–ï¼Œåœ¨å®˜æ–¹çš„é©±åŠ¨é‡Œé¢æ˜¯å¹¶æ²¡æœ‰è¿™ä¸€éƒ¨åˆ†çš„ï¼Œæ‰€ä»¥å¢åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">diff --git a/drivers/pci/controller/dwc/pcie-dw-rockchip.c b/drivers/pci/controller/dwc/pcie-dw-rockchip.c</span><br><span class="line">index fa40f51..<span class="number">3</span>c6cd4f <span class="number">100755</span></span><br><span class="line">--- a/drivers/pci/controller/dwc/pcie-dw-rockchip.c</span><br><span class="line">+++ b/drivers/pci/controller/dwc/pcie-dw-rockchip.c</span><br><span class="line">@@ <span class="number">-133</span>,<span class="number">6</span> +<span class="number">133</span>,<span class="number">7</span> @@ <span class="class"><span class="keyword">struct</span> <span class="title">rk_pcie</span> &#123;</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">int</span>clk_cnt;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">reset_bulk_data</span>*<span class="title">rsts</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span>*<span class="title">rst_gpio</span>;</span></span><br><span class="line">+<span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span>*<span class="title">dis_gpio</span>;</span></span><br><span class="line"> <span class="type">phys_addr_t</span>mem_start;</span><br><span class="line"> <span class="type">size_t</span>mem_size;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">pcie_port</span><span class="title">pp</span>;</span></span><br><span class="line">@@ <span class="number">-892</span>,<span class="number">6</span> +<span class="number">893</span>,<span class="number">11</span> @@ <span class="type">static</span> <span class="type">int</span> <span class="title function_">rk_pcie_host_init</span><span class="params">(<span class="keyword">struct</span> pcie_port *pp)</span></span><br><span class="line"> &#123;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">dw_pcie</span> *<span class="title">pci</span> =</span> to_dw_pcie_from_pp(pp);</span><br><span class="line">+<span class="class"><span class="keyword">struct</span> <span class="title">rk_pcie</span> *<span class="title">rk_pcie</span> =</span> to_rk_pcie(pci);</span><br><span class="line">+        </span><br><span class="line">+<span class="keyword">if</span> (!IS_ERR(rk_pcie-&gt;dis_gpio)) &#123;</span><br><span class="line">+gpiod_set_value_cansleep(rk_pcie-&gt;dis_gpio, <span class="number">1</span>);</span><br><span class="line">+        &#125;</span><br><span class="line"> </span><br><span class="line"> dw_pcie_setup_rc(pp);</span><br><span class="line"> </span><br><span class="line">@@ <span class="number">-1066</span>,<span class="number">6</span> +<span class="number">1072</span>,<span class="number">13</span> @@ <span class="type">static</span> <span class="type">int</span> <span class="title function_">rk_pcie_resource_get</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev,</span></span><br><span class="line"><span class="params"> dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;invalid reset-gpios property in node\n&quot;</span>);</span></span><br><span class="line"><span class="params"> <span class="keyword">return</span> PTR_ERR(rk_pcie-&gt;rst_gpio);</span></span><br><span class="line"><span class="params"> &#125;</span></span><br><span class="line"><span class="params">+</span></span><br><span class="line"><span class="params">+rk_pcie-&gt;dis_gpio = devm_gpiod_get_optional(&amp;pdev-&gt;dev, <span class="string">&quot;disable&quot;</span>,</span></span><br><span class="line"><span class="params">+    GPIOD_OUT_LOW);</span></span><br><span class="line"><span class="params">+<span class="keyword">if</span> (IS_ERR(rk_pcie-&gt;dis_gpio)) &#123;</span></span><br><span class="line"><span class="params">+dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;invalid disable-gpios property in node\n&quot;</span>);</span></span><br><span class="line"><span class="params">+<span class="keyword">return</span> PTR_ERR(rk_pcie-&gt;rst_gpio);</span></span><br><span class="line"><span class="params">+&#125;</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params"> <span class="keyword">return</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="params"> &#125;</span></span><br><span class="line"><span class="params">-- </span></span><br><span class="line"><span class="params"><span class="number">2.34</span>.<span class="number">1</span></span></span><br></pre></td></tr></table></figure><p>é‡æ–°ç¼–è¯‘çƒ§å½•å†…æ ¸ï¼Œä¸€åˆ‡æ­£å¸¸ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rfkill list                                                                  </span></span><br><span class="line">0: hci0: bluetooth</span><br><span class="line">        Soft blocked: no</span><br><span class="line">        Hard blocked: no</span><br><span class="line">1: phy0: wlan</span><br><span class="line">        Soft blocked: no</span><br><span class="line">        Hard blocked: no</span><br></pre></td></tr></table></figure><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://wireless.wiki.kernel.org/en/users/Drivers/iwlwifi">https://wireless.wiki.kernel.org/en/users/Drivers/iwlwifi</a><br><a href="https://www.kernel.org/doc/html/v4.14/driver-api/firmware/built-in-fw.html">https://www.kernel.org/doc/html/v4.14/driver-api/firmware/built-in-fw.html</a><br><a href="https://wiki.gentoo.org/wiki/">https://wiki.gentoo.org/wiki/</a></p>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> openHarmony </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu22.04 è‡ªå¸¦è¾“å…¥æ³•å¡æ­»é—®é¢˜</title>
      <link href="/2024/08/19/Ubuntu22-04-%E8%87%AA%E5%B8%A6%E8%BE%93%E5%85%A5%E6%B3%95%E5%8D%A1%E6%AD%BB%E9%97%AE%E9%A2%98/"/>
      <url>/2024/08/19/Ubuntu22-04-%E8%87%AA%E5%B8%A6%E8%BE%93%E5%85%A5%E6%B3%95%E5%8D%A1%E6%AD%BB%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/libpinyin/ibus-libpinyin/issues/308">https://github.com/libpinyin/ibus-libpinyin/issues/308</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntuå®‰è£…hdcå·¥å…·</title>
      <link href="/2024/08/19/ubuntu%E5%AE%89%E8%A3%85hdc%E5%B7%A5%E5%85%B7/"/>
      <url>/2024/08/19/ubuntu%E5%AE%89%E8%A3%85hdc%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<p>é¦–å…ˆæ‰“å¼€é“¾æ¥ï¼š<a href="https://ci.openharmony.cn/workbench/cicd/dailybuild/dailylist">https://ci.openharmony.cn/workbench/cicd/dailybuild/dailylist</a></p><p>é€‰æ‹©ä½ çš„openharmonyç‰ˆæœ¬ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç³»ç»Ÿï¼Œ æ˜¯standardè¿˜æ˜¯Smallæ ¹æ®éœ€è¦é€‰æ‹©ã€‚</p><p>ä¹‹åé€‰æ‹©ä¸‹è½½å…¨é‡åŒ…ï¼Œæ‰“å¼€å…¨é‡åŒ…å‹ç¼©åŒ…åå¯åœ¨toolchainsä¸­çœ‹åˆ°hdcï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtoolchainsæ•´ä¸ªæ–‡ä»¶å¤¹éƒ½éœ€è¦è§£å‹å‡ºæ¥ï¼Œå› ä¸ºsoæ–‡ä»¶çš„åŸå› ï¼Œä¸èƒ½å•ç‹¬æ‰§è¡Œhdcã€‚</p><p>è§£å‹å®Œæˆåæ·»åŠ åˆ°~&#x2F;.bashrcä¸­çš„PATHå˜é‡å³å¯ã€‚</p><p><strong>Refï¼š</strong></p><p><a href="https://docs.openharmony.cn/pages/v4.1/zh-cn/device-dev/subsystems/subsys-toolchain-hdc-guide.md">https://docs.openharmony.cn/pages/v4.1/zh-cn/device-dev/subsystems/subsys-toolchain-hdc-guide.md</a><br><a href="https://docs.openharmony.cn/pages/v4.1/zh-cn/application-dev/dfx/hdc.md">https://docs.openharmony.cn/pages/v4.1/zh-cn/application-dev/dfx/hdc.md</a><br><a href="https://developer.huawei.com/consumer/cn/blog/topic/03137966529669104">https://developer.huawei.com/consumer/cn/blog/topic/03137966529669104</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
            <tag> linux </tag>
            
            <tag> openHarmony </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568ç§»æ¤openHarmony v3.2.3---ç³»ç»Ÿç§»æ¤</title>
      <link href="/2024/08/16/rk3568%E7%A7%BB%E6%A4%8DopenHarmony-v3-2-3-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/"/>
      <url>/2024/08/16/rk3568%E7%A7%BB%E6%A4%8DopenHarmony-v3-2-3-%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿®æ”¹build-kernel-shè„šæœ¬"><a href="#ä¿®æ”¹build-kernel-shè„šæœ¬" class="headerlink" title="ä¿®æ”¹build_kernel.shè„šæœ¬"></a>ä¿®æ”¹build_kernel.shè„šæœ¬</h2><ul><li>KERNEL_PATCHå¢åŠ 2ä¸ªï¼Œå¢åŠ äº†æ¿çº§patchå’Œjl2101çš„patch</li><li>å¢åŠ CONFIG_PATCHå¯¹configæ–‡ä»¶æ‰“è¡¥ä¸</li><li>å¢åŠ æ‹·è´è®¾å¤‡æ ‘åˆ°å†…æ ¸ä¸´æ—¶ç›®å½•</li><li>ä¿®æ”¹äº†ä¼ é€’ç»™<code>make-ohos.sh</code>è„šæœ¬çš„å‚æ•°</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ git diff build_kernel.sh</span><br><span class="line">diff --git a/rk3568/kernel/build_kernel.sh b/rk3568/kernel/build_kernel.sh</span><br><span class="line">index 4bd1e65..c205e0b 100755</span><br><span class="line">--- a/rk3568/kernel/build_kernel.sh</span><br><span class="line">+++ b/rk3568/kernel/build_kernel.sh</span><br><span class="line">@@ -23,12 +23,17 @@ <span class="built_in">export</span> DEVICE_NAME=<span class="variable">$&#123;7&#125;</span></span><br><span class="line"> <span class="built_in">export</span> PRODUCT_COMPANY=<span class="variable">$&#123;8&#125;</span></span><br><span class="line"> ENABLE_LTO_O0=<span class="variable">$&#123;9&#125;</span></span><br><span class="line"> </span><br><span class="line">+YOUR_BOARD_NAME=your_board_name</span><br><span class="line">+</span><br><span class="line"> KERNEL_SRC_TMP_PATH=<span class="variable">$&#123;ROOT_DIR&#125;</span>/out/kernel/src_tmp/linux-5.10</span><br><span class="line"> KERNEL_OBJ_TMP_PATH=<span class="variable">$&#123;ROOT_DIR&#125;</span>/out/kernel/OBJ/linux-5.10</span><br><span class="line"> KERNEL_SOURCE=<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/linux-5.10</span><br><span class="line"> KERNEL_PATCH_PATH=<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10</span><br><span class="line">-KERNEL_PATCH=<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10/rk3568_patch/kernel.patch</span><br><span class="line">+KERNEL_PATCHES=<span class="string">&quot;<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10/rk3568_patch/kernel.patch</span></span><br><span class="line"><span class="string">+<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10/rk3568_patch/<span class="variable">$YOUR_BOARD_NAME</span>.patch</span></span><br><span class="line"><span class="string">+<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10/rk3568_patch/add-jl201-drivers.patch&quot;</span></span><br><span class="line"> KERNEL_CONFIG_FILE=<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/config/linux-5.10/arch/arm64/configs/rk3568_standard_defconfig</span><br><span class="line">+KERNEL_CONFIG_PATCH=<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10/<span class="variable">$&#123;YOUR_BOARD_NAME&#125;</span>_config.patch</span><br><span class="line"> NEWIP_PATCH_FILE=<span class="variable">$&#123;ROOT_DIR&#125;</span>/foundation/communication/sfc/newip/apply_newip.sh</span><br><span class="line"> </span><br><span class="line"> <span class="built_in">rm</span> -rf <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span></span><br><span class="line">@@ -46,17 +51,27 @@ <span class="built_in">cd</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span></span><br><span class="line"> bash <span class="variable">$&#123;ROOT_DIR&#125;</span>/drivers/hdf_core/adapter/khdf/linux/patch_hdf.sh <span class="variable">$&#123;ROOT_DIR&#125;</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span> <span class="variable">$&#123;KERNEL_PATCH_PATH&#125;</span> <span class="variable">$&#123;DEVICE_NAME&#125;</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">#kernel patch</span></span><br><span class="line">-patch -p1 &lt; <span class="variable">$&#123;KERNEL_PATCH&#125;</span></span><br><span class="line">+<span class="keyword">for</span> KERNEL_PATCH <span class="keyword">in</span> <span class="variable">$KERNEL_PATCHES</span></span><br><span class="line">+<span class="keyword">do</span></span><br><span class="line">+    patch -p1 &lt; <span class="variable">$&#123;KERNEL_PATCH&#125;</span></span><br><span class="line">+<span class="keyword">done</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">#newip</span></span><br><span class="line"> <span class="keyword">if</span> [ -f <span class="variable">$NEWIP_PATCH_FILE</span> ]; <span class="keyword">then</span></span><br><span class="line"> bash <span class="variable">$NEWIP_PATCH_FILE</span> <span class="variable">$&#123;ROOT_DIR&#125;</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span> <span class="variable">$&#123;DEVICE_NAME&#125;</span> linux-5.10</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line">+#kernel dts</span><br><span class="line">+<span class="built_in">cp</span> -rf <span class="variable">$&#123;3&#125;</span>/kernel/dts/*.dts* <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/arch/arm64/boot/dts/rockchip/</span><br><span class="line">+# jl2101 driver</span><br><span class="line">+<span class="built_in">cp</span> -rf <span class="variable">$&#123;3&#125;</span>/kernel/JL201/jlsemi* <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/drivers/net/phy/</span><br><span class="line">+</span><br><span class="line"> <span class="built_in">cp</span> -rf <span class="variable">$&#123;3&#125;</span>/kernel/logo* <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/</span><br><span class="line"> </span><br><span class="line"> <span class="comment">#config</span></span><br><span class="line"> <span class="built_in">cp</span> -rf <span class="variable">$&#123;KERNEL_CONFIG_FILE&#125;</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/arch/arm64/configs/rockchip_linux_defconfig</span><br><span class="line">+#config patch</span><br><span class="line">+#patch -p1 &lt; <span class="variable">$&#123;CONFIG_PATCH&#125;</span></span><br><span class="line"> </span><br><span class="line"> ramdisk_arg=<span class="string">&quot;disable_ramdisk&quot;</span></span><br><span class="line"> make_ohos_env=<span class="string">&quot;GPUDRIVER=mali&quot;</span></span><br><span class="line">@@ -72,7 +87,7 @@ <span class="keyword">do</span></span><br><span class="line"> ;;</span><br><span class="line"> <span class="keyword">esac</span></span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line">-<span class="built_in">eval</span> <span class="variable">$make_ohos_env</span> ./make-ohos.sh TB-RK3568X0 <span class="variable">$ramdisk_arg</span> <span class="variable">$&#123;ENABLE_LTO_O0&#125;</span></span><br><span class="line">+<span class="built_in">eval</span> <span class="variable">$make_ohos_env</span> ./make-ohos.sh <span class="variable">$YOUR_BOARD_NAME</span> <span class="variable">$ramdisk_arg</span> <span class="variable">$&#123;ENABLE_LTO_O0&#125;</span></span><br><span class="line"> </span><br><span class="line"> <span class="built_in">mkdir</span> -p <span class="variable">$&#123;2&#125;</span></span><br></pre></td></tr></table></figure><h2 id="å†…æ ¸è¡¥ä¸å‡†å¤‡å·¥ä½œ"><a href="#å†…æ ¸è¡¥ä¸å‡†å¤‡å·¥ä½œ" class="headerlink" title="å†…æ ¸è¡¥ä¸å‡†å¤‡å·¥ä½œ"></a>å†…æ ¸è¡¥ä¸å‡†å¤‡å·¥ä½œ</h2><p>é¦–å…ˆç¼–å†™<code>Makefile</code>å®ç°è‡ªåŠ¨åŒ–å¤åˆ¶å†…æ ¸ï¼Œæ‰“è¡¥ä¸çš„æ“ä½œï¼š</p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Linuxå†…æ ¸ç›®å½•</span></span><br><span class="line">KERNEL_SRC_TMP_PATH := &lt;ç»å¯¹è·¯å¾„&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenHarmonyç›®å½•ç›¸å…³å˜é‡</span></span><br><span class="line">OHOS_BUILD_HOME := &lt;ç»å¯¹è·¯å¾„&gt;</span><br><span class="line">DEVICE_NAME := rk3568</span><br><span class="line">KERNEL_VERSION := linux-5.10</span><br><span class="line">KERNEL_SRC_PATH := <span class="variable">$(OHOS_BUILD_HOME)</span>/kernel/linux/$&#123;KERNEL_VERSION&#125;</span><br><span class="line">DEVICE_PATCH_DIR := <span class="variable">$(OHOS_BUILD_HOME)</span>/kernel/linux/patches/$&#123;KERNEL_VERSION&#125;/<span class="variable">$(DEVICE_NAME)</span>_patch</span><br><span class="line">DEVICE_PATCH_FILE := <span class="variable">$(DEVICE_PATCH_DIR)</span>/kernel.patch</span><br><span class="line">HDF_PATCH_FILE := <span class="variable">$(DEVICE_PATCH_DIR)</span>/hdf.patch</span><br><span class="line">KERNEL_PATCH_PATH := <span class="variable">$(OHOS_BUILD_HOME)</span>/kernel/linux/patches/$&#123;KERNEL_VERSION&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all clean copy_kernel copy_device</span></span><br><span class="line"><span class="section">copy_kernel:</span></span><br><span class="line">rm -rf <span class="variable">$(KERNEL_SRC_TMP_PATH)</span>;mkdir -p <span class="variable">$(KERNEL_SRC_TMP_PATH)</span>;cp -arfL <span class="variable">$(KERNEL_SRC_PATH)</span>/* <span class="variable">$(KERNEL_SRC_TMP_PATH)</span></span><br><span class="line">    cp <span class="variable">$(OHOS_BUILD_HOME)</span>/kernel/linux/config/$&#123;KERNEL_VERSION&#125;/arch/arm64/configs/rk3568_standard_defconfig <span class="variable">$(KERNEL_SRC_TMP_PATH)</span>/arch/arm64/configs/rockchip_linux_defconfig</span><br><span class="line"></span><br><span class="line"><span class="section">put_hdf_patch:</span></span><br><span class="line">cd <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> &amp;&amp; patch -p1 &lt; $&#123;HDF_PATCH_FILE&#125;</span><br><span class="line"><span class="section">ln_hdf_repos:</span></span><br><span class="line">cd <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> &amp;&amp; ln -sf $&#123;OHOS_BUILD_HOME&#125;/drivers/hdf_core/adapter/khdf/linux Â  Â drivers/hdf/khdf</span><br><span class="line">cd <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> &amp;&amp; ln -sf $&#123;OHOS_BUILD_HOME&#125;/drivers/hdf_core/framework Â  Â  Â  Â  Â  Â  drivers/hdf/framework</span><br><span class="line">cd <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> &amp;&amp; ln -sf $&#123;OHOS_BUILD_HOME&#125;/drivers/hdf_core/framework/<span class="keyword">include</span> Â  Â  <span class="keyword">include</span>/hdf</span><br><span class="line"><span class="section">copy_external_compents:</span></span><br><span class="line">cd <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> &amp;&amp; cp -arfL $&#123;OHOS_BUILD_HOME&#125;/third_party/bounds_checking_function Â ./</span><br><span class="line">cd <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> &amp;&amp; mkdir -p drivers/hdf/</span><br><span class="line">cd <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> &amp;&amp; cp -arfL $&#123;OHOS_BUILD_HOME&#125;/device/soc/hisilicon/common/platform/wifi Â  Â  Â  Â  drivers/hdf/</span><br><span class="line">cd <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> &amp;&amp; cp -arfL $&#123;OHOS_BUILD_HOME&#125;/third_party/FreeBSD/sys/dev/evdev Â  Â  drivers/hdf/</span><br><span class="line">Â  Â  </span><br><span class="line"><span class="section">patch_hdf_all:</span></span><br><span class="line"><span class="variable">$(OHOS_BUILD_HOME)</span>/drivers/hdf_core/adapter/khdf/linux/patch_hdf.sh <span class="variable">$(OHOS_BUILD_HOME)</span> <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> <span class="variable">$(KERNEL_PATCH_PATH)</span> <span class="variable">$(DEVICE_NAME)</span></span><br><span class="line"><span class="comment">#make put_hdf_patch</span></span><br><span class="line"><span class="comment">#make ln_hdf_repos</span></span><br><span class="line"><span class="comment">#make copy_external_compentsls</span></span><br><span class="line"></span><br><span class="line"><span class="section">patch_kernel:</span></span><br><span class="line">cd <span class="variable">$(KERNEL_SRC_TMP_PATH)</span> &amp;&amp; patch -p1 &lt; <span class="variable">$(DEVICE_PATCH_FILE)</span></span><br><span class="line"><span class="section">copy_config:</span></span><br><span class="line">cp -rf <span class="variable">$(KERNEL_CONFIG_PATH)</span>/. <span class="variable">$(KERNEL_SRC_TMP_PATH)</span>/</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">make clean</span><br><span class="line">make copy_kernel</span><br><span class="line">make patch_hdf_all</span><br><span class="line">make patch_kernel</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -rf <span class="variable">$(KERNEL_SRC_TMP_PATH)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make copy_kernel</span><br><span class="line">make patch_kernel</span><br><span class="line">find ./* -name <span class="string">&quot;*.orig&quot;</span> | xargs <span class="built_in">rm</span> -rf</span><br><span class="line">make patch_hdf</span><br><span class="line"></span><br><span class="line">åˆ›å»ºè®¾å¤‡æ ‘ç›®å½•å¹¶å°†å·²ç»é€‚é…å¥½`Linux`ç³»ç»Ÿçš„è®¾å¤‡æ ‘æ–‡ä»¶æ‹·è´è¿›æ¥(è¿™ä¸€æ­¥æ˜¯ä¸ºäº†`build_kernel.sh`å°†æ­¤æ–‡ä»¶å¤¹ä¸­çš„è®¾å¤‡æ ‘æ‹·è´åˆ°å†…æ ¸ä¸´æ—¶ç›®å½•çš„è®¾å¤‡æ ‘æ–‡ä»¶å¤¹ä¸­)ï¼š</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"><span class="built_in">mkdir</span> -p device/board/hihope/rk3568/kernel/dts</span><br><span class="line"><span class="built_in">cp</span> rk3568-xxx.dts device/board/hihope/rk3568/kernel/dts</span><br></pre></td></tr></table></figure><p>åˆ›å»ºgitä»“åº“å¹¶ä¸”æäº¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git init &amp;&amp; git add -A &amp;&amp; git commit -m <span class="string">&quot;First&quot;</span></span><br></pre></td></tr></table></figure><h2 id="å¢åŠ å†…æ ¸è¡¥ä¸"><a href="#å¢åŠ å†…æ ¸è¡¥ä¸" class="headerlink" title="å¢åŠ å†…æ ¸è¡¥ä¸"></a>å¢åŠ å†…æ ¸è¡¥ä¸</h2><p>è¿›å…¥å†…æ ¸ä¸´æ—¶ç›®å½•åä¿®æ”¹<code>make-ohos.h</code>ï¼š<br>    - ä¿®æ”¹äº†DTBå˜é‡<br>    - ä¿®æ”¹äº†model_list</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">diff --git a/make-ohos.sh b/make-ohos.sh</span><br><span class="line">index 4dc437165..704e8c78f 100755</span><br><span class="line">--- a/make-ohos.sh</span><br><span class="line">+++ b/make-ohos.sh</span><br><span class="line">@@ -14,7 +14,7 @@ MAKE=<span class="string">&quot;make LLVM=1 LLVM_IAS=1 CROSS_COMPILE=../../../../prebuilts/gcc/linux-x86/a</span></span><br><span class="line"><span class="string"> BUILD_PATH=boot_linux</span></span><br><span class="line"><span class="string"> EXTLINUX_PATH=<span class="variable">$&#123;BUILD_PATH&#125;</span>/extlinux</span></span><br><span class="line"><span class="string"> EXTLINUX_CONF=<span class="variable">$&#123;EXTLINUX_PATH&#125;</span>/extlinux.conf</span></span><br><span class="line"><span class="string">-TOYBRICK_DTB=toybrick.dtb</span></span><br><span class="line"><span class="string">+YOUR_BOARD_NAME_DTB=rk3568-your_board_name.dtb</span></span><br><span class="line"><span class="string"> if [ <span class="variable">$&#123;KBUILD_OUTPUT&#125;</span> ]; then</span></span><br><span class="line"><span class="string"> OBJ_PATH=<span class="variable">$&#123;KBUILD_OUTPUT&#125;</span>/</span></span><br><span class="line"><span class="string"> fi</span></span><br><span class="line"><span class="string">@@ -26,8 +26,7 @@ ID_DTB=4</span></span><br><span class="line"><span class="string"> ID_IMAGE=5</span></span><br><span class="line"><span class="string"> ID_CONF=6</span></span><br><span class="line"><span class="string"> model_list=(</span></span><br><span class="line"><span class="string">-&quot;</span>TB-RK3568X0   arm64 0xfe660000 rk3568-toybrick-x0-linux  Image rockchip_linux_defconfig<span class="string">&quot;</span></span><br><span class="line"><span class="string">-&quot;</span>TB-RK3568X10  arm64 0xfe660000 rk3568-toybrick-x10-linux Image rockchip_linux_defconfig<span class="string">&quot;</span></span><br><span class="line"><span class="string">+&quot;</span>your_board_name   arm64 0xfe660000 rk3568-your_board_name  Image rockchip_linux_defconfig<span class="string">&quot;</span></span><br><span class="line"><span class="string"> )</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">@@ -49,7 +48,7 @@ function make_extlinux_conf()</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"> echo &quot;</span>label rockchip-kernel-5.10<span class="string">&quot; &gt; <span class="variable">$&#123;EXTLINUX_CONF&#125;</span></span></span><br><span class="line"><span class="string"> echo &quot;</span>kernel /extlinux/<span class="variable">$&#123;image&#125;</span><span class="string">&quot; &gt;&gt; <span class="variable">$&#123;EXTLINUX_CONF&#125;</span></span></span><br><span class="line"><span class="string">-echo &quot;</span>fdt /extlinux/<span class="variable">$&#123;TOYBRICK_DTB&#125;</span><span class="string">&quot; &gt;&gt; <span class="variable">$&#123;EXTLINUX_CONF&#125;</span></span></span><br><span class="line"><span class="string">+echo &quot;</span>fdt /extlinux/<span class="variable">$&#123;YOUR_BOARD_NAME_DTB&#125;</span><span class="string">&quot; &gt;&gt; <span class="variable">$&#123;EXTLINUX_CONF&#125;</span></span></span><br><span class="line"><span class="string"> cmdline=&quot;</span>append earlycon=uart8250,mmio32,<span class="variable">$&#123;uart&#125;</span> root=PARTUUID=614e0000-0000-4b53-8000-1d28000054a9 rw rootwait rootfstype=ext4<span class="string">&quot;</span></span><br><span class="line"><span class="string"> echo &quot;</span>  <span class="variable">$&#123;cmdline&#125;</span><span class="string">&quot; &gt;&gt; <span class="variable">$&#123;EXTLINUX_CONF&#125;</span></span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string">@@ -118,7 +117,7 @@ function make_boot_linux()</span></span><br><span class="line"><span class="string"> fi</span></span><br><span class="line"><span class="string"> make_extlinux_conf <span class="variable">$&#123;dtb_path&#125;</span> <span class="variable">$&#123;uart&#125;</span> <span class="variable">$&#123;image&#125;</span></span></span><br><span class="line"><span class="string"> cp -f <span class="variable">$&#123;OBJ_PATH&#125;</span>arch/<span class="variable">$&#123;arch&#125;</span>/boot/<span class="variable">$&#123;image&#125;</span> <span class="variable">$&#123;EXTLINUX_PATH&#125;</span>/</span></span><br><span class="line"><span class="string">-cp -f <span class="variable">$&#123;OBJ_PATH&#125;</span><span class="variable">$&#123;dtb_path&#125;</span>/<span class="variable">$&#123;dtb&#125;</span>.dtb <span class="variable">$&#123;EXTLINUX_PATH&#125;</span>/<span class="variable">$&#123;TOYBRICK_DTB&#125;</span></span></span><br><span class="line"><span class="string">+cp -f <span class="variable">$&#123;OBJ_PATH&#125;</span><span class="variable">$&#123;dtb_path&#125;</span>/<span class="variable">$&#123;dtb&#125;</span>.dtb <span class="variable">$&#123;EXTLINUX_PATH&#125;</span>/<span class="variable">$&#123;YOUR_BOARD_NAME_DTB&#125;</span></span></span><br><span class="line"><span class="string"> cp -f logo*.bmp <span class="variable">$&#123;BUILD_PATH&#125;</span>/</span></span><br><span class="line"><span class="string"> if [ &quot;</span>enable_ramdisk<span class="string">&quot; != &quot;</span><span class="variable">$&#123;ramdisk_flag&#125;</span><span class="string">&quot; ]; then</span></span><br><span class="line"><span class="string"> make_ext2_image</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>arch/arm64/boot/dts/rockchip/Makefile</code>åŠ å…¥ä½ çš„æ¿å­ã€‚</p><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æäº¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git add -A &amp;&amp; git commit -m <span class="string">&quot;something you like&quot;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆpatch:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git format-patch --subject-prefix=<span class="string">&#x27;PATCH&#x27;</span> -n -s -1</span><br></pre></td></tr></table></figure><p>å°†è¿™ä¸ª<code>patch</code>ç§»åŠ¨åˆ°<code>kernel/linux/patches/linux-5.10/rk3568_patch/$YOUR_BOARD_NAME.patch</code>ä¸‹ï¼Œ<code>YOUR_BOARD_NAME</code>å¯¹åº”ä½ <code>build_kernel.sh</code>ä¸­å®šä¹‰çš„ã€‚</p><p>æ ¹æ®è‡ªå·±çš„éœ€è¦ä¿®æ”¹<code>arch/arm64/configs/rockchip_linux_defconfig</code>åæäº¤ï¼Œéšåç”Ÿæˆè¡¥ä¸ï¼Œç§»åŠ¨åˆ°<code>build_kernel.sh</code>ä¸­è®¾ç½®çš„<code>CONFIG_PATCH_FILE</code>ã€‚</p><p>å›åˆ°ä¸»ç›®å½•ï¼Œåˆ é™¤<code>out/kernel</code>æ–‡ä»¶å¤¹åé‡æ–°ç¼–è¯‘ï¼Œå³å¯åœ¨<code>out/rk3568/packages/phone/images</code>ç›®å½•ä¸‹çœ‹åˆ°è¾“å‡ºæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf out/kernel</span><br><span class="line">./build.sh --product-name rk3568 --ccache</span><br><span class="line"></span><br><span class="line">â¯ <span class="built_in">cd</span> out/rk3568/packages/phone/images</span><br><span class="line">â¯ <span class="built_in">ls</span></span><br><span class="line">boot_linux.img  config.cfg         parameter.txt  resource.img  system.img  updater.img   vendor.img</span><br><span class="line">chip_prod.img   MiniLoaderAll.bin  ramdisk.img    sys_prod.img  uboot.img   userdata.img</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openHarmony </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568ç§»æ¤openHarmony v3.2.3---ç¼–è¯‘æµç¨‹åˆ†æ</title>
      <link href="/2024/08/16/rk3568%E7%A7%BB%E6%A4%8DopenHarmony-v3-2-3-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-1/"/>
      <url>/2024/08/16/rk3568%E7%A7%BB%E6%A4%8DopenHarmony-v3-2-3-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-1/</url>
      
        <content type="html"><![CDATA[<h2 id="ç›®å½•åˆ†æ"><a href="#ç›®å½•åˆ†æ" class="headerlink" title="ç›®å½•åˆ†æ"></a>ç›®å½•åˆ†æ</h2><p>åœ¨<code>OpenHarmony</code>ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå†…æ ¸æºç æ˜¯ä¸å˜çš„ï¼Œå†…æ ¸æºç ä¿å­˜åœ¨<code>kernel/linux/linux-5.10/</code>ä¸‹ï¼Œå¹¶ä¸”æ°¸è¿œä¸è¢«ä¿®æ”¹ã€‚</p><p>åœ¨ç¼–è¯‘å†…æ ¸å‰ï¼Œä¼šå°†å†…æ ¸æºç å¤åˆ¶åˆ°å†…æ ¸ä¸´æ—¶æºç ç›®å½•<code>out/kernel/src_tmp/linux-5.10/</code>ä¸‹ï¼Œç„¶åå†ä»¥æ‰“è¡¥ä¸çš„æ–¹å¼è¿›è¡Œä¿®æ”¹ã€‚</p><p>åœ¨ç¼–è¯‘å‘½ä»¤<code>./build.sh --product-name rk3568 --ccache</code>ä¸­ï¼Œç”¨<code>--product</code>å‘½ä»¤æŒ‡å®šäº†<code>rk3568</code>ã€‚</p><p>é€šè¿‡æŸ¥é˜…æ–‡æ¡£å¾—çŸ¥ï¼Œè¿™ä¸ª<code>product</code>å‚æ•°æ˜¯åœ¨<code>vendor</code>æ–‡ä»¶å¤¹ä¸­æ‰€æŒ‡å®šçš„ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">â¯ vim vendor/hihope/rk3568/config.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;product_name&quot;</span>: <span class="string">&quot;rk3568&quot;</span>,</span><br><span class="line">  <span class="string">&quot;device_company&quot;</span>: <span class="string">&quot;rockchip&quot;</span>,</span><br><span class="line">  <span class="string">&quot;device_build_path&quot;</span>: <span class="string">&quot;device/board/hihope/rk3568&quot;</span>,</span><br><span class="line">  <span class="string">&quot;target_cpu&quot;</span>: <span class="string">&quot;arm&quot;</span>,</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;3.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;board&quot;</span>: <span class="string">&quot;rk3568&quot;</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†<code>product_name</code>ä¸º<code>rk3568</code>çš„ç›®æ ‡çš„ç¼–è¯‘è·¯å¾„æ˜¯<code>device/board/hihope/rk3568</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cd</span> device/board/hihope/rk3568</span><br><span class="line">â¯ <span class="built_in">ls</span></span><br><span class="line">audio_drivers  bootanimation  BUILD.gn  camera  cfg  config.gni  device.gni  distributedhardware  kernel  loader  ohos.build  startup  updater  wifi</span><br></pre></td></tr></table></figure><p>ç›®æ ‡çš„ç¼–è¯‘è·¯å¾„ä¸‹é¢æœ‰å¾ˆå¤šæ–‡ä»¶ï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ˜¯å†…æ ¸ç§»æ¤ï¼Œæ‰€ä»¥åªéœ€è¦çœ‹<code>kernel</code>æ–‡ä»¶å¤¹ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cd</span> kernel &amp;&amp; <span class="built_in">ls</span></span><br><span class="line">BUILD.gn  build_kernel.sh  dts  JL201  logo.bmp  logo_kernel.bmp  ov8858.c</span><br></pre></td></tr></table></figure><p>å…ˆä»<code>BUILD.gn</code>æ–‡ä»¶å¼€å§‹çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">cat</span> BUILD.gn</span><br><span class="line">Â·Â·Â·</span><br><span class="line">import(<span class="string">&quot;//build/config/clang/clang.gni&quot;</span>)</span><br><span class="line">import(<span class="string">&quot;//build/ohos.gni&quot;</span>)</span><br><span class="line">kernel_build_script_dir = <span class="string">&quot;//kernel/linux/linux-5.10&quot;</span></span><br><span class="line">kernel_source_dir = <span class="string">&quot;//kernel/linux/linux-5.10&quot;</span></span><br><span class="line"></span><br><span class="line">action(<span class="string">&quot;kernel&quot;</span>) &#123;</span><br><span class="line">  script = <span class="string">&quot;build_kernel.sh&quot;</span></span><br><span class="line">  sources = [ kernel_source_dir ]</span><br><span class="line"></span><br><span class="line">  product_path = <span class="string">&quot;vendor/<span class="variable">$product_company</span>/<span class="variable">$product_name</span>&quot;</span></span><br><span class="line">  outputs = [ <span class="string">&quot;<span class="variable">$root_build_dir</span>/../kernel/src_tmp/linux-5.10/boot_linux&quot;</span> ]</span><br><span class="line">  args = [</span><br><span class="line">    rebase_path(kernel_build_script_dir, root_build_dir),</span><br><span class="line">    rebase_path(<span class="string">&quot;<span class="variable">$root_build_dir</span>/packages/phone/images&quot;</span>),</span><br><span class="line">    rebase_path(<span class="string">&quot;//device/board/hihope/<span class="variable">$device_name</span>&quot;</span>),</span><br><span class="line">    product_path,</span><br><span class="line">    rebase_path(<span class="string">&quot;<span class="variable">$root_build_dir</span>/../..&quot;</span>),</span><br><span class="line">    device_company,</span><br><span class="line">    device_name,</span><br><span class="line">    product_company,</span><br><span class="line">  ]</span><br><span class="line">Â·Â·Â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“æ„å»ºæµæ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ä¼šç›´æ¥æ‰§è¡Œ<code>build_kernel.sh</code>è¿™ä¸ªè„šæœ¬ï¼Œå¹¶ä¸”ä¼ å…¥ä¸€äº›å‚æ•°ã€‚</p><h2 id="ç¼–è¯‘æµç¨‹"><a href="#ç¼–è¯‘æµç¨‹" class="headerlink" title="ç¼–è¯‘æµç¨‹"></a>ç¼–è¯‘æµç¨‹</h2><p>æŸ¥çœ‹<code>build_kernel.sh</code>è¿™ä¸ªè„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="built_in">pushd</span> <span class="variable">$&#123;1&#125;</span></span><br><span class="line">ROOT_DIR=<span class="variable">$&#123;5&#125;</span></span><br><span class="line"><span class="built_in">export</span> PRODUCT_PATH=<span class="variable">$&#123;4&#125;</span></span><br><span class="line"><span class="built_in">export</span> DEVICE_COMPANY=<span class="variable">$&#123;6&#125;</span></span><br><span class="line"><span class="built_in">export</span> DEVICE_NAME=<span class="variable">$&#123;7&#125;</span></span><br><span class="line"><span class="built_in">export</span> PRODUCT_COMPANY=<span class="variable">$&#123;8&#125;</span></span><br><span class="line">ENABLE_LTO_O0=<span class="variable">$&#123;9&#125;</span></span><br><span class="line"></span><br><span class="line">KERNEL_SRC_TMP_PATH=<span class="variable">$&#123;ROOT_DIR&#125;</span>/out/kernel/src_tmp/linux-5.10</span><br><span class="line">KERNEL_OBJ_TMP_PATH=<span class="variable">$&#123;ROOT_DIR&#125;</span>/out/kernel/OBJ/linux-5.10</span><br><span class="line">KERNEL_SOURCE=<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/linux-5.10</span><br><span class="line">KERNEL_PATCH_PATH=<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10</span><br><span class="line">KERNEL_PATCH=<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/patches/linux-5.10/rk3568_patch/kernel.patch</span><br><span class="line">KERNEL_CONFIG_FILE=<span class="variable">$&#123;ROOT_DIR&#125;</span>/kernel/linux/config/linux-5.10/arch/arm64/configs/rk3568_standard_defconfig</span><br><span class="line">NEWIP_PATCH_FILE=<span class="variable">$&#123;ROOT_DIR&#125;</span>/foundation/communication/sfc/newip/apply_newip.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span></span><br><span class="line"><span class="built_in">export</span> KBUILD_OUTPUT=<span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -arf <span class="variable">$&#123;KERNEL_SOURCE&#125;</span>/* <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#HDF patch</span></span><br><span class="line">bash <span class="variable">$&#123;ROOT_DIR&#125;</span>/drivers/hdf_core/adapter/khdf/linux/patch_hdf.sh <span class="variable">$&#123;ROOT_DIR&#125;</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span> <span class="variable">$&#123;KERNEL_PATCH_PATH&#125;</span> <span class="variable">$&#123;DEVICE_NAME&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#kernel patch</span></span><br><span class="line">patch -p1 &lt; <span class="variable">$&#123;KERNEL_PATCH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#newip</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$NEWIP_PATCH_FILE</span> ]; <span class="keyword">then</span></span><br><span class="line">bash <span class="variable">$NEWIP_PATCH_FILE</span> <span class="variable">$&#123;ROOT_DIR&#125;</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span> <span class="variable">$&#123;DEVICE_NAME&#125;</span> linux-5.10</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -rf <span class="variable">$&#123;3&#125;</span>/kernel/logo* <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment">#config</span></span><br><span class="line"><span class="built_in">cp</span> -rf <span class="variable">$&#123;KERNEL_CONFIG_FILE&#125;</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/arch/arm64/configs/rockchip_linux_defconfig</span><br><span class="line"></span><br><span class="line">ramdisk_arg=<span class="string">&quot;disable_ramdisk&quot;</span></span><br><span class="line">make_ohos_env=<span class="string">&quot;GPUDRIVER=mali&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span> </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$i</span> <span class="keyword">in</span></span><br><span class="line">enable_ramdisk)</span><br><span class="line">ramdisk_arg=enable_ramdisk</span><br><span class="line">;;</span><br><span class="line">enable_mesa3d)</span><br><span class="line">make_ohos_env=<span class="string">&quot;GPUDRIVER=mesa3d&quot;</span></span><br><span class="line">python <span class="variable">$&#123;ROOT_DIR&#125;</span>/third_party/mesa3d/ohos/modifyDtsi.py <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/arch/arm64/boot/dts/rockchip/rk3568.dtsi</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">eval</span> <span class="variable">$make_ohos_env</span> ./make-ohos.sh TB-RK3568X0 <span class="variable">$ramdisk_arg</span> <span class="variable">$&#123;ENABLE_LTO_O0&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$&#123;2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;enable_ramdisk&quot;</span> != <span class="string">&quot;<span class="variable">$&#123;10&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span>/boot_linux.img <span class="variable">$&#123;2&#125;</span>/boot_linux.img</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span>/resource.img <span class="variable">$&#123;2&#125;</span>/resource.img</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;3&#125;</span>/loader/parameter.txt <span class="variable">$&#123;2&#125;</span>/parameter.txt</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;3&#125;</span>/loader/MiniLoaderAll.bin <span class="variable">$&#123;2&#125;</span>/MiniLoaderAll.bin</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;3&#125;</span>/loader/uboot.img <span class="variable">$&#123;2&#125;</span>/uboot.img</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;3&#125;</span>/loader/config.cfg <span class="variable">$&#123;2&#125;</span>/config.cfg</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line"></span><br><span class="line">../kernel/src_tmp/linux-5.10/make-boot.sh ..</span><br></pre></td></tr></table></figure><h3 id="å˜é‡è§£é‡Š"><a href="#å˜é‡è§£é‡Š" class="headerlink" title="å˜é‡è§£é‡Š"></a>å˜é‡è§£é‡Š</h3><pre><code>- KERNEL_SRC_TMP_PATH: æºç ä¸´æ—¶è·¯å¾„ï¼Œåœ¨ç¼–è¯‘æµç¨‹ä¸­ï¼Œå†…æ ¸çš„åŸæºç æ˜¯ä¸å˜çš„ï¼Œéœ€è¦å°†å†…æ ¸æºç å¤åˆ¶åˆ°è¿™ä¸ªè·¯å¾„ä¸‹ï¼Œç„¶åå¯¹è¿™ä¸ªè·¯å¾„ä¸‹çš„å†…æ ¸æºç è¿›è¡Œæ‰“è¡¥ä¸ã€‚- KERNEL_OBJ_TMP_PATH: ç›®æ ‡ä¸´æ—¶è·¯å¾„ã€‚- KERNEL_SOURCE: å†…æ ¸åŸæºç è·¯å¾„- KERNEL_PATCH_PATH: å†…æ ¸è¡¥ä¸è·¯å¾„- KERNEL_PATCH: å†…æ ¸è¡¥ä¸æ–‡ä»¶- KERNEL_CONFIG_FILE: å†…æ ¸é…ç½®æ–‡ä»¶- NEWIP_PATCH_FILE: newipè¡¥ä¸æ–‡ä»¶</code></pre><h3 id="è„šæœ¬è§£é‡Š"><a href="#è„šæœ¬è§£é‡Š" class="headerlink" title="è„šæœ¬è§£é‡Š"></a>è„šæœ¬è§£é‡Š</h3><p>å°†å†…æ ¸æºç å¤åˆ¶åˆ°å†…æ ¸ä¸´æ—¶æºç ç›®å½•å¹¶ä¸”è¿›å…¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span></span><br><span class="line"><span class="built_in">export</span> KBUILD_OUTPUT=<span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -arf <span class="variable">$&#123;KERNEL_SOURCE&#125;</span>/* <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span></span><br></pre></td></tr></table></figure><p>å¯¹å†…æ ¸æºç è¿›è¡Œæ‰“è¡¥ä¸ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#HDF patch</span></span><br><span class="line">bash <span class="variable">$&#123;ROOT_DIR&#125;</span>/drivers/hdf_core/adapter/khdf/linux/patch_hdf.sh <span class="variable">$&#123;ROOT_DIR&#125;</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span> <span class="variable">$&#123;KERNEL_PATCH_PATH&#125;</span> <span class="variable">$&#123;DEVICE_NAME&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#kernel patch</span></span><br><span class="line">patch -p1 &lt; <span class="variable">$&#123;KERNEL_PATCH&#125;</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­HDFçš„è¡¥ä¸è°ƒç”¨åˆ°äº†<code>drivers/hdf_core/adapter/khdf/linux/patch_hdf.sh</code>è¿™ä¸ªè„šæœ¬ï¼Œè„šæœ¬å‚æ•°å¦‚ä¸‹ï¼š<br>    - OHå·¥ç¨‹æ ¹ç›®å½•ï¼Œç»å¯¹è·¯å¾„<br>    - å†…æ ¸ä¸´æ—¶ç›®å½•ï¼Œç»å¯¹è·¯å¾„<br>    - å†…æ ¸è¡¥ä¸è·¯å¾„ï¼Œç»å¯¹è·¯å¾„<br>    - è®¾å¤‡åç§°</p><p><code>patch_hdf.sh</code>è„šæœ¬å¯¹äºè¡¥ä¸çš„æœç´¢ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">put_hdf_patch</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    HDF_PATCH_FILE=<span class="variable">$&#123;KERNEL_PATCH_PATH&#125;</span>/<span class="variable">$&#123;DEVICE_NAME&#125;</span>_patch/hdf.patch</span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$&#123;HDF_PATCH_FILE&#125;</span>&quot;</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">    HDF_PATCH_FILE=<span class="variable">$&#123;KERNEL_PATCH_PATH&#125;</span>/<span class="variable">$&#123;HDF_COMMON_PATCH&#125;</span>_patch/hdf.patch</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    patch -p1 &lt; <span class="variable">$HDF_PATCH_FILE</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ­¤è„šæœ¬æ˜¯æ ¹æ®è¡¥ä¸è·¯å¾„+è®¾å¤‡åç§°æ‰¾åˆ°<code>hdf.patch</code>è¿™ä¸ªè¡¥ä¸ã€‚</p><p>æ‹·è´å¼€æœºlogoå’Œé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> -rf <span class="variable">$&#123;3&#125;</span>/kernel/logo* <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment">#config</span></span><br><span class="line"><span class="built_in">cp</span> -rf <span class="variable">$&#123;KERNEL_CONFIG_FILE&#125;</span> <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/arch/arm64/configs/rockchip_linux_defconfig</span><br></pre></td></tr></table></figure><p>åˆ›å»ºenvå’Œæ‰§è¡Œç¼–è¯‘è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ramdisk_arg=<span class="string">&quot;disable_ramdisk&quot;</span></span><br><span class="line">make_ohos_env=<span class="string">&quot;GPUDRIVER=mali&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span> </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$i</span> <span class="keyword">in</span></span><br><span class="line">enable_ramdisk)</span><br><span class="line">ramdisk_arg=enable_ramdisk</span><br><span class="line">;;</span><br><span class="line">enable_mesa3d)</span><br><span class="line">make_ohos_env=<span class="string">&quot;GPUDRIVER=mesa3d&quot;</span></span><br><span class="line">python <span class="variable">$&#123;ROOT_DIR&#125;</span>/third_party/mesa3d/ohos/modifyDtsi.py <span class="variable">$&#123;KERNEL_SRC_TMP_PATH&#125;</span>/arch/arm64/boot/dts/rockchip/rk3568.dtsi</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">eval</span> <span class="variable">$make_ohos_env</span> ./make-ohos.sh TB-RK3568X0 <span class="variable">$ramdisk_arg</span> <span class="variable">$&#123;ENABLE_LTO_O0&#125;</span></span><br></pre></td></tr></table></figure><p><code>make-ohos.sh</code>è„šæœ¬åœ¨å†…æ ¸ä¸´æ—¶æºç ç›®å½•ï¼Œ<code>TB-RK3568X0</code>æ˜¯é€‰æ‹©è®¾å¤‡æ ‘çš„ã€‚</p><p><code>make-ohos.sh</code>è„šæœ¬ä¸­å…³äºè®¾å¤‡æ ‘å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Â·Â·Â·</span><br><span class="line">model_list=(</span><br><span class="line"><span class="string">&quot;TB-RK3568X0   arm64 0xfe660000 rk3568-xxx  Image rockchip_linux_defconfig&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">Â·Â·Â·</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>TB-RK3568X0 </code>æ˜¯è®¾å¤‡æ ‘ç›®æ ‡åå­—ï¼Œ <code>rk3568-xxx</code>æ˜¯å…·ä½“çš„è®¾å¤‡æ ‘åå­—ï¼Œæ³¨æ„ï¼Œæ²¡æœ‰åç¼€ã€‚</p><p>å›åˆ°<code>build_kernel.sh</code>ï¼Œåˆ›å»ºç¼–è¯‘æ–‡ä»¶ç›®å½•å¹¶ä¸”æ‹·è´è¿‡å»ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># $2 = rebase_path(&quot;$root_build_dir/packages/phone/images&quot;),</span></span><br><span class="line"><span class="comment"># $3 = rebase_path(&quot;//device/board/hihope/$device_name&quot;),</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$&#123;2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;enable_ramdisk&quot;</span> != <span class="string">&quot;<span class="variable">$&#123;10&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span>/boot_linux.img <span class="variable">$&#123;2&#125;</span>/boot_linux.img</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;KERNEL_OBJ_TMP_PATH&#125;</span>/resource.img <span class="variable">$&#123;2&#125;</span>/resource.img</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;3&#125;</span>/loader/parameter.txt <span class="variable">$&#123;2&#125;</span>/parameter.txt</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;3&#125;</span>/loader/MiniLoaderAll.bin <span class="variable">$&#123;2&#125;</span>/MiniLoaderAll.bin</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;3&#125;</span>/loader/uboot.img <span class="variable">$&#123;2&#125;</span>/uboot.img</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;3&#125;</span>/loader/config.cfg <span class="variable">$&#123;2&#125;</span>/config.cfg</span><br><span class="line"><span class="built_in">popd</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç”Ÿæˆ<code>boot_linux.img</code>è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">../kernel/src_tmp/linux-5.10/make-boot.sh ..</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openHarmony </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>home-assistant MQTTæ— æ³•ä½¿ç”¨é«˜çº§é€‰é¡¹</title>
      <link href="/2024/08/13/home-assistant-MQTT/"/>
      <url>/2024/08/13/home-assistant-MQTT/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/home-assistant/frontend/issues/16886">https://github.com/home-assistant/frontend/issues/16886</a></p>]]></content>
      
      
      <categories>
          
          <category> home-assistant </category>
          
      </categories>
      
      
        <tags>
            
            <tag> home-assistant </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[é€†å‘ç ´è§£]Oscal Pad70---æå–ç³»ç»Ÿåˆ†åŒº</title>
      <link href="/2024/08/12/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3-Oscal-Pad70-%E6%8F%90%E5%8F%96%E7%B3%BB%E7%BB%9F%E5%88%86%E5%8C%BA/"/>
      <url>/2024/08/12/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3-Oscal-Pad70-%E6%8F%90%E5%8F%96%E7%B3%BB%E7%BB%9F%E5%88%86%E5%8C%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="Starting"><a href="#Starting" class="headerlink" title="Starting"></a>Starting</h2><p><code>Oscal Pad70</code>å®ç‰©å›¾ï¼š</p><p><img src="https://i.imghippo.com/files/Ct0oQ1723469150.jpg" alt="oscal pad70"></p><p>ç”±å®˜ç½‘å¯çŸ¥ï¼Œ<code>Oscal Pad70</code>æ˜¯ä½¿ç”¨<code>rk3566</code>ä½œä¸ºä¸»æ§ï¼š</p><p><img src="https://i.imghippo.com/files/wqrko1723469276.png" alt="oscal pad70 website"></p><p>è¿™å°è®¾å¤‡å¹¶æ²¡æœ‰å…³é—­<code>adb</code>ï¼Œä½¿ç”¨<code>adb</code>å‘½ä»¤å¯ä»¥å¾ˆè½»æ¾çš„æŸ¥çœ‹åˆ°<code>adb</code>çš„è®¾å¤‡ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">Pad70PROL02309200121device</span><br><span class="line"></span><br><span class="line">â¯ adb shell</span><br><span class="line">Pad70_Pro:/ $ <span class="built_in">cat</span> /proc/version                                                                              </span><br><span class="line">Linux version 5.10.168-android13-4-00008-g33b1e2eb04dc-ab10159773 (build-user@build-host) (Android (8508608, based on r450784e) clang version 14.0.7 (https://android.googlesource.com/toolchain/llvm-project 4c603efb0cca074e9238af8b4106c30add4418f6), LLD 14.0.7) <span class="comment">#1 SMP PREEMPT Thu May 11 18:17:05 UTC 2023</span></span><br></pre></td></tr></table></figure><p>ä¸å‡ºæ„æ–™çš„æ˜¯<code>5.10</code>ç‰ˆæœ¬çš„å†…æ ¸ã€‚</p><h2 id="å¤‡ä»½åˆ†åŒº"><a href="#å¤‡ä»½åˆ†åŒº" class="headerlink" title="å¤‡ä»½åˆ†åŒº"></a>å¤‡ä»½åˆ†åŒº</h2><p>ä¸ºäº†é˜²æ­¢åœ¨åç»­ç§»æ¤è¿‡ç¨‹ä¸­å‡ºé—®é¢˜ï¼Œå…ˆå¤‡ä»½ä¸€ä¸‹åˆ†åŒºã€‚</p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹åˆ†åŒºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Pad70_Pro:/ $ <span class="built_in">ls</span> /dev/block/by-name -l</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 backup -&gt; /dev/block/mmcblk2p19</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 baseparameter -&gt; /dev/block/mmcblk2p23</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 boot_a -&gt; /dev/block/mmcblk2p17</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 boot_b -&gt; /dev/block/mmcblk2p18</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 cache -&gt; /dev/block/mmcblk2p20</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 dtbo_a -&gt; /dev/block/mmcblk2p13</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 dtbo_b -&gt; /dev/block/mmcblk2p14</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 frp -&gt; /dev/block/mmcblk2p22</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 init_boot_a -&gt; /dev/block/mmcblk2p11</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 init_boot_b -&gt; /dev/block/mmcblk2p12</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 metadata -&gt; /dev/block/mmcblk2p21</span><br><span class="line">lrwxrwxrwx 1 root root 20 2024-08-11 20:21 misc -&gt; /dev/block/mmcblk2p6</span><br><span class="line">lrwxrwxrwx 1 root root 18 2024-08-11 20:21 mmcblk2 -&gt; /dev/block/mmcblk2</span><br><span class="line">lrwxrwxrwx 1 root root 23 2024-08-11 20:21 mmcblk2boot0 -&gt; /dev/block/mmcblk2boot0</span><br><span class="line">lrwxrwxrwx 1 root root 23 2024-08-11 20:21 mmcblk2boot1 -&gt; /dev/block/mmcblk2boot1</span><br><span class="line">lrwxrwxrwx 1 root root 20 2024-08-11 20:21 resource_a -&gt; /dev/block/mmcblk2p7</span><br><span class="line">lrwxrwxrwx 1 root root 20 2024-08-11 20:21 resource_b -&gt; /dev/block/mmcblk2p8</span><br><span class="line">lrwxrwxrwx 1 root root 20 2024-08-11 20:21 security -&gt; /dev/block/mmcblk2p1</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 super -&gt; /dev/block/mmcblk2p24</span><br><span class="line">lrwxrwxrwx 1 root root 20 2024-08-11 20:21 trust_a -&gt; /dev/block/mmcblk2p4</span><br><span class="line">lrwxrwxrwx 1 root root 20 2024-08-11 20:21 trust_b -&gt; /dev/block/mmcblk2p5</span><br><span class="line">lrwxrwxrwx 1 root root 20 2024-08-11 20:21 uboot_a -&gt; /dev/block/mmcblk2p2</span><br><span class="line">lrwxrwxrwx 1 root root 20 2024-08-11 20:21 uboot_b -&gt; /dev/block/mmcblk2p3</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 userdata -&gt; /dev/block/mmcblk2p25</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 vbmeta_a -&gt; /dev/block/mmcblk2p15</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 vbmeta_b -&gt; /dev/block/mmcblk2p16</span><br><span class="line">lrwxrwxrwx 1 root root 20 2024-08-11 20:21 vendor_boot_a -&gt; /dev/block/mmcblk2p9</span><br><span class="line">lrwxrwxrwx 1 root root 21 2024-08-11 20:21 vendor_boot_b -&gt; /dev/block/mmcblk2p10</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ–‡ä»¶è¶…çº§å¤šï¼Œæ²¡åŠæ³•ï¼Œæ˜¯ä¸ªä½“åŠ›æ´»äº†ã€‚</p><p>ä»ç³»ç»Ÿåˆ†åŒºçš„<code>_a</code>å’Œ<code>_b</code>èƒ½å¤Ÿçœ‹å‡ºæ¥ï¼Œä½¿ç”¨çš„æ˜¯é‡‡ç”¨äº†<code> A/Bï¼ˆåŒç³»ç»Ÿï¼‰</code>åˆ†åŒºç»“æ„ã€‚è¿™ç§åˆ†åŒºç»“æ„å¸¸ç”¨äºå®‰å“è®¾å¤‡ï¼Œä»¥å®ç°æ— ç¼ç³»ç»Ÿæ›´æ–°ã€‚</p><blockquote><p>åŒåˆ†åŒºï¼š åœ¨ A&#x2F;B åˆ†åŒºç»“æ„ä¸­ï¼Œå…³é”®çš„ç³»ç»Ÿåˆ†åŒºï¼ˆå¦‚ bootã€systemã€vendor ç­‰ï¼‰è¢«å¤åˆ¶æˆä¸¤ä»½ï¼Œåˆ†åˆ«ä¸º Aï¼ˆ_a åç¼€ï¼‰å’Œ Bï¼ˆ_b åç¼€ï¼‰åˆ†åŒºã€‚<br>ç³»ç»Ÿæ›´æ–°ï¼š å½“æœ‰æ–°çš„ç³»ç»Ÿæ›´æ–°æ—¶ï¼Œç³»ç»Ÿä¼šå°†æ›´æ–°å†™å…¥æœªä½¿ç”¨çš„åˆ†åŒºï¼ˆä¾‹å¦‚å½“å‰ä½¿ç”¨ A åˆ†åŒºæ—¶ä¼šæ›´æ–° B åˆ†åŒºï¼‰ã€‚æ›´æ–°å®Œæˆåï¼Œè®¾å¤‡ä¼šåˆ‡æ¢åˆ°æ›´æ–°åçš„åˆ†åŒºå¯åŠ¨ã€‚</p></blockquote><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰æ­£åœ¨ä½¿ç”¨çš„åˆ†åŒºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Pad70_Pro:/mnt/backup <span class="comment"># getprop ro.boot.slot_suffix</span></span><br><span class="line">_a</span><br></pre></td></tr></table></figure><p>æ­£åœ¨ä½¿ç”¨çš„åˆ†åŒºæ˜¯<code>_a</code>ï¼Œæ‰€ä»¥<code>_b</code>çš„æˆ‘ä»¬å°±ä¸ç”¨æå–äº†ã€‚</p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æå–åˆ†åŒºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Pad70_Pro:/ <span class="comment"># dd if=/dev/block/mmcblk2p19 of=backup.img                                                        </span></span><br><span class="line"><span class="built_in">dd</span>: backup.img: Read-only file system</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes (0 B) copied, 0.000704 s, 0 B/s</span><br></pre></td></tr></table></figure><p>å‘ç°æ ¹ç›®å½•æ˜¯ä»¥åªè¯»æ–¹å¼æŒ‚è½½çš„ï¼Œæ‰€ä»¥ä¸¤ç§æ–¹æ¡ˆï¼š</p><ul><li>é‡æ–°æŒ‚è½½</li><li>æ‰¾ä¸€ä¸ªå¯å†™çš„ç›®å½•</li><li>æ’å…¥sdå¡</li></ul><p>è¿™é‡Œå·æ‡’æ’äº†ä¸€å¼ <code>sdå¡</code>ï¼Œçœå»å¾ˆå¤šéº»çƒ¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„è¿™é‡Œçš„6EBE-F0F5å¯èƒ½æœ‰æ‰€ä¸åŒ</span></span><br><span class="line"><span class="built_in">cd</span> /storage/6EBE-F0F5 &amp;&amp; <span class="built_in">mkdir</span> backup &amp;&amp; <span class="built_in">cd</span> backup</span><br><span class="line"></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p19 of=backup.img   </span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p23 of=baseparameter    </span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p17 of=boot_a.img      </span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p20 of=cache.img    </span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p13 of=dtbo_a.img       </span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p22 of=frp.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p11 of=init_boot_a.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p21 of=metadata.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p6 of=misc.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2boot0 of=mmcblk2boot0.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2boot1 of=mmcblk2boot1.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p7 of=resource_a.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p1 of=security.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p24 of=super.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p4 of=trust_a.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p2 of=uboot_a.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p15 of=vbmeta_a.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p9 of=vendor_boot_a.img</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/block/mmcblk2p25 of=userdata.img bs=1M count=9216</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>pull</code>å‘½ä»¤æ‹‰å–åˆ°æœ¬åœ°æ–‡ä»¶å¤¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ adb pull /data/back/</span><br><span class="line">/data/back/: 26 files pulled. 35.7 MB/s (5431099392 bytes <span class="keyword">in</span> 144.983s)</span><br></pre></td></tr></table></figure><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> reverse </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> kernel </tag>
            
            <tag> rockchip </tag>
            
            <tag> hack </tag>
            
            <tag> rk3566 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LinuxæœåŠ¡å™¨æ­å»ºnfsæœåŠ¡(è½¬)</title>
      <link href="/2024/08/12/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BAnfs%E6%9C%8D%E5%8A%A1/"/>
      <url>/2024/08/12/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BAnfs%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<p><a href="https://juejin.cn/post/6868085817987268616">https://juejin.cn/post/6868085817987268616</a></p>]]></content>
      
      
      <categories>
          
          <category> server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LinuxæœåŠ¡å™¨é…ç½®sshå¯†é’¥ç™»å½•</title>
      <link href="/2024/08/12/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AEssh%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95/"/>
      <url>/2024/08/12/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AEssh%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h2 id="What-server-does"><a href="#What-server-does" class="headerlink" title="What server does"></a>What server does</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p>æ‰“å¼€å¦‚ä¸‹é€‰é¡¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PubkeyAuthentication <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆå¯†é’¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> .ssh</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> id_rsa.pub &gt;&gt; authorized_keys</span><br></pre></td></tr></table></figure><p>é‡å¯<code>sshd</code>æœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart ssh</span><br></pre></td></tr></table></figure><h2 id="What-client-does"><a href="#What-client-does" class="headerlink" title="What client does"></a>What client does</h2><p>å¤åˆ¶<code>.ssh</code>ç›®å½•ä¸‹çš„<code>id_rsa</code>æ–‡ä»¶åˆ°<code>~/.ssh</code>ç›®å½•ä¸‹å¹¶é‡å‘½åä¸€ä¸ªåå­—ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 600 ./&lt;your id_rsa name&gt; </span><br></pre></td></tr></table></figure><p>ç¼–è¾‘<code>hostname</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim ~/.ssh/config</span><br></pre></td></tr></table></figure><p>å°†ä»¥ä¸‹å†…å®¹æ·»åŠ è¿›å…¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Host &lt;your server name&gt;</span><br><span class="line">HostName &lt;your server IP&gt;</span><br><span class="line">TCPKeepAlive <span class="built_in">yes</span></span><br><span class="line">ServerAliveInterval 15</span><br><span class="line">User &lt;your user name of server&gt;</span><br><span class="line">IdentityFile &lt;your id_rsa file path&gt;</span><br><span class="line">Port &lt;your server port&gt;</span><br></pre></td></tr></table></figure><p>å°è¯•è¿æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh &lt;your server name&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568ä¸èƒ½çƒ§å†™é—®é¢˜</title>
      <link href="/2024/08/08/rk3568%E4%B8%8D%E8%83%BD%E7%83%A7%E5%86%99%E9%97%AE%E9%A2%98/"/>
      <url>/2024/08/08/rk3568%E4%B8%8D%E8%83%BD%E7%83%A7%E5%86%99%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>çƒ§å†™å›ºä»¶æ—¶è¢«æ‰“æ–­å°±ä¼šå¯¼è‡´<code>Loader</code>å’Œ<code>Maskrom</code>æ¨¡å¼éƒ½æ— æ³•è¿›å…¥ã€‚</p><p>æ­¤æ—¶å°†<code>sd</code>å¡åˆ·å†™ä¸€ä¸ª<code>update.img</code>ï¼Œå°±å¯ä»¥è¿›å…¥<code>Maskrom</code>æ¨¡å¼ï¼Œæ­¤æ—¶å¯å‘<code>emmc</code>çƒ§å†™é•œåƒã€‚</p>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>esp32-system-api: Event Loop Library</title>
      <link href="/2024/08/07/esp32-system-api-Event-Loop-Library/"/>
      <url>/2024/08/07/esp32-system-api-Event-Loop-Library/</url>
      
        <content type="html"><![CDATA[<h2 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h2><p>esp-idf: v5.3-stable</p><h2 id="æ•°æ®ç»“æ„ä»‹ç»"><a href="#æ•°æ®ç»“æ„ä»‹ç»" class="headerlink" title="æ•°æ®ç»“æ„ä»‹ç»"></a>æ•°æ®ç»“æ„ä»‹ç»</h2><h3 id="äº‹ä»¶å¤„ç†å‡½æ•°"><a href="#äº‹ä»¶å¤„ç†å‡½æ•°" class="headerlink" title="äº‹ä»¶å¤„ç†å‡½æ•°"></a>äº‹ä»¶å¤„ç†å‡½æ•°</h3><p>å½“äº‹ä»¶åˆ°è¾¾åï¼Œè¿è¡Œçš„å‡½æ•°åä¸º<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ã€‚</p><p><code>äº‹ä»¶å¤„ç†å‡½æ•°</code>è¦åœ¨<code>äº‹ä»¶å¾ªç¯</code>åˆ›å»ºå®Œæˆä¹‹åè°ƒç”¨æ³¨å†Œå‡½æ•°æ³¨å†Œè¿›å…¥<code>äº‹ä»¶å¾ªç¯</code>ã€‚</p><p><code>äº‹ä»¶å¤„ç†å‡½æ•°</code>å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">esp_event_handler_t</span>)</span><span class="params">(<span class="type">void</span>* event_handler_arg,</span></span><br><span class="line"><span class="params">                                    <span class="type">esp_event_base_t</span> event_base,</span></span><br><span class="line"><span class="params">                                    <span class="type">int32_t</span> event_id,</span></span><br><span class="line"><span class="params">                                    <span class="type">void</span>* event_data)</span>; </span><br><span class="line"><span class="comment">/**&lt; function called when an event is posted to the queue */</span></span><br></pre></td></tr></table></figure><h3 id="äº‹ä»¶å¾ªç¯å¥æŸ„"><a href="#äº‹ä»¶å¾ªç¯å¥æŸ„" class="headerlink" title="äº‹ä»¶å¾ªç¯å¥æŸ„"></a>äº‹ä»¶å¾ªç¯å¥æŸ„</h3><p>äº‹ä»¶å¾ªç¯å¥æŸ„çš„<code>å†…å­˜</code>ä¸<code>å€¼</code>ç”±<code>API</code>å†³å®šï¼Œç”¨æˆ·å¹¶ä¸å‚ä¸ï¼Œæ‰€ä»¥ç”¨æˆ·åœ¨åˆ›å»ºäº‹ä»¶å¾ªç¯å¥æŸ„çš„æ—¶å€™åº”è¯¥åˆ›å»ºä¸ºæŒ‡é’ˆï¼Œè°ƒç”¨<code>esp_event_loop_create</code>å‡½æ•°åˆ›å»ºäº‹ä»¶å¾ªç¯å¥æŸ„ï¼Œç»è¯¥å‡½æ•°åˆ›å»ºçš„äº‹ä»¶å¾ªç¯å¥æŸ„ç§°ä¸º<code>ç”¨æˆ·äº‹ä»¶å¾ªç¯å¥æŸ„</code>ã€‚</p><p>äº‹ä»¶å¾ªç¯å¥æŸ„ç±»å‹ï¼š<code>esp_event_loop_handle_t</code><br>PS: è¿™ä¸ªç±»å‹å·²ç»ä¸ºä¸€ä¸ªæŒ‡é’ˆã€‚</p><p>e.g.: </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">esp_event_loop_handle_t</span> loop_handle;</span><br></pre></td></tr></table></figure><h3 id="äº‹ä»¶å¾ªç¯é…ç½®é¡¹"><a href="#äº‹ä»¶å¾ªç¯é…ç½®é¡¹" class="headerlink" title="äº‹ä»¶å¾ªç¯é…ç½®é¡¹"></a>äº‹ä»¶å¾ªç¯é…ç½®é¡¹</h3><p>ä¸Šé¢æåˆ°<code>äº‹ä»¶å¾ªç¯å¥æŸ„</code>ç”±APIåˆ›å»ºï¼Œé‚£ä¹ˆå¦‚æœæƒ³é…ç½®<code>äº‹ä»¶å¾ªç¯</code>å°±è¦ç”¨åˆ°<code>äº‹ä»¶å¾ªç¯é…ç½®é¡¹</code>ã€‚</p><p><code>äº‹ä»¶å¾ªç¯é…ç½®é¡¹</code>å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// Configuration for creating event loops</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int32_t</span> queue_size;                         <span class="comment">/**&lt; size of the event loop queue */</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *task_name;                      <span class="comment">/**&lt; name of the event loop task; if NULL,</span></span><br><span class="line"><span class="comment">                                                        a dedicated task is not created for event loop*/</span></span><br><span class="line">    UBaseType_t task_priority;                  <span class="comment">/**&lt; priority of the event loop task, ignored if task name is NULL */</span></span><br><span class="line">    <span class="type">uint32_t</span> task_stack_size;                   <span class="comment">/**&lt; stack size of the event loop task, ignored if task name is NULL */</span></span><br><span class="line">    BaseType_t task_core_id;                    <span class="comment">/**&lt; core to which the event loop task is pinned to,</span></span><br><span class="line"><span class="comment">                                                        ignored if task name is NULL */</span></span><br><span class="line">&#125; <span class="type">esp_event_loop_args_t</span>;</span><br></pre></td></tr></table></figure><p>é…ç½®é¡¹è§£æå¦‚ä¸‹ï¼š</p><ul><li>queue_size: äº‹ä»¶å¾ªç¯é˜Ÿåˆ—å¤§å°ï¼ŒæŒ‡åœ¨<code>äº‹ä»¶</code>æ²¡å‘é€åˆ°<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ä¹‹å‰ï¼Œè¯¥<code>äº‹ä»¶å¾ªç¯</code>æœ€å¤šèƒ½å®¹çº³çš„äº‹ä»¶æ•°é‡ã€‚</li><li>task_name: æ˜¯å¦é€‰æ‹©å®šä¹‰ä¸€ä¸ª<code>çº¿ç¨‹</code>å»è¯»å–<code>äº‹ä»¶å¾ªç¯</code>çš„é˜Ÿåˆ—ï¼Œå¹¶ä¸”åœ¨è¯»å–åˆ°æ•°æ®åæ‰§è¡Œ<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ï¼Œå¦‚æœè¯¥å‚æ•°ä¸º<code>NULL</code>ï¼Œåˆ™æ²¡æœ‰<code>ä¸“ç”¨çº¿ç¨‹</code>è¯»å–äº‹ä»¶å¹¶æ‰§è¡Œ<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨<code>esp_event_loop_run</code>å‡½æ•°å»è¯»å–<code>é˜Ÿåˆ—</code>æ‰§è¡Œ<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ï¼Œå¹¶ä¸”ä¸‹é¢ä¸‰ä¸ªæˆå‘˜é…ç½®é¡¹æ— æ•ˆã€‚</li><li>task_priority: <code>äº‹ä»¶å¾ªç¯ä¸“ç”¨çº¿ç¨‹</code>çš„ä¼˜å…ˆçº§é…ç½®ï¼Œå¯ä½¿ç”¨<code>uxTaskPriorityGet(NULL)</code>å‡½æ•°è·å–å½“å‰çº¿ç¨‹ä¼˜å…ˆçº§é™„åŠ ç»™å®ƒã€‚</li><li>task_stack_size: è¯¥<code>ä¸“ç”¨çº¿ç¨‹</code>çš„å †æ ˆå¤§å°ï¼Œä¸å»ºè®®å¤ªå°ï¼Œä¼šæº¢å‡ºï¼Œ<code>3072</code>æ˜¯ä¸€ä¸ªæ™®éå®‰å…¨å€¼ã€‚</li><li>task_core_id: è¯¥äº‹ä»¶å¾ªç¯<code>ä¸“ç”¨çº¿ç¨‹</code>åœ¨å“ªä¸ªæ ¸å¿ƒä¸Šæ‰§è¡Œï¼Œåº”è¯¥â‰¥<code>0</code> &amp;&amp; ï¼œ <code>CONFIG_FREERTOS_NUMBER_OF_CORES</code>ï¼Œè¯¥å®åœ¨<code>sdkconfig</code>å®šä¹‰äº†æœ€å¤§æ ¸å¿ƒæ•°ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨<code>tskNO_AFFINITY</code>å®å®šä¹‰ä¸æŒ‡å®šä»»ä½•ä¸€ä¸ªæ ¸å¿ƒï¼Œç”±<code>FreeRTOS</code>æŒ‡å®šã€‚</li></ul><h2 id="EVENT-BASEä¸EVENT-ID"><a href="#EVENT-BASEä¸EVENT-ID" class="headerlink" title="EVENT_BASEä¸EVENT_ID"></a>EVENT_BASEä¸EVENT_ID</h2><p>æ¯ä¸ª<code>äº‹ä»¶å¾ªç¯</code>éƒ½åº”è¯¥æœ‰<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ï¼Œå¦åˆ™<code>äº‹ä»¶å¾ªç¯</code>æ¯«æ— æ„ä¹‰ã€‚</p><p>åœ¨<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ä¸­åŒºåˆ«<code>äº‹ä»¶</code>çš„å”¯ä¸€æ–¹å¼å°±æ˜¯é€šè¿‡<code>EVENT_BASE</code>ä¸<code>EVENT_ID</code>ã€‚</p><p>è¿™ä¸¤ä¸ªç±»ä¼¼äºLinuxçš„majorä¸minorã€‚</p><p>å¦‚<code>EVENT_BASE</code>å¯ä»¥æ˜¯<code>WIFI_EVENT</code>ï¼Œ<code>EVENT_ID</code>å¯ä»¥æ˜¯<code>CONNECTED</code>ã€<code>GOT_IP</code>ç­‰ã€‚</p><p><code>EVENT_BASE</code>å®šä¹‰æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ESP_EVENT_DECLARE_BASE(MY_EVENT_BASE);</span><br><span class="line">ESP_EVENT_DEFINE_BASE(MY_EVENT_BASE);</span><br></pre></td></tr></table></figure><p><code>EVENT_ID</code>æ¨èé€šè¿‡<code>enum</code>å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    MY_EVENT_ID1,</span><br><span class="line">    MY_EVENT_ID2,</span><br><span class="line">    MY_EVENT_ID3,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p>è¯¥ç« èŠ‚æ¶µç›–äº†å¸¸ç”¨APIä»¥åŠç®€ä»‹ï¼Œæ¬²çŸ¥æ›´è¯¦ç»†ï¼Œè¯·è§[1]</p><ul><li><code>esp_event_loop_create</code>:  è¯¥å‡½æ•°åˆ›å»ºäº†<code>äº‹ä»¶å¾ªç¯</code>ï¼Œä¸¤ä¸ªå…¥å‚ä¸€ä¸ªæ˜¯<code>äº‹ä»¶å¾ªç¯å¥æŸ„</code>ï¼Œä¸€ä¸ªæ˜¯<code>äº‹ä»¶å¾ªç¯å‚æ•°</code>ã€‚</li><li><code>esp_event_loop_create_default</code>: è¯¥å‡½æ•°åˆ›å»ºäº†é»˜è®¤çš„äº‹ä»¶å¾ªç¯ï¼Œç”±äºä¸€äº›äº‹ä»¶çš„æ¨é€ä¸èƒ½ç”±ç”¨æˆ·æäº¤åˆ°é˜Ÿåˆ—ï¼Œå¦‚wifiè¿æ¥äº‹ä»¶ï¼Œè·å–ipäº‹ä»¶ç­‰ï¼Œæ‰€ä»¥ä¾¿æœ‰äº†é»˜è®¤çš„äº‹ä»¶å¾ªç¯ï¼Œå…·ä½“è§[4]</li><li><code>esp_event_loop_delete:</code> åˆ é™¤äº‹ä»¶å¾ªç¯ï¼Œå…¥å‚æ˜¯<code>äº‹ä»¶å¾ªç¯å¥æŸ„</code>ã€‚</li><li><code>esp_event_loop_delete_default</code>: åˆ é™¤é»˜è®¤äº‹ä»¶å¾ªç¯</li><li><code>esp_event_handler_register_with</code>: æ³¨å†Œ<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>åˆ°æŸä¸ª<code>äº‹ä»¶å¾ªç¯</code>ï¼Œéœ€è¦æä¾›è¯¥äº‹ä»¶å¤„ç†å‡½æ•°æ‰€å¤„ç†çš„<code>EVENT_BASE</code>å’Œ<code>EVENT_ID</code>ï¼Œä¸€ä¸ª<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>å¯ç”¨ä¸åŒçš„<code>EVENT</code>æ³¨å†Œå¤šæ¬¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>ESP_EVENT_ANY_ID</code>å»å¤„ç†æ•´ä¸ª<code>EVENT_BASE</code>ä¸‹çš„<code>ID</code></li><li><code>esp_event_handler_unregister_with</code>: æ³¨é”€æŸä¸ª<code>äº‹ä»¶å¤„ç†å‡½æ•°</code></li><li><code>esp_event_handler_register</code>: ä¸º<code>é»˜è®¤äº‹ä»¶å¾ªç¯</code>æ³¨å†Œ<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ï¼Œé™¤äº†ä¸éœ€è¦æä¾›<code>äº‹ä»¶å¾ªç¯å¥æŸ„</code>ä»¥å¤–ï¼Œä¸<code>esp_event_handler_register</code>æ— å¼‚ã€‚</li><li><code>esp_event_handler_unregister</code>: ä¸º<code>é»˜è®¤äº‹ä»¶å¾ªç¯</code>æ³¨é”€<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ï¼Œé™¤äº†ä¸éœ€è¦æä¾›<code>äº‹ä»¶å¾ªç¯å¥æŸ„</code>ä»¥å¤–ï¼Œä¸<code>esp_event_handler_register</code>æ— å¼‚ã€‚</li><li><code>esp_event_post_to</code>: å‘æŒ‡å®šçš„<code>äº‹ä»¶å¾ªç¯</code>å‘é€äº‹ä»¶ã€‚</li><li><code>esp_event_post</code>: å‘é»˜è®¤çš„<code>äº‹ä»¶å¾ªç¯</code>å‘é€äº‹ä»¶</li><li><code>esp_event_loop_run</code>: å½“åœ¨äº‹ä»¶å¾ªç¯å‚æ•°å†…æ²¡æœ‰é…ç½®<code>task_name</code>æ—¶ï¼Œå°±ä¸ç”¨æœ‰<code>ä¸“æœ‰çº¿ç¨‹</code>å»è¯»å–<code>é˜Ÿåˆ—</code>å¹¶ä¸”æ‰§è¡Œ<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ï¼Œæ­¤æ—¶éœ€è¦è°ƒç”¨<code>esp_event_loop_run</code>æ‰‹åŠ¨è¯»å–å¹¶è°ƒç”¨<code>äº‹ä»¶å¤„ç†å‡½æ•°</code>ï¼Œè¯¥å‡½æ•°ä¸¤ä¸ªå…¥å‚åˆ†åˆ«ä¸º<code>äº‹ä»¶å¾ªç¯å¥æŸ„</code>å’Œ<code>è¿è¡Œtick</code></li></ul><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><h3 id="ç”¨æˆ·äº‹ä»¶å¾ªç¯"><a href="#ç”¨æˆ·äº‹ä»¶å¾ªç¯" class="headerlink" title="ç”¨æˆ·äº‹ä»¶å¾ªç¯"></a>ç”¨æˆ·äº‹ä»¶å¾ªç¯</h3><h4 id="ä¸“å±çº¿ç¨‹"><a href="#ä¸“å±çº¿ç¨‹" class="headerlink" title="ä¸“å±çº¿ç¨‹"></a>ä¸“å±çº¿ç¨‹</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* äº‹ä»¶å¾ªç¯å¥æŸ„ */</span></span><br><span class="line"><span class="type">esp_event_loop_handle_t</span> loop_with_task;</span><br><span class="line"></span><br><span class="line">ESP_EVENT_DECLARE_BASE(TASK_EVENTS);         <span class="comment">// declaration of the task events family</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    TASK_ITERATION_EVENT                     <span class="comment">// raised during an iteration of the loop within the task</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">task_iteration_handler</span><span class="params">(<span class="type">void</span>* handler_args, <span class="type">esp_event_base_t</span> base, <span class="type">int32_t</span> id, <span class="type">void</span>* event_data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Two types of data can be passed in to the event handler: the handler specific data and the event-specific data.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The handler specific data (handler_args) is a pointer to the original data, therefore, the user should ensure that</span></span><br><span class="line">    <span class="comment">// the memory location it points to is still valid when the handler executes.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The event-specific data (event_data) is a pointer to a deep copy of the original data, and is managed automatically.</span></span><br><span class="line">    <span class="type">int</span> iteration = *((<span class="type">int</span>*) event_data);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* loop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handler_args == loop_with_task) &#123;</span><br><span class="line">        loop = <span class="string">&quot;loop_with_task&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        loop = <span class="string">&quot;loop_without_task&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ESP_LOGI(TAG, <span class="string">&quot;handling %s:%s from %s, iteration %d&quot;</span>, base, <span class="string">&quot;TASK_ITERATION_EVENT&quot;</span>, loop, iteration);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">/* äº‹ä»¶å¾ªç¯å‚æ•° æœ‰ä¸“å±ä»»åŠ¡*/</span> </span><br><span class="line">    <span class="type">esp_event_loop_args_t</span> loop_with_task_args = &#123;</span><br><span class="line">            <span class="comment">/* é˜Ÿåˆ—å¤§å° */</span> </span><br><span class="line">            .queue_size = <span class="number">5</span>,</span><br><span class="line">            .task_name = <span class="string">&quot;loop_task&quot;</span>, <span class="comment">// task will be created</span></span><br><span class="line">            <span class="comment">/* å½“å‰åˆ›å»ºäº‹ä»¶å¾ªç¯çš„ä»»åŠ¡çš„ä¼˜å…ˆçº§ */</span></span><br><span class="line">            .task_priority = uxTaskPriorityGet(<span class="literal">NULL</span>),</span><br><span class="line">            <span class="comment">/* å †æ ˆå¤§å° */</span> </span><br><span class="line">            .task_stack_size = <span class="number">3072</span>,</span><br><span class="line">            <span class="comment">/* ä¸æŒ‡å®šä»»ä½•æ ¸å¿ƒï¼Œç”±ç³»ç»ŸæŒ‡æ´¾ */</span> </span><br><span class="line">            .task_core_id = tskNO_AFFINITY</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆ›å»ºäº‹ä»¶å¾ªç¯ */</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_event_loop_create(&amp;loop_with_task_args, &amp;loop_with_task));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ³¨å†Œäº‹ä»¶å¤„ç†å‡½æ•° */</span> </span><br><span class="line">    ESP_ERROR_CHECK(esp_event_handler_instance_register_with(loop_with_task, TASK_EVENTS, TASK_ITERATION_EVENT, task_iteration_handler, loop_with_task, <span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ²¡æœ‰ä¸“å±çº¿ç¨‹"><a href="#æ²¡æœ‰ä¸“å±çº¿ç¨‹" class="headerlink" title="æ²¡æœ‰ä¸“å±çº¿ç¨‹"></a>æ²¡æœ‰ä¸“å±çº¿ç¨‹</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* äº‹ä»¶å¾ªç¯å¥æŸ„ */</span></span><br><span class="line"><span class="type">esp_event_loop_handle_t</span> loop_without_task;</span><br><span class="line"></span><br><span class="line">ESP_EVENT_DECLARE_BASE(TASK_EVENTS);         <span class="comment">// declaration of the task events family</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    TASK_ITERATION_EVENT                     <span class="comment">// raised during an iteration of the loop within the task</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">task_iteration_handler</span><span class="params">(<span class="type">void</span>* handler_args, <span class="type">esp_event_base_t</span> base, <span class="type">int32_t</span> id, <span class="type">void</span>* event_data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Two types of data can be passed in to the event handler: the handler specific data and the event-specific data.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The handler specific data (handler_args) is a pointer to the original data, therefore, the user should ensure that</span></span><br><span class="line">    <span class="comment">// the memory location it points to is still valid when the handler executes.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The event-specific data (event_data) is a pointer to a deep copy of the original data, and is managed automatically.</span></span><br><span class="line">    <span class="type">int</span> iteration = *((<span class="type">int</span>*) event_data);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* loop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handler_args == loop_with_task) &#123;</span><br><span class="line">        loop = <span class="string">&quot;loop_with_task&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        loop = <span class="string">&quot;loop_without_task&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ESP_LOGI(TAG, <span class="string">&quot;handling %s:%s from %s, iteration %d&quot;</span>, base, <span class="string">&quot;TASK_ITERATION_EVENT&quot;</span>, loop, iteration);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">/* äº‹ä»¶å¾ªç¯å‚æ•° æ²¡æœ‰ä¸“å±ä»»åŠ¡</span></span><br><span class="line"><span class="comment">        åœ¨post_toä¹‹åéœ€è¦åœ¨çº¿ç¨‹ä¸­</span></span><br><span class="line"><span class="comment">        è°ƒç”¨esp_event_loop_run(loop_without_task, 100);</span></span><br><span class="line"><span class="comment">        å¦åˆ™æ— æ³•è¿›å…¥äº‹ä»¶å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="comment">    */</span> </span><br><span class="line">    <span class="type">esp_event_loop_args_t</span> loop_without_task_args = &#123;</span><br><span class="line">        .queue_size = <span class="number">5</span>,</span><br><span class="line">        .task_name = <span class="literal">NULL</span> <span class="comment">// no task will be created</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆ›å»ºäº‹ä»¶å¾ªç¯ */</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_event_loop_create(&amp;loop_without_task_args, &amp;loop_without_task));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ³¨å†Œäº‹ä»¶å¤„ç†å‡½æ•° */</span> </span><br><span class="line">    ESP_ERROR_CHECK(esp_event_handler_instance_register_with(loop_with_task, TASK_EVENTS, TASK_ITERATION_EVENT, task_iteration_handler, loop_with_task, <span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p>[1]<a href="https://docs.espressif.com/projects/esp-idf/zh_CN/v5.3/esp32/api-reference/system/esp_event.html">https://docs.espressif.com/projects/esp-idf/zh_CN/v5.3/esp32/api-reference/system/esp_event.html</a><br>[2]<a href="https://github.com/espressif/esp-idf/tree/v5.3/examples/system/esp_event/user_event_loops">https://github.com/espressif/esp-idf/tree/v5.3/examples/system/esp_event/user_event_loops</a><br>[3]<a href="https://github.com/espressif/esp-idf/tree/v5.3/examples/system/esp_event/default_event_loop">https://github.com/espressif/esp-idf/tree/v5.3/examples/system/esp_event/default_event_loop</a><br>[4]<a href="https://docs.espressif.com/projects/esp-idf/zh_CN/v5.3/esp32/api-reference/system/esp_event.html#esp-event-default-loops">https://docs.espressif.com/projects/esp-idf/zh_CN/v5.3/esp32/api-reference/system/esp_event.html#esp-event-default-loops</a></p>]]></content>
      
      
      <categories>
          
          <category> mcu </category>
          
          <category> esp32 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mcu </tag>
            
            <tag> esp32 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vimä¸­æ–‡ä¹±ç </title>
      <link href="/2024/08/07/vim%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/"/>
      <url>/2024/08/07/vim%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim ~/.vimrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ä»¥ä¸‹å†…å®¹åŠ å…¥ï¼š</span></span><br><span class="line"><span class="built_in">set</span> termencoding=utf-8</span><br><span class="line"><span class="built_in">set</span> encoding=utf8</span><br><span class="line"><span class="built_in">set</span> fileencodings=utf8,ucs-bom,gbk,cp936,gb2312,gb18030</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>clionå¼€å‘esp32</title>
      <link href="/2024/08/01/clion%E5%BC%80%E5%8F%91esp32/"/>
      <url>/2024/08/01/clion%E5%BC%80%E5%8F%91esp32/</url>
      
        <content type="html"><![CDATA[<h2 id="README"><a href="#README" class="headerlink" title="README"></a>README</h2><p>æœ¬æ–‡åŸºäºæ–‡æœ«çš„<code>ref</code>é“¾æ¥[Link1]æ­å»ºï¼Œè¿™é‡Œä½œä¸ºä¸€äº›è¡¥å……è®°å½•ã€‚</p><p>Chip: esp32c3</p><p>System: Ubuntu 22.04</p><h2 id="å®‰è£…idfå‡ºç°é”™è¯¯"><a href="#å®‰è£…idfå‡ºç°é”™è¯¯" class="headerlink" title="å®‰è£…idfå‡ºç°é”™è¯¯"></a>å®‰è£…idfå‡ºç°é”™è¯¯</h2><p>åœ¨æ‰§è¡Œ<code>.install.sh</code>æ—¶é‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./install.sh</span><br><span class="line">Detecting the Python interpreter</span><br><span class="line">Checking <span class="string">&quot;python3&quot;</span> ...</span><br><span class="line">Python 3.10.12</span><br><span class="line"><span class="string">&quot;python3&quot;</span> has been detected</span><br><span class="line">Checking Python cref: nsa-esp-elf-gdb, riscv32-esp-elf-gdb, xtensa-esp-elf, riscv32-esp-elf, esp32ulp-elf, openocd-esp32, esp-rom-elfs</span><br><span class="line">Skipping xtensa-esp-elf-gdb@14.2_20240403 (already installed)</span><br><span class="line">Skipping riscv32-esp-elf-gdb@14.2_20240403 (already installed)</span><br><span class="line">Skipping xtensa-esp-elf@esp-13.2.0_20240530 (already installed)</span><br><span class="line">Skipping riscv32-esp-elf@esp-13.2.0_20240530 (already installed)</span><br><span class="line">Skipping esp32ulp-elf@2.38_20240113 (already installed)</span><br><span class="line">Skipping openocd-esp32@v0.12.0-esp32-20240318 (already installed)</span><br><span class="line">Skipping esp-rom-elfs@20240305 (already installed)</span><br><span class="line">Installing Python environment and packages</span><br><span class="line">Python 3.10.12</span><br><span class="line">pip 22.0.2 from /home/troy/.espressif/python_env/idf5.3_py3.10_env/lib/python3.10/site-packages/pip (python 3.10)</span><br><span class="line">Upgrading pip and setuptools...</span><br><span class="line">Requirement already satisfied: pip <span class="keyword">in</span> /home/troy/.espressif/python_env/idf5.3_py3.10_env/lib/python3.10/site-packages (22.0.2)</span><br><span class="line">Collecting pip</span><br><span class="line">  Using cached pip-24.2-py3-none-any.whl (1.8 MB)</span><br><span class="line">Requirement already satisfied: setuptools <span class="keyword">in</span> /home/troy/.espressif/python_env/idf5.3_py3.10_env/lib/python3.10/site-packages (59.6.0)</span><br><span class="line">Collecting setuptools</span><br><span class="line">  Using cached setuptools-72.1.0-py3-none-any.whl (2.3 MB)</span><br><span class="line">Installing collected packages: setuptools, pip</span><br><span class="line">  Attempting uninstall: setuptools</span><br><span class="line">    Found existing installation: setuptools 59.6.0</span><br><span class="line">    Uninstalling setuptools-59.6.0:</span><br><span class="line">      Successfully uninstalled setuptools-59.6.0</span><br><span class="line">  Attempting uninstall: pip</span><br><span class="line">    Found existing installation: pip 22.0.2</span><br><span class="line">    Uninstalling pip-22.0.2:</span><br><span class="line">      Successfully uninstalled pip-22.0.2</span><br><span class="line">Successfully installed pip-24.2 setuptools-72.1.0</span><br><span class="line">Skipping the download of /home/troy/.espressif/espidf.constraints.v5.3.txt because it was downloaded recently.</span><br><span class="line">Installing Python packages</span><br><span class="line"> Constraint file: /home/troy/.espressif/espidf.constraints.v5.3.txt</span><br><span class="line"> Requirement files:</span><br><span class="line">  - /home/troy/repo/esp-idf-v5.3/tools/requirements/requirements.core.txt</span><br><span class="line">Usage: __main__.py [options]</span><br><span class="line"></span><br><span class="line">ERROR: Invalid requirement: --2024-08-01 15:30:43--  https://dl.espressif.com/dl/esp-idf/espidf.constraints.v5.3.txt</span><br><span class="line">__main__.py: error: no such option: --2024-08-01</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/home/troy/repo/esp-idf-v5.3/tools/idf_tools.py&quot;</span>, line 3241, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    main(sys.argv[1:])</span><br><span class="line">  File <span class="string">&quot;/home/troy/repo/esp-idf-v5.3/tools/idf_tools.py&quot;</span>, line 3233, <span class="keyword">in</span> main</span><br><span class="line">    action_func(args)</span><br><span class="line">  File <span class="string">&quot;/home/troy/repo/esp-idf-v5.3/tools/idf_tools.py&quot;</span>, line 2680, <span class="keyword">in</span> action_install_python_env</span><br><span class="line">    subprocess.check_call(run_args, stdout=sys.stdout, stderr=sys.stderr, <span class="built_in">env</span>=env_copy)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/subprocess.py&quot;</span>, line 369, <span class="keyword">in</span> check_call</span><br><span class="line">    raise CalledProcessError(retcode, cmd)</span><br><span class="line">subprocess.CalledProcessError: Command <span class="string">&#x27;[&#x27;</span>/home/troy/.espressif/python_env/idf5.3_py3.10_env/bin/python<span class="string">&#x27;, &#x27;</span>-m<span class="string">&#x27;, &#x27;</span>pip<span class="string">&#x27;, &#x27;</span>install<span class="string">&#x27;, &#x27;</span>--no-warn-script-location<span class="string">&#x27;, &#x27;</span>-r<span class="string">&#x27;, &#x27;</span>/home/troy/repo/esp-idf-v5.3/tools/requirements/requirements.core.txt<span class="string">&#x27;, &#x27;</span>--upgrade<span class="string">&#x27;, &#x27;</span>--constraint<span class="string">&#x27;, &#x27;</span>/home/troy/.espressif/espidf.constraints.v5.3.txt<span class="string">&#x27;, &#x27;</span>--extra-index-url<span class="string">&#x27;, &#x27;</span>https://dl.espressif.com/pypi<span class="string">&#x27;]&#x27;</span> returned non-zero <span class="built_in">exit</span> status 1.</span><br></pre></td></tr></table></figure><p>æ‰‹åŠ¨ä¸‹è½½ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://dl.espressif.com/dl/esp-idf/espidf.constraints.v5.3.txt -O /home/troy/.espressif/espidf.constraints.v5.3.txt</span><br><span class="line"></span><br><span class="line">--2024-08-01 15:43:03--  https://dl.espressif.com/dl/esp-idf/espidf.constraints.v5.3.txt</span><br><span class="line">æ­£åœ¨è¿æ¥ 127.0.0.1:7897... å·²è¿æ¥ã€‚</span><br><span class="line">å·²å‘å‡º Proxy è¯·æ±‚ï¼Œæ­£åœ¨ç­‰å¾…å›åº”... 200 OK</span><br><span class="line">é•¿åº¦ï¼š 2940 (2.9K) [text/plain]</span><br><span class="line">æ­£åœ¨ä¿å­˜è‡³: â€˜/home/troy/.espressif/espidf.constraints.v5.3.txtâ€™</span><br><span class="line"></span><br><span class="line">/home/troy/.espressif/espidf.constrai 100%[========================================================================&gt;]   2.87K  --.-KB/s    ç”¨æ—¶ 0s    </span><br><span class="line"></span><br><span class="line">2024-08-01 15:43:03 (446 MB/s) - å·²ä¿å­˜ â€˜/home/troy/.espressif/espidf.constraints.v5.3.txtâ€™ [2940/2940])</span><br></pre></td></tr></table></figure><h2 id="çƒ§å½•ç¨‹åºåå¦‚ä½•è‡ªåŠ¨æ‰“å¼€ä¸²å£"><a href="#çƒ§å½•ç¨‹åºåå¦‚ä½•è‡ªåŠ¨æ‰“å¼€ä¸²å£" class="headerlink" title="çƒ§å½•ç¨‹åºåå¦‚ä½•è‡ªåŠ¨æ‰“å¼€ä¸²å£"></a>çƒ§å½•ç¨‹åºåå¦‚ä½•è‡ªåŠ¨æ‰“å¼€ä¸²å£</h2><p>åœ¨ç»è¿‡å¯¹é…ç½®æ–‡ä»¶<code>monitor</code>çš„å°è¯•ä¹‹åï¼Œç¡®å®ä»¥<code>115200</code>æ³¢ç‰¹ç‡æ‰“å¼€äº†<code>/dev/ttyACM0</code>ï¼Œä½†æ˜¯<code>console</code>ä¸Šæ˜¾ç¤ºçš„å­—ç¬¦å…¨æ˜¯ç©ºç™½ï¼Œä¸æ¸…æ¥šä¸ºä»€ä¹ˆï¼Œæ‰€ä»¥ä¸º<code>flash</code>è¿™ä¸ª<code>configuration</code>æ·»åŠ ä¸€ä¸‹å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè®°å¾—å‹¾é€‰ä¸Šåœ¨<code>è¾“å‡ºæ§åˆ¶å°æ¨¡æ‹Ÿç»ˆç«¯</code>ã€‚</p><p>å¯æ‰§è¡Œæ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">idf.py monitor</span><br></pre></td></tr></table></figure><p>PS: ç”±äºç”¨åˆ°äº†<code>idf.py</code>ï¼Œæ‰€ä»¥è¦æ‰§è¡Œ<code>export.sh</code>ï¼Œåœ¨<code>toolchain</code>é‡Œé¢çš„ç¯å¢ƒå˜é‡ä¸­å¯ä»¥æ·»åŠ <code>export.sh</code>.</p><p><img src="https://i.ibb.co/42jkNps/2024-08-04-19-28-11.png" alt="how to install export.sh"></p><p>è®°å¾—å‹¾é€‰ä¸Š</p><h2 id="å¦‚ä½•é€šè¿‡JTAGè¿›è¡Œè°ƒè¯•"><a href="#å¦‚ä½•é€šè¿‡JTAGè¿›è¡Œè°ƒè¯•" class="headerlink" title="å¦‚ä½•é€šè¿‡JTAGè¿›è¡Œè°ƒè¯•"></a>å¦‚ä½•é€šè¿‡JTAGè¿›è¡Œè°ƒè¯•</h2><p>æ·»åŠ <code>åµŒå…¥å¼GDBæœåŠ¡å™¨</code>configurationåæŒ‰ç…§ä¸‹å›¾å¡«å†™å‚æ•°ï¼Œéœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p><ul><li><code>GDBæœåŠ¡å™¨å®å‚</code>çš„<code>cfgæ–‡ä»¶</code>è¯·å‚è€ƒé“¾æ¥5[5]</li><li>è°ƒè¯•å™¨éœ€è¦é€‰æ‹©<code>esp32</code>å¯¹åº”çš„<code>gdb</code>ï¼Œè€Œä¸æ˜¯å†…ç½®çš„ï¼Œè¿™ç‚¹éœ€è¦åœ¨<code>toolchain</code>é‡Œé¢å»é…ç½®è·¯å¾„ï¼Œè·Ÿ<code>gcc</code>å’Œ<code>g++</code>åœ¨çš„åœ°æ–¹å·®ä¸å¤š</li></ul><p><img src="https://i.ibb.co/Qf8TRnx/2024-08-05-15-12-56.png" alt="how to jtag"></p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p>[Link1]<a href="https://blog.csdn.net/m0_51719399/article/details/127389279">https://blog.csdn.net/m0_51719399/article/details/127389279</a><br>[Link2]<a href="https://www.bilibili.com/read/cv15226500/">https://www.bilibili.com/read/cv15226500/</a><br>[Link3]<a href="https://github.com/TroyMitchell911/esp32-example-clion">https://github.com/TroyMitchell911/esp32-example-clion</a><br>[Link4]<a href="https://docs.espressif.com/projects/esp-idf/zh_CN/stable/esp32c3/api-guides/jtag-debugging/index.html">https://docs.espressif.com/projects/esp-idf/zh_CN/stable/esp32c3/api-guides/jtag-debugging/index.html</a><br>[Link5]<a href="https://docs.espressif.com/projects/esp-idf/zh_CN/stable/esp32c3/api-guides/jtag-debugging/tips-and-quirks.html#jtag-debugging-tip-openocd-configure-target">https://docs.espressif.com/projects/esp-idf/zh_CN/stable/esp32c3/api-guides/jtag-debugging/tips-and-quirks.html#jtag-debugging-tip-openocd-configure-target</a></p>]]></content>
      
      
      <categories>
          
          <category> mcu </category>
          
          <category> esp32 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mcu </tag>
            
            <tag> esp32 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568ç§»æ¤openHarmony v3.2.3---ç¯å¢ƒå‡†å¤‡</title>
      <link href="/2024/08/01/rk3568%E7%A7%BB%E6%A4%8DopenHarmony/"/>
      <url>/2024/08/01/rk3568%E7%A7%BB%E6%A4%8DopenHarmony/</url>
      
        <content type="html"><![CDATA[<h1 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h1><p>System: Ubuntu 20.04</p><h2 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h2><p>å®‰è£…ç¼–è¯‘æ‰€éœ€è¦çš„è½¯ä»¶åŒ…ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install binutils git git-lfs gnupg flex bison gperf build-essential zlib1g-dev \</span><br><span class="line">gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev \</span><br><span class="line">ccache libgl1-mesa-dev libxml2-utils xsltproc unzip m4 bc gnutls-bin python3.8 python3-pip ruby \</span><br><span class="line">openjdk-8-jdk genext2fs libopencv-dev lz4 libssl-dev libncurses5 git-lfs lib32z1-dev zip curl</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœlibncurses5è¿™ä¸ªä¾èµ–æ²¡å®‰è£…ä¸Šï¼Œæ‰§è¡Œaptå†æ¬¡å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libncurses5</span><br></pre></td></tr></table></figure><h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">repo init -u git@gitee.com:openharmony/manifest.git -b refs/tags/OpenHarmony-v3.1.3-Release --no-repo-verify</span><br><span class="line">repo <span class="built_in">sync</span> -c</span><br><span class="line">repo forall -c <span class="string">&#x27;git lfs pull&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="https"><a href="#https" class="headerlink" title="https"></a>https</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">repo init -u https://gitee.com/openharmony/manifest.git -b refs/tags/OpenHarmony-v3.1.3-Release --no-repo-verify</span><br><span class="line">repo <span class="built_in">sync</span> -c</span><br><span class="line">repo forall -c <span class="string">&#x27;git lfs pull&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Toolchains"><a href="#Toolchains" class="headerlink" title="Toolchains"></a>Toolchains</h2><p>å¯¹äºè¿™ä¸€æ­¥ï¼Œå¦‚æœä½ æœ‰å¼€å¯<code>proxy</code>çš„è¯ï¼Œè¯·å…³é—­ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash ./build/prebuilts_download.sh</span><br></pre></td></tr></table></figure><h1 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h1><p>åœ¨ç§»æ¤ä¹‹å‰ï¼Œè¯·å…ˆç¼–è¯‘ä¸€æ¬¡åŸç‰ˆï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./build.sh --product-name rk3568 --ccache</span><br></pre></td></tr></table></figure><h1 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h1><p><a href="https://doc.embedfire.com/linux/rk356x/OpenHarmony_manual/zh/latest/doc/linux_introduce/ohos-compile.html">https://doc.embedfire.com/linux/rk356x/OpenHarmony_manual/zh/latest/doc/linux_introduce/ohos-compile.html</a></p>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openHarmony </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568 sd cardæ— æ³•æ£€æµ‹</title>
      <link href="/2024/07/31/rk3568-sd-card%E6%97%A0%E6%B3%95%E6%A3%80%E6%B5%8B-1/"/>
      <url>/2024/07/31/rk3568-sd-card%E6%97%A0%E6%B3%95%E6%A3%80%E6%B5%8B-1/</url>
      
        <content type="html"><![CDATA[<p>é…ç½®å¥½è®¾å¤‡æ ‘èŠ‚ç‚¹åæ’å…¥sdå¡æ— æ³•æ£€æµ‹ã€‚</p><p>è®¾å¤‡æ ‘èŠ‚ç‚¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&amp;sdmmc0 &#123;</span><br><span class="line">bus-width = &lt;4&gt;;</span><br><span class="line">cap-sd-highspeed;</span><br><span class="line">cd-gpios = &lt;&amp;gpio0 RK_PA4 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">disable-wp;</span><br><span class="line">pinctrl-names = &quot;default&quot;;</span><br><span class="line">pinctrl-0 = &lt;&amp;sdmmc0_bus4 &amp;sdmmc0_clk &amp;sdmmc0_cmd &amp;sdmmc0_det&gt;;</span><br><span class="line">sd-uhs-sdr104;</span><br><span class="line">vmmc-supply = &lt;&amp;vcc3v3_sd&gt;;</span><br><span class="line">vqmmc-supply = &lt;&amp;vccio_sd&gt;;</span><br><span class="line">status = &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å†…æ ¸æ—¥å¿—å‘ç°å¦‚ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dmesg | grep mmc</span><br><span class="line">[   12.226496] dwmmc_rockchip fe2b0000.mmc: Looking up vmmc-supply from device tree</span><br><span class="line">[   12.226535] dwmmc_rockchip fe2b0000.mmc: Looking up vqmmc-supply from device tree</span><br></pre></td></tr></table></figure><p><code>vmmc-supply</code>å’Œ<code>vqmmc-supply</code>ç”±<code>rk809</code>æä¾›ï¼Œ<code>rk809</code>åœ¨è¯¥æ¿å­ä¸Šè¿æ¥åˆ°äº†<code>i2c0</code>, è®¾å¤‡æ ‘å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&amp;i2c0 &#123;</span><br><span class="line">status = &quot;okay&quot;;</span><br><span class="line"></span><br><span class="line">rk809: pmic@20 &#123;</span><br><span class="line">compatible = &quot;rockchip,rk809&quot;;</span><br><span class="line">reg = &lt;0x20&gt;;</span><br><span class="line">interrupt-parent = &lt;&amp;gpio0&gt;;</span><br><span class="line">interrupts = &lt;RK_PA3 IRQ_TYPE_LEVEL_LOW&gt;;</span><br><span class="line">assigned-clocks = &lt;&amp;cru I2S1_MCLKOUT_TX&gt;;</span><br><span class="line">assigned-clock-parents = &lt;&amp;cru CLK_I2S1_8CH_TX&gt;;</span><br><span class="line">#clock-cells = &lt;1&gt;;</span><br><span class="line">clock-names = &quot;mclk&quot;;</span><br><span class="line">clocks = &lt;&amp;cru I2S1_MCLKOUT_TX&gt;;</span><br><span class="line">pinctrl-names = &quot;default&quot;;</span><br><span class="line">pinctrl-0 = &lt;&amp;pmic_int&gt;;</span><br><span class="line">rockchip,system-power-controller;</span><br><span class="line">#sound-dai-cells = &lt;0&gt;;</span><br><span class="line">vcc1-supply = &lt;&amp;vcc3v3_sys&gt;;</span><br><span class="line">vcc2-supply = &lt;&amp;vcc3v3_sys&gt;;</span><br><span class="line">vcc3-supply = &lt;&amp;vcc3v3_sys&gt;;</span><br><span class="line">vcc4-supply = &lt;&amp;vcc3v3_sys&gt;;</span><br><span class="line">vcc5-supply = &lt;&amp;vcc3v3_sys&gt;;</span><br><span class="line">vcc6-supply = &lt;&amp;vcc3v3_sys&gt;;</span><br><span class="line">vcc7-supply = &lt;&amp;vcc3v3_sys&gt;;</span><br><span class="line">vcc8-supply = &lt;&amp;vcc3v3_sys&gt;;</span><br><span class="line">vcc9-supply = &lt;&amp;vcc3v3_sys&gt;;</span><br><span class="line">wakeup-source;</span><br><span class="line"></span><br><span class="line">regulators &#123;</span><br><span class="line">vdd_logic: DCDC_REG1 &#123;</span><br><span class="line">regulator-name = &quot;vdd_logic&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;500000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;1350000&gt;;</span><br><span class="line">regulator-ramp-delay = &lt;6001&gt;;</span><br><span class="line">regulator-initial-mode = &lt;0x2&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vdd_gpu: DCDC_REG2 &#123;</span><br><span class="line">regulator-name = &quot;vdd_gpu&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;500000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;1350000&gt;;</span><br><span class="line">regulator-ramp-delay = &lt;6001&gt;;</span><br><span class="line">regulator-initial-mode = &lt;0x2&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vcc_ddr: DCDC_REG3 &#123;</span><br><span class="line">regulator-name = &quot;vcc_ddr&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-initial-mode = &lt;0x2&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-on-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vdd_npu: DCDC_REG4 &#123;</span><br><span class="line">regulator-name = &quot;vdd_npu&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;500000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;1350000&gt;;</span><br><span class="line">regulator-ramp-delay = &lt;6001&gt;;</span><br><span class="line">regulator-initial-mode = &lt;0x2&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vcc_1v8: DCDC_REG5 &#123;</span><br><span class="line">regulator-name = &quot;vcc_1v8&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;1800000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;1800000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vdda0v9_image: LDO_REG1 &#123;</span><br><span class="line">regulator-name = &quot;vdda0v9_image&quot;;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-min-microvolt = &lt;900000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;900000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vdda_0v9: LDO_REG2 &#123;</span><br><span class="line">regulator-name = &quot;vdda_0v9&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;900000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;900000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vdda0v9_pmu: LDO_REG3 &#123;</span><br><span class="line">regulator-name = &quot;vdda0v9_pmu&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;900000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;900000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-on-in-suspend;</span><br><span class="line">regulator-suspend-microvolt = &lt;900000&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vccio_acodec: LDO_REG4 &#123;</span><br><span class="line">regulator-name = &quot;vccio_acodec&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;3300000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;3300000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vccio_sd: LDO_REG5 &#123;</span><br><span class="line">regulator-name = &quot;vccio_sd&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;1800000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;3300000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vcc3v3_pmu: LDO_REG6 &#123;</span><br><span class="line">regulator-name = &quot;vcc3v3_pmu&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;3300000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;3300000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-on-in-suspend;</span><br><span class="line">regulator-suspend-microvolt = &lt;3300000&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vcca_1v8: LDO_REG7 &#123;</span><br><span class="line">regulator-name = &quot;vcca_1v8&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;1800000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;1800000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vcca1v8_pmu: LDO_REG8 &#123;</span><br><span class="line">regulator-name = &quot;vcca1v8_pmu&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;1800000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;1800000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-on-in-suspend;</span><br><span class="line">regulator-suspend-microvolt = &lt;1800000&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vcca1v8_image: LDO_REG9 &#123;</span><br><span class="line">regulator-name = &quot;vcca1v8_image&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line">regulator-min-microvolt = &lt;1800000&gt;;</span><br><span class="line">regulator-max-microvolt = &lt;1800000&gt;;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vcc_3v3: SWITCH_REG1 &#123;</span><br><span class="line">regulator-name = &quot;vcc_3v3&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vcc3v3_sd: SWITCH_REG2 &#123;</span><br><span class="line">regulator-name = &quot;vcc3v3_sd&quot;;</span><br><span class="line">regulator-always-on;</span><br><span class="line">regulator-boot-on;</span><br><span class="line"></span><br><span class="line">regulator-state-mem &#123;</span><br><span class="line">regulator-off-in-suspend;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾<code>rk809</code>å¯¹åº”çš„<code>compatible</code>cæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ find -name <span class="string">&quot;*.c&quot;</span> -<span class="built_in">exec</span> grep -nR <span class="string">&quot;rockchip,rk809&quot;</span> &#123;&#125; +</span><br><span class="line"></span><br><span class="line">./drivers/mfd/rk8xx-i2c.c:163:&#123; .compatible = <span class="string">&quot;rockchip,rk809&quot;</span>, .data = &amp;rk809_data &#125;,</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¯¥ç›®å½•ä¸‹çš„<code>Makefile</code>æ‰¾åˆ°å¯¹åº”é…ç½®é€‰é¡¹ï¼š</p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">  1 obj-<span class="variable">$(CONFIG_MFD_RK8XX)</span>         += rk8xx-core.o</span><br><span class="line">225 obj-<span class="variable">$(CONFIG_MFD_RK8XX_I2C)</span>     += rk8xx-i2c.o</span><br></pre></td></tr></table></figure><p><code>menuconfig</code>å¼€å¯ä»¥ä¸‹é€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CONFIG_MFD_RK8XX</span><br><span class="line">CONFIG_MFD_RK8XX_I2C</span><br></pre></td></tr></table></figure><p>é‡æ–°ç¼–è¯‘å†…æ ¸å‘ç°è¿˜æ˜¯æ— æ³•æ£€æµ‹åˆ°ï¼Œç»è¿‡æŸ¥è¯¢å‘ç°<code>RK809</code>è¿˜æœ‰å…¶ä»–é€‰é¡¹å¯ä»¥æ‰“å¼€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CONFIG_RTC_RK808</span><br><span class="line">CONFIG_PINCTRL_RK805</span><br><span class="line">CONFIG_REGULATOR_RK808</span><br><span class="line">CONFIG_INPUT_RK805_PWRKEY</span><br><span class="line">CONFIG_COMMON_CLK_RK808</span><br></pre></td></tr></table></figure><p>ç»è¿‡å¯ç”¨<code>CONFIG_REGULATOR_RK808</code>é€‰é¡¹åï¼Œå¯ä»¥æ­£å¸¸æ£€æµ‹å¹¶æŒ‚è½½ã€‚</p><p>æ²¡æœ‰æµ‹è¯•<code>CONFIG_REGULATOR_RK808</code>æ˜¯å¦ä¾èµ–äºå…¶ä»–å‡ ä¸ªé€‰é¡¹ï¼Œç›´æ¥å…¨éƒ¨å¼€å¯äº†ã€‚</p><p>ref: <a href="https://blog.csdn.net/weixin_49303682/article/details/138390797">https://blog.csdn.net/weixin_49303682/article/details/138390797</a></p>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vimè®¾ç½®80åˆ—è‡ªåŠ¨æ¢è¡Œ</title>
      <link href="/2024/07/30/vim%E8%AE%BE%E7%BD%AE80%E8%A1%8C%E8%87%AA%E5%8A%A8%E6%8D%A2%E8%A1%8C/"/>
      <url>/2024/07/30/vim%E8%AE%BE%E7%BD%AE80%E8%A1%8C%E8%87%AA%E5%8A%A8%E6%8D%A2%E8%A1%8C/</url>
      
        <content type="html"><![CDATA[<p>ç”±äºå¹³å¸¸æ–‡ä»¶ç¼–è¾‘å¹¶ä¸éœ€è¦è¯¥è®¾ç½®ï¼Œä½†æ˜¯commitçš„æ—¶å€™éœ€è¦ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> tw=80</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rk3568åˆ·å†™openharmony3.2</title>
      <link href="/2024/07/25/rk3568%E5%88%B7%E5%86%99openharmony3-2/"/>
      <url>/2024/07/25/rk3568%E5%88%B7%E5%86%99openharmony3-2/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> upgrade_tool di -p parameter.txt</span><br><span class="line"><span class="built_in">sudo</span> upgrade_tool UL MiniLoaderAll.bin -noreset</span><br><span class="line"><span class="built_in">sudo</span> upgrade_tool di -u uboot.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -boot_linux boot_linux.img&amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -system system.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -vendor vendor.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -userdata userdata.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -ramdisk ramdisk.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -resource resource.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -sys-prod sys_prod.img &amp;&amp; <span class="built_in">sudo</span> upgrade_tool di -chip-prod chip_prod.img</span><br><span class="line"><span class="built_in">sudo</span> upgrade_tool rd</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
          <category> rockchip </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> openHarmony </tag>
            
            <tag> kernel </tag>
            
            <tag> rk3568 </tag>
            
            <tag> rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu22.04å¤šå±é—ªçƒé—®é¢˜</title>
      <link href="/2024/07/24/Ubuntu22-04%E5%A4%9A%E5%B1%8F%E9%97%AA%E7%83%81%E9%97%AE%E9%A2%98/"/>
      <url>/2024/07/24/Ubuntu22-04%E5%A4%9A%E5%B1%8F%E9%97%AA%E7%83%81%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>å½“ç”µè„‘è¿æ¥å¤šä¸ªæ˜¾ç¤ºå±æ—¶ï¼Œåªè¦åœ¨å‰¯å±æ‰“å­—ä¸”å…‰æ ‡æ²¡æœ‰æ‚¬æµ®åœ¨ä¸»å±å¹•ï¼Œä¸»å±å¹•å°±ä¼šç™½å±é—ªçƒã€‚</p><p>åç»­å‘ç°åªæœ‰åœ¨ç»ˆç«¯å’Œæ–‡ä»¶å¤¹å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œæƒ³åˆ°å®‰è£…äº†<code>Blur my shell</code>è¿™ä¸ªextensionï¼Œå¹¶ä¸”æŒ‡å®šäº†è¿™ä¸¤ä¸ªappä¸ºæ¨¡ç³Šï¼Œåœ¨è¿™ä¸ªextensioné‡Œé¢åˆ æ‰è¿™ä¸¤ä¸ªappçš„é…ç½®å³å¯è§£å†³ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>i2c-adpater-mainline for k1 of spacemit</title>
      <link href="/2024/07/17/i2c-adpater-mainline-for-k1-of-spacemit/"/>
      <url>/2024/07/17/i2c-adpater-mainline-for-k1-of-spacemit/</url>
      
        <content type="html"><![CDATA[<h2 id="åˆæ­¥å®Œå–„æ¡†æ¶"><a href="#åˆæ­¥å®Œå–„æ¡†æ¶" class="headerlink" title="åˆæ­¥å®Œå–„æ¡†æ¶"></a>åˆæ­¥å®Œå–„æ¡†æ¶</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mod_devicetable.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/clk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;i2c-k1x.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">spacemit_k1_i2c_xfer</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adapt, <span class="keyword">struct</span> i2c_msg msgs[], <span class="type">int</span> num)</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spacemit_k1_i2c</span> *<span class="title">i2c</span> =</span> i2c_get_adapdata(adapt);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> u32 <span class="title function_">spacemit_k1_i2c_functionality</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> I2C_FUNC_I2C | (I2C_FUNC_SMBUS_EMUL &amp; ~I2C_FUNC_SMBUS_QUICK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_algorithm</span> <span class="title">spacemit_k1_i2c_algrtm</span> =</span> &#123;</span><br><span class="line">.master_xfer= spacemit_k1_i2c_xfer,</span><br><span class="line">.functionality= spacemit_k1_i2c_functionality,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spacemit_k1_i2c_parse_dt</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev,</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> spacemit_k1_i2c *i2c)</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">dnode</span> =</span> pdev-&gt;dev.of_node;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">ret = of_property_read_u32(dnode, <span class="string">&quot;spacemit,adapter-id&quot;</span>, &amp;pdev-&gt;id);</span><br><span class="line"><span class="keyword">if</span>(ret)</span><br><span class="line">pdev-&gt;id = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spacemit_k1_i2c_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spacemit_k1_i2c</span> *<span class="title">i2c</span>;</span></span><br><span class="line"><span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">i2c = devm_kzalloc(&amp;pdev-&gt;dev,</span><br><span class="line"><span class="keyword">sizeof</span>(<span class="keyword">struct</span> spacemit_k1_i2c),</span><br><span class="line">GFP_KERNEL);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!i2c) &#123;</span><br><span class="line">ret = -ENOMEM;</span><br><span class="line"><span class="keyword">goto</span> err_ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">i2c-&gt;dev = &amp;pdev-&gt;dev;</span><br><span class="line">platform_set_drvdata(pdev, i2c);</span><br><span class="line"></span><br><span class="line">ret = spacemit_k1_i2c_parse_dt(pdev, i2c);</span><br><span class="line"><span class="keyword">if</span>(ret)</span><br><span class="line"><span class="keyword">goto</span> err_ret;</span><br><span class="line"></span><br><span class="line">pr_info(<span class="string">&quot;spacemit_k1_i2c_probe function: pdev-&gt;id %d\n&quot;</span>, pdev-&gt;id);</span><br><span class="line"></span><br><span class="line">i2c-&gt;adap.owner = THIS_MODULE;</span><br><span class="line">i2c-&gt;adap.algo = &amp;spacemit_k1_i2c_algrtm;</span><br><span class="line">i2c-&gt;adap.algo_data = i2c;</span><br><span class="line">i2c-&gt;adap.nr = pdev-&gt;id;</span><br><span class="line">i2c-&gt;adap.dev.parent = &amp;pdev-&gt;dev;</span><br><span class="line">i2c-&gt;adap.dev.of_node = pdev-&gt;dev.of_node;</span><br><span class="line">i2c-&gt;adap.retries= <span class="number">3</span>;</span><br><span class="line">strscpy(i2c-&gt;adap.name, <span class="string">&quot;spacemit-i2c-adapter&quot;</span>,</span><br><span class="line"><span class="keyword">sizeof</span>(i2c-&gt;adap.name));</span><br><span class="line">ret = i2c_add_numbered_adapter(&amp;i2c-&gt;adap);</span><br><span class="line"><span class="keyword">if</span>(ret) &#123;</span><br><span class="line">dev_err(i2c-&gt;dev, <span class="string">&quot;failed to add i2c adapter\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> err_ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err_ret:</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spacemit_k1_i2c_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spacemit_k1_i2c</span> *<span class="title">i2c</span>;</span></span><br><span class="line"></span><br><span class="line">pr_info(<span class="string">&quot;spacemit_k1_i2c_remove\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">i2c = platform_get_drvdata(pdev);</span><br><span class="line"></span><br><span class="line">i2c_del_adapter(&amp;i2c-&gt;adap);</span><br><span class="line"></span><br><span class="line">dev_dbg(i2c-&gt;dev, <span class="string">&quot;driver removed\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">spacemit_k1_i2c_dt_match</span>[] =</span> &#123;</span><br><span class="line">&#123;</span><br><span class="line">.compatible = <span class="string">&quot;spacemit,k1x-i2c&quot;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MODULE_DEVICE_TABLE(of, spacemit_k1_i2c_dt_match);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">spacemit_k1_i2c_driver</span> =</span> &#123;</span><br><span class="line">.probe  = spacemit_k1_i2c_probe,</span><br><span class="line">.remove = spacemit_k1_i2c_remove,</span><br><span class="line">.driver = &#123;</span><br><span class="line">.name= <span class="string">&quot;i2c-spacemit-k1x&quot;</span>,</span><br><span class="line">.of_match_table= spacemit_k1_i2c_dt_match,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module_platform_driver(spacemit_k1_i2c_driver);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL v2&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;i2c driver for Spacemit k1 soc&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€‰æ‹©<code>module_platform_driver</code>è€Œä¸æ˜¯åƒ<code>vendor</code>ç‰ˆæœ¬çš„å†™æ³•æ˜¯å› ä¸ºæˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦æ³¨å†Œé‡å¯<code>hook</code>ã€‚</p><p>k1å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">spacemit_i2c_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">register_restart_handler(&amp;spacemit_i2c_sys_nb);</span><br><span class="line"><span class="keyword">return</span> platform_driver_register(&amp;spacemit_i2c_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">spacemit_i2c_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">platform_driver_unregister(&amp;spacemit_i2c_driver);</span><br><span class="line">unregister_restart_handler(&amp;spacemit_i2c_sys_nb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">subsys_initcall(spacemit_i2c_init);</span><br><span class="line">module_exit(spacemit_i2c_exit);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tmux</title>
      <link href="/2024/07/09/tmux/"/>
      <url>/2024/07/09/tmux/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¼šè¯ç®¡ç†"><a href="#ä¼šè¯ç®¡ç†" class="headerlink" title="ä¼šè¯ç®¡ç†"></a>ä¼šè¯ç®¡ç†</h2><h3 id="è¿›å…¥"><a href="#è¿›å…¥" class="headerlink" title="è¿›å…¥"></a>è¿›å…¥</h3><ul><li><p><code>tmux</code>å‘½ä»¤å¯ä»¥ç›´æ¥è¿›å…¥ä¸€ä¸ª<code>session</code></p></li><li><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>session-name</code>çš„ä¼šè¯ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tmux new -s &lt;session-name&gt;</span><br></pre></td></tr></table></figure><ul><li>è¿›å…¥ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ä¼šè¯<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ä¼šè¯ç¼–å·</span></span><br><span class="line">$ tmux attach -t 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ä¼šè¯åç§°</span></span><br><span class="line">$ tmux attach -t &lt;session-name&gt;</span><br></pre></td></tr></table></figure></li></ul><h3 id="é€€å‡º"><a href="#é€€å‡º" class="headerlink" title="é€€å‡º"></a>é€€å‡º</h3><ul><li><code>ctrl + d</code>å¯ä»¥ç›´æ¥é€€å‡º</li><li><code>ctrl + b</code>åæŒ‰<code>d</code>å¯ä»¥åå°è¿è¡Œè¯¥ä¼šè¯ï¼Œä½¿ç”¨<code>attach</code>è¿›å…¥</li></ul><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><ul><li><code>tmux ls</code> æˆ–<code>ctrl +b s</code>åˆ—å‡ºæ‰€æœ‰ä¼šè¯</li><li><code>tmux kill-session -t</code>é”€æ¯æŸä¸ªä¼šè¯</li><li><code>tmux rename-session</code>æˆ–<code>ctrl+b $</code>é‡å‘½åæŸä¸ªä¼šè¯</li></ul><h2 id="çª—æ ¼ç®¡ç†"><a href="#çª—æ ¼ç®¡ç†" class="headerlink" title="çª—æ ¼ç®¡ç†"></a>çª—æ ¼ç®¡ç†</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Ctrl+b %ï¼šåˆ’åˆ†å·¦å³ä¸¤ä¸ªçª—æ ¼ã€‚</span><br><span class="line">Ctrl+b <span class="string">&quot;ï¼šåˆ’åˆ†ä¸Šä¸‹ä¸¤ä¸ªçª—æ ¼ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b &lt;arrow key&gt;ï¼šå…‰æ ‡åˆ‡æ¢åˆ°å…¶ä»–çª—æ ¼ã€‚&lt;arrow key&gt;æ˜¯æŒ‡å‘è¦åˆ‡æ¢åˆ°çš„çª—æ ¼çš„æ–¹å‘é”®ï¼Œæ¯”å¦‚åˆ‡æ¢åˆ°ä¸‹æ–¹çª—æ ¼ï¼Œå°±æŒ‰æ–¹å‘é”®â†“ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b ;ï¼šå…‰æ ‡åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªçª—æ ¼ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b oï¼šå…‰æ ‡åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçª—æ ¼ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b &#123;ï¼šå½“å‰çª—æ ¼ä¸ä¸Šä¸€ä¸ªçª—æ ¼äº¤æ¢ä½ç½®ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b &#125;ï¼šå½“å‰çª—æ ¼ä¸ä¸‹ä¸€ä¸ªçª—æ ¼äº¤æ¢ä½ç½®ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b Ctrl+oï¼šæ‰€æœ‰çª—æ ¼å‘å‰ç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œç¬¬ä¸€ä¸ªçª—æ ¼å˜æˆæœ€åä¸€ä¸ªçª—æ ¼ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b Alt+oï¼šæ‰€æœ‰çª—æ ¼å‘åç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œæœ€åä¸€ä¸ªçª—æ ¼å˜æˆç¬¬ä¸€ä¸ªçª—æ ¼ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b xï¼šå…³é—­å½“å‰çª—æ ¼ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b !ï¼šå°†å½“å‰çª—æ ¼æ‹†åˆ†ä¸ºä¸€ä¸ªç‹¬ç«‹çª—å£ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b zï¼šå½“å‰çª—æ ¼å…¨å±æ˜¾ç¤ºï¼Œå†ä½¿ç”¨ä¸€æ¬¡ä¼šå˜å›åŸæ¥å¤§å°ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b Ctrl+&lt;arrow key&gt;ï¼šæŒ‰ç®­å¤´æ–¹å‘è°ƒæ•´çª—æ ¼å¤§å°ã€‚</span></span><br><span class="line"><span class="string">Ctrl+b qï¼šæ˜¾ç¤ºçª—æ ¼ç¼–å·ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å¯é¼ æ ‡æ§åˆ¶çª—æ ¼"><a href="#å¼€å¯é¼ æ ‡æ§åˆ¶çª—æ ¼" class="headerlink" title="å¼€å¯é¼ æ ‡æ§åˆ¶çª—æ ¼"></a>å¼€å¯é¼ æ ‡æ§åˆ¶çª—æ ¼</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;set -g mouse on&#x27;</span>&gt;&gt; ~/.tmux.conf</span><br><span class="line">$ tmux source-file ~/.tmux.conf</span><br></pre></td></tr></table></figure><h2 id="çª—å£ç®¡ç†"><a href="#çª—å£ç®¡ç†" class="headerlink" title="çª—å£ç®¡ç†"></a>çª—å£ç®¡ç†</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Ctrl+b cï¼šåˆ›å»ºä¸€ä¸ªæ–°çª—å£ï¼ŒçŠ¶æ€æ ä¼šæ˜¾ç¤ºå¤šä¸ªçª—å£çš„ä¿¡æ¯ã€‚</span><br><span class="line">Ctrl+b pï¼šåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªçª—å£ï¼ˆæŒ‰ç…§çŠ¶æ€æ ä¸Šçš„é¡ºåºï¼‰ã€‚</span><br><span class="line">Ctrl+b nï¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçª—å£ã€‚</span><br><span class="line">Ctrl+b &lt;number&gt;ï¼šåˆ‡æ¢åˆ°æŒ‡å®šç¼–å·çš„çª—å£ï¼Œå…¶ä¸­çš„&lt;number&gt;æ˜¯çŠ¶æ€æ ä¸Šçš„çª—å£ç¼–å·ã€‚</span><br><span class="line">Ctrl+b wï¼šä»åˆ—è¡¨ä¸­é€‰æ‹©çª—å£ã€‚</span><br><span class="line">Ctrl+b ,ï¼šçª—å£é‡å‘½åã€‚</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…è”æ±‡ç¼–</title>
      <link href="/2024/07/05/%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96/"/>
      <url>/2024/07/05/%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96/</url>
      
        <content type="html"><![CDATA[<p>åœ¨cè¯­è¨€ä¸­ä½¿ç”¨æ±‡ç¼–ä»£ç ï¼Œä¸ºäº†å®ç°æ›´é«˜æ•ˆç‡æˆ–æ‰§è¡Œç‰¹å®šæ±‡ç¼–æŒ‡ä»¤ã€‚</p><h2 id="è¯­æ³•æ ¼å¼"><a href="#è¯­æ³•æ ¼å¼" class="headerlink" title="è¯­æ³•æ ¼å¼"></a>è¯­æ³•æ ¼å¼</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;assembly code&quot;</span></span></span><br><span class="line"><span class="params">             : output operands               <span class="comment">/* å¯é€‰ */</span></span></span><br><span class="line"><span class="params">             : input operands                <span class="comment">/* å¯é€‰ */</span></span></span><br><span class="line"><span class="params">             : <span class="built_in">list</span> of clobbered registers   <span class="comment">/* å¯é€‰ */</span></span></span><br><span class="line"><span class="params">            )</span>;</span><br></pre></td></tr></table></figure><ol><li><p>asmå’Œvolatile</p><ul><li>asm æ˜¯å†…è”æ±‡ç¼–çš„å…³é”®å­—ã€‚</li><li>volatile å…³é”®å­—å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦ä¼˜åŒ–è¿™æ®µæ±‡ç¼–ä»£ç ã€‚</li></ul></li><li><p>è¾“å‡ºæ“ä½œæ•°</p><pre><code> æ ¼å¼ä¸º :[constraints](C variable) constraints æ˜¯çº¦æŸå­—ç¬¦ä¸²ï¼Œå®šä¹‰äº†è¾“å‡ºæ“ä½œæ•°çš„ç±»å‹å’Œä½ç½®ã€‚(C variable)æ˜¯ C å˜é‡ï¼Œç”¨äºå­˜å‚¨æ±‡ç¼–ä»£ç çš„è¾“å‡ºã€‚</code></pre></li><li><p>è¾“å…¥æ“ä½œæ•°<br>åŒè¾“å‡ºæ“ä½œæ•°</p></li><li><p>åˆ—è¡¨çš„æŸåå¯„å­˜å™¨<br>è¿™æ˜¯ä¸€ä¸ªå¯é€‰éƒ¨åˆ†ï¼Œåˆ—å‡ºäº†åœ¨æ±‡ç¼–ä»£ç ä¸­è¢«ä¿®æ”¹çš„å¯„å­˜å™¨ï¼Œå‘ŠçŸ¥ç¼–è¯‘å™¨è¿™äº›å¯„å­˜å™¨åœ¨æ±‡ç¼–ä»£ç åå¯èƒ½åŒ…å«ä¸åŒçš„å€¼ã€‚</p></li></ol><p><code>e.g.</code> :</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;mv %0, %1&quot;</span> : <span class="string">&quot;=r&quot;</span>(b) : <span class="string">&quot;r&quot;</span>(a))</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b = %d\n&quot;</span>, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­å°†<code>a</code>çš„å€¼èµ‹å€¼ç»™<code>b</code>å¹¶ä¸”æ‰“å°è¾“å‡ºäº†<code>b</code>çš„å€¼ã€‚</p><h2 id="constraints-çº¦æŸå­—ç¬¦ä¸²"><a href="#constraints-çº¦æŸå­—ç¬¦ä¸²" class="headerlink" title="constraints çº¦æŸå­—ç¬¦ä¸²"></a>constraints çº¦æŸå­—ç¬¦ä¸²</h2><p>çº¦æŸå­—ç¬¦ä¸çº¦æŸå­—ç¬¦ä¸å¯ä»¥è¿ç”¨ï¼Œä½†çº¦æŸå­—ç¬¦å’Œçº¦æŸä¿®é¥°ç¬¦å¯ä»¥è¿ç”¨ã€‚</p><h3 id="çº¦æŸå­—ç¬¦"><a href="#çº¦æŸå­—ç¬¦" class="headerlink" title="çº¦æŸå­—ç¬¦"></a>çº¦æŸå­—ç¬¦</h3><ul><li><code>r</code>è¡¨æ˜é€šç”¨å¯„å­˜å™¨ï¼Œç¼–è¯‘å™¨å¯ä»¥é€‰æ‹©ä»»æ„ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨æ¥å­˜å‚¨æ“ä½œæ•°ã€‚</li><li><code>m</code>è¡¨ç¤ºå†…å­˜åœ°å€ï¼Œæ“ä½œæ•°å¿…é¡»æ˜¯å†…å­˜ä½ç½®ã€‚</li><li><code>i</code>è¡¨ç¤ºç«‹å³æ•°ï¼Œæ“ä½œæ•°å¿…é¡»æ˜¯ç«‹å³æ•°ã€‚</li></ul><h3 id="çº¦æŸä¿®é¥°ç¬¦"><a href="#çº¦æŸä¿®é¥°ç¬¦" class="headerlink" title="çº¦æŸä¿®é¥°ç¬¦"></a>çº¦æŸä¿®é¥°ç¬¦</h3><ul><li><code>=</code>è¡¨ç¤ºè¾“å‡ºæ“ä½œæ•°ï¼Œæ‰€æ“ä½œçš„æ“ä½œæ•°å¯å†™ã€‚</li><li><code>+</code>è¡¨ç¤ºå¯è¯»å¯å†™ï¼Œæ‰€æ“ä½œçš„æ“ä½œæ•°å¯è¯»å¯å†™ã€‚</li><li><code>&amp;</code>è¯¥æ“ä½œæ•°è¦ç‹¬å ç›¸åº”çš„å¯„å­˜å™¨ï¼Œä¸è¦å†å°†å…¶åˆ†é…ç»™åˆ«äººã€‚</li></ul><h3 id="åŒ¹é…çº¦æŸ"><a href="#åŒ¹é…çº¦æŸ" class="headerlink" title="åŒ¹é…çº¦æŸ"></a>åŒ¹é…çº¦æŸ</h3><p>åŒ¹é…çº¦æŸä½¿ç”¨æ•°å­—æ¥è¡¨ç¤ºæ“ä½œæ•°ä¸å¦ä¸€ä¸ªæ“ä½œæ•°ç›¸åŒï¼Œä½¿ç”¨è¿™ä¸ªçº¦æŸæ—¶ï¼Œä¸¤ä¸ªæ“ä½œæ•°å°†ä½¿ç”¨ç›¸åŒçš„å¯„å­˜å™¨æˆ–å†…å­˜åœ°å€ã€‚</p><p><code>e.g.</code>ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mv %0, %1&quot;</span> : <span class="string">&quot;=r&quot;</span>(a) : <span class="string">&quot;0&quot;</span>(b))</span>;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œè¡¨ç¤º<code>a</code>å’Œ<code>b</code>ä½¿ç”¨ç›¸åŒçš„å¯„å­˜å™¨ã€‚</p><h2 id="ç¬¦å·å"><a href="#ç¬¦å·å" class="headerlink" title="ç¬¦å·å"></a>ç¬¦å·å</h2><p>åœ¨å†…è”æ±‡ç¼–ä¸­ï¼Œå¯ä»¥ä½¿ç”¨åˆ«åï¼ˆä¹Ÿç§°ä¸ºç¬¦å·åï¼‰æ¥æé«˜ä»£ç çš„å¯è¯»æ€§ã€‚åˆ«åå…è®¸ä½ ä¸ºæ“ä½œæ•°æŒ‡å®šä¸€ä¸ªæ›´å…·æè¿°æ€§çš„åç§°ï¼Œè€Œä¸æ˜¯ä¾èµ–æ•°å­—å ä½ç¬¦ï¼ˆå¦‚ %0ã€%1 ç­‰ï¼‰ã€‚</p><p>æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="string">&quot;assembly code with %(alias)s&quot;</span></span></span><br><span class="line"><span class="params">    : [alias1] <span class="string">&quot;constraint&quot;</span> (variable1)</span></span><br><span class="line"><span class="params">    , [alias2] <span class="string">&quot;constraint&quot;</span> (variable2)</span></span><br><span class="line"><span class="params">    : [alias3] <span class="string">&quot;constraint&quot;</span> (variable3)</span></span><br><span class="line"><span class="params">    , [alias4] <span class="string">&quot;constraint&quot;</span> (variable4)</span></span><br><span class="line"><span class="params">    : <span class="string">&quot;clobbered registers&quot;</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨æ—¶ï¼Œ<code>%(ç¬¦å·å)</code>æ¥è¿›è¡Œè°ƒç”¨ã€‚</p><p><code>e.g.</code>ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mv %(a), %(b)&quot;</span> : [a]<span class="string">&quot;=r&quot;</span>(a) : [b]<span class="string">&quot;0&quot;</span>(b))</span>;</span><br></pre></td></tr></table></figure><h2 id="list-of-clobbered-registers"><a href="#list-of-clobbered-registers" class="headerlink" title="list of clobbered registers"></a>list of clobbered registers</h2><p>åœ¨ GCC å†…è”æ±‡ç¼–ä¸­ï¼Œ<code>clobbered registers</code> åˆ—è¡¨ç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨åœ¨æ‰§è¡Œå†…è”æ±‡ç¼–ä»£ç æ—¶ä¼šä¿®æ”¹å“ªäº›å¯„å­˜å™¨ã€‚ç¼–è¯‘å™¨ä¼šç¡®ä¿è¿™äº›å¯„å­˜å™¨çš„å€¼åœ¨æ±‡ç¼–ä»£ç æ‰§è¡Œå‰è¢«ä¿å­˜ï¼Œå¹¶åœ¨æ±‡ç¼–ä»£ç æ‰§è¡Œåæ¢å¤ã€‚è¿™å¯¹äºé¿å…æ„å¤–çš„å¯„å­˜å™¨å€¼å˜åŒ–å’Œæ½œåœ¨çš„é”™è¯¯éå¸¸é‡è¦ã€‚</p><p><code>e.g.</code>ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">5</span>, b = <span class="number">10</span>, result;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;add %0, %1, %2\n\t&quot;</span></span></span><br><span class="line"><span class="params">        : <span class="string">&quot;=r&quot;</span> (result)          <span class="comment">// è¾“å‡ºæ“ä½œæ•°</span></span></span><br><span class="line"><span class="params">        : <span class="string">&quot;r&quot;</span> (a), <span class="string">&quot;r&quot;</span> (b)       <span class="comment">// è¾“å…¥æ“ä½œæ•°</span></span></span><br><span class="line"><span class="params">        : <span class="string">&quot;t0&quot;</span>                   <span class="comment">// clobbered å¯„å­˜å™¨</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;result = %d\n&quot;</span>, result);  <span class="comment">// è¾“å‡º result = 15</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç å½“ä¸­ï¼Œé˜²æ­¢t0è¢«ä¿®æ”¹ï¼ˆå®é™…æ ¹æœ¬ä¸ä¼šè¢«ä¿®æ”¹ï¼‰ï¼Œå†™å…¥äº†<code>clobbered</code>å¯„å­˜å™¨å½“ä¸­ï¼Œåœ¨æ‰§è¡Œå®Œæ±‡ç¼–ä»£ç ä¹‹å‰ï¼Œä¼šä¿å­˜<code>t0</code>å¯„å­˜å™¨ï¼Œæ‰§è¡Œä¹‹åï¼Œä¼šæ¢å¤<code>t0</code>å¯„å­˜å™¨ã€‚</p><h3 id="memory"><a href="#memory" class="headerlink" title="memory"></a>memory</h3><p>å¦‚æœä½ åœ¨<code>clobbered</code>åŠ å…¥<code>memory</code>è¿™ä¸ªç‰¹æ®Šçš„æè¿°ç¬¦ï¼Œç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œæ±‡ç¼–ä»£ç ä¼šå¯¹å†…å­˜è¿›è¡Œè¯»å†™æ“ä½œï¼Œå¯èƒ½ä¼šå½±å“åˆ°å†…å­˜ä¸­çš„ä»»ä½•æ•°æ®ã€‚è¿™ä¼šè®©ç¼–è¯‘å™¨çŸ¥é“ï¼Œå®ƒä¸èƒ½ä¾èµ–äºå¯„å­˜å™¨ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸”éœ€è¦åœ¨æ±‡ç¼–ä»£ç æ‰§è¡Œå‰å°†æ‰€æœ‰å˜é‡å€¼åˆ·æ–°åˆ°å†…å­˜ä¸­ï¼Œä»¥åŠåœ¨æ±‡ç¼–ä»£ç æ‰§è¡Œåé‡æ–°åŠ è½½è¿™äº›å˜é‡å€¼ã€‚</p><p>å½“ä½ ä½¿ç”¨ <code>memory</code> ä½œä¸º <code>clobbered</code> æè¿°ç¬¦æ—¶ï¼Œä½ å‘Šè¯‰ç¼–è¯‘å™¨ä»¥ä¸‹å‡ ç‚¹ï¼š</p><p>è¾“å…¥æ“ä½œæ•°å’Œè¾“å‡ºæ“ä½œæ•°ï¼šç¼–è¯‘å™¨ä¼šç¡®ä¿åœ¨æ‰§è¡Œæ±‡ç¼–ä»£ç ä¹‹å‰ï¼Œå°†æ‰€æœ‰è¾“å…¥æ“ä½œæ•°çš„å€¼åˆ·æ–°åˆ°å†…å­˜ä¸­ï¼Œå¹¶åœ¨æ‰§è¡Œæ±‡ç¼–ä»£ç åï¼Œä»å†…å­˜ä¸­é‡æ–°åŠ è½½æ‰€æœ‰è¾“å‡ºæ“ä½œæ•°çš„å€¼ã€‚<br>é˜²æ­¢ä¼˜åŒ–ï¼šç¼–è¯‘å™¨ä¸ä¼šå¯¹æ¶‰åŠå†…å­˜çš„æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œå› ä¸ºå®ƒä¸èƒ½ç¡®å®šå†…è”æ±‡ç¼–ä»£ç å…·ä½“ä¿®æ”¹äº†å“ªäº›å†…å­˜åœ°å€ã€‚è¿™æœ‰åŠ©äºé˜²æ­¢æ½œåœ¨çš„ä¼˜åŒ–é—®é¢˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> asm </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>earlycon</title>
      <link href="/2024/07/03/earlycon/"/>
      <url>/2024/07/03/earlycon/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p><code>earlycon</code> æ˜¯ä¸€ä¸ªæ—©æœŸæ§åˆ¶å°ï¼ˆearly consoleï¼‰æœºåˆ¶ï¼Œç”¨äºåœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—©æœŸé˜¶æ®µæä¾›è¾“å‡ºåŠŸèƒ½ã€‚åœ¨å†…æ ¸å¯åŠ¨è¿‡ç¨‹çš„æ—©æœŸé˜¶æ®µï¼Œæ ‡å‡†çš„æ§åˆ¶å°è®¾å¤‡ï¼ˆå¦‚ä¸²å£ã€VGAæ§åˆ¶å°ç­‰ï¼‰å¯èƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ <code>earlycon</code> æ¥è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œå¸®åŠ©å¼€å‘è€…è°ƒè¯•å†…æ ¸å¯åŠ¨è¿‡ç¨‹ä¸­çš„é—®é¢˜ã€‚</p><h2 id="å¦‚ä½•å¼€å¯earlycon"><a href="#å¦‚ä½•å¼€å¯earlycon" class="headerlink" title="å¦‚ä½•å¼€å¯earlycon"></a>å¦‚ä½•å¼€å¯earlycon</h2><p>è¦åœ¨å†…æ ¸å¯åŠ¨æ—¶å¯ç”¨ <code>earlycon</code>ï¼Œéœ€è¦åœ¨å†…æ ¸é…ç½®ä¸­å¯ç”¨å‡ ä¸ªç›¸å…³çš„é…ç½®é€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CONFIG_SERIAL_EARLYCON</span><br><span class="line">CONFIG_OF_EARLY_FLATTREE</span><br></pre></td></tr></table></figure><p>è¿˜éœ€è¦åœ¨å†…æ ¸å‘½ä»¤è¡Œå‚æ•°ä¸­æ·»åŠ ç›¸å…³è®¾ç½®ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">earlycon=pxa_serial,0xd4017000</span><br></pre></td></tr></table></figure><h2 id="å…·ä½“æµç¨‹"><a href="#å…·ä½“æµç¨‹" class="headerlink" title="å…·ä½“æµç¨‹"></a>å…·ä½“æµç¨‹</h2><p>åœ¨ <code>Kernel</code> åˆå§‹åŒ–æ±‡ç¼–ä»£ç æ‰§è¡Œå®Œè·³è½¬åˆ° <code>start_kernel</code> ä¹‹åï¼Œ<code>setup_arch</code> è°ƒç”¨ <code>parse_early_param</code>ï¼Œè¿›è€Œåœ¨å…¶ä¸­æ‰§è¡Œ <code>early_param</code> çš„è§£æï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><p>start_kernel-&gt;setup_arch-&gt;parse_early_param-&gt;parse_early_options-&gt;do_early_param</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In init/main.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">start_kernel</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *command_line;</span><br><span class="line">    ...</span><br><span class="line">setup_arch(&amp;command_line);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In arch/riscv/kernel/setup.c</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">setup_arch</span><span class="params">(<span class="type">char</span> **cmdline_p)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">parse_early_param();</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In arch/riscv/kernel/setup.c</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">parse_early_param</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> done __initdata;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> tmp_cmdline[COMMAND_LINE_SIZE] __initdata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (done)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* All fall through to do_early_param. */</span></span><br><span class="line">strscpy(tmp_cmdline, boot_command_line, COMMAND_LINE_SIZE);</span><br><span class="line">parse_early_options(tmp_cmdline);</span><br><span class="line">done = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In arch/riscv/kernel/setup.c</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">parse_early_options</span><span class="params">(<span class="type">char</span> *cmdline)</span></span><br><span class="line">&#123;</span><br><span class="line">parse_args(<span class="string">&quot;early options&quot;</span>, cmdline, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>,</span><br><span class="line">   do_early_param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œçœ‹åˆ°æœ‰ä¸€ä¸ª<code>parse_args</code>å‡½æ•°ï¼Œå…¶å‡½æ•°ç›®çš„æ˜¯<code>è§£æé”®å€¼</code>å¯¹å‚æ•°å¹¶å°†é”®å€¼å¯¹ä½œä¸ºå‚æ•°<code>æ‰§è¡Œ</code>æœ€åä¸€ä¸ªå‚æ•°å†™å…¥çš„å‡½æ•°æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In kernel/params.c</span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">parse_args</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *doing,</span></span><br><span class="line"><span class="params"> <span class="type">char</span> *args,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="keyword">struct</span> kernel_param *params,</span></span><br><span class="line"><span class="params"> <span class="type">unsigned</span> num,</span></span><br><span class="line"><span class="params"> s16 min_level,</span></span><br><span class="line"><span class="params"> s16 max_level,</span></span><br><span class="line"><span class="params"> <span class="type">void</span> *arg, parse_unknown_fn unknown)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> *param, *val, *err = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Chew leading spaces */</span></span><br><span class="line">args = skip_spaces(args);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (*args)</span><br><span class="line">pr_debug(<span class="string">&quot;doing %s, parsing ARGS: &#x27;%s&#x27;\n&quot;</span>, doing, args);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (*args) &#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">int</span> irq_was_disabled;</span><br><span class="line"></span><br><span class="line">args = next_arg(args, &amp;param, &amp;val);</span><br><span class="line"><span class="comment">/* Stop at -- */</span></span><br><span class="line"><span class="keyword">if</span> (!val &amp;&amp; <span class="built_in">strcmp</span>(param, <span class="string">&quot;--&quot;</span>) == <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err ?: args;</span><br><span class="line">irq_was_disabled = irqs_disabled();</span><br><span class="line">ret = parse_one(param, val, doing, params, num,</span><br><span class="line">min_level, max_level, arg, unknown);</span><br><span class="line"><span class="keyword">if</span> (irq_was_disabled &amp;&amp; !irqs_disabled())</span><br><span class="line">pr_warn(<span class="string">&quot;%s: option &#x27;%s&#x27; enabled irq&#x27;s!\n&quot;</span>,</span><br><span class="line">doing, param);</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (ret) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">case</span> -ENOENT:</span><br><span class="line">pr_err(<span class="string">&quot;%s: Unknown parameter `%s&#x27;\n&quot;</span>, doing, param);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> -ENOSPC:</span><br><span class="line">pr_err(<span class="string">&quot;%s: `%s&#x27; too large for parameter `%s&#x27;\n&quot;</span>,</span><br><span class="line">       doing, val ?: <span class="string">&quot;&quot;</span>, param);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">pr_err(<span class="string">&quot;%s: `%s&#x27; invalid for parameter `%s&#x27;\n&quot;</span>,</span><br><span class="line">       doing, val ?: <span class="string">&quot;&quot;</span>, param);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = ERR_PTR(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In arch/riscv/kernel/setup.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">do_early_param</span><span class="params">(<span class="type">char</span> *param, <span class="type">char</span> *val,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *unused, <span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">obs_kernel_param</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (p = __setup_start; p &lt; __setup_end; p++) &#123;</span><br><span class="line"><span class="keyword">if</span> ((p-&gt;early &amp;&amp; parameq(param, p-&gt;str)) ||</span><br><span class="line">    (<span class="built_in">strcmp</span>(param, <span class="string">&quot;console&quot;</span>) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">     <span class="built_in">strcmp</span>(p-&gt;str, <span class="string">&quot;earlycon&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">) &#123;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;setup_func(val) != <span class="number">0</span>)</span><br><span class="line">pr_warn(<span class="string">&quot;Malformed early option &#x27;%s&#x27;\n&quot;</span>, param);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* We accept everything at this stage. */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>__setup_start</code>å’Œ<code>__setup_end</code>å˜é‡åœ¨<code>arch/riscv/kernel/vmlinux.lds</code>ä¸­å¯ä»¥æŸ¥æ‰¾åˆ°ç›¸å…³å®šä¹‰ï¼Œä»–ä»¬æ˜¯<code>.init.setup</code>æ®µçš„å¼€å§‹åœ°å€å’Œç»“æŸåœ°å€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.init.data : AT(ADDR(.init.data) - ((((-1))) - 0x80000000 + 1)) &#123;</span><br><span class="line">    ... </span><br><span class="line">    __setup_start = .; KEEP(*(.init.setup)) __setup_end = .;  </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>__setup_start</code>å’Œ<code>__setup_end</code>éƒ½å±äº<code>.init.setup</code>æ®µï¼Œç»è¿‡æœç´¢åœ¨<code>include/linux/init.h</code>å‘ç°æœ‰å®å®šä¹‰å¯ä»¥å°†å‡½æ•°æ”¾å…¥è¯¥æ®µï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Only for really core code.  See moduleparam.h for the normal way.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Force the alignment so the compiler doesn&#x27;t space elements of the</span></span><br><span class="line"><span class="comment"> * obs_kernel_param &quot;array&quot; too far apart in .init.setup.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __setup_param(str, unique_id, fn, early)\</span></span><br><span class="line"><span class="meta">static const char __setup_str_##unique_id[] __initconst\</span></span><br><span class="line"><span class="meta">__aligned(1) = str; \</span></span><br><span class="line"><span class="meta">static struct obs_kernel_param __setup_##unique_id\</span></span><br><span class="line"><span class="meta">__used __section(<span class="string">&quot;.init.setup&quot;</span>)\</span></span><br><span class="line"><span class="meta">__aligned(__alignof__(struct obs_kernel_param))\</span></span><br><span class="line"><span class="meta">= &#123; __setup_str_##unique_id, fn, early &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> __setup functions return values:</span></span><br><span class="line"><span class="comment"> * @fn returns 1 (or non-zero) if the option argument is &quot;handled&quot;</span></span><br><span class="line"><span class="comment"> * and returns 0 if the option argument is &quot;not handled&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __setup(str, fn)\</span></span><br><span class="line"><span class="meta">__setup_param(str, fn, fn, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> @fn is as per module_param, not __setup!</span></span><br><span class="line"><span class="comment"> * I.e., @fn returns 0 for no error or non-zero for error</span></span><br><span class="line"><span class="comment"> * (possibly @fn returns a -errno value, but it does not matter).</span></span><br><span class="line"><span class="comment"> * Emits warning if @fn returns non-zero.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> early_param(str, fn)\</span></span><br><span class="line"><span class="meta">__setup_param(str, fn, fn, 1)</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šä»£ç ä¸éš¾çœ‹å‡ºï¼Œ<code>__setup_param</code>å®å®šä¹‰è¢«<code>__setup</code>å’Œ<code>early_param</code>ä¸¤ä¸ªå®è°ƒç”¨ï¼Œå…·ä½“åŒºåˆ«å°±æ˜¯<code>early</code>å®å‚æ•°æ˜¯<code>0</code>è¿˜æ˜¯<code>1</code>ã€‚</p><p>åœ¨<code>do_early_param</code>å‡½æ•°ä¸­ï¼Œå¦‚æœ<code>early</code>ä¸æ˜¯<code>1</code>çš„è¯å°±ä¸ä¼šåœ¨<code>early</code>é˜¶æ®µè§£æï¼Œå…·ä½“åœ¨å“ªä¸ªé˜¶æ®µä¸æ˜¯æœ¬ç« çš„èŒƒç•´ï¼Œé‚£ä¹ˆçœ‹æ¥æˆ‘ä»¬åªå…³å¿ƒ<code>early_param</code>è¿™ä¸ªå®å®šä¹‰å³å¯ã€‚</p><p><code>e.g. early_param(&quot;earlycon&quot;, earlycon_func)</code> </p><p>å°†<code>early_param</code>ä¸€æ­¥æ­¥å±•å¼€å¾—åˆ°å¦‚ä¸‹ç»“è®ºï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">   early_param(<span class="string">&quot;earlycon&quot;</span>, earlycon_func) </span><br><span class="line">   -&gt;</span><br><span class="line">__setup_param(<span class="string">&quot;earlycon&quot;</span>, earlycon_func, earlycon_func, <span class="number">1</span>)  </span><br><span class="line">   -&gt;</span><br><span class="line">   <span class="type">static</span> <span class="type">const</span> <span class="type">char</span> __setup_str_earlycon_func[] __initconst\</span><br><span class="line">__aligned(<span class="number">1</span>) = <span class="string">&quot;earlycon&quot;</span>; \</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">obs_kernel_param</span> __<span class="title">setup_earlycon_func</span>\</span></span><br><span class="line"><span class="class">__<span class="title">used</span> __<span class="title">section</span>(&quot;.<span class="title">init</span>.<span class="title">setup</span>&quot;)\</span></span><br><span class="line"><span class="class">__<span class="title">aligned</span>(__<span class="title">alignof__</span>(<span class="keyword">struct</span> <span class="title">obs_kernel_param</span>))\</span></span><br><span class="line"><span class="class">=</span> &#123; __setup_str_earlycon_func, earlycon_func, <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä¸Šé¢æ¨å¯¼å±•å¼€ä¸éš¾å‘ç°ï¼Œå…¶æœ¬è´¨å°±æ˜¯å£°æ˜äº†ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„ä½“ç±»å‹æ˜¯<code>struct obs_kernel_param</code>ï¼Œå¹¶ä¸”åœ¨è¯¥ç»“æ„ä½“å®šä¹‰çš„åœ°æ–¹ï¼Œè¿˜å¯¼å‡ºäº†<code>ldsæ–‡ä»¶</code>ä¸­å®šä¹‰çš„<code>__setup_start</code>å’Œ<code>__setup_end</code>å˜é‡ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//In include/linux/init.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">obs_kernel_param</span> &#123;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *str;</span><br><span class="line"><span class="type">int</span> (*setup_func)(<span class="type">char</span> *);</span><br><span class="line"><span class="type">int</span> early;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">obs_kernel_param</span> __<span class="title">setup_start</span>[], __<span class="title">setup_end</span>[];</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡æœç´¢æ‰¾åˆ°åœ¨<code>drivers/tty/serial/earlycon.c</code>æ–‡ä»¶ä¸­æœ‰è°ƒç”¨åˆ°<code>early_param</code>è¿™ä¸ªå®å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* early_param wrapper for setup_earlycon() */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">param_setup_earlycon</span><span class="params">(<span class="type">char</span> *buf)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Just &#x27;earlycon&#x27; is a valid param for devicetree and ACPI SPCR. */</span></span><br><span class="line"><span class="keyword">if</span> (!buf || !buf[<span class="number">0</span>]) &#123;</span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_ACPI_SPCR_TABLE)) &#123;</span><br><span class="line">earlycon_acpi_spcr_enable = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!buf) &#123;</span><br><span class="line"><span class="keyword">return</span> early_init_dt_scan_chosen_stdout();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = setup_earlycon(buf);</span><br><span class="line"><span class="keyword">if</span> (err == -ENOENT || err == -EALREADY)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">early_param(<span class="string">&quot;earlycon&quot;</span>, param_setup_earlycon);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯å°†<code>param_setup_early</code>è¿™ä¸ªå‡½æ•°ä½œä¸ºç»“æ„ä½“çš„<code>setup_func</code>æˆå‘˜çš„å€¼ï¼Œå¹¶ä¸”å°†è¿™ä¸ªç»“æ„ä½“åŠ å…¥<code>.init.setup</code>æ®µï¼Œä¹Ÿå°±æ˜¯åœ¨<code>__setup_start</code>å’Œ<code>__setup_end</code>åœ°å€ä¸­é—´ï¼Œå…¶ä¸­æ¶‰åŠåˆ°çš„åä¸º<code>param_setup_earlycon</code>çš„å‡½æ•°ï¼Œè¿™ä¸ªç•™ä½œåè¯ã€‚</p><h3 id="do-early-param"><a href="#do-early-param" class="headerlink" title="do_early_param"></a>do_early_param</h3><p>ç»è¿‡ä¸€ç³»åˆ—çš„è¿½æŸ¥ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å¼€å§‹åˆ†æ<code>do_early_param</code>ï¼Œå†å›é¡¾ä¸€ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In arch/riscv/kernel/setup.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">do_early_param</span><span class="params">(<span class="type">char</span> *param, <span class="type">char</span> *val,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *unused, <span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">obs_kernel_param</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (p = __setup_start; p &lt; __setup_end; p++) &#123;</span><br><span class="line"><span class="keyword">if</span> ((p-&gt;early &amp;&amp; parameq(param, p-&gt;str)) ||</span><br><span class="line">    (<span class="built_in">strcmp</span>(param, <span class="string">&quot;console&quot;</span>) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">     <span class="built_in">strcmp</span>(p-&gt;str, <span class="string">&quot;earlycon&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">) &#123;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;setup_func(val) != <span class="number">0</span>)</span><br><span class="line">pr_warn(<span class="string">&quot;Malformed early option &#x27;%s&#x27;\n&quot;</span>, param);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* We accept everything at this stage. */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªåä¸ºpçš„æŒ‡é’ˆï¼Œç±»å‹å°±æ˜¯åˆšåˆšæˆ‘ä»¬çœ‹çš„<code>obs_kernel_param</code>ï¼ŒåŒæ—¶<code>earlycon.c</code>ä¸­å£°æ˜çš„ç»“æ„ä½“ä¹Ÿæ˜¯è¿™ä¸ªç±»å‹ï¼Œç”±äº<code>early_param</code>æˆ–è€…<code>__setup</code>å®èƒ½å¤Ÿå°†ç»“æ„ä½“åŠ å…¥<code>__setup_start</code>å’Œ<code>__setup_end</code>ä¸­é—´çš„<code>.init.setupæ®µ</code>ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†<code>pæŒ‡é’ˆ</code>æŒ‡å‘<code>__setup_start</code>ï¼Œç„¶åå¼€å§‹éå†ï¼Œå³å¯è·å–åˆ°åœ¨è¯¥æ®µä¸­çš„æ¯ä¸€ä¸ªç»“æ„ä½“ã€‚</p><p>è¿™é‡Œåˆ¤æ–­<code>early</code>æ˜¯å¦ä¸º<code>1</code>ï¼Œä¹Ÿå°±æ˜¯åªæœ‰é€šè¿‡<code>early_paramå®</code>å£°æ˜çš„ç»“æ„ä½“æ‰å¯ä»¥åœ¨è¿™é‡Œè¢«å±•å¼€ç»§ç»­æ‰§è¡Œï¼Œ<code>__setup</code>çš„å¹¶ä¸å¯ä»¥ã€‚</p><p><code>parameq</code>å‡½æ•°æ˜¯åˆ¤æ–­ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œå¹¶ä¸”æŠŠ<code>-</code>æ›¿æ¢æˆ<code>_</code>å»æ¯”è¾ƒçš„ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> <span class="title function_">dash2underscore</span><span class="params">(<span class="type">char</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (c == <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;_&#x27;</span>;</span><br><span class="line"><span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">parameqn</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a, <span class="type">const</span> <span class="type">char</span> *b, <span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (dash2underscore(a[i]) != dash2underscore(b[i]))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">parameq</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a, <span class="type">const</span> <span class="type">char</span> *b)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> parameqn(a, b, <span class="built_in">strlen</span>(a)+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœåˆ¤æ–­å­—ç¬¦ä¸²ç›¸ç­‰æˆ–è€…<code>param</code>ä¸º<code>console</code>å¹¶ä¸”<code>p-&gt;str</code>ä¸º<code>earlycon</code>å°±å¯ä»¥æ‰§è¡Œ<code>setup_func</code>å‡½æ•°ï¼Œå‚æ•°æ˜¯<code>val</code>ã€‚</p><h3 id="param-setup-earlycon"><a href="#param-setup-earlycon" class="headerlink" title="param_setup_earlycon"></a>param_setup_earlycon</h3><p>ç»è¿‡äº†ä¸Šé¢çš„æ‰§è¡Œï¼Œæˆ‘ä»¬åº”è¯¥æ‰§è¡Œåˆ°äº†<code>setup</code>å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>param_setup_earlycon</code>å‡½æ•°ï¼Œå‡½æ•°å®ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* early_param wrapper for setup_earlycon() */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">param_setup_earlycon</span><span class="params">(<span class="type">char</span> *buf)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Just &#x27;earlycon&#x27; is a valid param for devicetree and ACPI SPCR. */</span></span><br><span class="line"><span class="keyword">if</span> (!buf || !buf[<span class="number">0</span>]) &#123;</span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_ACPI_SPCR_TABLE)) &#123;</span><br><span class="line">earlycon_acpi_spcr_enable = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!buf) &#123;</span><br><span class="line"><span class="keyword">return</span> early_init_dt_scan_chosen_stdout();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = setup_earlycon(buf);</span><br><span class="line"><span class="keyword">if</span> (err == -ENOENT || err == -EALREADY)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸éš¾çœ‹å‡ºè¿™å°±æ˜¯ä¸€ä¸ªåŒ…è£…å‡½æ•°ï¼Œç”¨æ¥åŒ…è£…ä¸¤ç§å¤„ç†æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡<code>boot command line</code>æ¥è·å–<code>earlycon</code>çš„é…ç½®ï¼Œä¸€ç§æ˜¯é€šè¿‡<code>device tree</code>æ¥è·å–é…ç½®ã€‚</p><p>åœ¨ifåˆ¤æ–­ä¸­åˆ¤æ–­æ˜¯å¦bufä¸ºé‡æŒ‡é’ˆæˆ–è€…bufä¸ºç©ºï¼Œå¦‚æœæ˜¯çš„è¯åˆ¤æ–­<code>CONFIG_ACPI_SPCR_TABLE</code>è¿™ä¸ªå®å®šä¹‰æ˜¯å¦å¼€å¯ï¼Œå¦‚æœæ²¡å¼€å¯çš„è¯å°±å»æœç´¢<code>è®¾å¤‡æ ‘</code>ã€‚å¦åˆ™é€šè¿‡<code>setup_earlycon</code>æ¥è¿›è¡Œåˆå§‹åŒ–ã€‚</p><h2 id="é€šè¿‡setup-earlyconåˆå§‹åŒ–"><a href="#é€šè¿‡setup-earlyconåˆå§‹åŒ–" class="headerlink" title="é€šè¿‡setup_earlyconåˆå§‹åŒ–"></a>é€šè¿‡setup_earlyconåˆå§‹åŒ–</h2><p><code>setup_earlycon</code>å‡½æ•°å®ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *setup_earlycon - match and register earlycon console</span></span><br><span class="line"><span class="comment"> *@buf:earlycon param string</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Registers the earlycon console matching the earlycon specified</span></span><br><span class="line"><span class="comment"> *in the param string @buf. Acceptable param strings are of the form</span></span><br><span class="line"><span class="comment"> *   &lt;name&gt;,io|mmio|mmio32|mmio32be,&lt;addr&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;name&gt;,0x&lt;addr&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;name&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;name&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Only for the third form does the earlycon setup() method receive the</span></span><br><span class="line"><span class="comment"> *&lt;options&gt; string in the &#x27;options&#x27; parameter; all other forms set</span></span><br><span class="line"><span class="comment"> *the parameter to NULL.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Returns 0 if an attempt to register the earlycon was made,</span></span><br><span class="line"><span class="comment"> *otherwise negative error code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> __init <span class="title function_">setup_earlycon</span><span class="params">(<span class="type">char</span> *buf)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">earlycon_id</span> *<span class="title">match</span>;</span></span><br><span class="line"><span class="type">bool</span> empty_compatible = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!buf || !buf[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (console_is_registered(&amp;early_con))</span><br><span class="line"><span class="keyword">return</span> -EALREADY;</span><br><span class="line"></span><br><span class="line">again:</span><br><span class="line"><span class="keyword">for</span> (match = __earlycon_table; match &lt; __earlycon_table_end; match++) &#123;</span><br><span class="line"><span class="type">size_t</span> len = <span class="built_in">strlen</span>(match-&gt;name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strncmp</span>(buf, match-&gt;name, len))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* prefer entries with empty compatible */</span></span><br><span class="line"><span class="keyword">if</span> (empty_compatible &amp;&amp; *match-&gt;compatible)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (buf[len]) &#123;</span><br><span class="line"><span class="keyword">if</span> (buf[len] != <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">buf += len + <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">buf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> register_earlycon(buf, match);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (empty_compatible) &#123;</span><br><span class="line">empty_compatible = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">goto</span> again;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹<code>buf</code>è¿›è¡Œäº†æ£€éªŒå¹¶ä¸”æ£€æŸ¥äº†<code>early_con</code>çš„<code>console</code>æ˜¯å¦å·²ç»æ³¨å†Œè¿‡äº†ã€‚<br>éšåä½¿ç”¨matchå˜é‡è¿›è¡Œéå†ï¼Œè¿™å…¶ä¸­ä»¥<code>__earlycon_table</code>åœ°å€å¼€å§‹ï¼Œä»¥<code>__earlycon_table_end</code>åœ°å€ç»“æŸã€‚</p><p><code>__earlycon_table</code>å’Œ<code>__earlycon_table_end</code>å˜é‡åœ¨<code>arch/riscv/kernel/vmlinux.lds</code>ä¸­å¯ä»¥æŸ¥æ‰¾åˆ°ç›¸å…³å®šä¹‰ï¼Œä»–ä»¬æ˜¯<code>__earlycon_table</code>æ®µçš„å¼€å§‹å’Œç»“æŸåœ°å€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> .init.data : AT(ADDR(.init.data) - ((((-1))) - 0x80000000 + 1)) </span><br><span class="line">&#123;  </span><br><span class="line">    __earlycon_table = .; KEEP(*(__earlycon_table)) __earlycon_table_end = .;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡æœç´¢å‘ç°è¿™ä¸¤ä¸ªå®å¯å°†å†…å®¹å®šä¹‰åˆ°è¿™ä¸ªæ®µå½“ä¸­ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OF_EARLYCON_DECLARE(_name, compat, fn)\</span></span><br><span class="line"><span class="meta">static const struct earlycon_id __UNIQUE_ID(__earlycon_##_name) \</span></span><br><span class="line"><span class="meta">EARLYCON_USED_OR_UNUSED  __section(<span class="string">&quot;__earlycon_table&quot;</span>)  \</span></span><br><span class="line"><span class="meta">__aligned(__alignof__(struct earlycon_id))\</span></span><br><span class="line"><span class="meta">= &#123; .name = __stringify(_name),\</span></span><br><span class="line"><span class="meta">    .compatible = compat,\</span></span><br><span class="line"><span class="meta">    .setup = fn &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EARLYCON_DECLARE(_name, fn)OF_EARLYCON_DECLARE(_name, <span class="string">&quot;&quot;</span>, fn)</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå®å®šä¹‰<code>OF_EARLYCON_DECLARE</code>æ˜¯ç”¨äºè®¾å¤‡æ ‘çš„<br>    - <code>_name</code>: åå­—ï¼Œä¸åº”è¯¥æœ‰åŒå¼•å·<br>    - <code>compat</code>: ä¸è®¾å¤‡æ ‘çš„compatibleç›¸å¯¹åº”ï¼Œç”¨äºåŒ¹é…ï¼Œåº”æœ‰åŒå¼•å·<br>    - <code>fn</code>: æ‰§è¡Œå‡½æ•°ï¼Œå³åŒ¹é…åˆ°åæ‰§è¡Œçš„å‡½æ•°</p><p>ç¬¬äºŒä¸ªå®å®šä¹‰<code>EARLYCON_DECLARE</code>æ˜¯ç”¨äºéè®¾å¤‡æ ‘çš„ç‰ˆæœ¬çš„ï¼Œå‚æ•°å®šä¹‰ä¸<code>OF_EARLYCON_DECLARE</code>ç›¸åŒï¼Œåªä¸è¿‡å°†compatè®¾ç½®ä¸ºäº†ç©ºå­—ç¬¦ä¸²ä¹Ÿå°±æ˜¯<code>\0</code>ã€‚</p><p>æ‹¿<code>bpi-f3</code>ä¸ºä¾‹ï¼Œå…¶åœ¨<code>drivers/tty/serial/pxa_k1x.c</code>ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Support for earlycon */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">pxa_early_write</span><span class="params">(<span class="keyword">struct</span> console *con, <span class="type">const</span> <span class="type">char</span> *s,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">earlycon_device</span> *<span class="title">dev</span> =</span> con-&gt;data;</span><br><span class="line"></span><br><span class="line">   uart_console_write(&amp;dev-&gt;port, s, n, serial_pxa_console_putchar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">pxa_early_console_setup</span><span class="params">(<span class="keyword">struct</span> earlycon_device *device, <span class="type">const</span> <span class="type">char</span> *opt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!device-&gt;port.membase) &#123;</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">device-&gt;con-&gt;write = pxa_early_write;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EARLYCON_DECLARE(pxa_serial, pxa_early_console_setup);</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†ä»£ç å°†<code>pxa_serial</code>, <code>&quot;&quot;</code>, <code>pxa_early_console_setup</code>ä¾æ¬¡å®šä¹‰æˆç»“æ„ä½“ã€‚</p><p><code>earlycon_id</code>çš„æˆå‘˜å¹¶ä¸”æ”¾åœ¨__earlycon_tableæ®µå½“ä¸­ï¼Œ<code>earlycon_id</code>ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">earlycon_id</span> &#123;</span></span><br><span class="line"><span class="type">char</span>name[<span class="number">15</span>];</span><br><span class="line"><span class="type">char</span>name_term;<span class="comment">/* In case compiler didn&#x27;t &#x27;\0&#x27; term name */</span></span><br><span class="line"><span class="type">char</span>compatible[<span class="number">128</span>];</span><br><span class="line"><span class="type">int</span>(*setup)(<span class="keyword">struct</span> earlycon_device *, <span class="type">const</span> <span class="type">char</span> *options);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­, <code>name_term</code>æˆå‘˜æ˜¯ä¸ºäº†<code>name</code>å­—ç¬¦ä¸²ä»¥<code>\0</code>ä¸ºç»“å°¾ã€‚</p><p>ç»§ç»­å›åˆ°<code>setup_earlycon</code>å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *setup_earlycon - match and register earlycon console</span></span><br><span class="line"><span class="comment"> *@buf:earlycon param string</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Registers the earlycon console matching the earlycon specified</span></span><br><span class="line"><span class="comment"> *in the param string @buf. Acceptable param strings are of the form</span></span><br><span class="line"><span class="comment"> *   &lt;name&gt;,io|mmio|mmio32|mmio32be,&lt;addr&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;name&gt;,0x&lt;addr&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;name&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;name&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Only for the third form does the earlycon setup() method receive the</span></span><br><span class="line"><span class="comment"> *&lt;options&gt; string in the &#x27;options&#x27; parameter; all other forms set</span></span><br><span class="line"><span class="comment"> *the parameter to NULL.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Returns 0 if an attempt to register the earlycon was made,</span></span><br><span class="line"><span class="comment"> *otherwise negative error code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> __init <span class="title function_">setup_earlycon</span><span class="params">(<span class="type">char</span> *buf)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">earlycon_id</span> *<span class="title">match</span>;</span></span><br><span class="line"><span class="type">bool</span> empty_compatible = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!buf || !buf[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (console_is_registered(&amp;early_con))</span><br><span class="line"><span class="keyword">return</span> -EALREADY;</span><br><span class="line"></span><br><span class="line">again:</span><br><span class="line"><span class="keyword">for</span> (match = __earlycon_table; match &lt; __earlycon_table_end; match++) &#123;</span><br><span class="line"><span class="type">size_t</span> len = <span class="built_in">strlen</span>(match-&gt;name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strncmp</span>(buf, match-&gt;name, len))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* prefer entries with empty compatible */</span></span><br><span class="line"><span class="keyword">if</span> (empty_compatible &amp;&amp; *match-&gt;compatible)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (buf[len]) &#123;</span><br><span class="line"><span class="keyword">if</span> (buf[len] != <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">buf += len + <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">buf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> register_earlycon(buf, match);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (empty_compatible) &#123;</span><br><span class="line">empty_compatible = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">goto</span> again;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¯”è¾ƒ<code>buf</code>ä¸æ¯ä¸€ä¸ªåœ¨<code>__earlycon_table</code>æ®µä¸­çš„<code>earlycon_id</code>ç»“æ„ä½“çš„<code>name</code>æ˜¯å¦åŒ¹é…ã€‚</p><p>åœ¨åŒ¹é…ä¹‹åæ¯”è¾ƒæ¯ä¸€ä¸ªåœ¨<code>__earlycon_table</code>æ®µä¸­çš„<code>earlycon_id</code>ç»“æ„ä½“çš„<code>compatible</code>æ˜¯å¦ä¸ä¸º<code>ç©º</code>ã€‚</p><p>éšåè¿›è¡Œåˆ¤æ–­æ˜¯å¦æœ‰<code>,</code>å­˜åœ¨ï¼Œå¦‚æœæœ‰<code>,</code>å­˜åœ¨ï¼Œå°±ä¼šè·³è¿‡å‰é¢çš„å†…å®¹ï¼Œå¦åˆ™åˆ™è®¾ç½®ä¸º<code>NULL</code>ã€‚</p><p>e.g. :</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">buf=&quot;pxa_serial,0xd4017000&quot;</span><br><span class="line">    -&gt;</span><br><span class="line">        buf=&quot;0xd4017000&quot;</span><br></pre></td></tr></table></figure><p>æœ€åé€šè¿‡<code>register_earlycon</code>å‡½æ•°è¿›è¡Œæ³¨å†Œï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">register_earlycon</span><span class="params">(<span class="type">char</span> *buf, <span class="type">const</span> <span class="keyword">struct</span> earlycon_id *match)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uart_port</span> *<span class="title">port</span> =</span> &amp;early_console_dev.port;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* On parsing error, pass the options buf to the setup function */</span></span><br><span class="line"><span class="keyword">if</span> (buf &amp;&amp; !parse_options(&amp;early_console_dev, buf))</span><br><span class="line">buf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">spin_lock_init(&amp;port-&gt;lock);</span><br><span class="line"><span class="keyword">if</span> (!port-&gt;uartclk)</span><br><span class="line">port-&gt;uartclk = BASE_BAUD * <span class="number">16</span>;</span><br><span class="line"><span class="keyword">if</span> (port-&gt;mapbase)</span><br><span class="line">port-&gt;membase = earlycon_map(port-&gt;mapbase, <span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">earlycon_init(&amp;early_console_dev, match-&gt;name);</span><br><span class="line">err = match-&gt;setup(&amp;early_console_dev, buf);</span><br><span class="line">earlycon_print_info(&amp;early_console_dev);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"><span class="keyword">if</span> (!early_console_dev.con-&gt;write)</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">register_console(early_console_dev.con);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>parse_options</code>è§£æå‚æ•°å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//In drivers/tty/serial/earlycon.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">parse_options</span><span class="params">(<span class="keyword">struct</span> earlycon_device *device, <span class="type">char</span> *options)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uart_port</span> *<span class="title">port</span> =</span> &amp;device-&gt;port;</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line"><span class="type">resource_size_t</span> addr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (uart_parse_earlycon(options, &amp;port-&gt;iotype, &amp;addr, &amp;options))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (port-&gt;iotype) &#123;</span><br><span class="line"><span class="keyword">case</span> UPIO_MEM:</span><br><span class="line">port-&gt;mapbase = addr;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> UPIO_MEM16:</span><br><span class="line">port-&gt;regshift = <span class="number">1</span>;</span><br><span class="line">port-&gt;mapbase = addr;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> UPIO_MEM32:</span><br><span class="line"><span class="keyword">case</span> UPIO_MEM32BE:</span><br><span class="line">port-&gt;regshift = <span class="number">2</span>;</span><br><span class="line">port-&gt;mapbase = addr;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> UPIO_PORT:</span><br><span class="line">port-&gt;iobase = addr;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (options) &#123;</span><br><span class="line"><span class="type">char</span> *uartclk;</span><br><span class="line"></span><br><span class="line">device-&gt;baud = simple_strtoul(options, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">uartclk = <span class="built_in">strchr</span>(options, <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (uartclk &amp;&amp; kstrtouint(uartclk + <span class="number">1</span>, <span class="number">0</span>, &amp;port-&gt;uartclk) &lt; <span class="number">0</span>)</span><br><span class="line">pr_warn(<span class="string">&quot;[%s] unsupported earlycon uart clkrate option\n&quot;</span>,</span><br><span class="line">options);</span><br><span class="line">length = min(<span class="built_in">strcspn</span>(options, <span class="string">&quot; &quot;</span>) + <span class="number">1</span>,</span><br><span class="line">     (<span class="type">size_t</span>)(<span class="keyword">sizeof</span>(device-&gt;options)));</span><br><span class="line">strscpy(device-&gt;options, options, length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>uart_parse_earlycon</code>å‡½æ•°è§£æä¼ å…¥å‚æ•°<code>options</code>ï¼Œä¹Ÿå°±æ˜¯<code>buf</code>ï¼Œ<code>buf</code>æŒ‡é’ˆç°åœ¨æŒ‡å‘<code>0xd4017000</code>ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In drivers/tty/serial/serial_core.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * uart_parse_earlycon - Parse earlycon options</span></span><br><span class="line"><span class="comment"> * @p:     ptr to 2nd field (ie., just beyond &#x27;&lt;name&gt;,&#x27;)</span></span><br><span class="line"><span class="comment"> * @iotype:  ptr for decoded iotype (out)</span></span><br><span class="line"><span class="comment"> * @addr:    ptr for decoded mapbase/iobase (out)</span></span><br><span class="line"><span class="comment"> * @options: ptr for &lt;options&gt; field; %NULL if not present (out)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Decodes earlycon kernel command line parameters of the form:</span></span><br><span class="line"><span class="comment"> *  * earlycon=&lt;name&gt;,io|mmio|mmio16|mmio32|mmio32be|mmio32native,&lt;addr&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *  * console=&lt;name&gt;,io|mmio|mmio16|mmio32|mmio32be|mmio32native,&lt;addr&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The optional form:</span></span><br><span class="line"><span class="comment"> *  * earlycon=&lt;name&gt;,0x&lt;addr&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *  * console=&lt;name&gt;,0x&lt;addr&gt;,&lt;options&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * is also accepted; the returned @iotype will be %UPIO_MEM.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns: 0 on success or -%EINVAL on failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">uart_parse_earlycon</span><span class="params">(<span class="type">char</span> *p, <span class="type">unsigned</span> <span class="type">char</span> *iotype, <span class="type">resource_size_t</span> *addr,</span></span><br><span class="line"><span class="params"><span class="type">char</span> **options)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strncmp</span>(p, <span class="string">&quot;mmio,&quot;</span>, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">*iotype = UPIO_MEM;</span><br><span class="line">p += <span class="number">5</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(p, <span class="string">&quot;mmio16,&quot;</span>, <span class="number">7</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">*iotype = UPIO_MEM16;</span><br><span class="line">p += <span class="number">7</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(p, <span class="string">&quot;mmio32,&quot;</span>, <span class="number">7</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">*iotype = UPIO_MEM32;</span><br><span class="line">p += <span class="number">7</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(p, <span class="string">&quot;mmio32be,&quot;</span>, <span class="number">9</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">*iotype = UPIO_MEM32BE;</span><br><span class="line">p += <span class="number">9</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(p, <span class="string">&quot;mmio32native,&quot;</span>, <span class="number">13</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">*iotype = IS_ENABLED(CONFIG_CPU_BIG_ENDIAN) ?</span><br><span class="line">UPIO_MEM32BE : UPIO_MEM32;</span><br><span class="line">p += <span class="number">13</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(p, <span class="string">&quot;io,&quot;</span>, <span class="number">3</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">*iotype = UPIO_PORT;</span><br><span class="line">p += <span class="number">3</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(p, <span class="string">&quot;0x&quot;</span>, <span class="number">2</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">*iotype = UPIO_MEM;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Before you replace it with kstrtoull(), think about options separator</span></span><br><span class="line"><span class="comment"> * (&#x27;,&#x27;) it will not tolerate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">*addr = simple_strtoull(p, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">p = <span class="built_in">strchr</span>(p, <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (p)</span><br><span class="line">p++;</span><br><span class="line"></span><br><span class="line">*options = p;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸éš¾çœ‹å‡ºè¿™é‡Œåœ¨å¯¹<code>ioç±»å‹</code>è¿›è¡Œåˆ¤æ–­ï¼Œæˆ‘ä»¬<code>buf</code>æŒ‡å‘çš„å†…å®¹æ˜¯<code>0xd4017000</code>ï¼Œæ‰€ä»¥è¿™é‡Œ<code>iotype</code>è¢«è®¾ç½®ä¸ºäº†<code>UPIO_MEM</code>ã€‚</p><p>é€šè¿‡<code>simple_strtoull</code>å‡½æ•°å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—ï¼Œæ­¤æ—¶<code>addr</code>åº”è¯¥ä¸º<code>0xd4017000</code>ã€‚</p><p><code>strchr</code>å‡½æ•°æ‰¾å‡ºæ˜¯å¦æœ‰é¢å¤–é€‰é¡¹ï¼Œå¦‚æœæœ‰é¢å¤–é€‰é¡¹ï¼Œåˆ™å°†é¢å¤–é€‰é¡¹å¼€å§‹çš„å­—ç¬¦ä¸²åœ°å€èµ‹å€¼ç»™<code>options</code>æŒ‡é’ˆï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰ï¼Œæ‰€ä»¥åº”è¯¥æŒ‡å‘äº†<code>NULL</code>ã€‚</p><p>å›åˆ°<code>parse_options</code>å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//In drivers/tty/serial/earlycon.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">parse_options</span><span class="params">(<span class="keyword">struct</span> earlycon_device *device, <span class="type">char</span> *options)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uart_port</span> *<span class="title">port</span> =</span> &amp;device-&gt;port;</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line"><span class="type">resource_size_t</span> addr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (uart_parse_earlycon(options, &amp;port-&gt;iotype, &amp;addr, &amp;options))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (port-&gt;iotype) &#123;</span><br><span class="line"><span class="keyword">case</span> UPIO_MEM:</span><br><span class="line">port-&gt;mapbase = addr;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> UPIO_MEM16:</span><br><span class="line">port-&gt;regshift = <span class="number">1</span>;</span><br><span class="line">port-&gt;mapbase = addr;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> UPIO_MEM32:</span><br><span class="line"><span class="keyword">case</span> UPIO_MEM32BE:</span><br><span class="line">port-&gt;regshift = <span class="number">2</span>;</span><br><span class="line">port-&gt;mapbase = addr;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> UPIO_PORT:</span><br><span class="line">port-&gt;iobase = addr;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (options) &#123;</span><br><span class="line"><span class="type">char</span> *uartclk;</span><br><span class="line"></span><br><span class="line">device-&gt;baud = simple_strtoul(options, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">uartclk = <span class="built_in">strchr</span>(options, <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (uartclk &amp;&amp; kstrtouint(uartclk + <span class="number">1</span>, <span class="number">0</span>, &amp;port-&gt;uartclk) &lt; <span class="number">0</span>)</span><br><span class="line">pr_warn(<span class="string">&quot;[%s] unsupported earlycon uart clkrate option\n&quot;</span>,</span><br><span class="line">options);</span><br><span class="line">length = min(<span class="built_in">strcspn</span>(options, <span class="string">&quot; &quot;</span>) + <span class="number">1</span>,</span><br><span class="line">     (<span class="type">size_t</span>)(<span class="keyword">sizeof</span>(device-&gt;options)));</span><br><span class="line">strscpy(device-&gt;options, options, length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä»¥ä¸Šçš„æ­¥éª¤ï¼Œ<code>port-&gt;iotype</code>çš„ç±»å‹åº”è¯¥è¢«è®¾ç½®æˆäº†<code>UPIO_MEM</code>ï¼Œæ‰€ä»¥å°†<code>port-&gt;mapbase</code>è®¾ç½®æˆäº†<code>addr</code>ã€‚</p><p><code>if</code>åˆ¤æ–­<code>options</code>æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯æ˜¯å¦æœ‰é¢å¤–é€‰é¡¹ã€‚</p><p>å›åˆ°<code>register_earlycon</code>å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">register_earlycon</span><span class="params">(<span class="type">char</span> *buf, <span class="type">const</span> <span class="keyword">struct</span> earlycon_id *match)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uart_port</span> *<span class="title">port</span> =</span> &amp;early_console_dev.port;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* On parsing error, pass the options buf to the setup function */</span></span><br><span class="line"><span class="keyword">if</span> (buf &amp;&amp; !parse_options(&amp;early_console_dev, buf))</span><br><span class="line">buf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">spin_lock_init(&amp;port-&gt;lock);</span><br><span class="line"><span class="keyword">if</span> (!port-&gt;uartclk)</span><br><span class="line">port-&gt;uartclk = BASE_BAUD * <span class="number">16</span>;</span><br><span class="line"><span class="keyword">if</span> (port-&gt;mapbase)</span><br><span class="line">port-&gt;membase = earlycon_map(port-&gt;mapbase, <span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">earlycon_init(&amp;early_console_dev, match-&gt;name);</span><br><span class="line">err = match-&gt;setup(&amp;early_console_dev, buf);</span><br><span class="line">earlycon_print_info(&amp;early_console_dev);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"><span class="keyword">if</span> (!early_console_dev.con-&gt;write)</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">register_console(early_console_dev.con);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>parse_options</code>å‡½æ•°æ‰§è¡Œåï¼Œ<code>mapbase</code>, <code>iotype</code>éƒ½å·²ç»è¢«è®¾ç½®å¥½ï¼Œä½†ç”±äºæˆ‘ä»¬æ²¡æœ‰<code>options</code>é€‰é¡¹ï¼Œæ‰€ä»¥<code>uartclk</code>æ˜¯æ²¡æœ‰è¢«è®¾ç½®çš„ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœè¿™é‡Œæ²¡æœ‰è¢«è®¾ç½®çš„è¯ï¼Œåœ¨è¿™é‡Œå°±ä¼šè¢«æ‰‹åŠ¨è®¾ç½®ä¸º<code>BASE_BAUD * 16</code>ã€‚</p><p><code>mapbase</code>ä¹Ÿå°±æ˜¯ä¸²å£å¯„å­˜å™¨åœ°å€çš„åœ°å€æˆ‘ä»¬ç°åœ¨å·²ç»æ‹¿åˆ°äº†ï¼Œä½†æ˜¯è¿™æ˜¯ä¸ªç‰©ç†åœ°å€ï¼Œæ‰€ä»¥è¦é€šè¿‡<code>earlycon_map</code>å‡½æ•°æ˜ å°„è¿›å…¥é¡µè¡¨ï¼Œéšåè¿”å›è™šæ‹Ÿåœ°å€èµ‹å€¼ç»™<code>membase</code>ã€‚</p><p>è°ƒç”¨<code>earlycon_init</code>å‡½æ•°è¿›è¡Œèµ‹å€¼ï¼Œéšåè°ƒç”¨<code>match-&gt;setup</code>å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡<code>EARLYCON_DECALRE</code>å®å£°æ˜çš„å‡½æ•°<code>pxa_early_console_setup</code>ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">pxa_early_console_setup</span><span class="params">(<span class="keyword">struct</span> earlycon_device *device, <span class="type">const</span> <span class="type">char</span> *opt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!device-&gt;port.membase) &#123;</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">device-&gt;con-&gt;write = pxa_early_write;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EARLYCON_DECLARE(pxa_serial, pxa_early_console_setup);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°å°±æ˜¯åˆ¤æ–­<code>membase</code>ä¹Ÿå°±æ˜¯è™šæ‹Ÿåœ°å€æ˜¯å¦æ˜ å°„æˆåŠŸï¼Œå¹¶ä¸”è®¾ç½®äº†<code>write</code>å‡½æ•°ä¸º<code>pxa_early_write</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Support for earlycon */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">pxa_early_write</span><span class="params">(<span class="keyword">struct</span> console *con, <span class="type">const</span> <span class="type">char</span> *s,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">earlycon_device</span> *<span class="title">dev</span> =</span> con-&gt;data;</span><br><span class="line"></span><br><span class="line">   uart_console_write(&amp;dev-&gt;port, s, n, serial_pxa_console_putchar);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡early-init-dt-scan-chosen-stdoutåˆå§‹åŒ–"><a href="#é€šè¿‡early-init-dt-scan-chosen-stdoutåˆå§‹åŒ–" class="headerlink" title="é€šè¿‡early_init_dt_scan_chosen_stdoutåˆå§‹åŒ–"></a>é€šè¿‡early_init_dt_scan_chosen_stdoutåˆå§‹åŒ–</h2><h4 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In drivers/of/fdt.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SERIAL_EARLYCON</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __init <span class="title function_">early_init_dt_scan_chosen_stdout</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> offset;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *p, *q, *options = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> l;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">earlycon_id</span> *<span class="title">match</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="type">void</span> *fdt = initial_boot_params;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">offset = fdt_path_offset(fdt, <span class="string">&quot;/chosen&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (offset &lt; <span class="number">0</span>)</span><br><span class="line">offset = fdt_path_offset(fdt, <span class="string">&quot;/chosen@0&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (offset &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line"></span><br><span class="line">p = fdt_getprop(fdt, offset, <span class="string">&quot;stdout-path&quot;</span>, &amp;l);</span><br><span class="line"><span class="keyword">if</span> (!p)</span><br><span class="line">p = fdt_getprop(fdt, offset, <span class="string">&quot;linux,stdout-path&quot;</span>, &amp;l);</span><br><span class="line"><span class="keyword">if</span> (!p || !l)</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line"></span><br><span class="line">q = strchrnul(p, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (*q != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">options = q + <span class="number">1</span>;</span><br><span class="line">l = q - p;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get the node specified by stdout-path */</span></span><br><span class="line">offset = fdt_path_offset_namelen(fdt, p, l);</span><br><span class="line"><span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">pr_warn(<span class="string">&quot;earlycon: stdout-path %.*s not found\n&quot;</span>, l, p);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (match = __earlycon_table; match &lt; __earlycon_table_end; match++) &#123;</span><br><span class="line"><span class="keyword">if</span> (!match-&gt;compatible[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fdt_node_check_compatible(fdt, offset, match-&gt;compatible))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">ret = of_setup_earlycon(match, offset, options);</span><br><span class="line"><span class="keyword">if</span> (!ret || ret == -EALREADY)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> kernel </tag>
            
            <tag> serial </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vimå¿«æ·æ“ä½œ</title>
      <link href="/2024/07/02/vim%E5%BF%AB%E6%8D%B7%E6%93%8D%E4%BD%9C/"/>
      <url>/2024/07/02/vim%E5%BF%AB%E6%8D%B7%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="å¿«é€Ÿå®šä½"><a href="#å¿«é€Ÿå®šä½" class="headerlink" title="å¿«é€Ÿå®šä½"></a>å¿«é€Ÿå®šä½</h2><ul><li>A: è·³åˆ°è¡Œå°¾å¹¶å¼€å¯ç¼–è¾‘æ¨¡å¼</li><li>0: è·³åˆ°è¡Œé¦–</li><li>$: è·³åˆ°è¡Œå°¾</li><li>G: è·³åˆ°æ–‡ä»¶å°¾</li><li>gg: è·³åˆ°æ–‡ä»¶é¦–</li><li>nG: è·³åˆ°ç¬¬nè¡Œ<ul><li>e.g. 50G: è·³åˆ°ç¬¬50è¡Œ</li></ul></li><li>nj: å‘ä¸‹è·³nè¡Œ<ul><li>e.g. 3j: å‘ä¸‹è·³3è¡Œ</li></ul></li><li>nk: å‘ä¸Šè·³nè¡Œ<ul><li>e.g. 3k: å‘ä¸Šè·³3è¡Œ</li></ul></li><li>nw: å‘åè·³nä¸ªå•è¯<ul><li>e.g. 3w: å‘åè·³3ä¸ªå•è¯</li></ul></li><li>nb: å‘å‰è·³nä¸ªå•è¯<ul><li>e.g. 3b: å‘å‰è·³3ä¸ªå•è¯</li></ul></li><li>&#x2F;: æœç´¢<ul><li>e.g. &#x2F;123: æœç´¢123æ–‡æœ¬</li><li>æŒ‰nå’ŒNå‘ä¸‹å’Œå‘ä¸Š</li></ul></li></ul><h3 id="pair"><a href="#pair" class="headerlink" title="pair"></a>pair</h3><ul><li>%: åœ¨pairä¸­æ¥å›è·³<ul><li>e.g. (123)  åœ¨ï¼ˆå’Œï¼‰ä¹‹é—´æ¥å›è·³</li></ul></li><li>ci + left-pair: åˆ é™¤pairä¸­çš„å†…å®¹å¹¶ä¸”å¼€å¯ç¼–è¾‘æ¨¡å¼<ul><li>e.g. ci+(: åˆ é™¤ï¼ˆï¼‰ä¸­çš„å†…å®¹å¹¶ä¸”å¼€å¯ç¼–è¾‘æ¨¡å¼</li></ul></li><li>di + left-pair: åˆ é™¤pairä¸­çš„å†…å®¹<ul><li>e.g. di+(: åˆ é™¤ï¼ˆï¼‰ä¸­çš„å†…å®¹</li></ul></li><li>yi + left-pair: å¤åˆ¶pairä¸­çš„å†…å®¹<ul><li>e.g. yi+(: å¤åˆ¶ï¼ˆï¼‰ä¸­çš„å†…å®¹</li></ul></li><li>vi + left-pair: é€‰ä¸­pairä¸­çš„å†…å®¹<ul><li>e.g. vi+(: é€‰ä¸­ï¼ˆï¼‰ä¸­çš„å†…å®¹</li></ul></li><li>va + left-pair: åˆ é™¤pairä¸­çš„å†…å®¹åŒ…æ‹¬pair<ul><li>e.g. va+(: åˆ é™¤ï¼ˆï¼‰ä¸­çš„å†…å®¹åŒ…æ‹¬ï¼ˆï¼‰</li></ul></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨vimé˜…è¯»ä»£ç </title>
      <link href="/2024/07/02/%E4%BD%BF%E7%94%A8vim%E9%98%85%E8%AF%BB%E4%BB%A3%E7%A0%81/"/>
      <url>/2024/07/02/%E4%BD%BF%E7%94%A8vim%E9%98%85%E8%AF%BB%E4%BB%A3%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><ul><li>Ubuntu22.04</li><li>VIM - Vi IMproved 8.2 (2019 Dec 12, ç¼–è¯‘äº May 03 2024 02:37:51)</li></ul><h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>åœ¨<code>Linux</code>ç¯å¢ƒä¸‹ï¼Œ<code>Source Insight</code>åªèƒ½åœ¨Wineç¯å¢ƒä¸‹è¿è¡Œï¼Œæ˜¾å¾—å¹¶æ²¡æœ‰é‚£ä¹ˆå¥½ç”¨ï¼Œäºæ˜¯ä¾¿æœ‰äº†æœ¬æ–‡ï¼Œä½¿ç”¨<code>Vim+Ctags+Cscope</code>æ¥è¿›è¡Œé˜…è¯»ä»£ç ã€‚</p><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="å®‰è£…Ctags"><a href="#å®‰è£…Ctags" class="headerlink" title="å®‰è£…Ctags"></a>å®‰è£…Ctags</h3><p>æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… <code>ctags</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install exuberant-ctags</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å¸Œæœ›ä½¿ç”¨ <code>universal-ctags</code>ï¼ˆè¿™æ˜¯ä¸€ä¸ªæ›´æ–°å’Œç»´æŠ¤æ›´ç§¯æçš„åˆ†æ”¯ï¼‰ï¼Œåˆ™å¯ä»¥å®‰è£…å®ƒï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install universal-ctags</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…Cscope"><a href="#å®‰è£…Cscope" class="headerlink" title="å®‰è£…Cscope"></a>å®‰è£…Cscope</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install cscope</span><br></pre></td></tr></table></figure><h2 id="é…ç½®ä¸ä½¿ç”¨"><a href="#é…ç½®ä¸ä½¿ç”¨" class="headerlink" title="é…ç½®ä¸ä½¿ç”¨"></a>é…ç½®ä¸ä½¿ç”¨</h2><h3 id="é…ç½®Ctags"><a href="#é…ç½®Ctags" class="headerlink" title="é…ç½®Ctags"></a>é…ç½®Ctags</h3><p>åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ<code>tags</code>æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ctags -R .  </span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å¤šäº†å¦‚ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> tags</span><br><span class="line">tags</span><br></pre></td></tr></table></figure><p>ä¸ºäº†èƒ½å¤Ÿåœ¨é¡¹ç›®ä¸­ä½¿ç”¨è¯¥æ–‡ä»¶ä½œä¸º<code>tag</code>ç´¢å¼•ï¼Œåˆ™åœ¨<code>~/.vimrc</code>ä¸­å¢åŠ å¦‚ä¸‹é…ç½®ï¼Œè¿™ä¸ªé…ç½®çš„ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©<code>vim</code>åœ¨é¡¹ç›®çš„ä»»æ„ç›®å½•ä¸­éƒ½èƒ½å¤Ÿæ‰¾åˆ°<code>tags</code>çš„é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> tags=./tags;/</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨Ctags"><a href="#ä½¿ç”¨Ctags" class="headerlink" title="ä½¿ç”¨Ctags"></a>ä½¿ç”¨Ctags</h3><ul><li><code>ctrl+t </code>:åœ¨è·³è½¬ä¹‹åï¼ŒæŒ‰ä¸‹ctrl+t,vimå°±ä¼šè¿”å›ä¹‹å‰çš„è·³è½¬ä½ç½®</li><li><code>ctrl+] </code>:å°†å…‰æ ‡ç§»åŠ¨åˆ°å‡½æ•°æˆ–å˜é‡åä¸Šï¼ŒæŒ‰ä¸‹ctrl+],vimä¼šè‡ªåŠ¨è·³è½¬åˆ°è¯¥å‡½æ•°æˆ–è€…å˜é‡çš„å®šä¹‰å¤„</li><li><code>ctrl + w + ctrl + ]</code>: å°†å…‰æ ‡ç§»åŠ¨åˆ°å‡½æ•°æˆ–å˜é‡åä¸Šï¼ŒæŒ‰ä¸‹å¿«æ·é”®,vimä¼šè‡ªåŠ¨è·³è½¬åˆ°è¯¥å‡½æ•°æˆ–è€…å˜é‡çš„å®šä¹‰å¤„å¹¶å‚ç›´æ‹†åˆ†æ ‡ç­¾é¡µ</li><li><code>ctrl +w +w</code>: åœ¨åˆšæ‰å‚ç›´æ‹†åˆ†çš„æ ‡ç­¾é¡µä¸­æ¥å›è·³è½¬å…‰æ ‡</li><li><code>ctrl + w + c</code>: å…³é—­ä¸€ä¸ªå‚ç›´æ‹†åˆ†çš„æ ‡ç­¾é¡µ</li><li><code>:tags </code>: è¾“å…¥:tags, vimä¼šæ˜¾ç¤ºæ‰€æœ‰å¯è·³è½¬çš„åˆ—è¡¨</li></ul><h3 id="é…ç½®Cscope"><a href="#é…ç½®Cscope" class="headerlink" title="é…ç½®Cscope"></a>é…ç½®Cscope</h3><p>åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ<code>tags</code>æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cscope -Rbq</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å¤šäº†å¦‚ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â¯ <span class="built_in">ls</span> cscope*</span><br><span class="line">cscope.in.out  cscope.out  cscope.po.out</span><br></pre></td></tr></table></figure><p>ä¸ºäº†èƒ½å¤Ÿåœ¨é¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›æ–‡ä»¶ä½œä¸ºç´¢å¼•ï¼Œåˆ™åœ¨ä¸‹è½½<code>cscope</code>çš„å®˜æ–¹é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -O ~/.cscope_maps.vim https://cscope.sourceforge.net/cscope_maps.vim</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨<code>.vimrc</code>ä¸­å¢åŠ é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.cscope_maps.vim</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨Cscope"><a href="#ä½¿ç”¨Cscope" class="headerlink" title="ä½¿ç”¨Cscope"></a>ä½¿ç”¨Cscope</h3><p>åœ¨<code>vim</code>ä¸­å…‰æ ‡æ”¾åˆ°ä¸€ä¸ª<code>symbol</code>ä¸Šï¼Œéšåä½¿ç”¨<code>vim</code>ä¸­é…ç½®çš„å¿«æ·é”®ï¼ˆdetails: ~&#x2F;.cscope_maps.vimï¼‰ã€‚</p><ul><li>a: æŸ¥æ‰¾ä¸€ä¸ªç¬¦åˆè¢«èµ‹å€¼(assigned)çš„åœ°æ–¹</li><li>c: æŸ¥æ‰¾è°ƒç”¨(call)è¿™ä¸ªå‡½æ•°çš„å‡½æ•°</li><li>d: æŸ¥æ‰¾è¢«è¿™ä¸ªå‡½æ•°è°ƒç”¨(called)çš„å‡½æ•°</li><li>e: ä½¿ç”¨(egrep)æœç´¢è¿›è¡ŒæŸ¥æ‰¾</li><li>f: æŒ‰ç…§æ–‡ä»¶(file)åæŸ¥æ‰¾</li><li>g: æŸ¥æ‰¾ä¸€ä¸ªç¬¦åˆçš„å…¨å±€(global)å®šä¹‰</li><li>i: æŸ¥æ‰¾åŒ…å«(include)è¿™ä¸ªæ–‡ä»¶çš„æ–‡ä»¶</li><li>s: æŸ¥æ‰¾ä¸€ä¸ªç¬¦åˆ(symbol)çš„å¼•ç”¨</li><li>t: æŸ¥æ‰¾è¿™ä¸ªæ–‡æœ¬(text)å­—ç¬¦ä¸²çš„æ‰€æœ‰å‡ºç°ä½ç½®</li></ul><p>e.g.: <code>ctrl + \ + c</code>: æœç´¢å…‰æ ‡å¤„çš„<code>symbol</code>åœ¨å·¥ç¨‹ä¸­è¢«è°è°ƒç”¨äº†ã€‚</p><h2 id="åˆ›å»ºè„šæœ¬"><a href="#åˆ›å»ºè„šæœ¬" class="headerlink" title="åˆ›å»ºè„šæœ¬"></a>åˆ›å»ºè„šæœ¬</h2><p>ä¸ºäº†æ¯æ¬¡åˆ›å»º<code>cscope</code>å’Œ<code>ctag</code>ç´¢å¼•çš„æ–¹ä¾¿å¿«æ·æ€§ï¼Œå¯ä»¥åœ¨<code>/usr/local/bin</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º<code>ctcs</code>çš„è„šæœ¬ï¼Œè„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ctcs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">star</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    ctags -R *   </span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ctags successfully!&quot;</span></span><br><span class="line">    <span class="keyword">fi</span>  </span><br><span class="line">    cscope -qbR </span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;cscope successfully!&quot;</span></span><br><span class="line">    <span class="keyword">fi</span>  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">del</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> [ -f tags -o -f cscope.out -o -f cscope.po.out -o -f cscope.in.out ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">rm</span> -f tags  &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;clean tags ok!&quot;</span></span><br><span class="line">        <span class="built_in">rm</span> -f cscope.* &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;clean cscope.* files ok!&quot;</span></span><br><span class="line">    <span class="keyword">fi</span>  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    -r) </span><br><span class="line">        del </span><br><span class="line">        star</span><br><span class="line">        ;;  </span><br><span class="line">    -d) </span><br><span class="line">        del </span><br><span class="line">        ;;  </span><br><span class="line">    *)  </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;usage : ctcs -r|-d&quot;</span>   </span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p>éšåä½¿ç”¨å¦‚ä¸‹å‘½ä»¤èµ‹äºˆæ‰§è¡Œæƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/ctcs</span><br></pre></td></tr></table></figure><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://cscope.sourceforge.net/cscope_maps.vim">https://cscope.sourceforge.net/cscope_maps.vim</a><br><a href="https://stackoverflow.com/questions/563616/vim-and-ctags-tips-and-tricks">https://stackoverflow.com/questions/563616/vim-and-ctags-tips-and-tricks</a><br><a href="https://bigeast.github.io/Source_Code_Tree_Navigation_in_Vim.html">https://bigeast.github.io/Source_Code_Tree_Navigation_in_Vim.html</a><br><a href="https://segmentfault.com/a/1190000044591252">https://segmentfault.com/a/1190000044591252</a><br><a href="https://blog.csdn.net/zg_hover/article/details/78917921">https://blog.csdn.net/zg_hover/article/details/78917921</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
            <tag> vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºCloudFlareæ­å»ºDockeré•œåƒ</title>
      <link href="/2024/07/01/%E5%9F%BA%E4%BA%8ECloudFlare%E6%90%AD%E5%BB%BADocker%E9%95%9C%E5%83%8F-1/"/>
      <url>/2024/07/01/%E5%9F%BA%E4%BA%8ECloudFlare%E6%90%AD%E5%BB%BADocker%E9%95%9C%E5%83%8F-1/</url>
      
        <content type="html"><![CDATA[<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><ul><li>ä¸€ä¸ªåŸŸå</li><li>ä¸€ä¸ªCloudFlareè´¦å·</li></ul><h2 id="åŸŸåä¿®æ”¹DNS"><a href="#åŸŸåä¿®æ”¹DNS" class="headerlink" title="åŸŸåä¿®æ”¹DNS"></a>åŸŸåä¿®æ”¹DNS</h2><p>PS:å¦‚æœè¯¥ç«™ç‚¹å·²åœ¨CloudFlareä¸­å­˜åœ¨ï¼Œè¯·å¿½ç•¥è¯¥æ­¥éª¤ã€‚</p><p>é¦–å…ˆåœ¨CloudFlareä¸­æ·»åŠ ä¸€ä¸ªç«™ç‚¹ï¼ŒåŸŸåå°±å†™ä½ è‡ªå·±çš„åŸŸåï¼š</p><p><img src="/images/pasted-0.png" alt="upload successful"></p><p>æ·»åŠ å¥½ä¹‹ååœ¨ä¸‹é¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°éœ€è¦ä¿®æ”¹çš„DNSä¸ºï¼š</p><p><img src="/images/pasted-1.png" alt="upload successful"></p><p>è¿™é‡Œæˆ‘æ˜¯ä½¿ç”¨çš„è…¾è®¯äº‘çš„åŸŸåï¼Œæ‰€ä»¥ä»¥è…¾è®¯è¿™é‡Œä¸ºä¾‹ï¼Œä¿®æ”¹å¥½åå¦‚ä¸‹å›¾ï¼š</p><p><img src="/images/pasted-2.png" alt="upload successful"></p><h2 id="ä½¿ç”¨githubéƒ¨ç½²"><a href="#ä½¿ç”¨githubéƒ¨ç½²" class="headerlink" title="ä½¿ç”¨githubéƒ¨ç½²"></a>ä½¿ç”¨githubéƒ¨ç½²</h2><p>é¦–å…ˆforkè¯¥ä»“åº“ï¼š<a href="https://github.com/ciiiii/cloudflare-docker-proxy">https://github.com/ciiiii/cloudflare-docker-proxy</a></p><p>å°†<code>src/index.js</code>ã€<code>wrangler.toml</code>çš„<code>libcuda.so</code>æ›¿æ¢æˆä½ çš„åŸŸåï¼Œä»¥<code>src/index.js</code>ä¸ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim src/index.js</span><br><span class="line"></span><br><span class="line">:%s/libcuda.so/your-url/g</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œæˆåpushï¼ˆå¦‚æœåœ¨ç½‘é¡µuiæ“ä½œå¿½ç•¥è¯¥æ­¥éª¤ï¼‰ã€‚</p><p>éšåç‚¹å‡»Deploy with workså³å¯å¼€å§‹éƒ¨ç½²ã€‚</p><p>PS:<br>å¦‚æœDelpoy with worksæœ‰é—®é¢˜ï¼Œè¯·ä¿®æ”¹readmeä¸­è¯¥æŒ‰é’®çš„è¶…é“¾æ¥ä¸ºä½ è‡ªå·±çš„ä»“åº“åœ°å€ã€‚</p><h2 id="Deploy-with-works"><a href="#Deploy-with-works" class="headerlink" title="Deploy with works"></a>Deploy with works</h2><p>Account idå°±æ˜¯<a href="https://dash.cloudflare.com/%E4%B8%AD/%E5%90%8E%E9%9D%A2%E7%9A%84%E9%82%A3%E4%B8%80%E9%83%A8%E5%88%86%E3%80%82">https://dash.cloudflare.com/ä¸­/åé¢çš„é‚£ä¸€éƒ¨åˆ†ã€‚</a><br>Tokenéœ€è¦è‡ªå·±åœ¨è¯¥ç½‘å€è¿›è¡Œåˆ›å»ºï¼š<a href="https://dash.cloudflare.com/profile/api-tokens">https://dash.cloudflare.com/profile/api-tokens</a><br>tokenæ¨¡æ¿å°±é€‰æ‹©<code>ç¼–è¾‘ Cloudflare Workers</code>å³å¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
